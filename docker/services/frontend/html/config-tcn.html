<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCN Pattern Service - Konfiguration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .service-badge {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .service-badge.offline {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #a0a0a0;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
        }

        .tab-btn.active {
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
            border-bottom: 2px solid #64c8ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.2rem;
            color: #64c8ff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #64c8ff;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .btn-success {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .btn-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .btn-warning:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            top: 50%;
            right: 8px;
            margin-top: -6px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .grid-2-equal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .grid-2, .grid-2-equal, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Training Status */
        .training-status {
            font-size: 0.9rem;
        }

        .training-status .training-active {
            color: #4ade80;
            font-weight: 600;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin: 0.75rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #64c8ff, #a78bfa);
            border-radius: 6px;
            transition: width 0.3s;
        }

        /* Pattern Badge */
        .pattern-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            margin: 0.2rem;
            border-radius: 6px;
            font-size: 0.75rem;
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
            border: 1px solid rgba(156, 39, 176, 0.3);
        }

        .pattern-badge.bullish {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border-color: rgba(76, 175, 80, 0.3);
        }

        .pattern-badge.bearish {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border-color: rgba(244, 67, 54, 0.3);
        }

        .pattern-badge.neutral {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-color: rgba(255, 193, 7, 0.3);
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            color: #888;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #4caf50;
        }

        .toast.error {
            border-left: 4px solid #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: #888;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(100, 200, 255, 0.2);
            border-top-color: #64c8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Detection Result */
        .detection-result {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.03);
        }

        .confidence-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .confidence-fill.high { background: #4caf50; }
        .confidence-fill.medium { background: #ffc107; }
        .confidence-fill.low { background: #f44336; }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e8e8e8;
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #64c8ff;
        }

        select.form-control {
            cursor: pointer;
        }

        /* Info Box */
        .info-box {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
            color: #90caf9;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="back-link">&#8592; Dashboard</a>
            <h1 class="header-title">&#128202; TCN Pattern Service</h1>
            <span class="service-badge" id="status-badge">Laden...</span>
        </div>
    </header>

    <div class="container">
        <!-- Stats Bar -->
        <div class="stats-bar" id="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="stat-patterns">-</div>
                <div class="stat-label">Pattern-Klassen</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-params">-</div>
                <div class="stat-label">Parameter</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-uptime">-</div>
                <div class="stat-label">Uptime</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-models">-</div>
                <div class="stat-label">Modelle</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('overview')">&#128200; Übersicht</button>
            <button class="tab-btn" onclick="showTab('detection')">&#128269; Pattern-Erkennung</button>
            <button class="tab-btn" onclick="showTab('training')">&#9881; Training</button>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content active">
            <div class="grid-2-equal">
                <!-- Model Info -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#129302; Modell-Information</h3>
                        <button class="btn btn-primary btn-sm" onclick="loadInfo()">&#8635; Aktualisieren</button>
                    </div>
                    <div id="model-info">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Pattern Classes -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#127919; Erkennbare Pattern</h3>
                    </div>
                    <div id="pattern-classes">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Service Status -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128337; Service Status</h3>
                </div>
                <div id="service-status">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Detection Tab -->
        <div id="tab-detection" class="tab-content">
            <!-- Auto-Scan Status -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128336; Auto-Erkennung</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" id="btn-start-autoscan" onclick="toggleAutoScan(true)">&#9654; Starten</button>
                        <button class="btn btn-danger btn-sm" id="btn-stop-autoscan" onclick="toggleAutoScan(false)" disabled>&#9632; Stoppen</button>
                    </div>
                </div>
                <div id="autoscan-status" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;" id="autoscan-status-indicator">-</div>
                        <div style="color: #888; font-size: 0.85rem;">Status</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #64c8ff;" id="autoscan-total">-</div>
                        <div style="color: #888; font-size: 0.85rem;">Gespeicherte Patterns</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #a78bfa;" id="autoscan-symbols">-</div>
                        <div style="color: #888; font-size: 0.85rem;">Symbole</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1rem; color: #fff;" id="autoscan-lastscan">-</div>
                        <div style="color: #888; font-size: 0.85rem;">Letzter Scan</div>
                    </div>
                </div>
                <div class="info-box" style="margin-top: 1rem;">
                    Auto-Erkennung scannt alle 5 Minuten alle aktiven Symbole auf den Timeframes 1h, 4h und 1d.
                    Erkannte Patterns werden 7 Tage gespeichert (max. 2000 Eintraege).
                </div>
            </div>

            <div class="grid-2">
                <!-- Detection Form -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128269; Manuelle Erkennung</h3>
                    </div>
                    <div class="form-group">
                        <label>Symbol</label>
                        <select class="form-control" id="detect-symbol">
                            <option value="">Lade Symbole...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Timeframe</label>
                        <select class="form-control" id="detect-timeframe">
                            <option value="1h" selected>1h</option>
                            <option value="4h">4h</option>
                            <option value="1d">1d</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Min. Confidence</label>
                        <input type="number" class="form-control" id="detect-confidence" value="0.5" min="0" max="1" step="0.05">
                    </div>
                    <button class="btn btn-success" id="btn-detect" onclick="detectPattern()">&#128269; Pattern erkennen</button>

                    <div id="detection-result"></div>
                </div>

                <!-- Scan All -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128640; Manueller Multi-Symbol Scan</h3>
                    </div>
                    <div class="info-box" style="margin-bottom: 1rem;">
                        Scannt alle aktiven Symbole sofort nach Patterns und speichert sie in der Historie.
                    </div>
                    <button class="btn btn-primary" id="btn-scan-all" onclick="scanAllAndSave()">&#128640; Alle Symbole scannen</button>
                    <div id="scan-results" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Pattern History Table (moved from Verlauf tab) -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Erkannte Patterns</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <select class="form-control" id="history-symbol-filter" style="width: auto;">
                            <option value="">Alle Symbole</option>
                        </select>
                        <select class="form-control" id="history-category-filter" style="width: auto;">
                            <option value="">Alle Kategorien</option>
                            <option value="reversal">Reversal</option>
                            <option value="continuation">Continuation</option>
                            <option value="trend">Trend</option>
                        </select>
                        <select class="form-control" id="history-direction-filter" style="width: auto;">
                            <option value="">Alle Richtungen</option>
                            <option value="bullish">Bullish</option>
                            <option value="bearish">Bearish</option>
                            <option value="neutral">Neutral</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadPatternHistory()">&#8635; Aktualisieren</button>
                    </div>
                </div>
                <div id="pattern-history-table" style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Pattern</th>
                                <th>Richtung</th>
                                <th>Konfidenz</th>
                                <th>Timeframe</th>
                                <th>Erkannt</th>
                                <th>Preis</th>
                            </tr>
                        </thead>
                        <tbody id="pattern-history-body">
                            <tr><td colspan="7" style="text-align: center; padding: 2rem; color: #888;">Lade Pattern-Historie...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <span id="history-count" style="color: #888; font-size: 0.85rem;"></span>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Nach Pattern-Typ</h3>
                    </div>
                    <div id="stats-by-type" style="font-size: 0.85rem;">Lade...</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Nach Kategorie</h3>
                    </div>
                    <div id="stats-by-category" style="font-size: 0.85rem;">Lade...</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Nach Timeframe</h3>
                    </div>
                    <div id="stats-by-timeframe" style="font-size: 0.85rem;">Lade...</div>
                </div>
            </div>
        </div>

        <!-- Training Tab -->
        <div id="tab-training" class="tab-content">
            <!-- Auto-Training (moved to top) -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128336; Auto-Training</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" id="btn-enable-auto" onclick="toggleAutoTraining(true)">
                            &#9654; Aktivieren
                        </button>
                        <button class="btn btn-danger btn-sm" id="btn-disable-auto" onclick="toggleAutoTraining(false)" disabled>
                            &#9632; Deaktivieren
                        </button>
                    </div>
                </div>
                <div id="auto-training-status">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Intervall</label>
                        <select class="form-control" id="auto-interval">
                            <option value="daily">Täglich</option>
                            <option value="weekly" selected>Wöchentlich</option>
                            <option value="monthly">Monatlich</option>
                            <option value="manual">Manuell</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Timeframes</label>
                        <div style="display: flex; gap: 1rem; padding-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                                <input type="checkbox" id="auto-tf-1h" checked> 1h
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                                <input type="checkbox" id="auto-tf-4h" checked> 4h
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                                <input type="checkbox" id="auto-tf-1d" checked> 1d
                            </label>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" id="btn-run-now" onclick="runAutoTrainingNow()">
                        &#9889; Jetzt starten
                    </button>
                </div>
            </div>

            <div class="grid-2-equal">
                <!-- Training Status -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#9881; Training Status</h3>
                    </div>
                    <div id="training-status">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Start Training -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128295; Manuelles Training</h3>
                    </div>
                    <div class="form-group">
                        <label>Symbole <span id="symbols-count" style="color: #888; font-weight: normal;"></span></label>
                        <select class="form-control" id="train-symbols" multiple style="height: 120px;">
                            <option disabled>Lade Symbole...</option>
                        </select>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button type="button" class="btn btn-secondary" onclick="selectAllSymbols()" style="flex: 1; padding: 0.3rem;">Alle</button>
                            <button type="button" class="btn btn-secondary" onclick="selectNoSymbols()" style="flex: 1; padding: 0.3rem;">Keine</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="form-group">
                            <label>Timeframe</label>
                            <select class="form-control" id="train-timeframe">
                                <option value="1h" selected>1h</option>
                                <option value="4h">4h</option>
                                <option value="1d">1d</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lookback (Tage)</label>
                            <input type="number" class="form-control" id="train-lookback" value="365" min="30" max="1000">
                        </div>
                        <div class="form-group">
                            <label>Epochen</label>
                            <input type="number" class="form-control" id="train-epochs" value="100" min="10" max="1000">
                        </div>
                        <div class="form-group">
                            <label>Batch Size</label>
                            <input type="number" class="form-control" id="train-batch" value="32" min="8" max="128">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Learning Rate</label>
                        <input type="number" class="form-control" id="train-lr" value="0.0001" min="0.00001" max="0.01" step="0.0001">
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" id="btn-train" onclick="startTraining()">&#9654; Training starten</button>
                        <button class="btn btn-danger" id="btn-stop-train" onclick="stopTraining()" disabled>&#9632; Stoppen</button>
                    </div>
                </div>
            </div>

            <!-- Available Models -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128230; Verfügbare Modelle</h3>
                    <button class="btn btn-secondary btn-sm" onclick="loadModels()">&#8635; Aktualisieren</button>
                </div>
                <div id="models-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Training History -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Training-Verlauf</h3>
                </div>
                <div id="training-history">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Inference endpoints remain on /tcn, training moved to /tcn-train
        const API_BASE = '/tcn/api/v1';
        const TRAIN_API_BASE = '/tcn-train/api/v1';
        let trainingInterval = null;

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Format Uptime
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        // Parse UTC timestamp (timestamps from API are UTC but without Z suffix)
        function parseUTCTimestamp(timestamp) {
            if (!timestamp) return null;
            // If timestamp doesn't have timezone info, treat as UTC
            if (!timestamp.endsWith('Z') && !timestamp.includes('+')) {
                timestamp = timestamp + 'Z';
            }
            return new Date(timestamp);
        }

        // Format UTC timestamp to local timezone
        function formatLocalDateTime(timestamp, options = { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) {
            const date = parseUTCTimestamp(timestamp);
            if (!date || isNaN(date.getTime())) return '-';
            return date.toLocaleString('de-CH', { timeZone: 'Europe/Zurich', ...options });
        }

        // Pattern Type Detection
        function getPatternType(pattern) {
            const bullish = ['inverse_head_and_shoulders', 'double_bottom', 'triple_bottom', 'ascending_triangle', 'bull_flag', 'cup_and_handle', 'falling_wedge', 'channel_up'];
            const bearish = ['head_and_shoulders', 'double_top', 'triple_top', 'descending_triangle', 'bear_flag', 'rising_wedge', 'channel_down'];
            if (bullish.includes(pattern)) return 'bullish';
            if (bearish.includes(pattern)) return 'bearish';
            return 'neutral';
        }

        // Load Service Info
        async function loadInfo() {
            try {
                const [infoRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/info`),
                    fetch(`${API_BASE}/stats`)
                ]);

                if (!infoRes.ok || !statsRes.ok) throw new Error('Failed to load data');

                const info = await infoRes.json();
                const stats = await statsRes.json();

                // Update status badge
                const badge = document.getElementById('status-badge');
                badge.textContent = info.model?.loaded ? 'Online' : 'Offline';
                badge.className = `service-badge ${info.model?.loaded ? '' : 'offline'}`;

                // Update stats - info has num_classes at top level, model info under model object
                document.getElementById('stat-patterns').textContent = info.num_classes || info.model?.num_classes || '-';
                document.getElementById('stat-params').textContent = info.model?.parameters ? (info.model.parameters / 1000000).toFixed(2) + 'M' : '-';
                document.getElementById('stat-uptime').textContent = stats.uptime_seconds ? formatUptime(stats.uptime_seconds) : '-';
                document.getElementById('stat-models').textContent = stats.available_models || 0;

                // Model Info
                document.getElementById('model-info').innerHTML = `
                    <table class="data-table">
                        <tr><td style="color: #888;">Service</td><td>${info.service}</td></tr>
                        <tr><td style="color: #888;">Version</td><td>${info.version}</td></tr>
                        <tr><td style="color: #888;">Gestartet</td><td>${formatLocalDateTime(info.started_at, { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td></tr>
                        <tr><td style="color: #888;">Modell geladen</td><td>${info.model?.loaded ? '<span style="color: #4caf50;">Ja</span>' : '<span style="color: #f44336;">Nein</span>'}</td></tr>
                        <tr><td style="color: #888;">Pattern-Klassen</td><td>${info.num_classes || info.model?.num_classes || '-'}</td></tr>
                        <tr><td style="color: #888;">Parameter</td><td>${info.model?.parameters?.toLocaleString() || '-'}</td></tr>
                        <tr><td style="color: #888;">Training aktiv</td><td>${info.training?.in_progress ? '<span style="color: #ffc107;">Ja</span>' : 'Nein'}</td></tr>
                    </table>
                `;

                // Pattern Classes - pattern_classes is at top level in info response
                const patterns = info.pattern_classes || info.model?.pattern_classes || [];
                document.getElementById('pattern-classes').innerHTML = patterns.length > 0
                    ? patterns.map(p => `<span class="pattern-badge ${getPatternType(p)}">${p.replace(/_/g, ' ')}</span>`).join('')
                    : '<span style="color: #888;">Keine Pattern geladen</span>';

                // Service Status - model info is under stats.model
                const modelLoaded = stats.model?.loaded || false;
                document.getElementById('service-status').innerHTML = `
                    <div class="grid-3">
                        <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                            <div style="font-size: 1.5rem; color: #64c8ff;">${stats.training_history_count || 0}</div>
                            <div style="color: #888; font-size: 0.85rem;">Training Sessions</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                            <div style="font-size: 1.5rem; color: ${modelLoaded ? '#4caf50' : '#f44336'};">${modelLoaded ? 'Bereit' : 'Nicht bereit'}</div>
                            <div style="color: #888; font-size: 0.85rem;">Model Status</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                            <div style="font-size: 1.5rem; color: #a78bfa;">${stats.available_models || 0}</div>
                            <div style="color: #888; font-size: 0.85rem;">Verfügbare Modelle</div>
                        </div>
                    </div>
                `;

            } catch (error) {
                showToast('Fehler beim Laden der Service-Info', 'error');
                console.error(error);
            }
        }

        // Detect Pattern
        async function detectPattern() {
            const btn = document.getElementById('btn-detect');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const symbol = document.getElementById('detect-symbol').value;
                const timeframe = document.getElementById('detect-timeframe').value;
                const minConfidence = parseFloat(document.getElementById('detect-confidence').value);

                const response = await fetch(`${API_BASE}/detect/${symbol}?timeframe=${timeframe}&min_confidence=${minConfidence}`);
                if (!response.ok) throw new Error('Detection failed');

                const data = await response.json();
                const result = document.getElementById('detection-result');

                if (data.patterns && data.patterns.length > 0) {
                    result.innerHTML = data.patterns.map(p => `
                        <div class="detection-result">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="pattern-badge ${getPatternType(p.pattern_type)}" style="font-size: 0.9rem;">${p.pattern_type.replace(/_/g, ' ')}</span>
                                <span style="color: #64c8ff; font-weight: 600;">${(p.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill ${p.confidence >= 0.8 ? 'high' : p.confidence >= 0.6 ? 'medium' : 'low'}" style="width: ${p.confidence * 100}%"></div>
                            </div>
                            ${p.price_target ? `<div style="margin-top: 0.5rem; color: #888;">Ziel: ${p.price_target.toFixed(2)}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    result.innerHTML = '<div class="detection-result" style="color: #888; text-align: center;">Keine Pattern erkannt</div>';
                }

                showToast(`Pattern-Erkennung für ${symbol} abgeschlossen`);
            } catch (error) {
                showToast('Fehler bei der Pattern-Erkennung', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // =============================================================================
        // Auto-Scan Functions (Pattern Detection)
        // =============================================================================

        // Load Auto-Scan Status for Detection Tab
        async function loadAutoScanStatus() {
            try {
                const response = await fetch(`${API_BASE}/history/statistics`);
                if (!response.ok) throw new Error('Failed to load auto-scan status');

                const stats = await response.json();

                // Update status indicator
                const statusIndicator = document.getElementById('autoscan-status-indicator');
                if (stats.scan_running) {
                    statusIndicator.innerHTML = '<span style="color: #4caf50;">Aktiv</span>';
                    document.getElementById('btn-start-autoscan').disabled = true;
                    document.getElementById('btn-stop-autoscan').disabled = false;
                } else {
                    statusIndicator.innerHTML = '<span style="color: #ffc107;">Gestoppt</span>';
                    document.getElementById('btn-start-autoscan').disabled = false;
                    document.getElementById('btn-stop-autoscan').disabled = true;
                }

                // Update other stats
                document.getElementById('autoscan-total').textContent = stats.total_patterns || 0;
                document.getElementById('autoscan-symbols').textContent = stats.symbols_with_patterns || 0;
                document.getElementById('autoscan-lastscan').textContent = stats.last_scan
                    ? formatLocalDateTime(stats.last_scan)
                    : '-';

            } catch (error) {
                console.error('Error loading auto-scan status:', error);
            }
        }

        // Toggle Auto-Scan
        async function toggleAutoScan(enable) {
            const endpoint = enable ? 'start-auto-scan' : 'stop-auto-scan';
            const btn = enable ? document.getElementById('btn-start-autoscan') : document.getElementById('btn-stop-autoscan');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/history/${endpoint}`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to toggle auto-scan');

                const result = await response.json();
                showToast(enable ? 'Auto-Erkennung gestartet' : 'Auto-Erkennung gestoppt');
                loadAutoScanStatus();

            } catch (error) {
                showToast('Fehler beim Ändern des Auto-Scan Status', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        // Load Symbols for Detection Dropdown
        async function loadDetectionSymbols() {
            const select = document.getElementById('detect-symbol');

            try {
                const response = await fetch('/data/api/v1/managed-symbols');
                if (!response.ok) throw new Error('Failed to load symbols');

                const data = await response.json();

                // Filter active symbols with data
                const symbols = data
                    .filter(s => s.has_timescaledb_data && s.status === 'active')
                    .sort((a, b) => a.symbol.localeCompare(b.symbol));

                select.innerHTML = '';

                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Symbol wählen...';
                select.appendChild(defaultOption);

                // Add symbols
                symbols.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.symbol;
                    option.textContent = s.display_name || s.symbol;
                    select.appendChild(option);
                });

                // Select first symbol if available
                if (symbols.length > 0) {
                    select.value = symbols[0].symbol;
                }

            } catch (error) {
                console.error('Error loading detection symbols:', error);
                // Fallback
                select.innerHTML = `
                    <option value="BTCUSD">BTCUSD</option>
                    <option value="ETHUSD">ETHUSD</option>
                    <option value="EURUSD">EURUSD</option>
                    <option value="XAUUSD">XAUUSD</option>
                `;
            }
        }

        // Scan All Symbols and Save to History
        async function scanAllAndSave() {
            const btn = document.getElementById('btn-scan-all');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                // Use the history/scan endpoint which saves to history
                const response = await fetch(`${API_BASE}/history/scan`, { method: 'POST' });
                if (!response.ok) throw new Error('Scan failed');

                const result = await response.json();
                const results = document.getElementById('scan-results');

                results.innerHTML = `
                    <div class="info-box" style="background: rgba(76,175,80,0.1); border-color: rgba(76,175,80,0.3); color: #81c784;">
                        <strong>Scan abgeschlossen</strong><br>
                        ${result.patterns_found || 0} Patterns gefunden, ${result.patterns_added || 0} neu gespeichert
                    </div>
                `;

                showToast(`Scan: ${result.patterns_found || 0} Patterns gefunden`);

                // Refresh stats
                loadAutoScanStatus();

            } catch (error) {
                showToast('Fehler beim Scan', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Legacy function for backwards compatibility
        async function scanAll() {
            return scanAllAndSave();
        }

        // Format duration from start time
        function formatDuration(startTimeISO) {
            if (!startTimeISO) return '-';
            const start = new Date(startTimeISO);
            const now = new Date();
            const diffMs = now - start;
            const diffSecs = Math.floor(diffMs / 1000);
            const mins = Math.floor(diffSecs / 60);
            const secs = diffSecs % 60;
            const hours = Math.floor(mins / 60);
            if (hours > 0) return `${hours}h ${mins % 60}m ${secs}s`;
            if (mins > 0) return `${mins}m ${secs}s`;
            return `${secs}s`;
        }

        // Load Training Status
        async function loadTrainingStatus() {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/train/status`);
                if (!response.ok) throw new Error('Failed to load training status');

                const data = await response.json();
                const container = document.getElementById('training-status');

                const isTraining = data.status === 'training' || data.status === 'preparing';

                if (isTraining) {
                    document.getElementById('btn-train').disabled = true;
                    document.getElementById('btn-stop-train').disabled = false;

                    const progressPercent = data.progress ? (data.progress * 100).toFixed(1) : 0;
                    const duration = formatDuration(data.started_at);

                    container.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(76,175,80,0.15), rgba(76,175,80,0.05)); border: 1px solid rgba(76,175,80,0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="color: #4caf50; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                                    Training läuft...
                                </span>
                                <span style="background: #4caf50; color: #000; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                                    ${progressPercent}%
                                </span>
                            </div>
                            <div class="progress-bar" style="height: 8px; margin-bottom: 0.75rem;">
                                <div class="progress-fill" style="width: ${progressPercent}%; background: linear-gradient(90deg, #4caf50, #81c784);"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem;">
                                <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: #888;">Epoche</div>
                                    <div style="color: #fff; font-weight: 600;">${data.current_epoch || 0} / ${data.total_epochs || '-'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: #888;">Laufzeit</div>
                                    <div style="color: #fff; font-weight: 600;">${duration}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: #888;">Samples</div>
                                    <div style="color: #fff; font-weight: 600;">${data.samples_count?.toLocaleString() || '-'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: #888;">Best Loss</div>
                                    <div style="color: #fff; font-weight: 600;">${data.best_loss?.toFixed(4) || '-'}</div>
                                </div>
                            </div>
                            ${data.job_id ? `<div style="margin-top: 0.75rem; color: #666; font-size: 0.75rem;">Job: ${data.job_id}</div>` : ''}
                        </div>
                    `;
                } else {
                    document.getElementById('btn-train').disabled = false;
                    document.getElementById('btn-stop-train').disabled = true;

                    // Try to get last training info
                    try {
                        const histResponse = await fetch(`${TRAIN_API_BASE}/train/history`);
                        if (histResponse.ok) {
                            const histData = await histResponse.json();
                            if (histData.history && histData.history.length > 0) {
                                // Get most recent training
                                const lastTraining = [...histData.history].sort((a, b) =>
                                    new Date(b.started_at) - new Date(a.started_at)
                                )[0];

                                let duration = '-';
                                if (lastTraining.started_at && lastTraining.completed_at) {
                                    const durationSecs = Math.floor((new Date(lastTraining.completed_at) - new Date(lastTraining.started_at)) / 1000);
                                    duration = formatUptime(durationSecs);
                                }

                                container.innerHTML = `
                                    <div style="text-align: center; padding: 1rem; color: #888; margin-bottom: 1rem;">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.3rem;">&#9989;</div>
                                        <div>Bereit für Training</div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.03); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem;">
                                        <div style="color: #888; margin-bottom: 0.5rem;">Letztes Training:</div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                            <div><span style="color: #888;">Status:</span> <span style="color: ${lastTraining.status === 'completed' ? '#4caf50' : '#f44336'};">${lastTraining.status}</span></div>
                                            <div><span style="color: #888;">Datum:</span> ${formatLocalDateTime(lastTraining.started_at)}</div>
                                            <div><span style="color: #888;">Epochen:</span> ${lastTraining.current_epoch || 0}/${lastTraining.total_epochs || '-'}</div>
                                            <div><span style="color: #888;">Loss:</span> ${lastTraining.best_loss?.toFixed(4) || '-'}</div>
                                        </div>
                                    </div>
                                `;
                                return;
                            }
                        }
                    } catch (e) {
                        // Ignore error, show default message
                    }

                    container.innerHTML = `
                        <div style="text-align: center; padding: 1.5rem; color: #888;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#9989;</div>
                            <div>Bereit für Training</div>
                            <div style="font-size: 0.85rem; margin-top: 0.5rem;">Noch keine Trainings durchgeführt</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
            }
        }

        // Start Training
        async function startTraining() {
            const btn = document.getElementById('btn-train');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                // Get selected symbols
                const symbolSelect = document.getElementById('train-symbols');
                const symbols = Array.from(symbolSelect.selectedOptions).map(o => o.value);
                if (symbols.length === 0) {
                    showToast('Bitte mindestens ein Symbol auswählen', 'error');
                    btn.classList.remove('btn-loading');
                    btn.disabled = false;
                    return;
                }

                const timeframe = document.getElementById('train-timeframe').value;
                const lookbackDays = parseInt(document.getElementById('train-lookback').value);
                const epochs = parseInt(document.getElementById('train-epochs').value);
                const batchSize = parseInt(document.getElementById('train-batch').value);
                const learningRate = parseFloat(document.getElementById('train-lr').value);

                const response = await fetch(`${TRAIN_API_BASE}/train`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols,
                        timeframe,
                        lookback_days: lookbackDays,
                        epochs,
                        batch_size: batchSize,
                        learning_rate: learningRate
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Failed to start training');
                }

                showToast('Training gestartet');
                document.getElementById('btn-stop-train').disabled = false;

                // Start polling for status
                trainingInterval = setInterval(loadTrainingStatus, 2000);

            } catch (error) {
                showToast('Fehler beim Starten des Trainings', 'error');
                console.error(error);
                btn.disabled = false;
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        // Stop Training
        async function stopTraining() {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/train/stop`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to stop training');

                showToast('Training gestoppt');
                if (trainingInterval) {
                    clearInterval(trainingInterval);
                    trainingInterval = null;
                }
                loadTrainingStatus();
            } catch (error) {
                showToast('Fehler beim Stoppen des Trainings', 'error');
                console.error(error);
            }
        }

        // Load Training History
        async function loadTrainingHistory() {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/train/history`);
                if (!response.ok) throw new Error('Failed to load history');

                const data = await response.json();
                const container = document.getElementById('training-history');

                if (data.history && data.history.length > 0) {
                    // Sort by date (newest first)
                    const sortedHistory = [...data.history].sort((a, b) =>
                        new Date(b.started_at) - new Date(a.started_at)
                    );

                    container.innerHTML = `
                        <table class="data-table">
                            <tr>
                                <th>Datum</th>
                                <th>Status</th>
                                <th>Epochen</th>
                                <th>Samples</th>
                                <th>Best Loss</th>
                                <th>Dauer</th>
                            </tr>
                            ${sortedHistory.map(h => {
                                // Calculate duration from started_at and completed_at
                                let duration = '-';
                                if (h.started_at && h.completed_at) {
                                    const startDate = parseUTCTimestamp(h.started_at);
                                    const endDate = parseUTCTimestamp(h.completed_at);
                                    if (startDate && endDate) {
                                        const durationSecs = Math.floor((endDate - startDate) / 1000);
                                        duration = formatUptime(durationSecs);
                                    }
                                }
                                const statusColor = h.status === 'completed' ? '#4caf50' : h.status === 'failed' ? '#f44336' : '#ffc107';
                                return `
                                <tr>
                                    <td>${formatLocalDateTime(h.started_at)}</td>
                                    <td><span style="color: ${statusColor};">${h.status}</span></td>
                                    <td>${h.current_epoch || 0}/${h.total_epochs || '-'}</td>
                                    <td>${h.samples_count?.toLocaleString() || '-'}</td>
                                    <td>${h.best_loss?.toFixed(4) || '-'}</td>
                                    <td>${duration}</td>
                                </tr>
                            `}).join('')}
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="info-box">Noch keine Trainings durchgeführt.</div>';
                }
            } catch (error) {
                console.error(error);
            }
        }

        // Load Available Models
        async function loadModels() {
            const container = document.getElementById('models-list');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models`);
                if (!response.ok) throw new Error('Failed to load models');

                const data = await response.json();

                if (data.models && data.models.length > 0) {
                    // Sort by creation date (newest first)
                    const sortedModels = data.models.sort((a, b) =>
                        new Date(b.created) - new Date(a.created)
                    );

                    container.innerHTML = `
                        <div style="margin-bottom: 0.5rem; color: #888; font-size: 0.85rem;">
                            ${data.count} Modell${data.count !== 1 ? 'e' : ''} verfügbar
                        </div>
                        ${sortedModels.map((m, idx) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: ${idx === 0 ? 'rgba(76,175,80,0.1)' : 'rgba(255,255,255,0.03)'}; border: 1px solid ${idx === 0 ? 'rgba(76,175,80,0.3)' : 'rgba(255,255,255,0.05)'}; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-weight: 600; color: #fff;">${m.name}</span>
                                        ${idx === 0 ? '<span style="background: #4caf50; color: #000; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">AKTUELL</span>' : ''}
                                    </div>
                                    <div style="display: flex; gap: 1rem; margin-top: 0.3rem; font-size: 0.8rem; color: #888;">
                                        <span>&#128197; ${formatLocalDateTime(m.created, { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                                        <span>&#128190; ${m.size_mb} MB</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="loadModel('${m.name}')" ${idx === 0 ? 'disabled' : ''}>
                                    ${idx === 0 ? '&#10004; Geladen' : '&#128194; Laden'}
                                </button>
                            </div>
                        `).join('')}
                    `;
                } else {
                    container.innerHTML = `
                        <div class="info-box" style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#128230;</div>
                            <div>Keine trainierten Modelle vorhanden</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                                Starten Sie ein Training um ein Modell zu erstellen
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading models:', error);
                container.innerHTML = '<div class="info-box" style="color: #e57373;">Fehler beim Laden der Modelle</div>';
            }
        }

        // Load specific model (reload model in inference service)
        async function loadModel(modelName) {
            try {
                // Notify inference service to reload the model
                const response = await fetch(`${API_BASE}/model/reload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_path: `data/models/tcn/${modelName}` })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Failed to load model');
                }

                showToast(`Modell ${modelName} geladen`);
                loadModels(); // Refresh list
                loadInfo();   // Refresh service info
            } catch (error) {
                showToast('Fehler beim Laden des Modells', 'error');
                console.error(error);
            }
        }

        // Load Pattern History Statistics
        async function loadHistoryStats() {
            try {
                const response = await fetch(`${API_BASE}/history/statistics`);
                if (!response.ok) throw new Error('Failed to load history stats');

                const stats = await response.json();

                // Pattern types (top 5)
                const typeHtml = Object.entries(stats.by_pattern_type || {}).slice(0, 5)
                    .map(([type, count]) => `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>${type.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</span><span style="color: #64c8ff;">${count}</span></div>`)
                    .join('');
                document.getElementById('stats-by-type').innerHTML = typeHtml || '<span style="color: #888;">Keine Daten</span>';

                // Categories
                const catHtml = Object.entries(stats.by_category || {})
                    .map(([cat, count]) => `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>${cat}</span><span style="color: #a78bfa;">${count}</span></div>`)
                    .join('');
                document.getElementById('stats-by-category').innerHTML = catHtml || '<span style="color: #888;">Keine Daten</span>';

                // Timeframes
                const tfHtml = Object.entries(stats.by_timeframe || {})
                    .map(([tf, count]) => `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>${tf}</span><span style="color: #ffc107;">${count}</span></div>`)
                    .join('');
                document.getElementById('stats-by-timeframe').innerHTML = tfHtml || '<span style="color: #888;">Keine Daten</span>';

            } catch (error) {
                console.error('Error loading history stats:', error);
            }
        }

        // Load Pattern History Table
        async function loadPatternHistory() {
            const symbol = document.getElementById('history-symbol-filter').value;
            const category = document.getElementById('history-category-filter').value;
            const direction = document.getElementById('history-direction-filter').value;

            let url = `${API_BASE}/history?limit=50`;
            if (symbol) url += `&symbol=${symbol}`;
            if (category) url += `&category=${category}`;
            if (direction) url += `&direction=${direction}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load pattern history');

                const data = await response.json();
                const tbody = document.getElementById('pattern-history-body');

                if (!data.patterns || data.patterns.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #888;">Keine Patterns gefunden</td></tr>';
                    document.getElementById('history-count').textContent = '0 Patterns';
                    return;
                }

                tbody.innerHTML = data.patterns.map(p => `
                    <tr>
                        <td style="font-weight: 500;">${p.symbol}</td>
                        <td><span class="pattern-badge ${p.direction}">${p.pattern_type.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</span></td>
                        <td><span class="pattern-badge ${p.direction}">${p.direction}</span></td>
                        <td style="color: ${p.confidence >= 0.7 ? '#4caf50' : p.confidence >= 0.5 ? '#ffc107' : '#f44336'};">${(p.confidence * 100).toFixed(1)}%</td>
                        <td>${p.timeframe}</td>
                        <td style="color: #888;">${formatLocalDateTime(p.detected_at)}</td>
                        <td style="font-family: monospace;">${p.price_at_detection ? p.price_at_detection.toLocaleString('de-CH', {maximumFractionDigits: 2}) : '-'}</td>
                    </tr>
                `).join('');

                document.getElementById('history-count').textContent = `${data.count} Patterns angezeigt`;

                // Update symbol filter
                await updateHistorySymbolFilter();

            } catch (error) {
                console.error('Error loading pattern history:', error);
                document.getElementById('pattern-history-body').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #f44336;">Fehler beim Laden</td></tr>';
            }
        }

        // Update symbol filter dropdown
        async function updateHistorySymbolFilter() {
            try {
                const response = await fetch(`${API_BASE}/history-by-symbol?limit_per_symbol=1`);
                if (!response.ok) return;

                const data = await response.json();
                const select = document.getElementById('history-symbol-filter');
                const currentValue = select.value;

                // Keep first option
                while (select.options.length > 1) {
                    select.remove(1);
                }

                Object.keys(data.by_symbol || {}).sort().forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    select.appendChild(option);
                });

                select.value = currentValue;
            } catch (error) {
                console.error('Error updating symbol filter:', error);
            }
        }

        // Trigger manual pattern scan
        async function triggerManualScan() {
            try {
                showToast('Scan gestartet...');
                const response = await fetch(`${API_BASE}/history/scan`, { method: 'POST' });
                if (!response.ok) throw new Error('Scan failed');

                const result = await response.json();
                showToast(`Scan abgeschlossen: ${result.patterns_found} Patterns gefunden, ${result.patterns_added} neu`);

                loadPatternHistory();
                loadHistoryStats();
            } catch (error) {
                showToast('Fehler beim Scan', 'error');
                console.error(error);
            }
        }

        // Load Available Symbols from Data Service
        async function loadAvailableSymbols() {
            const select = document.getElementById('train-symbols');
            const countSpan = document.getElementById('symbols-count');

            try {
                // managed-symbols liefert Array mit {symbol, category, has_timescaledb_data, ...}
                const response = await fetch('/data/api/v1/managed-symbols');
                if (!response.ok) throw new Error('Failed to load symbols');

                const data = await response.json();

                // Nur Symbole mit Daten, sortiert nach Kategorie und Name
                const symbols = data
                    .filter(s => s.has_timescaledb_data && s.status === 'active')
                    .sort((a, b) => {
                        // Erst nach Kategorie, dann alphabetisch
                        if (a.category !== b.category) return a.category.localeCompare(b.category);
                        return a.symbol.localeCompare(b.symbol);
                    });

                select.innerHTML = '';
                let currentCategory = '';

                symbols.forEach(s => {
                    // Optgroup für Kategorien
                    if (s.category !== currentCategory) {
                        currentCategory = s.category;
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = currentCategory.toUpperCase();
                        select.appendChild(optgroup);
                    }

                    const option = document.createElement('option');
                    option.value = s.symbol;
                    option.textContent = s.display_name || s.symbol;
                    option.selected = true; // Alle standardmässig ausgewählt
                    select.lastElementChild.appendChild(option);
                });

                countSpan.textContent = `(${symbols.length} verfügbar)`;

            } catch (error) {
                console.error('Error loading symbols:', error);
                // Fallback auf einige Standard-Symbole
                select.innerHTML = `
                    <option value="BTCUSD" selected>BTCUSD</option>
                    <option value="ETHUSD" selected>ETHUSD</option>
                    <option value="EURUSD" selected>EURUSD</option>
                    <option value="XAUUSD" selected>XAUUSD</option>
                `;
                countSpan.textContent = '(Fallback)';
            }
        }

        // Select All Symbols
        function selectAllSymbols() {
            const select = document.getElementById('train-symbols');
            Array.from(select.options).forEach(o => o.selected = true);
        }

        // Select No Symbols
        function selectNoSymbols() {
            const select = document.getElementById('train-symbols');
            Array.from(select.options).forEach(o => o.selected = false);
        }

        // =============================================================================
        // Auto-Training Functions
        // =============================================================================

        // Load Auto-Training Status
        async function loadAutoTrainingStatus() {
            const container = document.getElementById('auto-training-status');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/auto-training/status`);
                if (!response.ok) throw new Error('Failed to load auto-training status');

                const data = await response.json();

                // Update interval dropdown
                document.getElementById('auto-interval').value = data.interval || 'weekly';

                // Update timeframe checkboxes
                const timeframes = data.timeframes || ['1h', '4h', '1d'];
                document.getElementById('auto-tf-1h').checked = timeframes.includes('1h');
                document.getElementById('auto-tf-4h').checked = timeframes.includes('4h');
                document.getElementById('auto-tf-1d').checked = timeframes.includes('1d');

                // Update buttons
                document.getElementById('btn-enable-auto').disabled = data.enabled;
                document.getElementById('btn-disable-auto').disabled = !data.enabled;

                // Format dates
                const lastRun = data.last_run ? formatLocalDateTime(data.last_run, { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Noch nie';
                const nextRun = data.next_run ? formatLocalDateTime(data.next_run, { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';

                const intervalLabels = {
                    'daily': 'Taglich',
                    'weekly': 'Wochentlich',
                    'monthly': 'Monatlich',
                    'manual': 'Manuell'
                };

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem;">
                        <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #888;">Status</div>
                            <div style="color: ${data.enabled ? '#4caf50' : '#888'}; font-weight: 600;">
                                ${data.enabled ? '&#10004; Aktiv' : '&#10008; Inaktiv'}
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #888;">Intervall</div>
                            <div style="color: #fff; font-weight: 600;">${intervalLabels[data.interval] || data.interval}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #888;">Letzter Lauf</div>
                            <div style="color: #fff; font-weight: 600;">${lastRun}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #888;">Nächster Lauf</div>
                            <div style="color: #fff; font-weight: 600;">${nextRun}</div>
                        </div>
                    </div>
                    ${data.current_training ? `
                        <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(100,200,255,0.1); border: 1px solid rgba(100,200,255,0.3); border-radius: 4px;">
                            <div style="color: #64c8ff; font-weight: 600;">Training läuft...</div>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">
                                ${data.current_training.symbols?.length || 0} Symbole,
                                ${data.current_training.completed_timeframes?.length || 0}/${data.current_training.timeframes?.length || 0} Timeframes
                            </div>
                        </div>
                    ` : ''}
                `;

            } catch (error) {
                console.error('Error loading auto-training status:', error);
                container.innerHTML = '<div class="info-box" style="color: #e57373;">Fehler beim Laden des Auto-Training Status</div>';
            }
        }

        // Toggle Auto-Training
        async function toggleAutoTraining(enable) {
            try {
                const endpoint = enable ? 'enable' : 'disable';
                const response = await fetch(`${TRAIN_API_BASE}/auto-training/${endpoint}`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Failed to toggle auto-training');

                showToast(enable ? 'Auto-Training aktiviert' : 'Auto-Training deaktiviert');
                loadAutoTrainingStatus();

            } catch (error) {
                showToast('Fehler beim Ändern des Auto-Training Status', 'error');
                console.error(error);
            }
        }

        // Update Auto-Training Config
        async function updateAutoTrainingConfig() {
            const interval = document.getElementById('auto-interval').value;
            const timeframes = [];
            if (document.getElementById('auto-tf-1h').checked) timeframes.push('1h');
            if (document.getElementById('auto-tf-4h').checked) timeframes.push('4h');
            if (document.getElementById('auto-tf-1d').checked) timeframes.push('1d');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/auto-training/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval, timeframes })
                });

                if (!response.ok) throw new Error('Failed to update config');

                showToast('Auto-Training Konfiguration aktualisiert');
                loadAutoTrainingStatus();

            } catch (error) {
                showToast('Fehler beim Speichern der Konfiguration', 'error');
                console.error(error);
            }
        }

        // Run Auto-Training Now
        async function runAutoTrainingNow() {
            const btn = document.getElementById('btn-run-now');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px; border-width: 2px;"></span> Startet...';

            try {
                // Get selected timeframes
                const timeframes = [];
                if (document.getElementById('auto-tf-1h').checked) timeframes.push('1h');
                if (document.getElementById('auto-tf-4h').checked) timeframes.push('4h');
                if (document.getElementById('auto-tf-1d').checked) timeframes.push('1d');

                const response = await fetch(`${TRAIN_API_BASE}/auto-training/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeframes })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Failed to start auto-training');
                }

                showToast('Auto-Training für alle Symbole gestartet');
                loadAutoTrainingStatus();
                loadTrainingStatus();

            } catch (error) {
                showToast('Fehler beim Starten des Auto-Trainings', 'error');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '&#9889; Jetzt starten';
            }
        }

        // Add event listeners for config changes
        document.getElementById('auto-interval')?.addEventListener('change', updateAutoTrainingConfig);
        document.getElementById('auto-tf-1h')?.addEventListener('change', updateAutoTrainingConfig);
        document.getElementById('auto-tf-4h')?.addEventListener('change', updateAutoTrainingConfig);
        document.getElementById('auto-tf-1d')?.addEventListener('change', updateAutoTrainingConfig);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInfo();
            loadAvailableSymbols();
            loadDetectionSymbols();
            loadAutoScanStatus();
            loadTrainingStatus();
            loadTrainingHistory();
            loadModels();
            loadAutoTrainingStatus();
            loadHistoryStats();
            loadPatternHistory();

            // Auto-refresh every 30 seconds
            setInterval(loadInfo, 30000);

            // Auto-refresh training status every 3 seconds
            setInterval(loadTrainingStatus, 3000);

            // Auto-refresh auto-training status every 10 seconds
            setInterval(loadAutoTrainingStatus, 10000);

            // Auto-refresh auto-scan status every 15 seconds
            setInterval(loadAutoScanStatus, 15000);

            // Auto-refresh pattern history every 60 seconds
            setInterval(() => {
                loadHistoryStats();
                loadPatternHistory();
            }, 60000);
        });
    </script>
</body>
</html>
