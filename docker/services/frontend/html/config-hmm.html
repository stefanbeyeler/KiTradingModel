<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMM Regime Service - Konfiguration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .service-badge {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .service-badge.offline {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #a0a0a0;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
        }

        .tab-btn.active {
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
            border-bottom: 2px solid #64c8ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card - Compact */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .card-title {
            font-size: 1rem;
            color: #64c8ff;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Stats Bar - Compact */
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #64c8ff;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Progress Bar */
        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            height: 8px;
            margin: 0.75rem 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #64c8ff, #4caf50);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 0.25rem;
        }

        /* Buttons - Compact */
        .btn {
            padding: 0.4rem 0.9rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-primary {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .btn-success {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .btn-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .btn-warning:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            top: 50%;
            right: 8px;
            margin-top: -6px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .grid-2-equal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .grid-2, .grid-2-equal, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Regime Badge */
        .regime-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            margin: 0.2rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .regime-badge.bull_trend {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .regime-badge.bear_trend {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .regime-badge.sideways {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .regime-badge.high_volatility {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
            border: 1px solid rgba(156, 39, 176, 0.3);
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            color: #888;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #4caf50;
        }

        .toast.error {
            border-left: 4px solid #f44336;
        }

        .toast.info {
            border-left: 4px solid #2196f3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: #888;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(100, 200, 255, 0.2);
            border-top-color: #64c8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Form Elements - Compact */
        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: #aaa;
            font-size: 0.8rem;
        }

        .form-control {
            width: 100%;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e8e8e8;
            font-size: 0.85rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #64c8ff;
        }

        select.form-control {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364c8ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* Select dropdown styling for better contrast */
        select.form-control {
            background-color: #1a1a2e;
            color: #e8e8e8;
        }

        select.form-control option {
            background-color: #1e2740;
            color: #e8e8e8;
            padding: 10px 12px;
        }

        select.form-control optgroup {
            background-color: #0d1520;
            color: #64c8ff;
            font-weight: 700;
            font-style: normal;
        }

        select.form-control optgroup option {
            background-color: #1e2740;
            color: #d0d0d0;
            font-weight: 400;
            padding-left: 16px;
        }

        select.form-control option:checked {
            background-color: #3a5080;
            color: #ffffff;
        }

        select.form-control option:hover,
        select.form-control option:focus {
            background-color: #2a4060;
            color: #64c8ff;
        }

        /* Info Box */
        .info-box {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
            color: #90caf9;
        }

        /* Score Display */
        .score-display {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }

        .score-value {
            font-size: 3rem;
            font-weight: 700;
        }

        .score-value.positive { color: #4caf50; }
        .score-value.negative { color: #f44336; }
        .score-value.neutral { color: #ffc107; }

        /* Regime Card */
        .regime-card {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.2s;
        }

        .regime-card:hover {
            transform: translateY(-2px);
        }

        .regime-card.bull_trend { background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.2); }
        .regime-card.bear_trend { background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.2); }
        .regime-card.sideways { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2); }
        .regime-card.high_volatility { background: rgba(156, 39, 176, 0.1); border: 1px solid rgba(156, 39, 176, 0.2); }

        .regime-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .regime-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .regime-probability {
            font-size: 1.5rem;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <header>
        <div class="container" style="flex-direction: column; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <a href="index.html" class="back-link">‚Üê Dashboard</a>
                <h1 class="header-title">üìä HMM Regime Service</h1>
                <span class="service-badge" id="status-badge">Laden...</span>
            </div>
            <!-- Compact Header Status Bar -->
            <div style="display: flex; gap: 1.5rem; align-items: center; flex-wrap: wrap; font-size: 0.85rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Service-Status">
                    <span>‚è≥</span>
                    <span style="color: #888;">Status:</span>
                    <strong id="headerStatus" style="color: #4caf50;">L√§dt...</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Service-Version">
                    <span>üì¶</span>
                    <span style="color: #888;">Version:</span>
                    <strong id="headerVersion" style="color: #64c8ff;">-</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Anzahl HMM Modelle">
                    <span>üß†</span>
                    <span style="color: #888;">Modelle:</span>
                    <strong id="headerModels" style="color: #64c8ff;">-</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Anzahl Regime-Typen">
                    <span>üìà</span>
                    <span style="color: #888;">Regimes:</span>
                    <strong id="headerRegimes" style="color: #64c8ff;">4</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Anzahl Features">
                    <span>‚öôÔ∏è</span>
                    <span style="color: #888;">Features:</span>
                    <strong id="headerFeatures" style="color: #64c8ff;">-</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Zeit seit Service-Start">
                    <span>üïê</span>
                    <span style="color: #888;">Uptime:</span>
                    <strong id="headerUptime" style="color: #64c8ff;">-</strong>
                </div>
                <button class="btn btn-primary" onclick="updateHeaderStatus()" style="margin-left: auto; padding: 0.3rem 0.6rem; font-size: 0.8rem;">‚Üª</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Bar -->
        <div class="stats-bar" id="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="stat-models">-</div>
                <div class="stat-label">HMM Modelle</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-regimes">4</div>
                <div class="stat-label">Regime-Typen</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-features">-</div>
                <div class="stat-label">Features</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-uptime">-</div>
                <div class="stat-label">Uptime</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('overview')">&#128200; √úbersicht</button>
            <button class="tab-btn" onclick="showTab('detection')">&#128269; Regime-Erkennung</button>
            <button class="tab-btn" onclick="showTab('scoring')">&#127919; Trade Scoring</button>
            <button class="tab-btn" onclick="showTab('training')">&#9881; Training</button>
            <button class="tab-btn" onclick="showTab('validation')">&#128203; Validierung</button>
            <button class="tab-btn" onclick="showTab('scheduling')">&#128197; Scheduling</button>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content active">
            <div class="grid-2-equal">
                <!-- Service Info -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#129302; Service-Information</h3>
                        <button class="btn btn-primary btn-sm" onclick="loadInfo()">&#8635; Aktualisieren</button>
                    </div>
                    <div id="service-info">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Regime Types -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#127919; Regime-Typen</h3>
                    </div>
                    <div class="grid-2-equal" id="regime-types">
                        <div class="regime-card bull_trend">
                            <div class="regime-icon">&#128200;</div>
                            <div class="regime-name">Bull Trend</div>
                            <div style="color: #888; font-size: 0.8rem;">Aufw√§rtstrend</div>
                        </div>
                        <div class="regime-card bear_trend">
                            <div class="regime-icon">&#128201;</div>
                            <div class="regime-name">Bear Trend</div>
                            <div style="color: #888; font-size: 0.8rem;">Abw√§rtstrend</div>
                        </div>
                        <div class="regime-card sideways">
                            <div class="regime-icon">&#8596;</div>
                            <div class="regime-name">Sideways</div>
                            <div style="color: #888; font-size: 0.8rem;">Seitw√§rtsbewegung</div>
                        </div>
                        <div class="regime-card high_volatility">
                            <div class="regime-icon">&#9889;</div>
                            <div class="regime-name">High Volatility</div>
                            <div style="color: #888; font-size: 0.8rem;">Hohe Volatilit√§t</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Models Overview -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Geladene Modelle</h3>
                </div>
                <div id="models-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Detection Tab -->
        <div id="tab-detection" class="tab-content">
            <!-- Combined Detection Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128269; Regime-Erkennung</h3>
                </div>
                <!-- Single row with all controls -->
                <div style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
                    <!-- Single Symbol Detection -->
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="font-size: 0.75rem;">Symbol</label>
                        <select class="form-control" id="detect-symbol">
                            <option value="BTCUSD">Lade Symbole...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0; min-width: 80px;">
                        <label style="font-size: 0.75rem;">Timeframe</label>
                        <select class="form-control" id="detect-timeframe">
                            <option value="M15">M15</option>
                            <option value="H1" selected>H1</option>
                            <option value="H4">H4</option>
                            <option value="D1">D1</option>
                        </select>
                    </div>
                    <button class="btn btn-success" id="btn-detect" onclick="detectRegime()" style="white-space: nowrap;">&#128269; Erkennen</button>

                    <!-- Separator -->
                    <div style="width: 1px; height: 32px; background: rgba(255,255,255,0.2); margin: 0 0.5rem;"></div>

                    <!-- Multi-Symbol Scan -->
                    <button class="btn btn-primary" id="btn-scan" onclick="scanAll()" style="white-space: nowrap;">&#128640; Alle scannen</button>
                    <div id="scan-progress" style="display: none; min-width: 120px;">
                        <div class="progress-container" style="margin-bottom: 0.25rem;">
                            <div class="progress-bar" id="scan-progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="progress-text" id="scan-progress-text" style="font-size: 0.75rem;">0 / 0</div>
                    </div>
                </div>

                <!-- Results row -->
                <div class="grid-2" style="gap: 1rem; margin-top: 0.75rem;">
                    <div id="detection-result"></div>
                    <div id="scan-results" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Regime History -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Regime-Verlauf</h3>
                    <div>
                        <select class="form-control" id="history-symbol" style="width: auto; display: inline-block;">
                            <option value="BTCUSD">Lade Symbole...</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadHistory()">&#8635; Laden</button>
                    </div>
                </div>
                <div id="regime-history">
                    <div class="info-box">Wahlen Sie ein Symbol und klicken Sie auf "Laden".</div>
                </div>
            </div>
        </div>

        <!-- Scoring Tab -->
        <div id="tab-scoring" class="tab-content">
            <div class="grid-2">
                <!-- Score Calculator -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#127919; Trade Score berechnen</h3>
                    </div>
                    <div class="form-group">
                        <label>Symbol</label>
                        <select class="form-control" id="score-symbol">
                            <option value="BTCUSD">Lade Symbole...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Richtung</label>
                        <select class="form-control" id="score-direction">
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Timeframe</label>
                        <select class="form-control" id="score-timeframe">
                            <option value="H1" selected>H1</option>
                            <option value="H4">H4</option>
                            <option value="D1">D1</option>
                        </select>
                    </div>
                    <button class="btn btn-success" id="btn-score" onclick="calculateScore()">&#127919; Score berechnen</button>
                </div>

                <!-- Score Result -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128202; Ergebnis</h3>
                    </div>
                    <div id="score-result">
                        <div class="score-display">
                            <div style="color: #888; margin-bottom: 0.5rem;">Trade Score</div>
                            <div class="score-value neutral" id="score-value">-</div>
                            <div id="score-details" style="margin-top: 1rem; font-size: 0.9rem; color: #888;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alignment Check -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128260; Alignment Check</h3>
                </div>
                <div class="info-box" style="margin-bottom: 1rem;">
                    Pruft die Ubereinstimmung von Regime und technischen Indikatoren uber mehrere Timeframes.
                </div>
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <div class="form-group" style="margin-bottom: 0; flex: 1;">
                        <label>Symbol</label>
                        <select class="form-control" id="align-symbol">
                            <option value="BTCUSD">BTCUSD</option>
                            <option value="ETHUSD">ETHUSD</option>
                            <option value="EURUSD">EURUSD</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="checkAlignment()">&#128260; Prufen</button>
                </div>
                <div id="alignment-result" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Training Tab -->
        <div id="tab-training" class="tab-content">
            <div class="grid-2-equal">
                <!-- HMM Training -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#9881; HMM Training</h3>
                    </div>
                    <div class="form-group">
                        <label>Symbol</label>
                        <select class="form-control" id="train-symbol">
                            <option value="BTCUSD">BTCUSD</option>
                            <option value="ETHUSD">ETHUSD</option>
                            <option value="EURUSD">EURUSD</option>
                            <option value="XAUUSD">XAUUSD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Trainingsdaten (Tage)</label>
                        <input type="number" class="form-control" id="train-days" value="90" min="30" max="365">
                    </div>
                    <div class="form-group">
                        <label>Anzahl Zustande</label>
                        <input type="number" class="form-control" id="train-states" value="4" min="2" max="8">
                    </div>
                    <button class="btn btn-success" id="btn-train-hmm" onclick="trainHMM()">&#9654; HMM trainieren</button>
                    <div id="hmm-training-result" style="margin-top: 1rem;"></div>
                </div>

                <!-- Scorer Training -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128295; Scorer Training</h3>
                    </div>
                    <div class="info-box" style="margin-bottom: 1rem;">
                        Trainiert den Trade-Scorer mit historischen Daten. Der Scorer bewertet Trade-Setups basierend auf 18 Features.
                    </div>
                    <div id="scorer-status" style="margin-bottom: 1rem;">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                    <button class="btn btn-success" id="btn-train-scorer" onclick="trainScorer()">&#9654; Scorer trainieren</button>
                </div>
            </div>

            <!-- Feature Info -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Scorer Features</h3>
                </div>
                <div id="feature-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Validation Tab -->
        <div id="tab-validation" class="tab-content">
            <!-- Validation Status -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Validierungs-Pipeline Status</h3>
                    <button class="btn btn-primary btn-sm" onclick="loadValidationStatus()">&#8635; Aktualisieren</button>
                </div>
                <div id="validation-status">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="grid-2-equal">
                <!-- Production Models -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#127937; Produktions-Modelle</h3>
                    </div>
                    <div id="production-models">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Registry Stats -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128202; Registry-Statistiken</h3>
                    </div>
                    <div id="registry-stats">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Model Versions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Modell-Versionen</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select class="form-control" id="version-filter-type" style="width: auto;">
                            <option value="">Alle Typen</option>
                            <option value="hmm">HMM</option>
                            <option value="scorer">Scorer</option>
                        </select>
                        <select class="form-control" id="version-filter-symbol" style="width: auto;">
                            <option value="">Alle Symbole</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadModelVersions()">&#128269; Filtern</button>
                    </div>
                </div>
                <div id="model-versions">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Deployment History -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Deployment-Historie</h3>
                </div>
                <div id="deployment-history">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Manual Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#9888;&#65039; Manuelle Aktionen</h3>
                </div>
                <div class="info-box" style="margin-bottom: 1rem; background: rgba(255, 152, 0, 0.1); border-color: rgba(255, 152, 0, 0.3); color: #ffb74d;">
                    <strong>Vorsicht:</strong> Diese Aktionen √ºberschreiben die automatische Validierung. Nur verwenden, wenn Sie sicher sind, dass das Modell produktionsreif ist.
                </div>

                <div class="grid-2-equal">
                    <!-- Force Deploy -->
                    <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem; color: #64c8ff;">Force Deploy</h4>
                        <div class="form-group">
                            <label>Version ID</label>
                            <select class="form-control" id="force-deploy-version">
                                <option value="">Version w√§hlen...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Modell-Typ</label>
                            <select class="form-control" id="force-deploy-type">
                                <option value="hmm">HMM</option>
                                <option value="scorer">Scorer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Symbol (nur f√ºr HMM)</label>
                            <select class="form-control" id="force-deploy-symbol">
                                <option value="">- Nicht anwendbar -</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Grund</label>
                            <input type="text" class="form-control" id="force-deploy-reason" placeholder="Grund f√ºr manuelles Deployment">
                        </div>
                        <button class="btn btn-warning" id="btn-force-deploy" onclick="forceDeploy()">&#9889; Force Deploy</button>
                    </div>

                    <!-- Rollback -->
                    <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem; color: #e57373;">Rollback</h4>
                        <div class="form-group">
                            <label>Modell-Typ</label>
                            <select class="form-control" id="rollback-type">
                                <option value="hmm">HMM</option>
                                <option value="scorer">Scorer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Symbol (nur f√ºr HMM)</label>
                            <select class="form-control" id="rollback-symbol">
                                <option value="">- Nicht anwendbar -</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ziel-Version</label>
                            <select class="form-control" id="rollback-version">
                                <option value="">Version w√§hlen...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Grund</label>
                            <input type="text" class="form-control" id="rollback-reason" placeholder="Grund f√ºr Rollback">
                        </div>
                        <button class="btn btn-danger" id="btn-rollback" onclick="rollbackModel()">&#8617; Rollback</button>
                    </div>
                </div>
            </div>

            <!-- Model Reload -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128260; Modell Hot-Reload</h3>
                </div>
                <div class="info-box" style="margin-bottom: 1rem;">
                    L√§dt Modelle neu aus dem Dateisystem, ohne den Service neu zu starten. N√ºtzlich nach manuellem Deployment.
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="reloadAllModels()">&#128260; Alle Modelle neu laden</button>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select class="form-control" id="reload-symbol" style="width: auto;">
                            <option value="">Symbol w√§hlen...</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="reloadHMMModel()">HMM neu laden</button>
                    </div>
                    <button class="btn btn-primary" onclick="reloadScorer()">Scorer neu laden</button>
                </div>
                <div id="reload-result" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Scheduling Tab -->
        <div id="tab-scheduling" class="tab-content">
            <!-- Scheduler Status -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128197; Scheduler Status</h3>
                    <button class="btn btn-primary btn-sm" onclick="loadSchedulerStatus()">&#8635; Aktualisieren</button>
                </div>
                <div id="scheduler-status">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="grid-2-equal">
                <!-- Schedule List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128203; Training-Schedules</h3>
                    </div>
                    <div id="schedule-list">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Create Schedule -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#10133; Neuer Schedule</h3>
                    </div>
                    <div class="form-group">
                        <label>Intervall</label>
                        <select class="form-control" id="schedule-interval">
                            <option value="hourly">St√ºndlich</option>
                            <option value="daily" selected>T√§glich</option>
                            <option value="weekly">W√∂chentlich</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stunde (UTC, 0-23)</label>
                        <input type="number" class="form-control" id="schedule-hour" value="3" min="0" max="23">
                    </div>
                    <div class="form-group" id="weekday-group" style="display: none;">
                        <label>Wochentag</label>
                        <select class="form-control" id="schedule-weekday">
                            <option value="0">Montag</option>
                            <option value="1">Dienstag</option>
                            <option value="2">Mittwoch</option>
                            <option value="3">Donnerstag</option>
                            <option value="4">Freitag</option>
                            <option value="5">Samstag</option>
                            <option value="6">Sonntag</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Timeframe</label>
                        <select class="form-control" id="schedule-timeframe">
                            <option value="1h" selected>H1</option>
                            <option value="4h">H4</option>
                            <option value="1day">D1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lookback (Tage)</label>
                        <input type="number" class="form-control" id="schedule-lookback" value="365" min="30" max="730">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="schedule-train-hmm" checked> HMM trainieren
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="schedule-train-scorer" checked> Scorer trainieren
                        </label>
                    </div>
                    <div class="info-box" style="margin-bottom: 1rem;">
                        <strong>Hinweis:</strong> Leere Symbol-Liste = Alle Symbole aus dem Data Service werden trainiert.
                    </div>
                    <button class="btn btn-success" onclick="createSchedule()">&#10133; Schedule erstellen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/hmm/api/v1';
        const TRAIN_API_BASE = '/hmm-train/api/v1';
        let serviceStartTime = null;

        // ==================== Header Status Functions ====================

        async function updateHeaderStatus() {
            try {
                // Fetch health info
                const healthResponse = await fetch(`${API_BASE.replace('/api/v1', '')}/health`);
                const healthData = await healthResponse.json();

                // Update status
                const statusEl = document.getElementById('headerStatus');
                const badgeEl = document.getElementById('status-badge');
                if (healthData.status === 'healthy') {
                    statusEl.textContent = 'Online';
                    statusEl.style.color = '#4caf50';
                    badgeEl.textContent = 'Online';
                    badgeEl.classList.remove('offline');
                } else {
                    statusEl.textContent = 'Offline';
                    statusEl.style.color = '#f44336';
                    badgeEl.textContent = 'Offline';
                    badgeEl.classList.add('offline');
                }

                // Fetch info and stats for version and other data
                try {
                    const [infoRes, statsRes] = await Promise.all([
                        fetch(`${API_BASE}/info`),
                        fetch(`${API_BASE}/stats`)
                    ]);
                    const info = await infoRes.json();
                    const stats = await statsRes.json();

                    // Version from info endpoint
                    document.getElementById('headerVersion').textContent = info.version || '-';
                    // Models count from stats
                    document.getElementById('headerModels').textContent = stats.hmm_models_count ?? '-';
                    // Features from info.components.scorer.feature_count
                    document.getElementById('headerFeatures').textContent = info.components?.scorer?.feature_count ?? '-';
                } catch (e) {
                    document.getElementById('headerVersion').textContent = '-';
                    document.getElementById('headerModels').textContent = '-';
                    document.getElementById('headerFeatures').textContent = '-';
                }

                // Calculate uptime
                if (!serviceStartTime) {
                    serviceStartTime = Date.now();
                }
                updateUptime();

            } catch (error) {
                console.error('Error updating header status:', error);
                document.getElementById('headerStatus').textContent = 'Offline';
                document.getElementById('headerStatus').style.color = '#f44336';
                document.getElementById('status-badge').textContent = 'Offline';
                document.getElementById('status-badge').classList.add('offline');
            }
        }

        function updateUptime() {
            if (!serviceStartTime) return;
            const diff = Date.now() - serviceStartTime;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            let uptimeStr;
            if (days > 0) {
                uptimeStr = `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                uptimeStr = `${hours}h ${minutes % 60}m`;
            } else {
                uptimeStr = `${minutes}m ${seconds % 60}s`;
            }
            document.getElementById('headerUptime').textContent = uptimeStr;
        }

        // Update uptime every second
        setInterval(updateUptime, 1000);

        // Initial header status load
        updateHeaderStatus();

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Format Uptime
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        // Format DateTime (ISO to local display)
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('de-CH', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });
            } catch (e) {
                return isoString;
            }
        }

        // Get Regime Display
        function getRegimeDisplay(regime) {
            const displays = {
                'bull_trend': { icon: '&#128200;', name: 'Bull Trend', color: '#4caf50' },
                'bear_trend': { icon: '&#128201;', name: 'Bear Trend', color: '#f44336' },
                'sideways': { icon: '&#8596;', name: 'Sideways', color: '#ffc107' },
                'high_volatility': { icon: '&#9889;', name: 'High Volatility', color: '#ce93d8' }
            };
            return displays[regime] || { icon: '?', name: regime, color: '#888' };
        }

        // Load Service Info
        async function loadInfo() {
            try {
                const [infoRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/info`),
                    fetch(`${API_BASE}/stats`)
                ]);

                if (!infoRes.ok || !statsRes.ok) throw new Error('Failed to load data');

                const info = await infoRes.json();
                const stats = await statsRes.json();

                // Update status badge
                const badge = document.getElementById('status-badge');
                badge.textContent = 'Online';
                badge.className = 'service-badge';

                // Update stats
                document.getElementById('stat-models').textContent = stats.hmm_models_count || 0;
                document.getElementById('stat-features').textContent = info.components?.scorer?.feature_count || 18;
                document.getElementById('stat-uptime').textContent = stats.uptime_seconds ? formatUptime(stats.uptime_seconds) : '-';

                // Service Info
                document.getElementById('service-info').innerHTML = `
                    <table class="data-table">
                        <tr><td style="color: #888;">Service</td><td>${info.service}</td></tr>
                        <tr><td style="color: #888;">Version</td><td>${info.version}</td></tr>
                        <tr><td style="color: #888;">Gestartet</td><td>${new Date(info.started_at).toLocaleString('de-CH')}</td></tr>
                        <tr><td style="color: #888;">HMM Modelle</td><td>${info.components?.hmm?.loaded_models?.length || 0}</td></tr>
                        <tr><td style="color: #888;">Scorer trainiert</td><td>${info.components?.scorer?.fitted ? '<span style="color: #4caf50;">Ja</span>' : '<span style="color: #f44336;">Nein</span>'}</td></tr>
                        <tr><td style="color: #888;">Feature Count</td><td>${info.components?.scorer?.feature_count || 18}</td></tr>
                    </table>
                `;

                // Models List
                const models = info.components?.hmm?.loaded_models || [];
                document.getElementById('models-list').innerHTML = models.length > 0
                    ? `<table class="data-table">
                        <tr><th>Symbol</th><th>Zustande</th><th>Status</th></tr>
                        ${models.map(m => `<tr><td>${m}</td><td>4</td><td><span style="color: #4caf50;">Aktiv</span></td></tr>`).join('')}
                       </table>`
                    : '<div class="info-box">Keine HMM-Modelle geladen. Trainieren Sie Modelle im Training-Tab.</div>';

                // Scorer Status
                document.getElementById('scorer-status').innerHTML = `
                    <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Status:</span>
                            <span style="color: ${info.components?.scorer?.fitted ? '#4caf50' : '#f44336'};">
                                ${info.components?.scorer?.fitted ? 'Trainiert' : 'Nicht trainiert'}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                            <span>Features:</span>
                            <span>${info.components?.scorer?.feature_count || 18}</span>
                        </div>
                    </div>
                `;

            } catch (error) {
                showToast('Fehler beim Laden der Service-Info', 'error');
                console.error(error);
                document.getElementById('status-badge').textContent = 'Offline';
                document.getElementById('status-badge').className = 'service-badge offline';
            }
        }

        // Load Features
        async function loadFeatures() {
            try {
                const response = await fetch(`${API_BASE}/models/features`);
                if (!response.ok) throw new Error('Failed to load features');

                const data = await response.json();
                const container = document.getElementById('feature-list');

                if (data.features && data.features.length > 0) {
                    container.innerHTML = `
                        <div class="grid-3">
                            ${data.features.map(f => `
                                <div style="padding: 0.5rem; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 0.85rem;">
                                    ${f}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="info-box">Feature-Liste nicht verf√ºgbar.</div>';
                }
            } catch (error) {
                document.getElementById('feature-list').innerHTML = '<div class="info-box">Feature-Liste konnte nicht geladen werden.</div>';
            }
        }

        // Detect Regime
        async function detectRegime() {
            const btn = document.getElementById('btn-detect');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const symbol = document.getElementById('detect-symbol').value;
                const timeframe = document.getElementById('detect-timeframe').value;

                const response = await fetch(`${API_BASE}/regime/detect/${symbol}?timeframe=${timeframe}`);
                if (!response.ok) throw new Error('Detection failed');

                const data = await response.json();
                const result = document.getElementById('detection-result');
                // API returns current_regime, not regime
                const currentRegime = data.current_regime || data.regime;
                const regime = getRegimeDisplay(currentRegime);
                // API returns transition_probabilities, not probabilities
                const probabilities = data.transition_probabilities || data.probabilities || {};

                result.innerHTML = `
                    <div class="grid-4" style="margin-bottom: 1rem;">
                        ${['bull_trend', 'bear_trend', 'sideways', 'high_volatility'].map(r => {
                            const d = getRegimeDisplay(r);
                            const prob = probabilities[r] || 0;
                            const isActive = currentRegime === r;
                            return `
                                <div class="regime-card ${r}" style="opacity: ${isActive ? 1 : 0.5};">
                                    <div class="regime-icon">${d.icon}</div>
                                    <div class="regime-name">${d.name}</div>
                                    <div class="regime-probability" style="color: ${d.color};">${(prob * 100).toFixed(1)}%</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="color: #888; margin-bottom: 0.5rem;">Aktuelles Regime</div>
                        <span class="regime-badge ${currentRegime}" style="font-size: 1.1rem;">${regime.icon} ${regime.name}</span>
                        <div style="margin-top: 0.5rem; color: #888; font-size: 0.85rem;">
                            Confidence: ${((data.regime_probability || probabilities[currentRegime] || 0) * 100).toFixed(1)}%
                        </div>
                    </div>
                `;

                showToast(`Regime f√ºr ${symbol} erkannt: ${regime.name}`);
            } catch (error) {
                showToast('Fehler bei der Regime-Erkennung', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Scan All Symbols with Progress
        async function scanAll() {
            const btn = document.getElementById('btn-scan');
            const progressContainer = document.getElementById('scan-progress');
            const progressBar = document.getElementById('scan-progress-bar');
            const progressText = document.getElementById('scan-progress-text');
            const resultsContainer = document.getElementById('scan-results');

            btn.classList.add('btn-loading');
            btn.disabled = true;
            progressContainer.style.display = 'block';
            resultsContainer.innerHTML = '';

            try {
                // 1. Lade alle verf√ºgbaren Symbole
                const symbolsResponse = await fetch('/data/api/v1/managed-symbols');
                if (!symbolsResponse.ok) throw new Error('Failed to load symbols');

                const symbolsData = await symbolsResponse.json();
                const symbols = symbolsData.map(s => s.symbol);

                if (symbols.length === 0) {
                    throw new Error('Keine Symbole verf√ºgbar');
                }

                // 2. Scanne Symbole einzeln mit Fortschrittsanzeige
                const results = [];
                const total = symbols.length;

                for (let i = 0; i < symbols.length; i++) {
                    const symbol = symbols[i];
                    const progress = ((i + 1) / total * 100).toFixed(0);
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${i + 1} / ${total} Symbole (${symbol})`;

                    try {
                        const response = await fetch(`${API_BASE}/regime/detect/${symbol}?timeframe=H1`);
                        if (response.ok) {
                            const data = await response.json();
                            results.push({
                                symbol: symbol,
                                regime: data.current_regime || data.regime,
                                probability: data.regime_probability || 0
                            });
                        }
                    } catch (e) {
                        console.warn(`Failed to scan ${symbol}:`, e);
                    }
                }

                // 3. Zeige Ergebnisse
                if (results.length > 0) {
                    // Sortiere nach Regime f√ºr bessere √úbersicht
                    results.sort((a, b) => a.regime.localeCompare(b.regime));

                    let html = '<table class="data-table"><tr><th>Symbol</th><th>Regime</th><th>Confidence</th></tr>';
                    for (const info of results) {
                        const regime = getRegimeDisplay(info.regime);
                        html += `<tr>
                            <td>${info.symbol}</td>
                            <td><span class="regime-badge ${info.regime}">${regime.icon} ${regime.name}</span></td>
                            <td>${(info.probability * 100).toFixed(1)}%</td>
                        </tr>`;
                    }
                    html += '</table>';
                    resultsContainer.innerHTML = html;
                } else {
                    resultsContainer.innerHTML = '<div class="info-box">Keine Ergebnisse.</div>';
                }

                showToast(`Scan abgeschlossen: ${results.length} Symbole`);
            } catch (error) {
                showToast(`Fehler beim Scan: ${error.message}`, 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        // Load Regime History
        async function loadHistory() {
            const symbol = document.getElementById('history-symbol').value;
            const container = document.getElementById('regime-history');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/regime/history/${symbol}`);
                if (!response.ok) throw new Error('Failed to load history');

                const data = await response.json();
                // API returns "entries" not "history", and "probability" not "confidence"
                const entries = data.entries || data.history || [];

                if (entries.length > 0) {
                    // Show distribution summary
                    const dist = data.regime_distribution || {};
                    const distHtml = Object.entries(dist).map(([r, pct]) => {
                        const d = getRegimeDisplay(r);
                        return `<span style="margin-right: 1rem;"><span class="regime-badge ${r}">${d.icon}</span> ${(pct * 100).toFixed(0)}%</span>`;
                    }).join('');

                    container.innerHTML = `
                        <div style="margin-bottom: 0.75rem; font-size: 0.85rem; color: #888;">
                            Verteilung: ${distHtml}
                        </div>
                        <table class="data-table">
                            <tr><th>Zeitpunkt</th><th>Regime</th><th>Wahrscheinlichkeit</th></tr>
                            ${entries.slice(-20).reverse().map(h => {
                                const regime = getRegimeDisplay(h.regime);
                                const prob = h.probability || h.confidence || 0;
                                // Parse timestamp - handle various formats
                                let timeStr = '-';
                                if (h.timestamp) {
                                    try {
                                        // Try parsing as ISO string or Unix timestamp
                                        let date;
                                        if (typeof h.timestamp === 'number') {
                                            // Unix timestamp (seconds or milliseconds)
                                            date = new Date(h.timestamp > 1e12 ? h.timestamp : h.timestamp * 1000);
                                        } else {
                                            // String format - try direct parse
                                            date = new Date(h.timestamp);
                                        }
                                        if (!isNaN(date.getTime())) {
                                            timeStr = date.toLocaleString('de-CH');
                                        } else {
                                            timeStr = h.timestamp; // Show raw if parse fails
                                        }
                                    } catch (e) {
                                        timeStr = h.timestamp;
                                    }
                                }
                                return `<tr>
                                    <td>${timeStr}</td>
                                    <td><span class="regime-badge ${h.regime}">${regime.icon} ${regime.name}</span></td>
                                    <td>${(prob * 100).toFixed(1)}%</td>
                                </tr>`;
                            }).join('')}
                        </table>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                            ${data.total_count || entries.length} Eintr√§ge insgesamt (zeige letzte 20)
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="info-box">Keine Historie f√ºr dieses Symbol. F√ºhren Sie zuerst einen Scan durch.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="info-box" style="border-color: rgba(244,67,54,0.3); color: #e57373;">Fehler beim Laden.</div>';
            }
        }

        // Calculate Score
        async function calculateScore() {
            const btn = document.getElementById('btn-score');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const symbol = document.getElementById('score-symbol').value;
                const direction = document.getElementById('score-direction').value;
                const timeframe = document.getElementById('score-timeframe').value;

                const response = await fetch(`${API_BASE}/scoring/score/${symbol}?direction=${direction}&timeframe=${timeframe}`);
                if (!response.ok) throw new Error('Scoring failed');

                const data = await response.json();
                const scoreEl = document.getElementById('score-value');
                const detailsEl = document.getElementById('score-details');

                const score = data.score || 0;
                scoreEl.textContent = score.toFixed(1);
                scoreEl.className = `score-value ${score >= 60 ? 'positive' : score <= 40 ? 'negative' : 'neutral'}`;

                detailsEl.innerHTML = `
                    <div>Richtung: ${direction.toUpperCase()}</div>
                    <div>Regime: ${data.regime || '-'}</div>
                    ${data.recommendation ? `<div style="margin-top: 0.5rem; color: ${score >= 60 ? '#4caf50' : '#f44336'};">${data.recommendation}</div>` : ''}
                `;

                showToast(`Score berechnet: ${score.toFixed(1)}`);
            } catch (error) {
                showToast('Fehler bei der Score-Berechnung', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Check Alignment
        async function checkAlignment() {
            const symbol = document.getElementById('align-symbol').value;
            const container = document.getElementById('alignment-result');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/scoring/alignment-check/${symbol}`);
                if (!response.ok) throw new Error('Alignment check failed');

                const data = await response.json();

                container.innerHTML = `
                    <div class="grid-3" style="margin-top: 1rem;">
                        ${Object.entries(data.timeframes || {}).map(([tf, info]) => {
                            const regime = getRegimeDisplay(info.regime);
                            return `
                                <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${tf}</div>
                                    <span class="regime-badge ${info.regime}">${regime.icon} ${regime.name}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center;">
                        <div style="color: #888; margin-bottom: 0.5rem;">Alignment Score</div>
                        <div style="font-size: 2rem; font-weight: 700; color: ${data.alignment_score >= 0.7 ? '#4caf50' : data.alignment_score >= 0.4 ? '#ffc107' : '#f44336'};">
                            ${((data.alignment_score || 0) * 100).toFixed(0)}%
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div class="info-box" style="border-color: rgba(244,67,54,0.3); color: #e57373;">Fehler beim Alignment Check.</div>';
            }
        }

        // Train HMM
        async function trainHMM() {
            const btn = document.getElementById('btn-train-hmm');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const symbol = document.getElementById('train-symbol').value;
                const days = parseInt(document.getElementById('train-days').value);
                const states = parseInt(document.getElementById('train-states').value);

                const response = await fetch(`${API_BASE}/train/hmm/${symbol}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days, n_states: states })
                });

                if (!response.ok) throw new Error('Training failed');

                const data = await response.json();
                document.getElementById('hmm-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(76,175,80,0.3); color: #81c784;">
                        HMM-Modell f√ºr ${symbol} erfolgreich trainiert!
                    </div>
                `;

                showToast(`HMM f√ºr ${symbol} trainiert`);
                loadInfo();
            } catch (error) {
                document.getElementById('hmm-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(244,67,54,0.3); color: #e57373;">
                        Fehler beim Training: ${error.message}
                    </div>
                `;
                showToast('Fehler beim HMM Training', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Train Scorer
        async function trainScorer() {
            const btn = document.getElementById('btn-train-scorer');
            const originalText = btn.innerHTML;

            btn.classList.add('btn-loading');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Training l√§uft...';

            try {
                const response = await fetch(`${TRAIN_API_BASE}/train/scorer`, { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Training failed');
                }

                const result = await response.json();

                // Warte auf Training-Abschluss (Polling)
                let attempts = 0;
                const maxAttempts = 30; // 30 Sekunden max

                while (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    const statusRes = await fetch(`${TRAIN_API_BASE}/train/status`);
                    const status = await statusRes.json();

                    if (!status.current_job || status.status === 'idle') {
                        // Training abgeschlossen
                        btn.innerHTML = '‚úÖ Erfolgreich trainiert!';
                        showToast(`Scorer erfolgreich trainiert (Job: ${result.job_id})`, 'success');
                        await loadInfo();

                        // Zur√ºcksetzen nach 3 Sekunden
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 3000);
                        break;
                    }

                    attempts++;
                }

                if (attempts >= maxAttempts) {
                    btn.innerHTML = '‚ö†Ô∏è Training l√§uft noch...';
                    showToast('Training l√§uft im Hintergrund weiter', 'info');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 3000);
                }

            } catch (error) {
                btn.innerHTML = '‚ùå Training fehlgeschlagen';
                showToast(`Fehler beim Scorer Training: ${error.message}`, 'error');
                console.error('Scorer training error:', error);

                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 3000);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // ==================== Validation Tab Functions ====================

        // Load Validation Status
        async function loadValidationStatus() {
            const container = document.getElementById('validation-status');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/stats`);
                if (!response.ok) throw new Error('Failed to load validation status');

                const data = await response.json();

                if (!data.validation_enabled) {
                    container.innerHTML = `
                        <div class="info-box" style="background: rgba(255, 152, 0, 0.1); border-color: rgba(255, 152, 0, 0.3); color: #ffb74d;">
                            <strong>Validierung deaktiviert:</strong> ${data.message || 'Die Validierungs-Pipeline ist nicht aktiviert.'}
                        </div>
                    `;
                    return;
                }

                const registry = data.registry || {};
                const deployment = data.deployment || {};

                container.innerHTML = `
                    <div class="grid-4">
                        <div class="stat-item">
                            <div class="stat-value" style="color: #4caf50;">${registry.total_versions || 0}</div>
                            <div class="stat-label">Versionen gesamt</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #64c8ff;">${registry.production_count || 0}</div>
                            <div class="stat-label">In Produktion</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #4caf50;">${deployment.deployed_count || 0}</div>
                            <div class="stat-label">Deployed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #f44336;">${deployment.rejected_count || 0}</div>
                            <div class="stat-label">Abgelehnt</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: #888;">Validierung:</span>
                            <span style="color: #4caf50;">&#10004; Aktiviert</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">Versions-Limit:</span>
                            <span>${registry.keep_versions || 5} Versionen</span>
                        </div>
                    </div>
                `;

                // Also load other sections
                loadProductionModels();
                loadRegistryStats();
                loadModelVersions();
                loadDeploymentHistory();
                loadSymbolsForValidation();

            } catch (error) {
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(244, 67, 54, 0.1); border-color: rgba(244, 67, 54, 0.3); color: #e57373;">
                        Fehler beim Laden: ${error.message}
                    </div>
                `;
            }
        }

        // Load Production Models
        async function loadProductionModels() {
            const container = document.getElementById('production-models');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/production`);
                if (!response.ok) throw new Error('Failed to load production models');

                const data = await response.json();
                const models = data.production_models || {};

                if (Object.keys(models).length === 0) {
                    container.innerHTML = '<div class="info-box">Keine Produktions-Modelle vorhanden.</div>';
                    return;
                }

                let html = '<table class="data-table"><tr><th>Modell</th><th>Version</th><th>Status</th><th>Deployed</th></tr>';
                for (const [key, model] of Object.entries(models)) {
                    const deployedAt = model.promoted_at ? new Date(model.promoted_at).toLocaleString('de-CH') : '-';
                    html += `
                        <tr>
                            <td><strong>${key}</strong></td>
                            <td><code style="background: rgba(100,200,255,0.1); padding: 0.2rem 0.4rem; border-radius: 4px;">${model.version_id || '-'}</code></td>
                            <td><span style="color: #4caf50;">&#10004; ${model.status || 'production'}</span></td>
                            <td style="color: #888; font-size: 0.85rem;">${deployedAt}</td>
                        </tr>
                    `;
                }
                html += '</table>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
            }
        }

        // Load Registry Stats
        async function loadRegistryStats() {
            const container = document.getElementById('registry-stats');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/stats`);
                if (!response.ok) throw new Error('Failed to load stats');

                const data = await response.json();
                const registry = data.registry || {};
                const deployment = data.deployment || {};

                container.innerHTML = `
                    <table class="data-table">
                        <tr><td style="color: #888;">Validierung aktiv</td><td>${data.validation_enabled ? '<span style="color: #4caf50;">Ja</span>' : '<span style="color: #f44336;">Nein</span>'}</td></tr>
                        <tr><td style="color: #888;">Versionen gesamt</td><td>${registry.total_versions || 0}</td></tr>
                        <tr><td style="color: #888;">In Produktion</td><td>${registry.production_count || 0}</td></tr>
                        <tr><td style="color: #888;">Archiviert</td><td>${registry.archived_count || 0}</td></tr>
                        <tr><td style="color: #888;">Deployed</td><td style="color: #4caf50;">${deployment.deployed_count || 0}</td></tr>
                        <tr><td style="color: #888;">Abgelehnt</td><td style="color: #f44336;">${deployment.rejected_count || 0}</td></tr>
                        <tr><td style="color: #888;">Rollbacks</td><td style="color: #ffb74d;">${deployment.rollback_count || 0}</td></tr>
                    </table>
                `;
            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
            }
        }

        // Load Model Versions
        async function loadModelVersions() {
            const container = document.getElementById('model-versions');
            const typeFilter = document.getElementById('version-filter-type').value;
            const symbolFilter = document.getElementById('version-filter-symbol').value;

            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                let url = `${TRAIN_API_BASE}/models/versions?limit=20`;
                if (typeFilter) url += `&model_type=${typeFilter}`;
                if (symbolFilter) url += `&symbol=${symbolFilter}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load versions');

                const data = await response.json();
                const versions = data.versions || [];

                // Populate version dropdowns
                populateVersionDropdowns(versions);

                if (versions.length === 0) {
                    container.innerHTML = '<div class="info-box">Keine Versionen gefunden.</div>';
                    return;
                }

                let html = `
                    <table class="data-table">
                        <tr>
                            <th>Version</th>
                            <th>Typ</th>
                            <th>Symbol</th>
                            <th>Status</th>
                            <th>Metriken</th>
                            <th>Erstellt</th>
                        </tr>
                `;

                for (const v of versions) {
                    const statusColor = getStatusColor(v.status);
                    const metrics = v.validation_metrics || {};
                    const metricsDisplay = Object.entries(metrics).slice(0, 2).map(([k, val]) =>
                        `${k}: ${typeof val === 'number' ? (val * 100).toFixed(1) + '%' : val}`
                    ).join(', ') || '-';

                    html += `
                        <tr>
                            <td><code style="background: rgba(100,200,255,0.1); padding: 0.2rem 0.4rem; border-radius: 4px;">${v.version_id || '-'}</code></td>
                            <td>${v.model_type || '-'}</td>
                            <td>${v.symbol || '-'}</td>
                            <td><span style="color: ${statusColor};">${getStatusIcon(v.status)} ${v.status || '-'}</span></td>
                            <td style="font-size: 0.8rem; color: #888;">${metricsDisplay}</td>
                            <td style="color: #888; font-size: 0.85rem;">${v.created_at ? new Date(v.created_at).toLocaleString('de-CH') : '-'}</td>
                        </tr>
                    `;
                }

                html += '</table>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
            }
        }

        // Load Deployment History
        async function loadDeploymentHistory() {
            const container = document.getElementById('deployment-history');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/deployment-history?limit=20`);
                if (!response.ok) throw new Error('Failed to load history');

                const data = await response.json();
                const history = data.history || [];

                if (history.length === 0) {
                    container.innerHTML = '<div class="info-box">Keine Deployment-Historie vorhanden.</div>';
                    return;
                }

                let html = `
                    <table class="data-table">
                        <tr>
                            <th>Zeitpunkt</th>
                            <th>Modell</th>
                            <th>Aktion</th>
                            <th>Grund</th>
                        </tr>
                `;

                for (const d of history) {
                    const actionColor = d.action === 'deployed' ? '#4caf50' : d.action === 'rejected' ? '#f44336' : '#ffb74d';
                    const modelName = d.symbol ? `${d.model_type}/${d.symbol}` : d.model_type;

                    html += `
                        <tr>
                            <td style="color: #888; font-size: 0.85rem;">${d.timestamp ? new Date(d.timestamp).toLocaleString('de-CH') : '-'}</td>
                            <td>${modelName || '-'}</td>
                            <td><span style="color: ${actionColor}; font-weight: 500;">${d.action || '-'}</span></td>
                            <td style="font-size: 0.85rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${d.reason || '-'}</td>
                        </tr>
                    `;
                }

                html += '</table>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
            }
        }

        // Load symbols for validation dropdowns
        async function loadSymbolsForValidation() {
            try {
                const response = await fetch('/data/api/v1/managed-symbols');
                if (!response.ok) return;

                const symbols = await response.json();
                const symbolList = symbols.map(s => s.symbol);

                // Populate all symbol dropdowns in validation tab
                const dropdowns = ['version-filter-symbol', 'force-deploy-symbol', 'rollback-symbol', 'reload-symbol'];
                for (const id of dropdowns) {
                    const select = document.getElementById(id);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">- Alle/Keine -</option>';
                        for (const symbol of symbolList) {
                            select.innerHTML += `<option value="${symbol}">${symbol}</option>`;
                        }
                        if (currentValue) select.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Failed to load symbols:', error);
            }
        }

        // Populate version dropdowns
        function populateVersionDropdowns(versions) {
            const forceDeploySelect = document.getElementById('force-deploy-version');
            const rollbackSelect = document.getElementById('rollback-version');

            if (forceDeploySelect) {
                forceDeploySelect.innerHTML = '<option value="">Version w√§hlen...</option>';
                for (const v of versions) {
                    forceDeploySelect.innerHTML += `<option value="${v.version_id}">${v.version_id} (${v.model_type}${v.symbol ? '/' + v.symbol : ''} - ${v.status})</option>`;
                }
            }

            if (rollbackSelect) {
                rollbackSelect.innerHTML = '<option value="">Version w√§hlen...</option>';
                for (const v of versions) {
                    if (v.status !== 'rejected') {
                        rollbackSelect.innerHTML += `<option value="${v.version_id}">${v.version_id} (${v.model_type}${v.symbol ? '/' + v.symbol : ''} - ${v.status})</option>`;
                    }
                }
            }
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'production': '#4caf50',
                'candidate': '#64c8ff',
                'archived': '#888',
                'rejected': '#f44336'
            };
            return colors[status] || '#888';
        }

        function getStatusIcon(status) {
            const icons = {
                'production': '&#10004;',
                'candidate': '&#9881;',
                'archived': '&#128230;',
                'rejected': '&#10060;'
            };
            return icons[status] || '';
        }

        // Force Deploy
        async function forceDeploy() {
            const btn = document.getElementById('btn-force-deploy');
            const versionId = document.getElementById('force-deploy-version').value;
            const modelType = document.getElementById('force-deploy-type').value;
            const symbol = document.getElementById('force-deploy-symbol').value || null;
            const reason = document.getElementById('force-deploy-reason').value || 'Manual deployment via UI';

            if (!versionId) {
                showToast('Bitte Version ausw√§hlen', 'error');
                return;
            }

            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/force-deploy/${versionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: modelType,
                        symbol: symbol,
                        reason: reason
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Force deploy failed');
                }

                const data = await response.json();
                showToast(`Version ${versionId} erfolgreich deployed!`, 'success');
                loadValidationStatus();

            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Rollback Model
        async function rollbackModel() {
            const btn = document.getElementById('btn-rollback');
            const modelType = document.getElementById('rollback-type').value;
            const symbol = document.getElementById('rollback-symbol').value || null;
            const targetVersion = document.getElementById('rollback-version').value;
            const reason = document.getElementById('rollback-reason').value || 'Manual rollback via UI';

            if (!targetVersion) {
                showToast('Bitte Ziel-Version ausw√§hlen', 'error');
                return;
            }

            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: modelType,
                        symbol: symbol,
                        target_version: targetVersion,
                        reason: reason
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Rollback failed');
                }

                const data = await response.json();
                showToast(`Rollback zu ${targetVersion} erfolgreich!`, 'success');
                loadValidationStatus();

            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Reload All Models
        async function reloadAllModels() {
            const container = document.getElementById('reload-result');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/model/reload-all`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Reload failed');

                const data = await response.json();
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); color: #81c784;">
                        &#10004; Alle Modelle neu geladen!<br>
                        HMM-Caches geleert: ${(data.hmm_models_cleared || []).join(', ') || 'keine'}<br>
                        Scorer neu geladen: ${data.scorer_reloaded ? 'Ja' : 'Nein'}
                    </div>
                `;
                showToast('Alle Modelle neu geladen', 'success');
                loadInfo();

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Reload HMM Model
        async function reloadHMMModel() {
            const symbol = document.getElementById('reload-symbol').value;
            if (!symbol) {
                showToast('Bitte Symbol ausw√§hlen', 'error');
                return;
            }

            const container = document.getElementById('reload-result');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/model/reload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'hmm',
                        symbol: symbol
                    })
                });

                if (!response.ok) throw new Error('Reload failed');

                const data = await response.json();
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); color: #81c784;">
                        &#10004; HMM-Modell f√ºr ${symbol} neu geladen!<br>
                        Status: ${data.status}<br>
                        Modell geladen: ${data.model_loaded ? 'Ja' : 'Nein'}
                    </div>
                `;
                showToast(`HMM f√ºr ${symbol} neu geladen`, 'success');
                loadInfo();

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Reload Scorer
        async function reloadScorer() {
            const container = document.getElementById('reload-result');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/model/reload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'scorer'
                    })
                });

                if (!response.ok) throw new Error('Reload failed');

                const data = await response.json();
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); color: #81c784;">
                        &#10004; Scorer neu geladen!<br>
                        Status: ${data.status}<br>
                        Pfad: ${data.path || '-'}<br>
                        Fitted: ${data.is_fitted ? 'Ja' : 'Nein'}
                    </div>
                `;
                showToast('Scorer neu geladen', 'success');
                loadInfo();

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // ==================== Scheduling Functions ====================

        async function loadSchedulerStatus() {
            const statusContainer = document.getElementById('scheduler-status');
            const listContainer = document.getElementById('schedule-list');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules`);
                const data = await response.json();

                // Status display
                const status = data.scheduler_status || {};
                statusContainer.innerHTML = `
                    <div class="grid-2-equal" style="margin-bottom: 1rem;">
                        <div class="stat-item">
                            <span class="stat-label">Scheduler</span>
                            <span class="stat-value">${status.running ? '&#9989; Aktiv' : '&#10060; Inaktiv'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Schedules</span>
                            <span class="stat-value">${status.active_schedules || 0} / ${status.total_schedules || 0}</span>
                        </div>
                    </div>
                    ${status.next_scheduled_run ? `
                        <div class="info-box">
                            <strong>N√§chster geplanter Lauf:</strong><br>
                            Schedule: ${status.next_scheduled_run.schedule_id}<br>
                            Zeit: ${formatDateTime(status.next_scheduled_run.next_run)}<br>
                            Intervall: ${formatInterval(status.next_scheduled_run.interval)}
                        </div>
                    ` : '<div class="info-box">Keine aktiven Schedules</div>'}
                `;

                // Schedule list
                const schedules = data.schedules || [];
                if (schedules.length === 0) {
                    listContainer.innerHTML = `
                        <div class="info-box">
                            Keine Schedules konfiguriert. Erstellen Sie einen neuen Schedule rechts.
                        </div>
                    `;
                } else {
                    listContainer.innerHTML = schedules.map(s => `
                        <div class="version-card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <strong>${s.schedule_id}</strong>
                                    <span class="status-badge ${s.enabled ? 'status-deployed' : 'status-rejected'}">
                                        ${s.enabled ? 'Aktiv' : 'Inaktiv'}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm ${s.enabled ? 'btn-warning' : 'btn-success'}"
                                            onclick="toggleSchedule('${s.schedule_id}', ${!s.enabled})">
                                        ${s.enabled ? '&#10074;&#10074; Pause' : '&#9658; Start'}
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="triggerSchedule('${s.schedule_id}')">
                                        &#9658; Jetzt
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${s.schedule_id}')">
                                        &#128465;
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #aaa;">
                                <div><strong>Intervall:</strong> ${formatInterval(s.interval)}</div>
                                <div><strong>Modelle:</strong> ${s.train_hmm ? 'HMM' : ''} ${s.train_scorer ? 'Scorer' : ''}</div>
                                <div><strong>Timeframe:</strong> ${s.timeframe}</div>
                                <div><strong>Lookback:</strong> ${s.lookback_days} Tage</div>
                                <div><strong>Symbole:</strong> ${s.symbols ? s.symbols.join(', ') : 'Alle'}</div>
                                ${s.next_run ? `<div><strong>N√§chster Lauf:</strong> ${formatDateTime(s.next_run)}</div>` : ''}
                                ${s.last_run ? `<div><strong>Letzter Lauf:</strong> ${formatDateTime(s.last_run)} (${s.last_status || 'unbekannt'})</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                statusContainer.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                listContainer.innerHTML = '';
            }
        }

        function formatInterval(interval) {
            const intervals = {
                'hourly': 'St√ºndlich',
                'daily': 'T√§glich',
                'weekly': 'W√∂chentlich'
            };
            return intervals[interval] || interval;
        }

        async function createSchedule() {
            const interval = document.getElementById('schedule-interval').value;
            const hour = parseInt(document.getElementById('schedule-hour').value);
            const weekday = parseInt(document.getElementById('schedule-weekday').value);
            const timeframe = document.getElementById('schedule-timeframe').value;
            const lookback = parseInt(document.getElementById('schedule-lookback').value);
            const trainHmm = document.getElementById('schedule-train-hmm').checked;
            const trainScorer = document.getElementById('schedule-train-scorer').checked;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interval: interval,
                        custom_hour: hour,
                        custom_weekday: weekday,
                        timeframe: timeframe,
                        lookback_days: lookback,
                        train_hmm: trainHmm,
                        train_scorer: trainScorer,
                        symbols: null,  // null = all symbols
                        enabled: true
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showToast('Schedule erstellt', 'success');
                    loadSchedulerStatus();
                } else {
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function toggleSchedule(scheduleId, enabled) {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules/${scheduleId}/toggle?enabled=${enabled}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    showToast(`Schedule ${enabled ? 'aktiviert' : 'pausiert'}`, 'success');
                    loadSchedulerStatus();
                } else {
                    const data = await response.json();
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function triggerSchedule(scheduleId) {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules/${scheduleId}/trigger`, {
                    method: 'POST'
                });
                if (response.ok) {
                    showToast('Training wird innerhalb 1 Minute gestartet', 'success');
                } else {
                    const data = await response.json();
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm(`Schedule "${scheduleId}" wirklich l√∂schen?`)) return;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    showToast('Schedule gel√∂scht', 'success');
                    loadSchedulerStatus();
                } else {
                    const data = await response.json();
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Show/hide weekday selector based on interval
        document.addEventListener('DOMContentLoaded', () => {
            const intervalSelect = document.getElementById('schedule-interval');
            if (intervalSelect) {
                intervalSelect.addEventListener('change', () => {
                    const weekdayGroup = document.getElementById('weekday-group');
                    weekdayGroup.style.display = intervalSelect.value === 'weekly' ? 'block' : 'none';
                });
            }
        });

        // Load all symbols from Data Service and populate dropdowns
        async function loadAllSymbols() {
            try {
                const response = await fetch('/data/api/v1/db/coverage');
                if (!response.ok) throw new Error('Failed to load symbols');

                const data = await response.json();
                const categories = data.categories || {};

                // Build grouped options HTML
                const order = ['Krypto', 'Forex', 'Indizes', 'Rohstoffe', 'Aktien', 'Andere'];
                let optionsHtml = '';

                for (const category of order) {
                    const symbols = categories[category];
                    if (symbols && symbols.length > 0) {
                        optionsHtml += `<optgroup label="${category} (${symbols.length})">`;
                        for (const symbol of symbols) {
                            optionsHtml += `<option value="${symbol}">${symbol}</option>`;
                        }
                        optionsHtml += '</optgroup>';
                    }
                }

                // Populate all symbol dropdowns
                const dropdownIds = ['detect-symbol', 'score-symbol', 'history-symbol', 'reload-symbol', 'force-deploy-symbol', 'rollback-symbol'];
                for (const id of dropdownIds) {
                    const dropdown = document.getElementById(id);
                    if (dropdown) {
                        const currentValue = dropdown.value;
                        dropdown.innerHTML = optionsHtml;
                        // Restore previous selection or default to BTCUSD
                        if (currentValue && dropdown.querySelector(`option[value="${currentValue}"]`)) {
                            dropdown.value = currentValue;
                        } else if (dropdown.querySelector('option[value="BTCUSD"]')) {
                            dropdown.value = 'BTCUSD';
                        }
                    }
                }

                // Also populate version filter dropdown
                const versionFilterSymbol = document.getElementById('version-filter-symbol');
                if (versionFilterSymbol) {
                    versionFilterSymbol.innerHTML = '<option value="">Alle Symbole</option>' + optionsHtml;
                }

                console.log(`Loaded ${Object.values(categories).flat().length} symbols from Data Service`);
            } catch (error) {
                console.warn('Could not load symbols from Data Service:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInfo();
            loadFeatures();
            loadAllSymbols();  // Load symbols for dropdowns

            // Auto-refresh every 30 seconds
            setInterval(loadInfo, 30000);

            // Load validation status when tab is shown
            const validationTabBtn = document.querySelector('.tab-btn:nth-child(5)');
            if (validationTabBtn) {
                validationTabBtn.addEventListener('click', () => {
                    loadValidationStatus();
                });
            }

            // Load scheduler status when tab is shown
            const schedulingTabBtn = document.querySelector('.tab-btn:nth-child(6)');
            if (schedulingTabBtn) {
                schedulingTabBtn.addEventListener('click', () => {
                    loadSchedulerStatus();
                });
            }
        });
    </script>
</body>
</html>
