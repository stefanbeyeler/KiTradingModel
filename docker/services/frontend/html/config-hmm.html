<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMM Regime Service - Konfiguration</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .service-badge {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .service-badge.offline {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #a0a0a0;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
        }

        .tab-btn.active {
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
            border-bottom: 2px solid #64c8ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card - Compact */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .card-title {
            font-size: 1rem;
            color: #64c8ff;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Stats Bar - Compact */
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #64c8ff;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Progress Bar */
        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            height: 8px;
            margin: 0.75rem 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #64c8ff, #4caf50);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 0.25rem;
        }

        /* Buttons - Compact */
        .btn {
            padding: 0.4rem 0.9rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-primary {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .btn-success {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .btn-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .btn-warning:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            top: 50%;
            right: 8px;
            margin-top: -6px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .grid-2-equal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .grid-2, .grid-2-equal, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Regime Badge */
        .regime-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            margin: 0.2rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .regime-badge.bull_trend {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .regime-badge.bear_trend {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .regime-badge.sideways {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .regime-badge.high_volatility {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
            border: 1px solid rgba(156, 39, 176, 0.3);
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            color: #888;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #4caf50;
        }

        .toast.error {
            border-left: 4px solid #f44336;
        }

        .toast.info {
            border-left: 4px solid #2196f3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: #888;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(100, 200, 255, 0.2);
            border-top-color: #64c8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Form Elements - Compact */
        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: #aaa;
            font-size: 0.8rem;
        }

        .form-control {
            width: 100%;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e8e8e8;
            font-size: 0.85rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #64c8ff;
        }

        select.form-control {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364c8ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* Select dropdown styling for better contrast */
        select.form-control {
            background-color: #1a1a2e;
            color: #e8e8e8;
        }

        select.form-control option {
            background-color: #1e2740;
            color: #e8e8e8;
            padding: 10px 12px;
        }

        select.form-control optgroup {
            background-color: #0d1520;
            color: #64c8ff;
            font-weight: 700;
            font-style: normal;
        }

        select.form-control optgroup option {
            background-color: #1e2740;
            color: #d0d0d0;
            font-weight: 400;
            padding-left: 16px;
        }

        select.form-control option:checked {
            background-color: #3a5080;
            color: #ffffff;
        }

        select.form-control option:hover,
        select.form-control option:focus {
            background-color: #2a4060;
            color: #64c8ff;
        }

        /* Info Box */
        .info-box {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
            color: #90caf9;
        }

        /* Score Display */
        .score-display {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }

        .score-value {
            font-size: 3rem;
            font-weight: 700;
        }

        .score-value.positive { color: #4caf50; }
        .score-value.negative { color: #f44336; }
        .score-value.neutral { color: #ffc107; }

        /* Regime Card */
        .regime-card {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.2s;
        }

        .regime-card:hover {
            transform: translateY(-2px);
        }

        .regime-card.bull_trend { background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.2); }
        .regime-card.bear_trend { background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.2); }
        .regime-card.sideways { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2); }
        .regime-card.high_volatility { background: rgba(156, 39, 176, 0.1); border: 1px solid rgba(156, 39, 176, 0.2); }

        .regime-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .regime-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .regime-probability {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Collapsible sections */
        .collapsible-header {
            transition: background-color 0.2s;
        }
        .collapsible-header:hover {
            background-color: rgba(100, 200, 255, 0.05);
        }
        .collapse-icon {
            display: inline-block;
            width: 1rem;
            font-size: 0.7rem;
            margin-right: 0.3rem;
            color: #64c8ff;
        }
        .collapsible-content {
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* Architecture Diagram - Collapsible */
        .architecture-diagram {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin: 1rem 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            overflow-x: auto;
            color: #e8e8e8;
        }

        .architecture-diagram summary {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: #64c8ff;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .architecture-diagram summary::-webkit-details-marker {
            display: none;
        }

        .architecture-diagram summary::before {
            content: '‚ñ∂';
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .architecture-diagram[open] summary::before {
            transform: rotate(90deg);
        }

        .architecture-diagram .diagram-content {
            padding: 0 1rem 1rem 1rem;
        }

        .architecture-diagram pre {
            margin: 0;
            white-space: pre;
        }

        /* Self-Learning specific styles */
        .btn-purple {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            color: white;
        }

        .btn-purple:hover {
            background: linear-gradient(135deg, #6d28d9, #7c3aed);
        }
    </style>
</head>
<body>
    <header>
        <div class="container" style="flex-direction: column; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <a href="index.html" class="back-link">‚Üê Dashboard</a>
                <h1 class="header-title">üìä HMM Regime Service</h1>
                <span class="service-badge" id="status-badge">Laden...</span>
            </div>
            <!-- Compact Header Status Bar -->
            <div style="display: flex; gap: 1.5rem; align-items: center; flex-wrap: wrap; font-size: 0.85rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Service-Status">
                    <span>‚è≥</span>
                    <span style="color: #888;">Status:</span>
                    <strong id="headerStatus" style="color: #4caf50;">L√§dt...</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Service-Version">
                    <span>üì¶</span>
                    <span style="color: #888;">Version:</span>
                    <strong id="headerVersion" style="color: #64c8ff;">-</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Anzahl HMM Modelle">
                    <span>üß†</span>
                    <span style="color: #888;">Modelle:</span>
                    <strong id="headerModels" style="color: #64c8ff;">-</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Anzahl Regime-Typen">
                    <span>üìà</span>
                    <span style="color: #888;">Regimes:</span>
                    <strong id="headerRegimes" style="color: #64c8ff;">4</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Anzahl Features">
                    <span>‚öôÔ∏è</span>
                    <span style="color: #888;">Features:</span>
                    <strong id="headerFeatures" style="color: #64c8ff;">-</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem;" title="Zeit seit Service-Start">
                    <span>üïê</span>
                    <span style="color: #888;">Uptime:</span>
                    <strong id="headerUptime" style="color: #64c8ff;">-</strong>
                </div>
                <button class="btn btn-primary" onclick="updateHeaderStatus()" style="margin-left: auto; padding: 0.3rem 0.6rem; font-size: 0.8rem;">‚Üª</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Bar -->
        <div class="stats-bar" id="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="stat-models">-</div>
                <div class="stat-label">HMM Modelle</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-regimes">4</div>
                <div class="stat-label">Regime-Typen</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-features">-</div>
                <div class="stat-label">Features</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-uptime">-</div>
                <div class="stat-label">Uptime</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('overview')">&#128200; √úbersicht</button>
            <button class="tab-btn" onclick="showTab('detection')">&#128269; Regime-Erkennung</button>
            <button class="tab-btn" onclick="showTab('scoring')">&#127919; Trade Scoring</button>
            <button class="tab-btn" onclick="showTab('training')">&#9881; Training</button>
            <button class="tab-btn" onclick="showTab('validation')">&#128203; Validierung</button>
            <button class="tab-btn" onclick="showTab('selflearning')">&#129302; Self-Learning</button>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content active">
            <!-- Compact Service Info + Regime Types -->
            <div class="card" style="padding: 0.75rem;">
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between;">
                    <!-- Service Info (inline) -->
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;" id="service-info-compact">
                        <span style="font-weight: 600; color: #64c8ff;">&#129302; hmm-regime</span>
                        <span style="color: #888;">v<span id="info-version">-</span></span>
                        <span><span style="color: #888;">Modelle:</span> <strong id="info-models" style="color: #4caf50;">-</strong></span>
                        <span><span style="color: #888;">Scorer:</span> <strong id="info-scorer" style="color: #4caf50;">-</strong></span>
                        <span><span style="color: #888;">Features:</span> <strong id="info-features" style="color: #64c8ff;">18</strong></span>
                        <span><span style="color: #888;">Uptime:</span> <span id="info-uptime" style="color: #888;">-</span></span>
                    </div>
                    <!-- Regime Types (inline badges) -->
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="background: linear-gradient(135deg, #1b5e20, #2e7d32); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;" title="Aufw√§rtstrend">&#128200; Bull</span>
                        <span style="background: linear-gradient(135deg, #b71c1c, #c62828); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;" title="Abw√§rtstrend">&#128201; Bear</span>
                        <span style="background: linear-gradient(135deg, #37474f, #455a64); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;" title="Seitw√§rtsbewegung">&#8596; Sideways</span>
                        <span style="background: linear-gradient(135deg, #e65100, #f57c00); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;" title="Hohe Volatilit√§t">&#9889; HighVol</span>
                        <button class="btn btn-primary btn-sm" onclick="loadInfo()" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; margin-left: 0.5rem;">&#8635;</button>
                    </div>
                </div>
            </div>

            <!-- Learning Progress Chart -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128200; Lernfortschritt</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select class="form-control" id="metrics-model-type" style="padding: 0.25rem; font-size: 0.85rem; width: auto;" onchange="loadMetricsHistory()">
                            <option value="hmm">HMM Modelle</option>
                            <option value="scorer">Scorer</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadMetricsHistory()" style="padding: 0.25rem 0.5rem;">&#8635;</button>
                    </div>
                </div>
                <div style="position: relative; height: 200px; padding: 0.5rem;">
                    <canvas id="metrics-chart"></canvas>
                </div>
                <div id="metrics-summary" style="padding: 0.5rem 1rem; font-size: 0.8rem; color: #888; border-top: 1px solid rgba(255,255,255,0.05);"></div>
            </div>

            <!-- Models Overview -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Geladene Modelle</h3>
                </div>
                <div id="models-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Detection Tab -->
        <div id="tab-detection" class="tab-content">
            <!-- Combined Detection Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128269; Regime-Erkennung</h3>
                </div>
                <!-- Single row with all controls -->
                <div style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
                    <!-- Single Symbol Detection -->
                    <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                        <label style="font-size: 0.75rem;">Symbol</label>
                        <select class="form-control" id="detect-symbol">
                            <option value="BTCUSD">Lade Symbole...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0; min-width: 80px;">
                        <label style="font-size: 0.75rem;">Timeframe</label>
                        <select class="form-control" id="detect-timeframe">
                            <option value="M15">M15</option>
                            <option value="H1" selected>H1</option>
                            <option value="H4">H4</option>
                            <option value="D1">D1</option>
                        </select>
                    </div>
                    <button class="btn btn-success" id="btn-detect" onclick="detectRegime()" style="white-space: nowrap;">&#128269; Erkennen</button>

                    <!-- Separator -->
                    <div style="width: 1px; height: 32px; background: rgba(255,255,255,0.2); margin: 0 0.5rem;"></div>

                    <!-- Multi-Symbol Scan -->
                    <button class="btn btn-primary" id="btn-scan" onclick="scanAll()" style="white-space: nowrap;">&#128640; Alle scannen</button>
                    <div id="scan-progress" style="display: none; min-width: 120px;">
                        <div class="progress-container" style="margin-bottom: 0.25rem;">
                            <div class="progress-bar" id="scan-progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="progress-text" id="scan-progress-text" style="font-size: 0.75rem;">0 / 0</div>
                    </div>
                </div>

                <!-- Detection Result (single symbol) -->
                <div id="detection-result" style="margin-top: 0.75rem;"></div>

                <!-- Scan Results (multi-symbol) -->
                <div id="scan-results" style="margin-top: 0.75rem; max-height: 400px; overflow-y: auto;"></div>
            </div>

            <!-- Regime History -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Regime-Verlauf</h3>
                    <div>
                        <select class="form-control" id="history-symbol" style="width: auto; display: inline-block;">
                            <option value="BTCUSD">Lade Symbole...</option>
                        </select>
                        <select class="form-control" id="history-timeframe" style="width: auto; display: inline-block;" onchange="loadHistory()">
                            <option value="M15">M15</option>
                            <option value="H1" selected>H1</option>
                            <option value="H4">H4</option>
                            <option value="D1">D1</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadHistory()">&#8635; Laden</button>
                    </div>
                </div>
                <div id="regime-history">
                    <div class="info-box">W√§hlen Sie ein Symbol und Timeframe und klicken Sie auf "Laden".</div>
                </div>
            </div>
        </div>

        <!-- Scoring Tab -->
        <div id="tab-scoring" class="tab-content">
            <!-- Kompakte 2-Spalten-Ansicht -->
            <div class="grid-2">
                <!-- Trade Score berechnen -->
                <div class="card" style="padding: 1rem;">
                    <h3 class="card-title" style="margin-bottom: 0.75rem; font-size: 1rem;">&#127919; Trade Score</h3>
                    <div style="display: grid; grid-template-columns: 1fr 80px 70px auto; gap: 0.5rem; align-items: end;">
                        <div>
                            <label style="font-size: 0.75rem; margin-bottom: 0.25rem; display: block;">Symbol</label>
                            <select class="form-control" id="score-symbol" style="padding: 0.4rem;">
                                <option value="BTCUSD">Lade...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; margin-bottom: 0.25rem; display: block;">Richtung</label>
                            <select class="form-control" id="score-direction" style="padding: 0.4rem;">
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; margin-bottom: 0.25rem; display: block;">TF</label>
                            <select class="form-control" id="score-timeframe" style="padding: 0.4rem;">
                                <option value="H1" selected>H1</option>
                                <option value="H4">H4</option>
                                <option value="D1">D1</option>
                            </select>
                        </div>
                        <button class="btn btn-success btn-sm" id="btn-score" onclick="calculateScore()" style="padding: 0.4rem 0.75rem;">Score</button>
                    </div>
                    <div id="score-result" style="margin-top: 0.75rem; display: flex; align-items: center; gap: 1rem;">
                        <div class="score-value neutral" id="score-value" style="font-size: 2rem; min-width: 60px;">-</div>
                        <div id="score-details" style="font-size: 0.8rem; color: #888; flex: 1;"></div>
                    </div>
                </div>

                <!-- Alignment Check -->
                <div class="card" style="padding: 1rem;">
                    <h3 class="card-title" style="margin-bottom: 0.75rem; font-size: 1rem;">&#128260; Alignment Check</h3>
                    <div style="display: grid; grid-template-columns: 1fr 80px auto; gap: 0.5rem; align-items: end;">
                        <div>
                            <label style="font-size: 0.75rem; margin-bottom: 0.25rem; display: block;">Symbol</label>
                            <select class="form-control" id="align-symbol" style="padding: 0.4rem;">
                                <option value="BTCUSD">BTCUSD</option>
                                <option value="ETHUSD">ETHUSD</option>
                                <option value="EURUSD">EURUSD</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; margin-bottom: 0.25rem; display: block;">Signal</label>
                            <select class="form-control" id="align-signal" style="padding: 0.4rem;">
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="checkAlignment()" style="padding: 0.4rem 0.75rem;">Pr√ºfen</button>
                    </div>
                    <div id="alignment-result" style="margin-top: 0.75rem;"></div>
                </div>
            </div>
        </div>

        <!-- Training Tab -->
        <div id="tab-training" class="tab-content">
            <div class="grid-2-equal">
                <!-- HMM Training -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#9881; HMM Training</h3>
                    </div>
                    <div class="form-group">
                        <label>Symbol</label>
                        <select class="form-control" id="train-symbol">
                            <option value="BTCUSD">Lade Symbole...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Trainingsdaten (Tage)</label>
                        <input type="number" class="form-control" id="train-days" value="365" min="30" max="730">
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-success" id="btn-train-hmm" onclick="trainHMM()">&#9654; Symbol trainieren</button>
                        <button class="btn btn-primary" id="btn-train-all" onclick="trainAllHMM()">&#9654; Alle trainieren</button>
                    </div>
                    <div id="hmm-training-result" style="margin-top: 1rem;"></div>
                </div>

                <!-- Scorer Training -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">&#128295; Scorer Training</h3>
                    </div>
                    <div id="scorer-status" style="margin-bottom: 1rem;">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                    <button class="btn btn-success" id="btn-train-scorer" onclick="trainScorer()">&#9654; Scorer trainieren</button>
                    <div id="scorer-training-result" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Feature Info -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">&#128203; Scorer Features</h3>
                </div>
                <div id="feature-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Validation Tab -->
        <div id="tab-validation" class="tab-content">
            <!-- Ultra-compact: Status + Production + Registry in one row -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                <div class="card" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                    <div class="card-header" style="padding: 0.3rem 0.6rem;">
                        <span style="font-size: 0.85rem; font-weight: 600;">&#128203; Pipeline</span>
                        <button class="btn btn-primary btn-sm" onclick="loadValidationStatus()" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;">&#8635;</button>
                    </div>
                    <div id="validation-status" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"></div>
                </div>
                <div class="card" style="margin-bottom: 0; flex: 1.5; min-width: 220px;">
                    <div class="card-header" style="padding: 0.3rem 0.6rem;">
                        <span style="font-size: 0.85rem; font-weight: 600;">&#127937; Produktion</span>
                    </div>
                    <div id="production-models" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; max-height: 60px; overflow-y: auto;"></div>
                </div>
                <div class="card" style="margin-bottom: 0; flex: 0.8; min-width: 120px;">
                    <div class="card-header" style="padding: 0.3rem 0.6rem;">
                        <span style="font-size: 0.85rem; font-weight: 600;">&#128202; Registry</span>
                    </div>
                    <div id="registry-stats" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;"></div>
                </div>
            </div>

            <!-- Collapsible sections in compact format -->
            <div class="card" style="margin-bottom: 0.4rem;">
                <div class="collapsible-header" style="padding: 0.35rem 0.6rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCollapsible('versions-content', this)">
                    <span style="font-size: 0.85rem;"><span class="collapse-icon">&#9654;</span> Modell-Versionen</span>
                    <div style="display: flex; gap: 0.3rem; align-items: center;" onclick="event.stopPropagation();">
                        <select class="form-control" id="version-filter-type" style="padding: 0.15rem; font-size: 0.75rem; width: 60px;">
                            <option value="">Alle</option>
                            <option value="hmm">HMM</option>
                            <option value="scorer">Scorer</option>
                        </select>
                        <select class="form-control" id="version-filter-symbol" style="padding: 0.15rem; font-size: 0.75rem; width: 80px;">
                            <option value="">Symbol</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadModelVersions()" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;">&#128269;</button>
                    </div>
                </div>
                <div id="versions-content" class="collapsible-content" style="display: none; padding: 0.3rem 0.6rem; max-height: 150px; overflow-y: auto;">
                    <div id="model-versions"></div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 0.4rem;">
                <div class="collapsible-header" style="padding: 0.35rem 0.6rem; cursor: pointer;" onclick="toggleCollapsible('deployment-content', this)">
                    <span style="font-size: 0.85rem;"><span class="collapse-icon">&#9654;</span> Deployment-Historie</span>
                </div>
                <div id="deployment-content" class="collapsible-content" style="display: none; padding: 0.3rem 0.6rem; max-height: 120px; overflow-y: auto;">
                    <div id="deployment-history"></div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 0.4rem;">
                <div class="collapsible-header" style="padding: 0.35rem 0.6rem; cursor: pointer;" onclick="toggleCollapsible('manual-actions-content', this)">
                    <span style="font-size: 0.85rem;"><span class="collapse-icon">&#9654;</span> &#9888;&#65039; Manuelle Aktionen</span>
                </div>
                <div id="manual-actions-content" class="collapsible-content" style="display: none; padding: 0.4rem 0.6rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <!-- Force Deploy compact -->
                        <div style="flex: 1; padding: 0.4rem; background: rgba(255,255,255,0.03); border-radius: 4px;">
                            <div style="font-size: 0.8rem; color: #64c8ff; margin-bottom: 0.3rem; font-weight: 600;">Deploy</div>
                            <select class="form-control" id="force-deploy-version" style="padding: 0.2rem; font-size: 0.75rem; margin-bottom: 0.25rem; width: 100%;">
                                <option value="">Version...</option>
                            </select>
                            <div style="display: flex; gap: 0.25rem; margin-bottom: 0.25rem;">
                                <select class="form-control" id="force-deploy-type" style="padding: 0.2rem; font-size: 0.75rem; flex: 1;">
                                    <option value="hmm">HMM</option>
                                    <option value="scorer">Scorer</option>
                                </select>
                                <select class="form-control" id="force-deploy-symbol" style="padding: 0.2rem; font-size: 0.75rem; flex: 1;">
                                    <option value="">Sym</option>
                                </select>
                            </div>
                            <input type="text" class="form-control" id="force-deploy-reason" placeholder="Grund" style="padding: 0.2rem; font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <button class="btn btn-warning btn-sm" onclick="forceDeploy()" style="width: 100%; padding: 0.2rem; font-size: 0.75rem;">&#9889; Deploy</button>
                        </div>
                        <!-- Rollback compact -->
                        <div style="flex: 1; padding: 0.4rem; background: rgba(255,255,255,0.03); border-radius: 4px;">
                            <div style="font-size: 0.8rem; color: #e57373; margin-bottom: 0.3rem; font-weight: 600;">Rollback</div>
                            <div style="display: flex; gap: 0.25rem; margin-bottom: 0.25rem;">
                                <select class="form-control" id="rollback-type" style="padding: 0.2rem; font-size: 0.75rem; flex: 1;">
                                    <option value="hmm">HMM</option>
                                    <option value="scorer">Scorer</option>
                                </select>
                                <select class="form-control" id="rollback-symbol" style="padding: 0.2rem; font-size: 0.75rem; flex: 1;">
                                    <option value="">Sym</option>
                                </select>
                            </div>
                            <select class="form-control" id="rollback-version" style="padding: 0.2rem; font-size: 0.75rem; margin-bottom: 0.25rem; width: 100%;">
                                <option value="">Ziel-Version...</option>
                            </select>
                            <input type="text" class="form-control" id="rollback-reason" placeholder="Grund" style="padding: 0.2rem; font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <button class="btn btn-danger btn-sm" onclick="rollbackModel()" style="width: 100%; padding: 0.2rem; font-size: 0.75rem;">&#8617; Rollback</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 0;">
                <div class="collapsible-header" style="padding: 0.35rem 0.6rem; cursor: pointer;" onclick="toggleCollapsible('reload-content', this)">
                    <span style="font-size: 0.85rem;"><span class="collapse-icon">&#9654;</span> &#128260; Hot-Reload</span>
                </div>
                <div id="reload-content" class="collapsible-content" style="display: none; padding: 0.4rem 0.6rem;">
                    <div style="display: flex; gap: 0.3rem; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-primary btn-sm" onclick="reloadAllModels()" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">Alle</button>
                        <select class="form-control" id="reload-symbol" style="padding: 0.2rem; font-size: 0.75rem; width: 80px;">
                            <option value="">Symbol</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="reloadHMMModel()" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">HMM</button>
                        <button class="btn btn-primary btn-sm" onclick="reloadScorer()" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">Scorer</button>
                    </div>
                    <div id="reload-result" style="margin-top: 0.3rem; font-size: 0.75rem;"></div>
                </div>
            </div>
        </div>

        <!-- Scheduling Tab -->
        <!-- Self-Learning Tab -->
        <div id="tab-selflearning" class="tab-content">
            <!-- Closed-Loop Visualization -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#129302; Self-Learning System</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-purple" id="hmm-selflearn-toggle-btn" onclick="toggleHmmSelfLearning()">&#10004; Aktiviert</button>
                        <button class="btn btn-warning" id="hmm-selflearn-manual-btn" onclick="triggerHmmManualRetrain()">&#9881; Manuell trainieren</button>
                    </div>
                </div>

                <!-- Manual Retrain Progress -->
                <div id="hmm-selflearn-retrain-progress" style="margin: 1rem 0; display: none;">
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span id="hmm-selflearn-retrain-status">Training l√§uft...</span>
                            <span id="hmm-selflearn-retrain-progress-text">0%</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="hmm-selflearn-retrain-progress-bar" style="background: #ffb74d; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="hmm-selflearn-retrain-details" style="margin-top: 0.5rem; font-size: 0.8rem; color: #888;"></div>
                    </div>
                </div>

                <p style="opacity: 0.8; margin-bottom: 1rem;">
                    Das HMM-System lernt kontinuierlich aus der Regime-Erkennung durch einen geschlossenen Feedback-Loop.
                    Bei schlechter Accuracy wird automatisch ein Re-Training getriggert.
                </p>

                <!-- Closed-Loop Diagram -->
                <div style="background: rgba(100, 200, 255, 0.1); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #64c8ff; margin-bottom: 1rem; font-size: 1rem;">Closed-Loop Feedback</h3>
                    <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(100, 200, 255, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-size: 1.8rem;">&#127919;</div>
                            <div style="font-size: 0.85rem; color: #64c8ff;">1. Regime-Erkennung</div>
                        </div>
                        <div style="color: #666; font-size: 1.5rem;">&#8594;</div>
                        <div style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(129, 199, 132, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-size: 1.8rem;">&#10004;</div>
                            <div style="font-size: 0.85rem; color: #81c784;">2. Validierung</div>
                        </div>
                        <div style="color: #666; font-size: 1.5rem;">&#8594;</div>
                        <div style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255, 183, 77, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-size: 1.8rem;">&#128202;</div>
                            <div style="font-size: 0.85rem; color: #ffb74d;">3. A/B Vergleich</div>
                        </div>
                        <div style="color: #666; font-size: 1.5rem;">&#8594;</div>
                        <div style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(167, 139, 250, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-size: 1.8rem;">&#129302;</div>
                            <div style="font-size: 0.85rem; color: #a78bfa;">4. Re-Train/Rollback</div>
                        </div>
                        <div style="color: #666; font-size: 1.5rem;">&#8617;</div>
                    </div>
                </div>

                <!-- Technical Architecture Diagram (Collapsible) -->
                <details class="architecture-diagram">
                    <summary>üìê Technische Architektur</summary>
                    <div class="diagram-content">
                        <pre>
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         HMM Self-Learning Pipeline                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ   HMM Model  ‚îÇ      ‚îÇ  Marktdaten  ‚îÇ      ‚îÇ    Regime    ‚îÇ
  ‚îÇ   + Scorer   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  eintreffen  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   erkennen   ‚îÇ
  ‚îÇ              ‚îÇ      ‚îÇ              ‚îÇ      ‚îÇ              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚ñ≤                                          ‚îÇ
         ‚îÇ                                          ‚ñº
         ‚îÇ                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                                   ‚îÇ  Validierung ‚îÇ
         ‚îÇ                                   ‚îÇ  vs Ground   ‚îÇ
         ‚îÇ                                   ‚îÇ   Truth      ‚îÇ
         ‚îÇ                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                                          ‚îÇ
         ‚îÇ                                          ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ   Deploy     ‚îÇ      ‚îÇ    A/B       ‚îÇ      ‚îÇ  Accuracy    ‚îÇ
  ‚îÇ   oder       ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Vergleich   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  berechnen   ‚îÇ
  ‚îÇ   Rollback   ‚îÇ      ‚îÇ              ‚îÇ      ‚îÇ              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</pre>
                    </div>
                </details>

                <!-- Stats Grid -->
                <div class="stats-bar" id="hmm-selflearn-stats" style="margin-bottom: 0;">
                    <div class="stat-item">
                        <div class="stat-value" style="color: #a78bfa;" id="hmm-sl-stat-threshold">40%</div>
                        <div class="stat-label">Accuracy-Schwelle</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="hmm-sl-stat-total-retrains">0</div>
                        <div class="stat-label">Re-Trainings</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #81c784;" id="hmm-sl-stat-accuracy">-</div>
                        <div class="stat-label">Avg. Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="hmm-sl-stat-cooldown">-</div>
                        <div class="stat-label">Cooldown</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="hmm-sl-stat-deployments">0</div>
                        <div class="stat-label">Deployments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="hmm-sl-stat-rollbacks">0</div>
                        <div class="stat-label">Rollbacks</div>
                    </div>
                </div>
            </div>

            <!-- Configuration Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#9881; Konfiguration</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
                    <div>
                        <label style="color: #aaa; display: block; margin-bottom: 0.5rem;">Accuracy-Schwelle</label>
                        <select class="form-control" id="hmm-sl-threshold-select" onchange="updateHmmSelfLearnConfig()" style="width: 100%;">
                            <option value="0.35">35% (Niedrig)</option>
                            <option value="0.40" selected>40% (Standard)</option>
                            <option value="0.45">45%</option>
                            <option value="0.50">50% (Hoch)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.3rem;">Re-Training wenn Accuracy darunter f√§llt</small>
                    </div>
                    <div>
                        <label style="color: #aaa; display: block; margin-bottom: 0.5rem;">Cooldown-Periode</label>
                        <select class="form-control" id="hmm-sl-cooldown-select" onchange="updateHmmSelfLearnCooldown()" style="width: 100%;">
                            <option value="4">4 Stunden</option>
                            <option value="6" selected>6 Stunden (Standard)</option>
                            <option value="12">12 Stunden</option>
                            <option value="24">24 Stunden</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.3rem;">Mindestwartezeit zwischen Trainings</small>
                    </div>
                    <div>
                        <label style="color: #aaa; display: block; margin-bottom: 0.5rem;">Regression-Toleranz</label>
                        <select class="form-control" id="hmm-sl-regression-select" style="width: 100%;">
                            <option value="0.02" selected>2% (Strikt)</option>
                            <option value="0.03">3%</option>
                            <option value="0.05">5% (Tolerant)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.3rem;">Max. Accuracy-Regression f√ºr Deployment</small>
                    </div>
                    <div>
                        <label style="color: #aaa; display: block; margin-bottom: 0.5rem;">Training-Symbole</label>
                        <select class="form-control" id="hmm-sl-symbols-select" style="width: 100%;">
                            <option value="all" selected>Alle Symbole</option>
                            <option value="crypto">Nur Krypto</option>
                            <option value="forex">Nur Forex</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.3rem;">Welche Symbole sollen trainiert werden</small>
                    </div>
                </div>
            </div>

            <!-- Scheduling Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#128197; Training-Scheduling</h2>
                    <button class="btn btn-primary btn-sm" onclick="loadSchedulerStatus()">&#8635; Aktualisieren</button>
                </div>
                <div id="scheduler-status" style="margin-bottom: 1rem;">
                    <div class="loading"><div class="spinner"></div></div>
                </div>

                <div class="grid-2-equal">
                    <!-- Schedule List -->
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #64c8ff; margin-bottom: 1rem; font-size: 0.9rem;">&#128203; Aktive Schedules</h4>
                        <div id="schedule-list">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>

                    <!-- Create Schedule -->
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #81c784; margin-bottom: 1rem; font-size: 0.9rem;">&#10133; Neuer Schedule</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Intervall</label>
                                <select class="form-control" id="schedule-interval" style="font-size: 0.85rem;">
                                    <option value="hourly">St√ºndlich</option>
                                    <option value="daily" selected>T√§glich</option>
                                    <option value="weekly">W√∂chentlich</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Stunde (UTC)</label>
                                <input type="number" class="form-control" id="schedule-hour" value="3" min="0" max="23" style="font-size: 0.85rem;">
                            </div>
                            <div class="form-group" id="weekday-group" style="display: none; margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Wochentag</label>
                                <select class="form-control" id="schedule-weekday" style="font-size: 0.85rem;">
                                    <option value="0">Montag</option>
                                    <option value="1">Dienstag</option>
                                    <option value="2">Mittwoch</option>
                                    <option value="3">Donnerstag</option>
                                    <option value="4">Freitag</option>
                                    <option value="5">Samstag</option>
                                    <option value="6">Sonntag</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Timeframe</label>
                                <select class="form-control" id="schedule-timeframe" style="font-size: 0.85rem;">
                                    <option value="1h" selected>H1</option>
                                    <option value="4h">H4</option>
                                    <option value="1day">D1</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Lookback (Tage)</label>
                                <input type="number" class="form-control" id="schedule-lookback" value="365" min="30" max="730" style="font-size: 0.85rem;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 1.5rem; margin: 0.75rem 0;">
                            <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="schedule-train-hmm" checked> HMM
                            </label>
                            <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="schedule-train-scorer" checked> Scorer
                            </label>
                        </div>
                        <button class="btn btn-success btn-sm" onclick="createSchedule()" style="width: 100%;">&#10133; Schedule erstellen</button>
                    </div>
                </div>
            </div>

            <!-- Deployment History Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#128203; Deployment-Historie</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-primary" onclick="loadHmmDeploymentHistory()">&#128260; Aktualisieren</button>
                    </div>
                </div>
                <div class="table-container" style="max-height: 400px;">
                    <table id="hmm-deployment-table">
                        <thead>
                            <tr>
                                <th>Zeitpunkt</th>
                                <th>Typ</th>
                                <th>Status</th>
                                <th>Accuracy</th>
                                <th>F1-Score</th>
                            </tr>
                        </thead>
                        <tbody id="hmm-deployment-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                                    Lade Deployment-Historie...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Model Versions Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#128230; Modell-Versionen</h2>
                    <button class="btn btn-sm btn-primary" onclick="loadHmmModelVersions()">&#128260; Aktualisieren</button>
                </div>
                <div class="table-container" style="max-height: 350px;">
                    <table id="hmm-versions-table">
                        <thead>
                            <tr>
                                <th>Typ</th>
                                <th>Erstellt</th>
                                <th>Samples</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="hmm-versions-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                                    Lade Modell-Versionen...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/hmm/api/v1';
        const TRAIN_API_BASE = '/hmm-train/api/v1';
        let serviceStartTime = null;

        // ==================== Header Status Functions ====================

        async function updateHeaderStatus() {
            try {
                // Fetch health info
                const healthResponse = await fetch(`${API_BASE.replace('/api/v1', '')}/health`);
                const healthData = await healthResponse.json();

                // Update status
                const statusEl = document.getElementById('headerStatus');
                const badgeEl = document.getElementById('status-badge');
                if (healthData.status === 'healthy') {
                    statusEl.textContent = 'Online';
                    statusEl.style.color = '#4caf50';
                    badgeEl.textContent = 'Online';
                    badgeEl.classList.remove('offline');
                } else {
                    statusEl.textContent = 'Offline';
                    statusEl.style.color = '#f44336';
                    badgeEl.textContent = 'Offline';
                    badgeEl.classList.add('offline');
                }

                // Fetch info and stats for version and other data
                try {
                    const [infoRes, statsRes] = await Promise.all([
                        fetch(`${API_BASE}/info`),
                        fetch(`${API_BASE}/stats`)
                    ]);
                    const info = await infoRes.json();
                    const stats = await statsRes.json();

                    // Version from info endpoint
                    document.getElementById('headerVersion').textContent = info.version || '-';
                    // Models count from stats
                    document.getElementById('headerModels').textContent = stats.hmm_models_count ?? '-';
                    // Features from info.components.scorer.feature_count
                    document.getElementById('headerFeatures').textContent = info.components?.scorer?.feature_count ?? '-';
                } catch (e) {
                    document.getElementById('headerVersion').textContent = '-';
                    document.getElementById('headerModels').textContent = '-';
                    document.getElementById('headerFeatures').textContent = '-';
                }

                // Calculate uptime
                if (!serviceStartTime) {
                    serviceStartTime = Date.now();
                }
                updateUptime();

            } catch (error) {
                console.error('Error updating header status:', error);
                document.getElementById('headerStatus').textContent = 'Offline';
                document.getElementById('headerStatus').style.color = '#f44336';
                document.getElementById('status-badge').textContent = 'Offline';
                document.getElementById('status-badge').classList.add('offline');
            }
        }

        function updateUptime() {
            if (!serviceStartTime) return;
            const diff = Date.now() - serviceStartTime;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            let uptimeStr;
            if (days > 0) {
                uptimeStr = `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                uptimeStr = `${hours}h ${minutes % 60}m`;
            } else {
                uptimeStr = `${minutes}m ${seconds % 60}s`;
            }
            document.getElementById('headerUptime').textContent = uptimeStr;
        }

        // Update uptime every second
        setInterval(updateUptime, 1000);

        // Initial header status load
        updateHeaderStatus();

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'selflearning') {
                loadHmmSelfLearningStats();
                loadSchedulerStatus();
                loadHmmDeploymentHistory();
                loadHmmModelVersions();
            }
        }

        // Toggle Collapsible Section
        function toggleCollapsible(contentId, headerEl) {
            const content = document.getElementById(contentId);
            const icon = headerEl.querySelector('.collapse-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (icon) icon.innerHTML = '&#9660;'; // Down arrow
            } else {
                content.style.display = 'none';
                if (icon) icon.innerHTML = '&#9654;'; // Right arrow
            }
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Format Uptime
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        // Format DateTime (ISO to local display)
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('de-CH', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });
            } catch (e) {
                return isoString;
            }
        }

        // Get Regime Display
        function getRegimeDisplay(regime) {
            const displays = {
                'bull_trend': { icon: '&#128200;', name: 'Bull Trend', color: '#4caf50' },
                'bear_trend': { icon: '&#128201;', name: 'Bear Trend', color: '#f44336' },
                'sideways': { icon: '&#8596;', name: 'Sideways', color: '#ffc107' },
                'high_volatility': { icon: '&#9889;', name: 'High Volatility', color: '#ce93d8' }
            };
            return displays[regime] || { icon: '?', name: regime, color: '#888' };
        }

        // Load Service Info
        async function loadInfo() {
            try {
                const [infoRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/info`),
                    fetch(`${API_BASE}/stats`)
                ]);

                if (!infoRes.ok || !statsRes.ok) throw new Error('Failed to load data');

                const info = await infoRes.json();
                const stats = await statsRes.json();

                // Update status badge
                const badge = document.getElementById('status-badge');
                badge.textContent = 'Online';
                badge.className = 'service-badge';

                // Update stats bar
                document.getElementById('stat-models').textContent = stats.hmm_models_count || 0;
                document.getElementById('stat-features').textContent = info.components?.scorer?.feature_count || 18;
                document.getElementById('stat-uptime').textContent = stats.uptime_seconds ? formatUptime(stats.uptime_seconds) : '-';

                // Update compact service info
                document.getElementById('info-version').textContent = info.version || '-';
                document.getElementById('info-models').textContent = info.components?.hmm?.loaded_models?.length || 0;
                document.getElementById('info-scorer').textContent = info.components?.scorer?.fitted ? 'Ja' : 'Nein';
                document.getElementById('info-scorer').style.color = info.components?.scorer?.fitted ? '#4caf50' : '#f44336';
                document.getElementById('info-features').textContent = info.components?.scorer?.feature_count || 18;
                document.getElementById('info-uptime').textContent = stats.uptime_seconds ? formatUptime(stats.uptime_seconds) : '-';

                // Models List
                const models = info.components?.hmm?.loaded_models || [];
                document.getElementById('models-list').innerHTML = models.length > 0
                    ? `<table class="data-table">
                        <tr><th>Symbol</th><th>Zustande</th><th>Status</th></tr>
                        ${models.map(m => `<tr><td>${m}</td><td>4</td><td><span style="color: #4caf50;">Aktiv</span></td></tr>`).join('')}
                       </table>`
                    : '<div class="info-box">Keine HMM-Modelle geladen. Trainieren Sie Modelle im Training-Tab.</div>';

                // Scorer Status
                document.getElementById('scorer-status').innerHTML = `
                    <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Status:</span>
                            <span style="color: ${info.components?.scorer?.fitted ? '#4caf50' : '#f44336'};">
                                ${info.components?.scorer?.fitted ? 'Trainiert' : 'Nicht trainiert'}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                            <span>Features:</span>
                            <span>${info.components?.scorer?.feature_count || 18}</span>
                        </div>
                    </div>
                `;

            } catch (error) {
                showToast('Fehler beim Laden der Service-Info', 'error');
                console.error(error);
                document.getElementById('status-badge').textContent = 'Offline';
                document.getElementById('status-badge').className = 'service-badge offline';
            }
        }

        // Metrics History Chart
        let metricsChart = null;

        async function loadMetricsHistory() {
            const modelType = document.getElementById('metrics-model-type').value;
            const summaryEl = document.getElementById('metrics-summary');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/metrics-history?model_type=${modelType}&limit=30`);
                if (!response.ok) throw new Error('Failed to load metrics history');

                const data = await response.json();
                const history = data.history || [];

                if (history.length === 0) {
                    summaryEl.innerHTML = 'Keine Metriken-Historie verf√ºgbar. Trainieren Sie Modelle, um den Lernfortschritt zu verfolgen.';
                    if (metricsChart) {
                        metricsChart.destroy();
                        metricsChart = null;
                    }
                    return;
                }

                // Prepare chart data
                const labels = history.map(h => h.date);
                const accuracyData = history.map(h => h.avg_accuracy);
                const f1Data = history.map(h => h.avg_f1);
                const deployRateData = history.map(h => h.deploy_rate);

                const ctx = document.getElementById('metrics-chart').getContext('2d');

                // Destroy existing chart
                if (metricsChart) {
                    metricsChart.destroy();
                }

                // Create new chart
                metricsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Accuracy %',
                                data: accuracyData,
                                borderColor: '#4caf50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 3
                            },
                            {
                                label: 'F1-Score %',
                                data: f1Data,
                                borderColor: '#64c8ff',
                                backgroundColor: 'rgba(100, 200, 255, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 3
                            },
                            {
                                label: 'Deploy-Rate %',
                                data: deployRateData,
                                borderColor: '#ffb74d',
                                backgroundColor: 'rgba(255, 183, 77, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3,
                                pointRadius: 3,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#888',
                                    font: { size: 11 },
                                    boxWidth: 12,
                                    padding: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(26, 26, 46, 0.95)',
                                titleColor: '#fff',
                                bodyColor: '#ccc',
                                borderColor: 'rgba(100, 200, 255, 0.3)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { color: '#666', font: { size: 10 } }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: {
                                    color: '#666',
                                    font: { size: 10 },
                                    callback: v => v + '%'
                                }
                            }
                        }
                    }
                });

                // Calculate trend
                const latestAcc = accuracyData[accuracyData.length - 1] || 0;
                const firstAcc = accuracyData[0] || 0;
                const accTrend = latestAcc - firstAcc;
                const totalDeployed = history.reduce((sum, h) => sum + h.deployed, 0);
                const totalRejected = history.reduce((sum, h) => sum + h.rejected, 0);

                const trendIcon = accTrend > 0 ? '&#128200;' : accTrend < 0 ? '&#128201;' : '&#8596;';
                const trendColor = accTrend > 0 ? '#4caf50' : accTrend < 0 ? '#f44336' : '#888';

                summaryEl.innerHTML = `
                    <span style="margin-right: 1rem;">${trendIcon} Trend: <span style="color: ${trendColor};">${accTrend > 0 ? '+' : ''}${accTrend.toFixed(1)}%</span></span>
                    <span style="margin-right: 1rem;">Letzte Accuracy: <strong>${latestAcc.toFixed(1)}%</strong></span>
                    <span style="margin-right: 1rem;">Deployed: <span style="color: #4caf50;">${totalDeployed}</span></span>
                    <span>Rejected: <span style="color: #f44336;">${totalRejected}</span></span>
                `;

            } catch (error) {
                console.error('Failed to load metrics history:', error);
                summaryEl.innerHTML = '<span style="color: #e57373;">Fehler beim Laden der Metriken-Historie</span>';
            }
        }

        // Load Features
        async function loadFeatures() {
            try {
                const response = await fetch(`${API_BASE}/models/features`);
                if (!response.ok) throw new Error('Failed to load features');

                const data = await response.json();
                const container = document.getElementById('feature-list');

                if (data.features && data.features.length > 0) {
                    container.innerHTML = `
                        <div class="grid-3">
                            ${data.features.map(f => `
                                <div style="padding: 0.5rem; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 0.85rem;">
                                    ${f}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="info-box">Feature-Liste nicht verf√ºgbar.</div>';
                }
            } catch (error) {
                document.getElementById('feature-list').innerHTML = '<div class="info-box">Feature-Liste konnte nicht geladen werden.</div>';
            }
        }

        // Detect Regime
        async function detectRegime() {
            const btn = document.getElementById('btn-detect');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const symbol = document.getElementById('detect-symbol').value;
                const timeframe = document.getElementById('detect-timeframe').value;

                const response = await fetch(`${API_BASE}/regime/detect/${symbol}?timeframe=${timeframe}`);
                if (!response.ok) throw new Error('Detection failed');

                const data = await response.json();
                const result = document.getElementById('detection-result');
                // API returns current_regime, not regime
                const currentRegime = data.current_regime || data.regime;
                const regime = getRegimeDisplay(currentRegime);
                // API returns transition_probabilities, not probabilities
                const probabilities = data.transition_probabilities || data.probabilities || {};

                result.innerHTML = `
                    <div class="grid-4" style="margin-bottom: 1rem;">
                        ${['bull_trend', 'bear_trend', 'sideways', 'high_volatility'].map(r => {
                            const d = getRegimeDisplay(r);
                            const prob = probabilities[r] || 0;
                            const isActive = currentRegime === r;
                            return `
                                <div class="regime-card ${r}" style="opacity: ${isActive ? 1 : 0.5};">
                                    <div class="regime-icon">${d.icon}</div>
                                    <div class="regime-name">${d.name}</div>
                                    <div class="regime-probability" style="color: ${d.color};">${(prob * 100).toFixed(1)}%</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="color: #888; margin-bottom: 0.5rem;">Aktuelles Regime</div>
                        <span class="regime-badge ${currentRegime}" style="font-size: 1.1rem;">${regime.icon} ${regime.name}</span>
                        <div style="margin-top: 0.5rem; color: #888; font-size: 0.85rem;">
                            Confidence: ${((data.regime_probability || probabilities[currentRegime] || 0) * 100).toFixed(1)}%
                        </div>
                    </div>
                `;

                showToast(`Regime f√ºr ${symbol} erkannt: ${regime.name}`);
            } catch (error) {
                showToast('Fehler bei der Regime-Erkennung', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Scan All Symbols with Progress
        async function scanAll() {
            const btn = document.getElementById('btn-scan');
            const progressContainer = document.getElementById('scan-progress');
            const progressBar = document.getElementById('scan-progress-bar');
            const progressText = document.getElementById('scan-progress-text');
            const resultsContainer = document.getElementById('scan-results');

            btn.classList.add('btn-loading');
            btn.disabled = true;
            progressContainer.style.display = 'block';
            resultsContainer.innerHTML = '';

            try {
                // 1. Lade alle verf√ºgbaren Symbole
                const symbolsResponse = await fetch('/data/api/v1/managed-symbols');
                if (!symbolsResponse.ok) throw new Error('Failed to load symbols');

                const symbolsData = await symbolsResponse.json();
                const symbols = symbolsData.map(s => s.symbol);

                if (symbols.length === 0) {
                    throw new Error('Keine Symbole verf√ºgbar');
                }

                // 2. Scanne Symbole einzeln mit Fortschrittsanzeige
                const results = [];
                const total = symbols.length;

                for (let i = 0; i < symbols.length; i++) {
                    const symbol = symbols[i];
                    const progress = ((i + 1) / total * 100).toFixed(0);
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${i + 1} / ${total} Symbole (${symbol})`;

                    try {
                        const response = await fetch(`${API_BASE}/regime/detect/${symbol}?timeframe=H1`);
                        if (response.ok) {
                            const data = await response.json();
                            results.push({
                                symbol: symbol,
                                regime: data.current_regime || data.regime,
                                probability: data.regime_probability || 0
                            });
                        }
                    } catch (e) {
                        console.warn(`Failed to scan ${symbol}:`, e);
                    }
                }

                // 3. Zeige Ergebnisse
                if (results.length > 0) {
                    // Sortiere nach Regime f√ºr bessere √úbersicht
                    results.sort((a, b) => a.regime.localeCompare(b.regime));

                    let html = '<table class="data-table"><tr><th>Symbol</th><th>Regime</th><th>Confidence</th></tr>';
                    for (const info of results) {
                        const regime = getRegimeDisplay(info.regime);
                        html += `<tr>
                            <td>${info.symbol}</td>
                            <td><span class="regime-badge ${info.regime}">${regime.icon} ${regime.name}</span></td>
                            <td>${(info.probability * 100).toFixed(1)}%</td>
                        </tr>`;
                    }
                    html += '</table>';
                    resultsContainer.innerHTML = html;
                } else {
                    resultsContainer.innerHTML = '<div class="info-box">Keine Ergebnisse.</div>';
                }

                showToast(`Scan abgeschlossen: ${results.length} Symbole`);
            } catch (error) {
                showToast(`Fehler beim Scan: ${error.message}`, 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        // Load Regime History
        async function loadHistory() {
            const symbol = document.getElementById('history-symbol').value;
            const timeframe = document.getElementById('history-timeframe').value;
            const container = document.getElementById('regime-history');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/regime/history/${symbol}?timeframe=${timeframe}`);
                if (!response.ok) throw new Error('Failed to load history');

                const data = await response.json();
                // API returns "entries" not "history", and "probability" not "confidence"
                const entries = data.entries || data.history || [];

                if (entries.length > 0) {
                    // Show distribution summary
                    const dist = data.regime_distribution || {};
                    const distHtml = Object.entries(dist).map(([r, pct]) => {
                        const d = getRegimeDisplay(r);
                        return `<span style="margin-right: 1rem;"><span class="regime-badge ${r}">${d.icon}</span> ${(pct * 100).toFixed(0)}%</span>`;
                    }).join('');

                    container.innerHTML = `
                        <div style="margin-bottom: 0.75rem; font-size: 0.85rem; color: #888;">
                            Verteilung: ${distHtml}
                        </div>
                        <table class="data-table">
                            <tr><th>Zeitpunkt</th><th>Regime</th><th>Wahrscheinlichkeit</th></tr>
                            ${entries.slice(0, 20).map(h => {
                                const regime = getRegimeDisplay(h.regime);
                                const prob = h.probability || h.confidence || 0;
                                // Parse timestamp - handle various formats
                                let timeStr = '-';
                                if (h.timestamp) {
                                    try {
                                        // Try parsing as ISO string or Unix timestamp
                                        let date;
                                        if (typeof h.timestamp === 'number') {
                                            // Unix timestamp (seconds or milliseconds)
                                            date = new Date(h.timestamp > 1e12 ? h.timestamp : h.timestamp * 1000);
                                        } else {
                                            // String format - try direct parse
                                            date = new Date(h.timestamp);
                                        }
                                        if (!isNaN(date.getTime())) {
                                            timeStr = date.toLocaleString('de-CH');
                                        } else {
                                            timeStr = h.timestamp; // Show raw if parse fails
                                        }
                                    } catch (e) {
                                        timeStr = h.timestamp;
                                    }
                                }
                                return `<tr>
                                    <td>${timeStr}</td>
                                    <td><span class="regime-badge ${h.regime}">${regime.icon} ${regime.name}</span></td>
                                    <td>${(prob * 100).toFixed(1)}%</td>
                                </tr>`;
                            }).join('')}
                        </table>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                            ${data.total_count || entries.length} Eintr√§ge insgesamt (zeige neueste 20)
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="info-box">Keine Historie f√ºr dieses Symbol. F√ºhren Sie zuerst einen Scan durch.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="info-box" style="border-color: rgba(244,67,54,0.3); color: #e57373;">Fehler beim Laden.</div>';
            }
        }

        // Calculate Score
        async function calculateScore() {
            const btn = document.getElementById('btn-score');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const symbol = document.getElementById('score-symbol').value;
                const direction = document.getElementById('score-direction').value;
                const timeframe = document.getElementById('score-timeframe').value;

                const response = await fetch(`${API_BASE}/scoring/score/${symbol}?signal_type=${direction}&timeframe=${timeframe}`);
                if (!response.ok) throw new Error('Scoring failed');

                const data = await response.json();
                const scoreEl = document.getElementById('score-value');
                const detailsEl = document.getElementById('score-details');

                const score = data.score || 0;
                scoreEl.textContent = score.toFixed(1);
                scoreEl.className = `score-value ${score >= 60 ? 'positive' : score <= 40 ? 'negative' : 'neutral'}`;

                detailsEl.innerHTML = `
                    <div>Richtung: ${direction.toUpperCase()}</div>
                    <div>Regime: ${data.current_regime || '-'}</div>
                    <div>Alignment: ${data.regime_alignment || '-'}</div>
                    ${data.recommendation ? `<div style="margin-top: 0.5rem; color: ${score >= 60 ? '#4caf50' : '#f44336'};">${data.recommendation}</div>` : ''}
                `;

                showToast(`Score berechnet: ${score.toFixed(1)}`);
            } catch (error) {
                showToast('Fehler bei der Score-Berechnung', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Check Alignment
        async function checkAlignment() {
            const symbol = document.getElementById('align-symbol').value;
            const signalType = document.getElementById('align-signal').value;
            const container = document.getElementById('alignment-result');
            container.innerHTML = '<div class="spinner" style="width: 20px; height: 20px;"></div>';

            try {
                const response = await fetch(`${API_BASE}/scoring/alignment-check/${symbol}?signal_type=${signalType}`);
                if (!response.ok) throw new Error('Alignment check failed');

                const data = await response.json();

                // Determine alignment color and icon
                const alignColor = data.alignment === 'aligned' ? '#4caf50' :
                                   data.alignment === 'neutral' ? '#ffc107' : '#f44336';
                const alignIcon = data.alignment === 'aligned' ? '‚úì' :
                                  data.alignment === 'neutral' ? '‚óã' : '‚úó';
                const regime = getRegimeDisplay(data.current_regime);

                // Kompakte Inline-Darstellung
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <span class="regime-badge ${data.current_regime}" style="font-size: 0.8rem;">${regime.icon} ${regime.name}</span>
                        <span style="color: ${signalType === 'long' ? '#4caf50' : '#f44336'}; font-weight: 600;">
                            ${signalType === 'long' ? '‚Üë Long' : '‚Üì Short'}
                        </span>
                        <span style="font-weight: 700; color: ${alignColor}; font-size: 1.1rem;">
                            ${alignIcon} ${data.alignment || 'unknown'}
                        </span>
                        <span style="color: #888; font-size: 0.8rem;">${data.recommendation || ''}</span>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<span style="color: #e57373; font-size: 0.85rem;">Fehler beim Alignment Check</span>';
            }
        }

        // Train HMM (single symbol)
        async function trainHMM() {
            const btn = document.getElementById('btn-train-hmm');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const symbol = document.getElementById('train-symbol').value;
                const days = parseInt(document.getElementById('train-days').value);

                const response = await fetch(`${TRAIN_API_BASE}/train/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'hmm',
                        symbols: [symbol],
                        lookback_days: days
                    })
                });

                if (!response.ok) throw new Error('Training failed');

                const data = await response.json();
                document.getElementById('hmm-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(76,175,80,0.3); color: #81c784;">
                        Training f√ºr ${symbol} gestartet!<br>
                        <small>Job-ID: ${data.job_id}</small>
                    </div>
                `;

                showToast(`HMM Training f√ºr ${symbol} gestartet`);
            } catch (error) {
                document.getElementById('hmm-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(244,67,54,0.3); color: #e57373;">
                        Fehler: ${error.message}
                    </div>
                `;
                showToast('Fehler beim HMM Training', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Train ALL HMM models
        async function trainAllHMM() {
            const btn = document.getElementById('btn-train-all');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const days = parseInt(document.getElementById('train-days').value);

                const response = await fetch(`${TRAIN_API_BASE}/train/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'hmm',
                        symbols: null,  // null = alle Symbole
                        lookback_days: days
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Training failed');
                }

                const data = await response.json();
                document.getElementById('hmm-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(33,150,243,0.3); color: #64b5f6;">
                        Training f√ºr ALLE Symbole gestartet!<br>
                        <small>Job-ID: ${data.job_id}</small>
                    </div>
                    <div id="training-progress" style="margin-top: 0.5rem;"></div>
                `;

                showToast('Training f√ºr alle Symbole gestartet');
                // Start progress polling
                pollTrainingProgress(data.job_id);
            } catch (error) {
                document.getElementById('hmm-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(244,67,54,0.3); color: #e57373;">
                        Fehler: ${error.message}
                    </div>
                `;
                showToast('Fehler beim Training', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Poll training progress
        let progressInterval = null;
        let currentTrainingJobId = null;
        async function pollTrainingProgress(jobId) {
            if (progressInterval) clearInterval(progressInterval);
            currentTrainingJobId = jobId;
            let trainingStarted = false;

            const container = document.getElementById('training-progress');
            if (container) {
                container.innerHTML = '<div style="color: #888; font-size: 0.8rem;">‚è≥ Training wird gestartet...</div>';
            }

            const updateProgress = async () => {
                try {
                    const response = await fetch(`${TRAIN_API_BASE}/train/status`);
                    if (!response.ok) return;

                    const data = await response.json();
                    const container = document.getElementById('training-progress');
                    if (!container) return;

                    if (data.status === 'training' && data.current_job) {
                        trainingStarted = true;
                        const job = data.current_job;
                        const pct = job.progress || 0;
                        container.innerHTML = `
                            <div style="background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; height: 20px;">
                                <div style="background: linear-gradient(90deg, #2196f3, #64b5f6); height: 100%; width: ${pct}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 0.25rem; color: #888;">
                                <span>${job.completed_models || 0} / ${job.total_models || 0} Modelle</span>
                                <span>${pct.toFixed(1)}%</span>
                            </div>
                            ${job.current_symbol ? `<div style="font-size: 0.75rem; color: #64b5f6; margin-top: 0.25rem;">Aktuell: ${job.current_symbol}</div>` : ''}
                        `;
                    } else if (data.status === 'idle' && trainingStarted) {
                        container.innerHTML = `
                            <div class="info-box" style="border-color: rgba(100,200,255,0.3); color: #64c8ff; margin-top: 0.5rem;">
                                ‚è≥ Modelle werden im Inference Service geladen...
                            </div>
                        `;
                        clearInterval(progressInterval);
                        progressInterval = null;

                        // Trigger reload-all in HMM Inference Service
                        try {
                            const reloadResponse = await fetch(`${API_BASE}/model/reload-all`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });

                            if (reloadResponse.ok) {
                                container.innerHTML = `
                                    <div class="info-box" style="border-color: rgba(76,175,80,0.3); color: #81c784; margin-top: 0.5rem;">
                                        ‚úì HMM Training abgeschlossen und Modelle geladen!
                                    </div>
                                `;
                            } else {
                                container.innerHTML = `
                                    <div class="info-box" style="border-color: rgba(255,152,0,0.3); color: #ffb74d; margin-top: 0.5rem;">
                                        ‚úì Training abgeschlossen, Reload fehlgeschlagen. Bitte Container neu starten.
                                    </div>
                                `;
                            }
                        } catch (reloadError) {
                            console.warn('HMM reload error:', reloadError);
                            container.innerHTML = `
                                <div class="info-box" style="border-color: rgba(255,152,0,0.3); color: #ffb74d; margin-top: 0.5rem;">
                                    ‚úì Training abgeschlossen. Reload-Aufruf fehlgeschlagen.
                                </div>
                            `;
                        }

                        loadInfo(); // Refresh status
                    }
                } catch (e) {
                    console.warn('Progress poll error:', e);
                }
            };

            // Warte kurz bevor wir anfangen zu pollen (Training braucht Zeit zum Starten)
            await new Promise(resolve => setTimeout(resolve, 1000));
            await updateProgress();
            progressInterval = setInterval(updateProgress, 2000);
        }

        // Train Scorer
        async function trainScorer() {
            const btn = document.getElementById('btn-train-scorer');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/train/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'scorer',
                        symbols: null,  // Scorer wird √ºber alle Symbole trainiert
                        lookback_days: 365
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Training failed');
                }

                const data = await response.json();
                document.getElementById('scorer-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(33,150,243,0.3); color: #64b5f6;">
                        Scorer Training gestartet!<br>
                        <small>Job-ID: ${data.job_id}</small>
                    </div>
                    <div id="scorer-progress" style="margin-top: 0.5rem;"></div>
                `;

                showToast('Scorer Training gestartet');
                // Start progress polling
                pollScorerProgress(data.job_id);
            } catch (error) {
                document.getElementById('scorer-training-result').innerHTML = `
                    <div class="info-box" style="border-color: rgba(244,67,54,0.3); color: #e57373;">
                        Fehler: ${error.message}
                    </div>
                `;
                showToast('Fehler beim Scorer Training', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Poll scorer training progress
        let scorerProgressInterval = null;
        async function pollScorerProgress(jobId) {
            if (scorerProgressInterval) clearInterval(scorerProgressInterval);
            let trainingStarted = false;

            const container = document.getElementById('scorer-progress');
            if (container) {
                container.innerHTML = '<div style="color: #888; font-size: 0.8rem;">‚è≥ Training wird gestartet...</div>';
            }

            const updateProgress = async () => {
                try {
                    const response = await fetch(`${TRAIN_API_BASE}/train/status`);
                    if (!response.ok) return;

                    const data = await response.json();
                    const container = document.getElementById('scorer-progress');
                    if (!container) return;

                    if (data.status === 'training' && data.current_job) {
                        trainingStarted = true;
                        const job = data.current_job;
                        const pct = job.progress || 0;
                        container.innerHTML = `
                            <div style="background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; height: 20px;">
                                <div style="background: linear-gradient(90deg, #9c27b0, #ce93d8); height: 100%; width: ${pct}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 0.25rem; color: #888;">
                                <span>${job.completed_models || 0} / ${job.total_models || 0} Symbole</span>
                                <span>${pct.toFixed(1)}%</span>
                            </div>
                            ${job.current_symbol ? `<div style="font-size: 0.75rem; color: #ce93d8; margin-top: 0.25rem;">Aktuell: ${job.current_symbol}</div>` : ''}
                        `;
                    } else if (data.status === 'idle' && trainingStarted) {
                        container.innerHTML = `
                            <div class="info-box" style="border-color: rgba(100,200,255,0.3); color: #64c8ff; margin-top: 0.5rem;">
                                ‚è≥ Scorer wird im Inference Service geladen...
                            </div>
                        `;
                        clearInterval(scorerProgressInterval);
                        scorerProgressInterval = null;

                        // Trigger reload in HMM Inference Service
                        try {
                            const reloadResponse = await fetch(`${API_BASE}/model/reload`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ model_type: 'scorer' })
                            });

                            if (reloadResponse.ok) {
                                const reloadData = await reloadResponse.json();
                                container.innerHTML = `
                                    <div class="info-box" style="border-color: rgba(76,175,80,0.3); color: #81c784; margin-top: 0.5rem;">
                                        ‚úì Scorer Training abgeschlossen und geladen!
                                    </div>
                                `;
                            } else {
                                container.innerHTML = `
                                    <div class="info-box" style="border-color: rgba(255,152,0,0.3); color: #ffb74d; margin-top: 0.5rem;">
                                        ‚úì Training abgeschlossen, Reload fehlgeschlagen. Bitte Container neu starten.
                                    </div>
                                `;
                            }
                        } catch (reloadError) {
                            console.warn('Scorer reload error:', reloadError);
                            container.innerHTML = `
                                <div class="info-box" style="border-color: rgba(255,152,0,0.3); color: #ffb74d; margin-top: 0.5rem;">
                                    ‚úì Training abgeschlossen. Reload-Aufruf fehlgeschlagen.
                                </div>
                            `;
                        }

                        loadInfo(); // Refresh status
                    }
                } catch (e) {
                    console.warn('Scorer progress poll error:', e);
                }
            };

            // Warte kurz bevor wir anfangen zu pollen (Training braucht Zeit zum Starten)
            await new Promise(resolve => setTimeout(resolve, 1000));
            await updateProgress();
            scorerProgressInterval = setInterval(updateProgress, 2000);
        }

        // ==================== Validation Tab Functions ====================

        // Load Validation Status
        async function loadValidationStatus() {
            const container = document.getElementById('validation-status');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/stats`);
                if (!response.ok) throw new Error('Failed to load validation status');

                const data = await response.json();

                if (!data.validation_enabled) {
                    container.innerHTML = `
                        <div class="info-box" style="background: rgba(255, 152, 0, 0.1); border-color: rgba(255, 152, 0, 0.3); color: #ffb74d;">
                            <strong>Validierung deaktiviert:</strong> ${data.message || 'Die Validierungs-Pipeline ist nicht aktiviert.'}
                        </div>
                    `;
                    return;
                }

                const registry = data.registry || {};
                const deployment = data.deployment || {};

                container.innerHTML = `
                    <div class="grid-4">
                        <div class="stat-item">
                            <div class="stat-value" style="color: #4caf50;">${registry.total_versions || 0}</div>
                            <div class="stat-label">Versionen gesamt</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #64c8ff;">${registry.production_count || 0}</div>
                            <div class="stat-label">In Produktion</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #4caf50;">${deployment.deployed_count || 0}</div>
                            <div class="stat-label">Deployed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #f44336;">${deployment.rejected_count || 0}</div>
                            <div class="stat-label">Abgelehnt</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: #888;">Validierung:</span>
                            <span style="color: #4caf50;">&#10004; Aktiviert</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">Versions-Limit:</span>
                            <span>${registry.keep_versions || 5} Versionen</span>
                        </div>
                    </div>
                `;

                // Also load other sections
                loadProductionModels();
                loadRegistryStats();
                loadModelVersions();
                loadDeploymentHistory();
                loadSymbolsForValidation();

            } catch (error) {
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(244, 67, 54, 0.1); border-color: rgba(244, 67, 54, 0.3); color: #e57373;">
                        Fehler beim Laden: ${error.message}
                    </div>
                `;
            }
        }

        // Load Production Models
        async function loadProductionModels() {
            const container = document.getElementById('production-models');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/production`);
                if (!response.ok) throw new Error('Failed to load production models');

                const data = await response.json();
                const models = data.production_models || {};
                const total = data.total || Object.keys(models).length;

                if (Object.keys(models).length === 0) {
                    container.innerHTML = '<span style="color: #888;">Keine Modelle</span>';
                    return;
                }

                // Count by type
                let hmmCount = 0, scorerCount = 0;
                for (const [key, model] of Object.entries(models)) {
                    if (model.model_type === 'scorer') scorerCount++;
                    else hmmCount++;
                }

                // Compact summary display
                container.innerHTML = `
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <span style="color: #4caf50;">&#10004; ${total} Modelle</span>
                        <span style="color: #888;">(${hmmCount} HMM, ${scorerCount} Scorer)</span>
                    </div>
                `;

            } catch (error) {
                container.innerHTML = `<span style="color: #e57373;">Fehler</span>`;
            }
        }

        // Load Registry Stats
        async function loadRegistryStats() {
            const container = document.getElementById('registry-stats');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/stats`);
                if (!response.ok) throw new Error('Failed to load stats');

                const data = await response.json();
                const registry = data.registry || {};
                const deployment = data.deployment || {};

                // Ultra-compact display
                container.innerHTML = `
                    <div style="line-height: 1.4;">
                        <div>${data.validation_enabled ? '<span style="color: #4caf50;">&#10004;</span>' : '<span style="color: #f44336;">&#10008;</span>'} Validierung</div>
                        <div style="color: #888;">${registry.total_versions || 0} Vers. | ${registry.production_count || 0} Prod.</div>
                        <div><span style="color: #4caf50;">${deployment.deployed_count || 0}</span>/<span style="color: #f44336;">${deployment.rejected_count || 0}</span>/<span style="color: #ffb74d;">${deployment.rollback_count || 0}</span></div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<span style="color: #e57373;">Fehler</span>`;
            }
        }

        // Load Model Versions
        async function loadModelVersions() {
            const container = document.getElementById('model-versions');
            const typeFilter = document.getElementById('version-filter-type').value;
            const symbolFilter = document.getElementById('version-filter-symbol').value;

            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                let url = `${TRAIN_API_BASE}/models/versions?limit=20`;
                if (typeFilter) url += `&model_type=${typeFilter}`;
                if (symbolFilter) url += `&symbol=${symbolFilter}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load versions');

                const data = await response.json();
                const versions = data.versions || [];

                // Populate version dropdowns
                populateVersionDropdowns(versions);

                if (versions.length === 0) {
                    container.innerHTML = '<div class="info-box">Keine Versionen gefunden.</div>';
                    return;
                }

                let html = `
                    <table class="data-table">
                        <tr>
                            <th>Version</th>
                            <th>Typ</th>
                            <th>Symbol</th>
                            <th>Status</th>
                            <th>Metriken</th>
                            <th>Erstellt</th>
                        </tr>
                `;

                for (const v of versions) {
                    const statusColor = getStatusColor(v.status);
                    const metrics = v.validation_metrics || {};
                    const metricsDisplay = Object.entries(metrics).slice(0, 2).map(([k, val]) =>
                        `${k}: ${typeof val === 'number' ? (val * 100).toFixed(1) + '%' : val}`
                    ).join(', ') || '-';

                    html += `
                        <tr>
                            <td><code style="background: rgba(100,200,255,0.1); padding: 0.2rem 0.4rem; border-radius: 4px;">${v.version_id || '-'}</code></td>
                            <td>${v.model_type || '-'}</td>
                            <td>${v.symbol || '-'}</td>
                            <td><span style="color: ${statusColor};">${getStatusIcon(v.status)} ${v.status || '-'}</span></td>
                            <td style="font-size: 0.8rem; color: #888;">${metricsDisplay}</td>
                            <td style="color: #888; font-size: 0.85rem;">${v.created_at ? new Date(v.created_at).toLocaleString('de-CH') : '-'}</td>
                        </tr>
                    `;
                }

                html += '</table>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
            }
        }

        // Load Deployment History
        async function loadDeploymentHistory() {
            const container = document.getElementById('deployment-history');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/deployment-history?limit=20`);
                if (!response.ok) throw new Error('Failed to load history');

                const data = await response.json();
                const history = data.history || [];

                if (history.length === 0) {
                    container.innerHTML = '<div class="info-box">Keine Deployment-Historie vorhanden.</div>';
                    return;
                }

                let html = `
                    <table class="data-table">
                        <tr>
                            <th>Zeitpunkt</th>
                            <th>Modell</th>
                            <th>Aktion</th>
                            <th>Grund</th>
                        </tr>
                `;

                for (const d of history) {
                    const actionColor = d.action === 'deployed' ? '#4caf50' : d.action === 'rejected' ? '#f44336' : '#ffb74d';
                    const modelName = d.symbol ? `${d.model_type}/${d.symbol}` : d.model_type;

                    html += `
                        <tr>
                            <td style="color: #888; font-size: 0.85rem;">${d.timestamp ? new Date(d.timestamp).toLocaleString('de-CH') : '-'}</td>
                            <td>${modelName || '-'}</td>
                            <td><span style="color: ${actionColor}; font-weight: 500;">${d.action || '-'}</span></td>
                            <td style="font-size: 0.85rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${d.reason || '-'}</td>
                        </tr>
                    `;
                }

                html += '</table>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
            }
        }

        // Load symbols for validation dropdowns
        async function loadSymbolsForValidation() {
            try {
                const response = await fetch('/data/api/v1/managed-symbols');
                if (!response.ok) return;

                const symbols = await response.json();
                const symbolList = symbols.map(s => s.symbol);

                // Populate all symbol dropdowns in validation tab
                const dropdowns = ['version-filter-symbol', 'force-deploy-symbol', 'rollback-symbol', 'reload-symbol'];
                for (const id of dropdowns) {
                    const select = document.getElementById(id);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">- Alle/Keine -</option>';
                        for (const symbol of symbolList) {
                            select.innerHTML += `<option value="${symbol}">${symbol}</option>`;
                        }
                        if (currentValue) select.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Failed to load symbols:', error);
            }
        }

        // Populate version dropdowns
        function populateVersionDropdowns(versions) {
            const forceDeploySelect = document.getElementById('force-deploy-version');
            const rollbackSelect = document.getElementById('rollback-version');

            if (forceDeploySelect) {
                forceDeploySelect.innerHTML = '<option value="">Version w√§hlen...</option>';
                for (const v of versions) {
                    forceDeploySelect.innerHTML += `<option value="${v.version_id}">${v.version_id} (${v.model_type}${v.symbol ? '/' + v.symbol : ''} - ${v.status})</option>`;
                }
            }

            if (rollbackSelect) {
                rollbackSelect.innerHTML = '<option value="">Version w√§hlen...</option>';
                for (const v of versions) {
                    if (v.status !== 'rejected') {
                        rollbackSelect.innerHTML += `<option value="${v.version_id}">${v.version_id} (${v.model_type}${v.symbol ? '/' + v.symbol : ''} - ${v.status})</option>`;
                    }
                }
            }
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'production': '#4caf50',
                'candidate': '#64c8ff',
                'archived': '#888',
                'rejected': '#f44336'
            };
            return colors[status] || '#888';
        }

        function getStatusIcon(status) {
            const icons = {
                'production': '&#10004;',
                'candidate': '&#9881;',
                'archived': '&#128230;',
                'rejected': '&#10060;'
            };
            return icons[status] || '';
        }

        // Force Deploy
        async function forceDeploy() {
            const btn = document.getElementById('btn-force-deploy');
            const versionId = document.getElementById('force-deploy-version').value;
            const modelType = document.getElementById('force-deploy-type').value;
            const symbol = document.getElementById('force-deploy-symbol').value || null;
            const reason = document.getElementById('force-deploy-reason').value || 'Manual deployment via UI';

            if (!versionId) {
                showToast('Bitte Version ausw√§hlen', 'error');
                return;
            }

            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/force-deploy/${versionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: modelType,
                        symbol: symbol,
                        reason: reason
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Force deploy failed');
                }

                const data = await response.json();
                showToast(`Version ${versionId} erfolgreich deployed!`, 'success');
                loadValidationStatus();

            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Rollback Model
        async function rollbackModel() {
            const btn = document.getElementById('btn-rollback');
            const modelType = document.getElementById('rollback-type').value;
            const symbol = document.getElementById('rollback-symbol').value || null;
            const targetVersion = document.getElementById('rollback-version').value;
            const reason = document.getElementById('rollback-reason').value || 'Manual rollback via UI';

            if (!targetVersion) {
                showToast('Bitte Ziel-Version ausw√§hlen', 'error');
                return;
            }

            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: modelType,
                        symbol: symbol,
                        target_version: targetVersion,
                        reason: reason
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Rollback failed');
                }

                const data = await response.json();
                showToast(`Rollback zu ${targetVersion} erfolgreich!`, 'success');
                loadValidationStatus();

            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Reload All Models
        async function reloadAllModels() {
            const container = document.getElementById('reload-result');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/model/reload-all`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Reload failed');

                const data = await response.json();
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); color: #81c784;">
                        &#10004; Alle Modelle neu geladen!<br>
                        HMM-Caches geleert: ${(data.hmm_models_cleared || []).join(', ') || 'keine'}<br>
                        Scorer neu geladen: ${data.scorer_reloaded ? 'Ja' : 'Nein'}
                    </div>
                `;
                showToast('Alle Modelle neu geladen', 'success');
                loadInfo();

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Reload HMM Model
        async function reloadHMMModel() {
            const symbol = document.getElementById('reload-symbol').value;
            if (!symbol) {
                showToast('Bitte Symbol ausw√§hlen', 'error');
                return;
            }

            const container = document.getElementById('reload-result');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/model/reload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'hmm',
                        symbol: symbol
                    })
                });

                if (!response.ok) throw new Error('Reload failed');

                const data = await response.json();
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); color: #81c784;">
                        &#10004; HMM-Modell f√ºr ${symbol} neu geladen!<br>
                        Status: ${data.status}<br>
                        Modell geladen: ${data.model_loaded ? 'Ja' : 'Nein'}
                    </div>
                `;
                showToast(`HMM f√ºr ${symbol} neu geladen`, 'success');
                loadInfo();

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Reload Scorer
        async function reloadScorer() {
            const container = document.getElementById('reload-result');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/model/reload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'scorer'
                    })
                });

                if (!response.ok) throw new Error('Reload failed');

                const data = await response.json();
                container.innerHTML = `
                    <div class="info-box" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); color: #81c784;">
                        &#10004; Scorer neu geladen!<br>
                        Status: ${data.status}<br>
                        Pfad: ${data.path || '-'}<br>
                        Fitted: ${data.is_fitted ? 'Ja' : 'Nein'}
                    </div>
                `;
                showToast('Scorer neu geladen', 'success');
                loadInfo();

            } catch (error) {
                container.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // ==================== Scheduling Functions ====================

        async function loadSchedulerStatus() {
            const statusContainer = document.getElementById('scheduler-status');
            const listContainer = document.getElementById('schedule-list');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules`);
                const data = await response.json();

                // Status display
                const status = data.scheduler_status || {};
                statusContainer.innerHTML = `
                    <div class="grid-2-equal" style="margin-bottom: 1rem;">
                        <div class="stat-item">
                            <span class="stat-label">Scheduler</span>
                            <span class="stat-value">${status.running ? '&#9989; Aktiv' : '&#10060; Inaktiv'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Schedules</span>
                            <span class="stat-value">${status.active_schedules || 0} / ${status.total_schedules || 0}</span>
                        </div>
                    </div>
                    ${status.next_scheduled_run ? `
                        <div class="info-box">
                            <strong>N√§chster geplanter Lauf:</strong><br>
                            Schedule: ${status.next_scheduled_run.schedule_id}<br>
                            Zeit: ${formatDateTime(status.next_scheduled_run.next_run)}<br>
                            Intervall: ${formatInterval(status.next_scheduled_run.interval)}
                        </div>
                    ` : '<div class="info-box">Keine aktiven Schedules</div>'}
                `;

                // Schedule list
                const schedules = data.schedules || [];
                if (schedules.length === 0) {
                    listContainer.innerHTML = `
                        <div class="info-box">
                            Keine Schedules konfiguriert. Erstellen Sie einen neuen Schedule rechts.
                        </div>
                    `;
                } else {
                    listContainer.innerHTML = schedules.map(s => `
                        <div class="version-card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <strong>${s.schedule_id}</strong>
                                    <span class="status-badge ${s.enabled ? 'status-deployed' : 'status-rejected'}">
                                        ${s.enabled ? 'Aktiv' : 'Inaktiv'}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm ${s.enabled ? 'btn-warning' : 'btn-success'}"
                                            onclick="toggleSchedule('${s.schedule_id}', ${!s.enabled})">
                                        ${s.enabled ? '&#10074;&#10074; Pause' : '&#9658; Start'}
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="triggerSchedule('${s.schedule_id}')">
                                        &#9658; Jetzt
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${s.schedule_id}')">
                                        &#128465;
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #aaa;">
                                <div><strong>Intervall:</strong> ${formatInterval(s.interval)}</div>
                                <div><strong>Modelle:</strong> ${s.train_hmm ? 'HMM' : ''} ${s.train_scorer ? 'Scorer' : ''}</div>
                                <div><strong>Timeframe:</strong> ${s.timeframe}</div>
                                <div><strong>Lookback:</strong> ${s.lookback_days} Tage</div>
                                <div><strong>Symbole:</strong> ${s.symbols ? s.symbols.join(', ') : 'Alle'}</div>
                                ${s.next_run ? `<div><strong>N√§chster Lauf:</strong> ${formatDateTime(s.next_run)}</div>` : ''}
                                ${s.last_run ? `<div><strong>Letzter Lauf:</strong> ${formatDateTime(s.last_run)} (${s.last_status || 'unbekannt'})</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                statusContainer.innerHTML = `<div class="info-box" style="color: #e57373;">Fehler: ${error.message}</div>`;
                listContainer.innerHTML = '';
            }
        }

        function formatInterval(interval) {
            const intervals = {
                'hourly': 'St√ºndlich',
                'daily': 'T√§glich',
                'weekly': 'W√∂chentlich'
            };
            return intervals[interval] || interval;
        }

        async function createSchedule() {
            const interval = document.getElementById('schedule-interval').value;
            const hour = parseInt(document.getElementById('schedule-hour').value);
            const weekday = parseInt(document.getElementById('schedule-weekday').value);
            const timeframe = document.getElementById('schedule-timeframe').value;
            const lookback = parseInt(document.getElementById('schedule-lookback').value);
            const trainHmm = document.getElementById('schedule-train-hmm').checked;
            const trainScorer = document.getElementById('schedule-train-scorer').checked;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interval: interval,
                        custom_hour: hour,
                        custom_weekday: weekday,
                        timeframe: timeframe,
                        lookback_days: lookback,
                        train_hmm: trainHmm,
                        train_scorer: trainScorer,
                        symbols: null,  // null = all symbols
                        enabled: true
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showToast('Schedule erstellt', 'success');
                    loadSchedulerStatus();
                } else {
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function toggleSchedule(scheduleId, enabled) {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules/${scheduleId}/toggle?enabled=${enabled}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    showToast(`Schedule ${enabled ? 'aktiviert' : 'pausiert'}`, 'success');
                    loadSchedulerStatus();
                } else {
                    const data = await response.json();
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function triggerSchedule(scheduleId) {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules/${scheduleId}/trigger`, {
                    method: 'POST'
                });
                if (response.ok) {
                    showToast('Training wird innerhalb 1 Minute gestartet', 'success');
                } else {
                    const data = await response.json();
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm(`Schedule "${scheduleId}" wirklich l√∂schen?`)) return;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    showToast('Schedule gel√∂scht', 'success');
                    loadSchedulerStatus();
                } else {
                    const data = await response.json();
                    showToast(`Fehler: ${data.detail || 'Unbekannt'}`, 'error');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // ==================== Self-Learning Functions ====================

        let hmmSelfLearningEnabled = true;
        let hmmRetrainPollingInterval = null;

        async function toggleHmmSelfLearning() {
            const btn = document.getElementById('hmm-selflearn-toggle-btn');
            const newState = !hmmSelfLearningEnabled;

            try {
                // Update on HMM Inference service (accuracy tracker config)
                const inferenceResponse = await fetch('/hmm/api/v1/self-learning/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: newState })
                });

                // Update on HMM Train service (self-learning monitor)
                const trainResponse = await fetch(`${TRAIN_API_BASE}/self-learning/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: newState })
                });

                // Start/stop monitor
                if (newState) {
                    await fetch(`${TRAIN_API_BASE}/self-learning/start`, { method: 'POST' });
                } else {
                    await fetch(`${TRAIN_API_BASE}/self-learning/stop`, { method: 'POST' });
                }

                hmmSelfLearningEnabled = newState;

                if (hmmSelfLearningEnabled) {
                    btn.innerHTML = '&#10004; Aktiviert';
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-purple');
                    showToast('Self-Learning aktiviert', 'success');
                } else {
                    btn.innerHTML = '&#10006; Deaktiviert';
                    btn.classList.remove('btn-purple');
                    btn.classList.add('btn-secondary');
                    showToast('Self-Learning deaktiviert', 'info');
                }
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function triggerHmmManualRetrain() {
            const btn = document.getElementById('hmm-selflearn-manual-btn');
            const progressDiv = document.getElementById('hmm-selflearn-retrain-progress');

            btn.disabled = true;
            btn.innerHTML = '&#9203; Training wird gestartet...';
            progressDiv.style.display = 'block';

            try {
                // Start HMM training via the training service
                const response = await fetch(`${TRAIN_API_BASE}/train/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'hmm',
                        symbols: [],
                        train_scorer: true
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to start training');
                }

                const data = await response.json();
                const jobId = data.job_id;

                showToast('Training gestartet', 'success');

                // Start polling for progress
                hmmRetrainPollingInterval = setInterval(async () => {
                    await pollHmmTrainingProgress(jobId);
                }, 2000);

            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '&#9881; Manuell trainieren';
                progressDiv.style.display = 'none';
            }
        }

        async function pollHmmTrainingProgress(jobId) {
            try {
                const response = await fetch(`${TRAIN_API_BASE}/train/status/${jobId}`);
                if (!response.ok) throw new Error('Status not available');

                const data = await response.json();
                const progress = data.progress || 0;
                const status = data.status || 'unknown';
                const currentSymbol = data.current_symbol || '';

                document.getElementById('hmm-selflearn-retrain-progress-bar').style.width = `${progress}%`;
                document.getElementById('hmm-selflearn-retrain-progress-text').textContent = `${Math.round(progress)}%`;
                document.getElementById('hmm-selflearn-retrain-status').textContent = `Training: ${status}`;
                document.getElementById('hmm-selflearn-retrain-details').textContent = currentSymbol ? `Aktuell: ${currentSymbol}` : '';

                if (status === 'completed' || status === 'failed') {
                    clearInterval(hmmRetrainPollingInterval);
                    hmmRetrainPollingInterval = null;

                    const btn = document.getElementById('hmm-selflearn-manual-btn');
                    btn.disabled = false;
                    btn.innerHTML = '&#9881; Manuell trainieren';

                    if (status === 'completed') {
                        showToast('Training erfolgreich abgeschlossen', 'success');
                        // Reload stats
                        loadHmmSelfLearningStats();
                        loadHmmDeploymentHistory();
                    } else {
                        showToast('Training fehlgeschlagen', 'error');
                    }

                    setTimeout(() => {
                        document.getElementById('hmm-selflearn-retrain-progress').style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        async function loadHmmSelfLearningStats() {
            try {
                // Load accuracy stats from HMM Inference service
                const accuracyResponse = await fetch('/hmm/api/v1/accuracy/stats');
                let accuracyData = null;
                if (accuracyResponse.ok) {
                    accuracyData = await accuracyResponse.json();
                }

                // Load self-learning status from HMM Train service
                const slResponse = await fetch(`${TRAIN_API_BASE}/self-learning/status`);
                let slData = null;
                if (slResponse.ok) {
                    slData = await slResponse.json();
                }

                // Load deployment history for stats
                const histResponse = await fetch(`${TRAIN_API_BASE}/models/deployment-history`);
                let deployments = 0;
                let rollbacks = 0;
                let totalRetrains = 0;

                if (histResponse.ok) {
                    const histData = await histResponse.json();
                    const history = histData.history || [];
                    totalRetrains = history.length;

                    history.forEach(item => {
                        if (item.action === 'deployed') deployments++;
                        if (item.action === 'rejected' || item.action === 'rolled_back') rollbacks++;
                    });
                }

                // Update stats display
                document.getElementById('hmm-sl-stat-total-retrains').textContent = totalRetrains;
                document.getElementById('hmm-sl-stat-deployments').textContent = deployments;
                document.getElementById('hmm-sl-stat-rollbacks').textContent = rollbacks;

                // Update accuracy from accuracy tracker
                if (accuracyData && accuracyData.global) {
                    const acc = accuracyData.global.rolling_accuracy;
                    document.getElementById('hmm-sl-stat-accuracy').textContent = acc > 0 ? `${(acc * 100).toFixed(1)}%` : '-';

                    // Update self-learning enabled state
                    if (accuracyData.self_learning) {
                        hmmSelfLearningEnabled = accuracyData.self_learning.enabled;
                        const btn = document.getElementById('hmm-selflearn-toggle-btn');
                        if (hmmSelfLearningEnabled) {
                            btn.innerHTML = '&#10004; Aktiviert';
                            btn.classList.remove('btn-secondary');
                            btn.classList.add('btn-purple');
                        } else {
                            btn.innerHTML = '&#10006; Deaktiviert';
                            btn.classList.remove('btn-purple');
                            btn.classList.add('btn-secondary');
                        }

                        // Update threshold/cooldown selects
                        const thresholdSelect = document.getElementById('hmm-sl-threshold-select');
                        const closestThreshold = findClosestOption(thresholdSelect, accuracyData.self_learning.accuracy_threshold);
                        if (closestThreshold) thresholdSelect.value = closestThreshold;

                        const cooldownSelect = document.getElementById('hmm-sl-cooldown-select');
                        const closestCooldown = findClosestOption(cooldownSelect, accuracyData.self_learning.cooldown_hours);
                        if (closestCooldown) cooldownSelect.value = closestCooldown;
                    }
                }

                // Update threshold display
                const threshold = document.getElementById('hmm-sl-threshold-select').value;
                document.getElementById('hmm-sl-stat-threshold').textContent = `${Math.round(threshold * 100)}%`;

                const cooldown = document.getElementById('hmm-sl-cooldown-select').value;
                document.getElementById('hmm-sl-stat-cooldown').textContent = `${cooldown}h`;

            } catch (error) {
                console.error('Error loading self-learning stats:', error);
            }
        }

        function findClosestOption(selectElement, value) {
            let closest = null;
            let minDiff = Infinity;
            for (const option of selectElement.options) {
                const diff = Math.abs(parseFloat(option.value) - value);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = option.value;
                }
            }
            return closest;
        }

        async function loadHmmDeploymentHistory() {
            const tbody = document.getElementById('hmm-deployment-tbody');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/deployment-history`);
                if (!response.ok) throw new Error('Failed to load history');

                const data = await response.json();
                const history = data.history || [];

                // Filter: only show deployed, rejected, rolled_back (not pending_review)
                const relevantActions = ['deployed', 'rejected', 'rolled_back', 'first_model'];
                const filtered = history.filter(h => relevantActions.includes(h.action));

                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #666;">Keine Deployment-Historie vorhanden</td></tr>`;
                    return;
                }

                // Group HMM entries by version_id, keep Scorer separate
                const grouped = {};
                const scorerEntries = [];

                filtered.forEach(item => {
                    if (item.model_type === 'scorer') {
                        scorerEntries.push(item);
                    } else {
                        const vid = item.version_id || 'unknown';
                        if (!grouped[vid]) {
                            grouped[vid] = {
                                timestamp: item.timestamp,
                                version_id: vid,
                                deployed: [], rejected: [], pending: []
                            };
                        }
                        if (item.action === 'deployed') grouped[vid].deployed.push(item.symbol);
                        else if (item.action === 'rejected') grouped[vid].rejected.push(item.symbol);
                    }
                });

                // Build rows
                let rows = [];

                // Scorer entries first (with full metrics)
                scorerEntries.forEach(item => {
                    const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString('de-CH', {
                        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                    }) : '-';

                    const comp = item.comparison_result || {};
                    const candMetrics = comp.candidate_metrics || {};
                    const accuracy = candMetrics.accuracy ? (candMetrics.accuracy * 100).toFixed(1) + '%' : '-';
                    const f1 = candMetrics.f1_weighted ? (candMetrics.f1_weighted * 100).toFixed(1) + '%' : '-';

                    const actionBadge = item.action === 'deployed'
                        ? '<span style="background: rgba(76,175,80,0.2); color: #81c784; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Deploy</span>'
                        : '<span style="background: rgba(244,67,54,0.2); color: #e57373; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úó Reject</span>';

                    rows.push(`<tr>
                        <td style="font-size: 0.85rem;">${timestamp}</td>
                        <td><span style="background: rgba(167,139,250,0.2); color: #a78bfa; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem;">Scorer</span></td>
                        <td>${actionBadge}</td>
                        <td>${accuracy}</td>
                        <td>${f1}</td>
                    </tr>`);
                });

                // Grouped HMM entries
                Object.values(grouped).forEach(g => {
                    const timestamp = g.timestamp ? new Date(g.timestamp).toLocaleString('de-CH', {
                        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                    }) : '-';

                    const deployed = g.deployed.length;
                    const rejected = g.rejected.length;
                    const total = deployed + rejected;

                    let statusHtml = '';
                    if (deployed > 0) {
                        statusHtml += `<span style="color: #81c784;">${deployed} deployed</span>`;
                    }
                    if (rejected > 0) {
                        if (statusHtml) statusHtml += ', ';
                        statusHtml += `<span style="color: #e57373;">${rejected} rejected</span>`;
                    }

                    rows.push(`<tr>
                        <td style="font-size: 0.85rem;">${timestamp}</td>
                        <td><span style="background: rgba(100,200,255,0.2); color: #64c8ff; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem;">HMM</span> <span style="opacity: 0.7; font-size: 0.8rem;">${total} Symbole</span></td>
                        <td>${statusHtml}</td>
                        <td colspan="2" style="font-size: 0.8rem; opacity: 0.7;">Pro Symbol validiert</td>
                    </tr>`);
                });

                tbody.innerHTML = rows.join('');

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #e57373;">Fehler beim Laden: ${error.message}</td></tr>`;
            }
        }

        async function loadHmmModelVersions() {
            const tbody = document.getElementById('hmm-versions-tbody');

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/versions`);
                if (!response.ok) throw new Error('Failed to load versions');

                const data = await response.json();
                const versions = data.versions || [];

                if (versions.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #666;">Keine Modell-Versionen vorhanden</td></tr>`;
                    return;
                }

                // Group by version_id, separate Scorer and HMM
                const grouped = {};
                const scorerVersions = [];

                versions.forEach(v => {
                    if (v.model_type === 'scorer') {
                        scorerVersions.push(v);
                    } else {
                        const vid = v.version_id || 'unknown';
                        if (!grouped[vid]) {
                            grouped[vid] = {
                                version_id: vid,
                                created_at: v.created_at,
                                samples_total: 0,
                                production: [], candidate: [], rejected: [], archived: []
                            };
                        }
                        grouped[vid].samples_total += v.samples_used || 0;
                        const status = v.status || 'archived';
                        if (grouped[vid][status]) {
                            grouped[vid][status].push(v.symbol);
                        }
                    }
                });

                let rows = [];

                // Scorer versions first (with full details)
                scorerVersions.sort((a, b) => {
                    if (a.status === 'production') return -1;
                    if (b.status === 'production') return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                scorerVersions.forEach(v => {
                    const created = v.created_at ? new Date(v.created_at).toLocaleString('de-CH', {
                        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                    }) : '-';
                    const samples = v.samples_used ? v.samples_used.toLocaleString() : '-';

                    const statusBadge = v.status === 'production'
                        ? '<span style="background: rgba(76,175,80,0.2); color: #81c784; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Produktion</span>'
                        : '<span style="background: rgba(244,67,54,0.2); color: #e57373; padding: 0.2rem 0.5rem; border-radius: 4px;">Archiv</span>';

                    rows.push(`<tr>
                        <td><span style="background: rgba(167,139,250,0.2); color: #a78bfa; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem;">Scorer</span></td>
                        <td style="font-size: 0.85rem;">${created}</td>
                        <td style="font-size: 0.85rem;">${samples}</td>
                        <td>${statusBadge}</td>
                        <td style="font-size: 0.8rem; opacity: 0.7;">Global</td>
                    </tr>`);
                });

                // Grouped HMM versions
                const groupedArr = Object.values(grouped).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                groupedArr.forEach(g => {
                    const created = g.created_at ? new Date(g.created_at).toLocaleString('de-CH', {
                        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                    }) : '-';
                    const samples = g.samples_total ? g.samples_total.toLocaleString() : '-';

                    // Summary status
                    let statusParts = [];
                    if (g.production.length > 0) statusParts.push(`<span style="color: #81c784;">${g.production.length} prod</span>`);
                    if (g.candidate.length > 0) statusParts.push(`<span style="color: #64c8ff;">${g.candidate.length} kand</span>`);
                    if (g.rejected.length > 0) statusParts.push(`<span style="color: #e57373;">${g.rejected.length} rej</span>`);

                    const total = g.production.length + g.candidate.length + g.rejected.length + g.archived.length;
                    const statusSummary = statusParts.length > 0 ? statusParts.join(', ') : '<span style="opacity: 0.5;">-</span>';

                    rows.push(`<tr>
                        <td><span style="background: rgba(100,200,255,0.2); color: #64c8ff; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem;">HMM</span></td>
                        <td style="font-size: 0.85rem;">${created}</td>
                        <td style="font-size: 0.85rem;">${samples}</td>
                        <td>${statusSummary}</td>
                        <td style="font-size: 0.8rem; opacity: 0.7;">${total} Symbole</td>
                    </tr>`);
                });

                tbody.innerHTML = rows.join('');

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #e57373;">Fehler beim Laden: ${error.message}</td></tr>`;
            }
        }

        async function rollbackToVersion(versionId) {
            if (!confirm(`M√∂chten Sie wirklich zu Version ${versionId} zur√ºckrollen?`)) return;

            try {
                const response = await fetch(`${TRAIN_API_BASE}/models/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_type: 'hmm',
                        target_version: versionId
                    })
                });

                if (!response.ok) throw new Error('Rollback failed');

                showToast('Rollback erfolgreich', 'success');
                loadHmmModelVersions();
                loadHmmDeploymentHistory();
                loadHmmSelfLearningStats();

            } catch (error) {
                showToast(`Rollback fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        async function updateHmmSelfLearnConfig() {
            const threshold = parseFloat(document.getElementById('hmm-sl-threshold-select').value);
            document.getElementById('hmm-sl-stat-threshold').textContent = `${Math.round(threshold * 100)}%`;

            try {
                // Update on HMM Inference service
                await fetch('/hmm/api/v1/self-learning/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accuracy_threshold: threshold })
                });
                showToast(`Accuracy-Schwelle auf ${Math.round(threshold * 100)}% gesetzt`, 'success');
            } catch (error) {
                showToast(`Fehler beim Speichern: ${error.message}`, 'error');
            }
        }

        async function updateHmmSelfLearnCooldown() {
            const cooldown = parseInt(document.getElementById('hmm-sl-cooldown-select').value);
            document.getElementById('hmm-sl-stat-cooldown').textContent = `${cooldown}h`;

            try {
                // Update on HMM Inference service
                await fetch('/hmm/api/v1/self-learning/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cooldown_hours: cooldown })
                });
                showToast(`Cooldown auf ${cooldown} Stunden gesetzt`, 'success');
            } catch (error) {
                showToast(`Fehler beim Speichern: ${error.message}`, 'error');
            }
        }

        // Show/hide weekday selector based on interval
        document.addEventListener('DOMContentLoaded', () => {
            const intervalSelect = document.getElementById('schedule-interval');
            if (intervalSelect) {
                intervalSelect.addEventListener('change', () => {
                    const weekdayGroup = document.getElementById('weekday-group');
                    weekdayGroup.style.display = intervalSelect.value === 'weekly' ? 'block' : 'none';
                });
            }
        });

        // Load all symbols from Data Service and populate dropdowns
        async function loadAllSymbols() {
            try {
                const response = await fetch('/data/api/v1/db/coverage');
                if (!response.ok) throw new Error('Failed to load symbols');

                const data = await response.json();
                const categories = data.categories || {};

                // Build grouped options HTML
                const order = ['Krypto', 'Forex', 'Indizes', 'Rohstoffe', 'Aktien', 'Andere'];
                let optionsHtml = '';

                for (const category of order) {
                    const symbols = categories[category];
                    if (symbols && symbols.length > 0) {
                        optionsHtml += `<optgroup label="${category} (${symbols.length})">`;
                        for (const symbol of symbols) {
                            optionsHtml += `<option value="${symbol}">${symbol}</option>`;
                        }
                        optionsHtml += '</optgroup>';
                    }
                }

                // Populate all symbol dropdowns
                const dropdownIds = ['detect-symbol', 'score-symbol', 'align-symbol', 'train-symbol', 'history-symbol', 'reload-symbol', 'force-deploy-symbol', 'rollback-symbol'];
                const placeholderHtml = '<option value="" disabled selected>-- Symbol w√§hlen --</option>';
                for (const id of dropdownIds) {
                    const dropdown = document.getElementById(id);
                    if (dropdown) {
                        const currentValue = dropdown.value;
                        dropdown.innerHTML = placeholderHtml + optionsHtml;
                        // Restore previous selection if exists, otherwise keep placeholder
                        if (currentValue && dropdown.querySelector(`option[value="${currentValue}"]`)) {
                            dropdown.value = currentValue;
                        }
                    }
                }

                // Also populate version filter dropdown
                const versionFilterSymbol = document.getElementById('version-filter-symbol');
                if (versionFilterSymbol) {
                    versionFilterSymbol.innerHTML = '<option value="">Alle Symbole</option>' + optionsHtml;
                }

                console.log(`Loaded ${Object.values(categories).flat().length} symbols from Data Service`);
            } catch (error) {
                console.warn('Could not load symbols from Data Service:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInfo();
            loadFeatures();
            loadMetricsHistory();  // Load learning progress chart
            loadAllSymbols();  // Load symbols for dropdowns

            // Auto-refresh every 30 seconds
            setInterval(loadInfo, 30000);

            // Load validation status when tab is shown
            const validationTabBtn = document.querySelector('.tab-btn:nth-child(5)');
            if (validationTabBtn) {
                validationTabBtn.addEventListener('click', () => {
                    loadValidationStatus();
                });
            }

            // Load scheduler status when tab is shown
            const schedulingTabBtn = document.querySelector('.tab-btn:nth-child(6)');
            if (schedulingTabBtn) {
                schedulingTabBtn.addEventListener('click', () => {
                    loadSchedulerStatus();
                });
            }
        });
    </script>
</body>
</html>
