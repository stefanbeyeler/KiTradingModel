<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Service - Konfiguration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .service-badge {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #a0a0a0;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
        }

        .tab-btn.active {
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
            border-bottom: 2px solid #64c8ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.2rem;
            color: #64c8ff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #64c8ff;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.6rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #e8e8e8;
            font-size: 0.9rem;
        }

        .search-box::placeholder {
            color: #888;
        }

        .filter-select {
            padding: 0.6rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #e8e8e8;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .filter-select option {
            background: #1a1a2e;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .btn-success {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .btn-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .btn-warning:hover {
            background: rgba(255, 152, 0, 0.3);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Symbol-Verwaltung Tabelle - dynamische Höhe */
        #symbols-table-container {
            max-height: calc(100vh - 380px);
            min-height: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            background: rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            font-weight: 500;
            color: #a0a0a0;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-crypto { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .badge-forex { background: rgba(33, 150, 243, 0.2); color: #64b5f6; }
        .badge-index { background: rgba(156, 39, 176, 0.2); color: #ce93d8; }
        .badge-commodity { background: rgba(158, 158, 158, 0.2); color: #bdbdbd; }
        .badge-stock { background: rgba(76, 175, 80, 0.2); color: #81c784; }
        .badge-etf { background: rgba(0, 188, 212, 0.2); color: #4dd0e1; }
        .badge-other { background: rgba(121, 85, 72, 0.2); color: #a1887f; }
        .badge-active { background: rgba(76, 175, 80, 0.2); color: #81c784; }
        .badge-inactive { background: rgba(158, 158, 158, 0.2); color: #9e9e9e; }

        /* Star for favorites */
        .favorite-star {
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .favorite-star:hover {
            transform: scale(1.2);
        }

        .favorite-star.active {
            color: #ffc107;
        }

        .favorite-star:not(.active) {
            color: #555;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.3rem;
            color: #64c8ff;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #fff;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #a0a0a0;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #e8e8e8;
            font-size: 0.9rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #64c8ff;
        }

        .form-select option {
            background: #1a1a2e;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success { background: #2e7d32; }
        .toast-error { background: #c62828; }
        .toast-info { background: #1565c0; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(100, 200, 255, 0.3);
            border-radius: 50%;
            border-top-color: #64c8ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Strategy card */
        .strategy-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid #64c8ff;
        }

        .strategy-card.default {
            border-left-color: #81c784;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .strategy-name {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .strategy-badges {
            display: flex;
            gap: 0.5rem;
        }

        .strategy-desc {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.75rem;
        }

        .strategy-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
            color: #a0a0a0;
        }

        .strategy-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        /* Risk level colors */
        .risk-low { color: #81c784; }
        .risk-moderate { color: #ffb74d; }
        .risk-high { color: #e57373; }
        .risk-aggressive { color: #f44336; }

        /* Cache Categories Grid */
        .cache-categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .cache-category-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            border-left: 3px solid #64c8ff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cache-category-card:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .cache-category-card.empty {
            border-left-color: #555;
            opacity: 0.6;
        }

        .cache-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .cache-category-name {
            font-size: 1rem;
            font-weight: 500;
            text-transform: uppercase;
            color: #64c8ff;
        }

        .cache-category-ttl {
            font-size: 0.75rem;
            color: #888;
            background: rgba(100, 200, 255, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .cache-category-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .cache-stat-item {
            text-align: center;
        }

        .cache-stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e8e8e8;
        }

        .cache-stat-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        .cache-symbols-preview {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        .cache-symbols-preview .symbol-tag {
            display: inline-block;
            background: rgba(100, 200, 255, 0.1);
            color: #64c8ff;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin: 0.1rem;
            font-size: 0.7rem;
        }

        .cache-timeframes-row {
            margin-top: 0.5rem;
        }

        .cache-timeframes-row .tf-tag {
            display: inline-block;
            background: rgba(76, 175, 80, 0.15);
            color: #81c784;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin: 0.1rem;
            font-size: 0.7rem;
        }

        /* Cache status indicator */
        .cache-status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .cache-status-indicator.connected {
            background: #81c784;
            box-shadow: 0 0 8px rgba(129, 199, 132, 0.5);
        }

        .cache-status-indicator.disconnected {
            background: #e57373;
            box-shadow: 0 0 8px rgba(229, 115, 115, 0.5);
        }

        footer {
            text-align: center;
            padding: 2rem;
            opacity: 0.5;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="back-link">&#8592; Zurück zum Dashboard</a>
            <span class="header-title">Data Service Konfiguration</span>
            <span class="service-badge">Port 3001</span>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="symbols">Symbole</button>
            <button class="tab-btn" data-tab="indicators">Indikatoren</button>
            <button class="tab-btn" data-tab="explorer">Daten-Explorer</button>
            <button class="tab-btn" data-tab="strategies">Trading-Strategien</button>
            <button class="tab-btn" data-tab="external">External Sources</button>
            <button class="tab-btn" data-tab="mt5logs">MT5 Logs</button>
            <button class="tab-btn" data-tab="cache">Cache</button>
            <button class="tab-btn" data-tab="export">Export / Import</button>
        </div>

        <!-- Symbols Tab -->
        <div id="symbols-tab" class="tab-content active">
            <div class="stats-bar" id="symbol-stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-symbols">-</div>
                    <div class="stat-label">Gesamt</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="active-symbols">-</div>
                    <div class="stat-label">Aktiv</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="favorite-symbols">-</div>
                    <div class="stat-label">Favoriten</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="crypto-count">-</div>
                    <div class="stat-label">Crypto</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="forex-count">-</div>
                    <div class="stat-label">Forex</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="index-count">-</div>
                    <div class="stat-label">Indices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="commodity-count">-</div>
                    <div class="stat-label">Commodities</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stock-count">-</div>
                    <div class="stat-label">Stocks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="etf-count">-</div>
                    <div class="stat-label">ETFs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="other-count">-</div>
                    <div class="stat-label">Andere</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Symbol-Verwaltung</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="openImportModal('easyinsight')">EasyInsight Import</button>
                        <button class="btn btn-info" onclick="openImportModal('twelvedata')" style="background: #17a2b8;">Twelve Data Import</button>
                        <button class="btn btn-primary" onclick="openSymbolModal()">+ Neues Symbol</button>
                    </div>
                </div>

                <div class="toolbar">
                    <input type="text" class="search-box" id="symbol-search" placeholder="Symbol suchen..." oninput="filterSymbols()">
                    <select class="filter-select" id="category-filter" onchange="updateSubcategoryFilter(); filterSymbols()">
                        <option value="">Alle Kategorien</option>
                        <option value="crypto">Crypto</option>
                        <option value="forex">Forex</option>
                        <option value="index">Indices</option>
                        <option value="commodity">Metals/Commodities</option>
                        <option value="stock">Stocks</option>
                        <option value="etf">ETFs</option>
                        <option value="other">Andere</option>
                    </select>
                    <select class="filter-select" id="subcategory-filter" onchange="filterSymbols()">
                        <option value="">Alle Sub-Kategorien</option>
                    </select>
                    <select class="filter-select" id="status-filter" onchange="filterSymbols()">
                        <option value="">Alle Status</option>
                        <option value="active">Aktiv</option>
                        <option value="inactive">Inaktiv</option>
                    </select>
                    <label class="form-checkbox">
                        <input type="checkbox" id="favorites-only" onchange="filterSymbols()">
                        <span>Nur Favoriten</span>
                    </label>
                    <button class="btn btn-secondary btn-sm" onclick="clearFilters()" title="Filter zurücksetzen">✕ Filter</button>
                </div>

                <div class="table-container" id="symbols-table-container">
                    <table id="symbols-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Symbol</th>
                                <th>API-Symbole / Aliase</th>
                                <th>Kategorie</th>
                                <th>Sub-Kategorie</th>
                                <th>Beschreibung</th>
                                <th>Status</th>
                                <th>Datenpunkte</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="symbols-body">
                            <tr><td colspan="9" class="loading"><div class="spinner"></div><br>Lade Symbole...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Indicators Tab -->
        <div id="indicators-tab" class="tab-content">
            <div class="stats-bar" id="indicator-stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-indicators">-</div>
                    <div class="stat-label">Gesamt</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="enabled-indicators">-</div>
                    <div class="stat-label">Aktiv</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="twelvedata-indicators">-</div>
                    <div class="stat-label">TwelveData</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="easyinsight-indicators">-</div>
                    <div class="stat-label">EasyInsight</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Indikator-Register</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="loadIndicators()">Aktualisieren</button>
                    </div>
                </div>

                <div class="toolbar">
                    <input type="text" class="search-box" id="indicator-search" placeholder="Indikator suchen..." oninput="filterIndicators()">
                    <select class="filter-select" id="indicator-category-filter" onchange="filterIndicators()">
                        <option value="">Alle Kategorien</option>
                        <option value="trend">Trend / Moving Averages</option>
                        <option value="momentum">Momentum</option>
                        <option value="volatility">Volatilität</option>
                        <option value="volume">Volumen</option>
                        <option value="trend_filter">Trend-Filter</option>
                        <option value="price_transform">Price Transform</option>
                        <option value="ml_features">ML Features</option>
                        <option value="pattern">Pattern</option>
                    </select>
                    <select class="filter-select" id="indicator-source-filter" onchange="filterIndicators()">
                        <option value="">Alle Quellen</option>
                        <option value="twelvedata">TwelveData</option>
                        <option value="easyinsight">EasyInsight</option>
                    </select>
                    <select class="filter-select" id="indicator-status-filter" onchange="filterIndicators()">
                        <option value="">Alle Status</option>
                        <option value="enabled">Aktiv</option>
                        <option value="disabled">Inaktiv</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="clearIndicatorFilters()" title="Filter zurücksetzen">✕ Filter</button>
                </div>

                <div class="table-container" id="indicators-table-container" style="max-height: calc(100vh - 400px); min-height: 300px;">
                    <table id="indicators-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Status</th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Kategorie</th>
                                <th>TwelveData</th>
                                <th>EasyInsight</th>
                                <th>Beschreibung</th>
                                <th style="width: 80px;">Details</th>
                            </tr>
                        </thead>
                        <tbody id="indicators-body">
                            <tr><td colspan="8" class="loading"><div class="spinner"></div><br>Lade Indikatoren...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Indicator Detail Modal -->
        <div class="modal-overlay" id="indicator-detail-modal">
            <div class="modal" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="indicator-detail-title">Indikator-Details</h3>
                    <button class="modal-close" onclick="closeIndicatorDetailModal()">&times;</button>
                </div>
                <div id="indicator-detail-content">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Strategies Tab -->
        <div id="strategies-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Trading-Strategien</h2>
                    <button class="btn btn-primary" onclick="openStrategyModal()">+ Neue Strategie</button>
                </div>

                <div id="strategies-list">
                    <div class="loading"><div class="spinner"></div><br>Lade Strategien...</div>
                </div>
            </div>
        </div>

        <!-- Cache Tab -->
        <div id="cache-tab" class="tab-content">
            <!-- Cache Status Bar -->
            <div class="stats-bar" id="cache-stats">
                <div class="stat-item">
                    <div class="stat-value" id="cache-backend">-</div>
                    <div class="stat-label">Backend</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-total-entries">-</div>
                    <div class="stat-label">Einträge</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-total-symbols">-</div>
                    <div class="stat-label">Symbole</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-hit-rate">-</div>
                    <div class="stat-label">Hit Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-memory">-</div>
                    <div class="stat-label">Speicher</div>
                </div>
            </div>

            <!-- Cache Overview Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Cache-Übersicht</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="loadCacheOverview()">Aktualisieren</button>
                        <button class="btn btn-danger" onclick="confirmClearAllCache()">Cache leeren</button>
                    </div>
                </div>

                <div id="cache-overview-content">
                    <div class="loading"><div class="spinner"></div><br>Lade Cache-Übersicht...</div>
                </div>
            </div>

            <!-- Cache Categories Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Cache nach Kategorien</h2>
                </div>

                <div class="cache-categories-grid" id="cache-categories">
                    <!-- Categories will be populated dynamically -->
                </div>
            </div>

            <!-- Cache Details Card -->
            <div class="card" id="cache-details-card" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">Kategorie-Details: <span id="cache-detail-category">-</span></h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-danger btn-sm" onclick="clearSelectedCategory()">Kategorie leeren</button>
                        <button class="btn btn-secondary btn-sm" onclick="hideCacheDetails()">Schließen</button>
                    </div>
                </div>

                <div class="table-container" style="max-height: 400px;">
                    <table id="cache-entries-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Timeframe</th>
                                <th>TTL verbleibend</th>
                                <th>Key</th>
                            </tr>
                        </thead>
                        <tbody id="cache-entries-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pre-Fetching Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Pre-Fetching für ML-Services</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="prefetch-status-badge" class="service-badge" style="background: rgba(158, 158, 158, 0.2); color: #bbb;">Unbekannt</span>
                        <button class="btn btn-primary btn-sm" onclick="loadPrefetchStatus()">Aktualisieren</button>
                    </div>
                </div>

                <!-- Prefetch Stats Bar -->
                <div class="stats-bar" id="prefetch-stats" style="margin-top: 1rem;">
                    <div class="stat-item">
                        <div class="stat-value" id="prefetch-last-run">-</div>
                        <div class="stat-label">Letzter Lauf</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="prefetch-total-runs">-</div>
                        <div class="stat-label">Durchläufe</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="prefetch-symbols">-</div>
                        <div class="stat-label">Symbole</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="prefetch-entries">-</div>
                        <div class="stat-label">Cache-Einträge</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="prefetch-errors">-</div>
                        <div class="stat-label">Fehler</div>
                    </div>
                </div>

                <!-- Prefetch Configuration -->
                <div style="padding: 1rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #64c8ff;">Konfiguration</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-success btn-sm" id="prefetch-start-btn" onclick="startPrefetch()">Starten</button>
                                <button class="btn btn-warning btn-sm" id="prefetch-stop-btn" onclick="stopPrefetch()">Stoppen</button>
                                <button class="btn btn-primary btn-sm" onclick="triggerPrefetch()">Jetzt ausführen</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Intervall (Sekunden)</label>
                            <input type="number" class="form-input" id="prefetch-interval" value="300" min="60" max="3600">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max. Symbole</label>
                            <input type="number" class="form-input" id="prefetch-max-symbols" value="50" min="1" max="200">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Timeframes</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <label class="form-checkbox"><input type="checkbox" id="pf-tf-1h" checked><span>1h</span></label>
                                <label class="form-checkbox"><input type="checkbox" id="pf-tf-4h" checked><span>4h</span></label>
                                <label class="form-checkbox"><input type="checkbox" id="pf-tf-1day" checked><span>1day</span></label>
                                <label class="form-checkbox"><input type="checkbox" id="pf-tf-15min"><span>15min</span></label>
                                <label class="form-checkbox"><input type="checkbox" id="pf-tf-1week"><span>1week</span></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Optionen</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                <label class="form-checkbox"><input type="checkbox" id="pf-favorites-only"><span>Nur Favoriten</span></label>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="savePrefetchConfig()">Konfiguration speichern</button>
                    </div>
                </div>

                <!-- Info Box -->
                <div style="padding: 0 1rem 1rem 1rem;">
                    <div style="background: rgba(100, 200, 255, 0.1); border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 8px; padding: 1rem;">
                        <div style="font-weight: 600; color: #64c8ff; margin-bottom: 0.5rem;">Optimiert für nachgelagerte ML-Services</div>
                        <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; color: #bbb;">
                            <li><strong>NHITS:</strong> Benötigt H1, D1 für Price Forecasting</li>
                            <li><strong>TCN:</strong> Benötigt M15-D1 für Pattern-Erkennung</li>
                            <li><strong>HMM:</strong> Benötigt H1, H4, D1 für Regime-Detection</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- External Sources Tab -->
        <div id="external-tab" class="tab-content">
            <div class="stats-bar" id="external-stats">
                <div class="stat-item">
                    <div class="stat-value" id="external-total-sources">9</div>
                    <div class="stat-label">Datenquellen</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="external-available">-</div>
                    <div class="stat-label">Verfügbar</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="external-last-fetch">-</div>
                    <div class="stat-label">Letzter Abruf</div>
                </div>
            </div>

            <!-- Source Selection -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">External Data Sources</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="fetchAllExternalSources()">Alle abrufen</button>
                        <button class="btn btn-primary" onclick="fetchTradingContext()">Trading Context</button>
                    </div>
                </div>
                <div style="padding: 1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Symbol (optional)</label>
                            <select class="form-select" id="external-symbol">
                                <option value="">Alle / Kein Symbol</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Datenquelle</label>
                            <select class="form-select" id="external-source-select" onchange="updateExternalSourceOptions()">
                                <option value="economic-calendar">Economic Calendar</option>
                                <option value="sentiment">Sentiment</option>
                                <option value="onchain">On-Chain</option>
                                <option value="orderbook">Orderbook</option>
                                <option value="macro">Macro</option>
                                <option value="historical-patterns">Historical Patterns</option>
                                <option value="technical-levels">Technical Levels</option>
                                <option value="regulatory">Regulatory</option>
                                <option value="easyinsight">EasyInsight</option>
                                <option value="correlations">Correlations</option>
                                <option value="volatility-regime">Volatility Regime</option>
                                <option value="institutional-flow">Institutional Flow</option>
                            </select>
                        </div>
                    </div>

                    <!-- Source-specific options -->
                    <div id="external-source-options">
                        <!-- Economic Calendar Options -->
                        <div id="options-economic-calendar" class="source-options">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tage voraus</label>
                                    <select class="form-select" id="ec-days-ahead">
                                        <option value="1">1 Tag</option>
                                        <option value="3">3 Tage</option>
                                        <option value="7" selected>7 Tage</option>
                                        <option value="14">14 Tage</option>
                                        <option value="30">30 Tage</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ec-high-impact" checked><span>Nur High Impact</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sentiment Options -->
                        <div id="options-sentiment" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="sent-fear-greed" checked><span>Fear & Greed</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="sent-social" checked><span>Social Media</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="sent-vix" checked><span>VIX</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- On-Chain Options -->
                        <div id="options-onchain" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="oc-whale" checked><span>Whale Alerts</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="oc-exchange" checked><span>Exchange Flows</span></label>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: #ffc107; margin-top: 0.5rem;">Hinweis: Symbol erforderlich (z.B. BTCUSD)</div>
                        </div>

                        <!-- Orderbook Options -->
                        <div id="options-orderbook" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tiefe</label>
                                    <select class="form-select" id="ob-depth">
                                        <option value="20">20</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ob-liquidations" checked><span>Liquidations</span></label>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: #ffc107; margin-top: 0.5rem;">Hinweis: Symbol erforderlich</div>
                        </div>

                        <!-- Macro Options -->
                        <div id="options-macro" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="macro-dxy" checked><span>DXY</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="macro-yields" checked><span>Bond Yields</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="macro-corr" checked><span>Korrelationen</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Historical Patterns Options -->
                        <div id="options-historical-patterns" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="hp-seasonality" checked><span>Saisonalität</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="hp-drawdowns" checked><span>Drawdowns</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Levels Options -->
                        <div id="options-technical-levels" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="tl-sr" checked><span>S/R Levels</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="tl-fib" checked><span>Fibonacci</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="tl-pivots" checked><span>Pivots</span></label>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: #ffc107; margin-top: 0.5rem;">Hinweis: Symbol erforderlich</div>
                        </div>

                        <!-- Regulatory Options -->
                        <div id="options-regulatory" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="reg-sec" checked><span>SEC</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="reg-etf" checked><span>ETF News</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EasyInsight Options -->
                        <div id="options-easyinsight" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ei-symbols" checked><span>Managed Symbols</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-logs" checked><span>MT5 Logs</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Correlations Options -->
                        <div id="options-correlations" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Zeitfenster</label>
                                    <select class="form-select" id="corr-timeframe">
                                        <option value="7d">7 Tage</option>
                                        <option value="30d" selected>30 Tage</option>
                                        <option value="90d">90 Tage</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="corr-matrix" checked><span>Matrix</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="corr-regime" checked><span>Regime</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Volatility Regime Options -->
                        <div id="options-volatility-regime" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="vol-vix" checked><span>VIX Analyse</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="vol-atr" checked><span>ATR Trend</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="vol-bbands" checked><span>Bollinger</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="vol-regime" checked><span>Regime</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Institutional Flow Options -->
                        <div id="options-institutional-flow" class="source-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Optionen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="inst-cot" checked><span>COT Report</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="inst-etf" checked><span>ETF Flows</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="inst-whale" checked><span>Whale Tracking</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="inst-13f"><span>13F Filings</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="fetchExternalSource()">Daten abrufen</button>
                        <button class="btn btn-secondary" onclick="clearExternalResults()">Ergebnisse löschen</button>
                    </div>
                </div>
            </div>

            <!-- Results Display -->
            <div class="card" id="external-results" style="display: none;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title" id="external-result-title">Ergebnisse</h2>
                    <div id="external-result-info" style="font-size: 0.85rem; color: #888;"></div>
                </div>
                <div id="external-result-content" style="padding: 1rem; max-height: 600px; overflow: auto;">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Loading State -->
            <div id="external-loading" style="display: none; text-align: center; padding: 3rem;">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #888;">Lade externe Daten...</p>
            </div>

            <!-- Error State -->
            <div id="external-error" style="display: none;" class="card">
                <div style="padding: 2rem; text-align: center; color: #f44336;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#9888;</div>
                    <p id="external-error-msg">Fehler beim Laden der Daten</p>
                </div>
            </div>

            <!-- Source Overview Cards -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Datenquellen-Übersicht</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; padding: 1rem;">
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #64c8ff;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #64c8ff;">Economic Calendar</strong>
                            <span class="badge badge-active" id="status-economic-calendar">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Fed, ECB, CPI, NFP, GDP Events</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('economic-calendar')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #ffc107;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #ffc107;">Sentiment</strong>
                            <span class="badge badge-active" id="status-sentiment">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Fear & Greed, Social Media, VIX</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('sentiment')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #81c784;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #81c784;">On-Chain</strong>
                            <span class="badge badge-active" id="status-onchain">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Whale Alerts, Exchange Flows</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('onchain')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #ce93d8;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #ce93d8;">Orderbook</strong>
                            <span class="badge badge-active" id="status-orderbook">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Bid/Ask Walls, Liquidations</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('orderbook')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #64b5f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #64b5f6;">Macro</strong>
                            <span class="badge badge-active" id="status-macro">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">DXY, Bond Yields, Korrelationen</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('macro')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #ffb74d;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #ffb74d;">Historical Patterns</strong>
                            <span class="badge badge-active" id="status-historical-patterns">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Saisonalität, Drawdowns</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('historical-patterns')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #4dd0e1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #4dd0e1;">Technical Levels</strong>
                            <span class="badge badge-active" id="status-technical-levels">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">S/R, Fibonacci, Pivots</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('technical-levels')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #e57373;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #e57373;">Regulatory</strong>
                            <span class="badge badge-active" id="status-regulatory">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">SEC, ETF News, Regulation</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('regulatory')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #a1887f;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #a1887f;">EasyInsight</strong>
                            <span class="badge badge-active" id="status-easyinsight">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Managed Symbols, MT5 Logs</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('easyinsight')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #7e57c2;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #7e57c2;">Correlations</strong>
                            <span class="badge badge-active" id="status-correlations">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Cross-Asset, Divergenzen, Hedge</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('correlations')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #ff7043;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #ff7043;">Volatility Regime</strong>
                            <span class="badge badge-active" id="status-volatility-regime">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">VIX, ATR, Position Sizing</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('volatility-regime')">Abrufen</button>
                    </div>
                    <div class="source-card" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border-left: 3px solid #26a69a;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #26a69a;">Institutional Flow</strong>
                            <span class="badge badge-active" id="status-institutional-flow">-</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">COT, ETF Flows, Whale</p>
                        <button class="btn btn-sm btn-primary" onclick="quickFetchSource('institutional-flow')">Abrufen</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MT5 Logs Tab -->
        <div id="mt5logs-tab" class="tab-content">
            <iframe src="/mt5-logs.html" style="width: 100%; height: calc(100vh - 180px); border: none; border-radius: 8px;"></iframe>
        </div>

        <!-- Export/Import Tab -->
        <div id="export-tab" class="tab-content">
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="export-count">-</div>
                    <div class="stat-label">Gespeicherte Exports</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="export-symbols-total">-</div>
                    <div class="stat-label">Symbole aktuell</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="export-strategies-total">-</div>
                    <div class="stat-label">Strategien aktuell</div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">Konfiguration exportieren</h2>
                </div>
                <div style="padding: 1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Beschreibung (optional)</label>
                            <input type="text" class="form-input" id="export-description" placeholder="z.B. Backup vor Update...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dateiname (optional)</label>
                            <input type="text" class="form-input" id="export-filename" placeholder="config_backup.json">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" id="export-symbols" checked>
                                <span>Symbole exportieren</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" id="export-strategies" checked>
                                <span>Strategien exportieren</span>
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="createExport()">Export erstellen & speichern</button>
                        <button class="btn btn-success" onclick="downloadCurrentConfig()">Direkt herunterladen</button>
                    </div>
                </div>
            </div>

            <!-- Import Section -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">Konfiguration importieren</h2>
                </div>
                <div style="padding: 1rem;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">JSON-Datei hochladen</label>
                            <input type="file" class="form-input" id="import-file" accept=".json" style="padding: 0.5rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" id="import-overwrite">
                                <span>Bestehende überschreiben</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" id="import-symbols" checked>
                                <span>Symbole importieren</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" id="import-strategies" checked>
                                <span>Strategien importieren</span>
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="uploadAndImport()" style="margin-top: 1rem;">Datei importieren</button>
                </div>
            </div>

            <!-- Saved Exports List -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Gespeicherte Exports</h2>
                    <button class="btn btn-secondary" onclick="loadExports()">Aktualisieren</button>
                </div>
                <div class="table-container">
                    <table id="exports-table">
                        <thead>
                            <tr>
                                <th>Dateiname</th>
                                <th>Beschreibung</th>
                                <th>Erstellt</th>
                                <th>Symbole</th>
                                <th>Strategien</th>
                                <th>Größe</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="exports-body">
                            <tr><td colspan="7" class="loading"><div class="spinner"></div><br>Lade Exports...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Daten-Explorer Tab -->
        <div id="explorer-tab" class="tab-content">
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">&#128202; Daten-Explorer</h2>
                </div>
                <div style="padding: 1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Datenquelle</label>
                            <select class="form-select" id="explorer-source" onchange="updateIndicatorOptions()">
                                <option value="twelvedata" selected>TwelveData (Historisch)</option>
                                <option value="easyinsight">EasyInsight (Historisch)</option>
                                <option value="yfinance">Yahoo Finance (Historisch)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Symbol *</label>
                            <select class="form-select" id="explorer-symbol">
                                <option value="">Symbol wählen...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Zeitrahmen</label>
                            <select class="form-select" id="explorer-interval">
                                <option value="1min">1 Minute</option>
                                <option value="5min">5 Minuten</option>
                                <option value="15min">15 Minuten</option>
                                <option value="30min">30 Minuten</option>
                                <option value="1h" selected>1 Stunde</option>
                                <option value="4h">4 Stunden</option>
                                <option value="1day">1 Tag</option>
                                <option value="1week">1 Woche</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Datenpunkte</label>
                            <select class="form-select" id="explorer-limit">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <label class="form-checkbox" style="margin-bottom: 0.5rem;">
                                <input type="checkbox" id="explorer-bypass-cache">
                                <span>Cache umgehen</span>
                            </label>
                        </div>
                    </div>

                    <!-- Indicator section - dynamically updated based on source -->
                    <div id="indicator-section">
                        <!-- EasyInsight Indicators (default) -->
                        <div id="indicators-easyinsight">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Preis & Spread</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ei-bidask" checked><span>Bid/Ask/Spread</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-ohlc-m15"><span>M15 OHLC</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-ohlc-h1"><span>H1 OHLC</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-ohlc-d1"><span>D1 OHLC</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-sr-levels"><span>S1/R1 (M5)</span></label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Momentum-Indikatoren</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ei-rsi" checked><span>RSI</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-macd" checked><span>MACD</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-stoch" checked><span>Stochastic</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-cci"><span>CCI</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-adx"><span>ADX (+DI/-DI)</span></label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Trend & Volatilität</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ei-ma10"><span>MA(10)</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-ichimoku"><span>Ichimoku (5)</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-bbands" checked><span>Bollinger</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-atr"><span>ATR/Range D1</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ei-strength"><span>Strength (4H/D1/W1)</span></label>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;">
                                EasyInsight liefert historische Daten mit allen verfügbaren Indikatoren
                            </div>
                        </div>

                        <!-- TwelveData Indicators -->
                        <div id="indicators-twelvedata" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Trend-Indikatoren</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ind-ema"><span>EMA(20)</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-sma"><span>SMA(20)</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-supertrend"><span>Supertrend</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-ichimoku"><span>Ichimoku</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-ht_trendmode"><span>HT Trend</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-linearregslope"><span>LinReg Slope</span></label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Momentum-Indikatoren</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ind-rsi" checked><span>RSI</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-crsi"><span>Connors RSI</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-macd" checked><span>MACD</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-stoch"><span>Stochastic</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-willr"><span>Williams %R</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-adx"><span>ADX</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-aroon"><span>Aroon</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-mfi"><span>MFI</span></label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Volatilität & Volumen</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                        <label class="form-checkbox"><input type="checkbox" id="ind-bbands" checked><span>Bollinger</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-percent_b"><span>Percent B</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-atr"><span>ATR</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-obv"><span>OBV</span></label>
                                        <label class="form-checkbox"><input type="checkbox" id="ind-vwap"><span>VWAP</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Yahoo Finance - no indicators -->
                        <div id="indicators-yfinance" style="display: none;">
                            <div style="padding: 1rem; background: rgba(255,152,0,0.1); border-radius: 4px; color: #ffc107;">
                                Yahoo Finance liefert nur OHLCV-Daten ohne technische Indikatoren.
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="loadExplorerData()">&#128269; Daten laden</button>
                        <button class="btn btn-secondary" onclick="exportExplorerData()">&#128190; Als CSV exportieren</button>
                    </div>
                </div>
            </div>

            <!-- Data Display -->
            <div class="card" id="explorer-results" style="display: none;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title" id="explorer-title">Ergebnisse</h2>
                    <div id="explorer-info" style="font-size: 0.85rem; color: #888;"></div>
                </div>
                <div id="explorer-table-container" style="padding: 0.5rem; max-height: 500px; overflow: auto; position: relative;">
                    <table id="explorer-table" style="width: max-content; min-width: 100%; font-size: 0.8rem; border-collapse: separate; border-spacing: 0;">
                        <thead id="explorer-thead" style="position: sticky; top: 0; z-index: 2;"></thead>
                        <tbody id="explorer-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Loading State -->
            <div id="explorer-loading" style="display: none; text-align: center; padding: 3rem;">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #888;">Lade Daten...</p>
            </div>

            <!-- Error State -->
            <div id="explorer-error" style="display: none;" class="card">
                <div style="padding: 2rem; text-align: center; color: #f44336;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#9888;</div>
                    <p id="explorer-error-msg">Fehler beim Laden der Daten</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Symbol Modal -->
    <div class="modal-overlay" id="symbol-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="symbol-modal-title">Symbol bearbeiten</h3>
                <button class="modal-close" onclick="closeSymbolModal()">&times;</button>
            </div>
            <form id="symbol-form" onsubmit="saveSymbol(event)">
                <input type="hidden" id="symbol-id">
                <input type="hidden" id="symbol-display-name">
                <!-- Anzeigename -->
                <div class="form-group">
                    <label class="form-label">Anzeigename *</label>
                    <input type="text" class="form-input" id="symbol-name" required placeholder="z.B. BTCUSD, EURUSD, US500">
                </div>
                <!-- API Symbol Mappings -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">TwelveData Symbol</label>
                        <input type="text" class="form-input" id="symbol-twelvedata" placeholder="z.B. BTC/USD, EUR/USD, SPX">
                        <small style="color: #888; font-size: 0.8rem;">Format für TwelveData API</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">EasyInsight Symbol</label>
                        <input type="text" class="form-input" id="symbol-easyinsight" placeholder="z.B. BTCUSD, EURUSD">
                        <small style="color: #888; font-size: 0.8rem;">Format für EasyInsight API</small>
                    </div>
                </div>
                <!-- Synonyme / Aliase -->
                <div class="form-group">
                    <label class="form-label">Synonyme / Aliase</label>
                    <input type="text" class="form-input" id="symbol-aliases" placeholder="z.B. BTC/USD, XBTUSD (kommagetrennt)">
                    <small style="color: #888; font-size: 0.8rem;">Alternative Bezeichnungen, kommagetrennt</small>
                </div>
                <!-- Kategorie und Sub-Kategorie -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Kategorie *</label>
                        <select class="form-select" id="symbol-category" required onchange="updateModalSubcategories()">
                            <option value="crypto">Crypto</option>
                            <option value="forex">Forex</option>
                            <option value="index">Indices</option>
                            <option value="commodity">Metals/Commodities</option>
                            <option value="stock">Stocks</option>
                            <option value="etf">ETFs</option>
                            <option value="other">Andere</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sub-Kategorie</label>
                        <select class="form-select" id="symbol-subcategory">
                            <option value="">Keine</option>
                        </select>
                    </div>
                </div>
                <!-- Basis- und Gegenwährung -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Basiswahrung</label>
                        <input type="text" class="form-input" id="symbol-base-currency" placeholder="z.B. BTC, EUR">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gegenwährung</label>
                        <input type="text" class="form-input" id="symbol-quote-currency" placeholder="z.B. USD">
                    </div>
                </div>
                <!-- Status -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="symbol-status">
                            <option value="active">Aktiv</option>
                            <option value="inactive">Inaktiv</option>
                        </select>
                    </div>
                    <div class="form-group"></div>
                </div>
                <!-- Beschreibung -->
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" id="symbol-description" placeholder="Optionale Beschreibung des Symbols..."></textarea>
                </div>
                <div class="form-checkbox" style="margin-bottom: 1rem;">
                    <input type="checkbox" id="symbol-favorite">
                    <label>Als Favorit markieren</label>
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeSymbolModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-success">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Strategy Modal -->
    <div class="modal-overlay" id="strategy-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="strategy-modal-title">Strategie bearbeiten</h3>
                <button class="modal-close" onclick="closeStrategyModal()">&times;</button>
            </div>
            <form id="strategy-form" onsubmit="saveStrategy(event)">
                <input type="hidden" id="strategy-id">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="strategy-name" required placeholder="Strategiename">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" id="strategy-description" placeholder="Beschreibung der Strategie..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Strategietyp</label>
                        <select class="form-select" id="strategy-type">
                            <option value="trend_following">Trend Following</option>
                            <option value="mean_reversion">Mean Reversion</option>
                            <option value="momentum">Momentum</option>
                            <option value="breakout">Breakout</option>
                            <option value="scalping">Scalping</option>
                            <option value="swing">Swing Trading</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Risikostufe</label>
                        <select class="form-select" id="strategy-risk">
                            <option value="low">Niedrig</option>
                            <option value="moderate">Moderat</option>
                            <option value="high">Hoch</option>
                            <option value="aggressive">Aggressiv</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Min. Kaufsignale</label>
                        <input type="number" class="form-input" id="strategy-min-buy" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Min. Verkaufsignale</label>
                        <input type="number" class="form-input" id="strategy-min-sell" value="3" min="1" max="10">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Stop-Loss (ATR Mult.)</label>
                        <input type="number" class="form-input" id="strategy-stop-loss" value="2.0" min="0.5" max="5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Take-Profit (ATR Mult.)</label>
                        <input type="number" class="form-input" id="strategy-take-profit" value="3.0" min="1" max="10" step="0.1">
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeStrategyModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-success">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Symbol Import Modal -->
    <div class="modal-overlay" id="import-modal">
        <div class="modal" style="max-width: 900px; max-height: 85vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="import-modal-title">Symbole importieren</h3>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div style="padding: 1rem;">
                <!-- Source Selection -->
                <div class="form-row" style="margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Quelle</label>
                        <select class="form-select" id="import-source" onchange="loadImportSymbols()">
                            <option value="easyinsight">EasyInsight (TimescaleDB)</option>
                            <option value="twelvedata">Twelve Data API</option>
                        </select>
                    </div>
                    <div class="form-group" id="twelvedata-category-group" style="display: none;">
                        <label class="form-label">Asset-Typ</label>
                        <select class="form-select" id="import-category" onchange="loadImportSymbols()">
                            <option value="crypto">Crypto</option>
                            <option value="forex">Forex</option>
                            <option value="stocks">Stocks</option>
                            <option value="etf">ETFs</option>
                            <option value="indices">Indices</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategorie-Filter</label>
                        <select class="form-select" id="import-category-filter" onchange="filterImportSymbols()">
                            <option value="">Alle Kategorien</option>
                        </select>
                    </div>
                    <div class="form-group" id="exchange-filter-group">
                        <label class="form-label">Exchange</label>
                        <select class="form-select" id="import-exchange-filter" onchange="filterImportSymbols()">
                            <option value="">Alle Exchanges</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Suche</label>
                        <input type="text" class="form-input" id="import-search" placeholder="Symbol suchen..." oninput="filterImportSymbols()">
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-bar" style="margin-bottom: 1rem; padding: 0.5rem;">
                    <div class="stat-item">
                        <div class="stat-value" id="import-total">-</div>
                        <div class="stat-label">Verfügbar</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="import-already">-</div>
                        <div class="stat-label">Bereits importiert</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="import-selected">0</div>
                        <div class="stat-label">Ausgewahlt</div>
                    </div>
                </div>

                <!-- Selection Controls -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="selectAllImportSymbols(true)">Alle auswählen</button>
                    <button class="btn btn-secondary btn-sm" onclick="selectAllImportSymbols(false)">Alle abwählen</button>
                    <button class="btn btn-secondary btn-sm" onclick="selectNewImportSymbols()">Nur neue auswählen</button>
                    <label class="form-checkbox" style="margin-left: auto;">
                        <input type="checkbox" id="import-hide-existing" onchange="filterImportSymbols()">
                        <span>Bereits importierte ausblenden</span>
                    </label>
                </div>

                <!-- Symbol List -->
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table id="import-symbols-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="import-select-all" onchange="toggleAllVisibleImportSymbols(this.checked)">
                                </th>
                                <th>Symbol</th>
                                <th>Name / Kategorie</th>
                                <th>Details</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="import-symbols-body">
                            <tr><td colspan="5" class="loading"><div class="spinner"></div><br>Wahle eine Quelle...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" class="btn btn-danger" onclick="closeImportModal()">Abbrechen</button>
                    <button type="button" class="btn btn-success" onclick="importSelectedSymbols()">Ausgewahlte importieren</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Data Modal -->
    <div class="modal-overlay" id="live-data-modal">
        <div class="modal" style="max-width: 1100px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="live-data-modal-title">Live-Daten</h3>
                <button class="modal-close" onclick="closeLiveDataModal()">&times;</button>
            </div>
            <div style="padding: 1rem; overflow-y: auto; max-height: calc(90vh - 80px);">
                <div id="live-data-content">
                    <div class="loading"><div class="spinner"></div><br>Lade Live-Daten...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Stats Modal -->
    <div class="modal-overlay" id="data-stats-modal">
        <div class="modal" style="max-width: 1000px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="data-stats-modal-title">Datenpunkte</h3>
                <button class="modal-close" onclick="closeDataStatsModal()">&times;</button>
            </div>
            <div style="padding: 1rem; overflow-y: auto; max-height: calc(90vh - 80px);">
                <div id="data-stats-content">
                    <div class="loading"><div class="spinner"></div><br>Lade Datenstatistiken...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <footer>
        KI Trading Model - Data Service Konfiguration
    </footer>

    <script>
        const API_BASE = '/data/api/v1';
        let allSymbols = [];
        let allStrategies = [];
        let allIndicators = [];

        // Subcategory mapping per category (using backend enum values)
        const SUBCATEGORIES = {
            'crypto': [
                { value: 'large_cap', label: 'Large Cap' },
                { value: 'mid_cap', label: 'Mid Cap' },
                { value: 'small_cap', label: 'Small Cap' },
                { value: 'defi', label: 'DeFi' },
                { value: 'meme', label: 'Meme' },
                { value: 'stablecoin', label: 'Stablecoin' },
                { value: 'other', label: 'Andere' }
            ],
            'forex': [
                { value: 'major', label: 'Major' },
                { value: 'minor', label: 'Minor' },
                { value: 'exotic', label: 'Exotic' },
                { value: 'other', label: 'Andere' }
            ],
            'index': [
                { value: 'global', label: 'Global' },
                { value: 'regional', label: 'Regional' },
                { value: 'sector', label: 'Sektor' },
                { value: 'other', label: 'Andere' }
            ],
            'commodity': [
                { value: 'precious_metal', label: 'Edelmetall' },
                { value: 'base_metal', label: 'Basismetall' },
                { value: 'agriculture', label: 'Agrar' },
                { value: 'energy_commodity', label: 'Energie' },
                { value: 'other', label: 'Andere' }
            ],
            'stock': [
                { value: 'tech', label: 'Tech' },
                { value: 'finance', label: 'Finanzen' },
                { value: 'healthcare', label: 'Gesundheit' },
                { value: 'energy', label: 'Energie' },
                { value: 'consumer', label: 'Konsum' },
                { value: 'industrial', label: 'Industrie' },
                { value: 'other', label: 'Andere' }
            ],
            'etf': [
                { value: 'global', label: 'Global' },
                { value: 'sector', label: 'Sektor' },
                { value: 'other', label: 'Andere' }
            ],
            'other': [
                { value: 'other', label: 'Andere' }
            ]
        };

        // Category display names
        const CATEGORY_LABELS = {
            'crypto': 'Crypto',
            'forex': 'Forex',
            'index': 'Indices',
            'commodity': 'Metals/Commodities',
            'stock': 'Stocks',
            'etf': 'ETFs',
            'other': 'Andere'
        };

        // Get subcategory label from value
        function getSubcategoryLabel(category, subcategory) {
            if (!subcategory || !category) return '-';
            const subs = SUBCATEGORIES[category] || [];
            const found = subs.find(s => s.value === subcategory);
            return found ? found.label : subcategory;
        }

        // Update subcategory filter dropdown based on selected category
        function updateSubcategoryFilter() {
            const category = document.getElementById('category-filter').value;
            const subcategoryFilter = document.getElementById('subcategory-filter');

            subcategoryFilter.innerHTML = '<option value="">Alle Sub-Kategorien</option>';

            if (category && SUBCATEGORIES[category]) {
                SUBCATEGORIES[category].forEach(sub => {
                    subcategoryFilter.innerHTML += `<option value="${sub.value}">${sub.label}</option>`;
                });
            } else {
                // Show all subcategories when no category selected
                const allSubs = new Set();
                Object.values(SUBCATEGORIES).forEach(cats => {
                    cats.forEach(sub => allSubs.add(JSON.stringify(sub)));
                });
                Array.from(allSubs).map(s => JSON.parse(s)).forEach(sub => {
                    subcategoryFilter.innerHTML += `<option value="${sub.value}">${sub.label}</option>`;
                });
            }
        }

        // Update modal subcategory dropdown based on selected category
        function updateModalSubcategories() {
            const category = document.getElementById('symbol-category').value;
            const subcategorySelect = document.getElementById('symbol-subcategory');
            const currentValue = subcategorySelect.value;

            subcategorySelect.innerHTML = '<option value="">Keine</option>';

            if (category && SUBCATEGORIES[category]) {
                SUBCATEGORIES[category].forEach(sub => {
                    subcategorySelect.innerHTML += `<option value="${sub.value}">${sub.label}</option>`;
                });
            }

            // Restore previous value if still valid
            if (currentValue) {
                const options = Array.from(subcategorySelect.options).map(o => o.value);
                if (options.includes(currentValue)) {
                    subcategorySelect.value = currentValue;
                }
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('symbol-search').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('subcategory-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('favorites-only').checked = false;
            updateSubcategoryFilter();
            filterSymbols();
        }

        // ==================== INDICATORS ====================

        // Indicator category labels
        const INDICATOR_CATEGORY_LABELS = {
            'trend': 'Trend / Moving Averages',
            'momentum': 'Momentum',
            'volatility': 'Volatilität',
            'volume': 'Volumen',
            'trend_filter': 'Trend-Filter',
            'price_transform': 'Price Transform',
            'ml_features': 'ML Features',
            'pattern': 'Pattern'
        };

        // Load indicators
        async function loadIndicators() {
            try {
                const response = await fetch(`${API_BASE}/indicators`);
                const data = await response.json();
                allIndicators = data.indicators || [];
                updateIndicatorStats();
                filterIndicators();
            } catch (error) {
                console.error('Error loading indicators:', error);
                document.getElementById('indicators-body').innerHTML =
                    '<tr><td colspan="8" class="empty-state">Fehler beim Laden der Indikatoren</td></tr>';
            }
        }

        // Update indicator statistics
        async function updateIndicatorStats() {
            try {
                const response = await fetch(`${API_BASE}/indicators/stats`);
                const stats = await response.json();
                document.getElementById('total-indicators').textContent = stats.total;
                document.getElementById('enabled-indicators').textContent = stats.enabled;
                document.getElementById('twelvedata-indicators').textContent = stats.twelvedata_supported;
                document.getElementById('easyinsight-indicators').textContent = stats.easyinsight_supported;
            } catch (error) {
                console.error('Error loading indicator stats:', error);
            }
        }

        // Filter indicators
        function filterIndicators() {
            const search = document.getElementById('indicator-search').value.toLowerCase();
            const category = document.getElementById('indicator-category-filter').value;
            const source = document.getElementById('indicator-source-filter').value;
            const status = document.getElementById('indicator-status-filter').value;

            let filtered = allIndicators.filter(ind => {
                // Search filter
                if (search && !ind.id.toLowerCase().includes(search) &&
                    !ind.name.toLowerCase().includes(search) &&
                    !ind.description.toLowerCase().includes(search)) {
                    return false;
                }
                // Category filter
                if (category && ind.category !== category) {
                    return false;
                }
                // Source filter
                if (source === 'twelvedata' && !ind.twelvedata_name) {
                    return false;
                }
                if (source === 'easyinsight' && !ind.easyinsight_name) {
                    return false;
                }
                // Status filter
                if (status === 'enabled' && !ind.enabled) {
                    return false;
                }
                if (status === 'disabled' && ind.enabled) {
                    return false;
                }
                return true;
            });

            renderIndicators(filtered);
        }

        // Render indicators table
        function renderIndicators(indicators) {
            const tbody = document.getElementById('indicators-body');

            if (indicators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Keine Indikatoren gefunden</td></tr>';
                return;
            }

            tbody.innerHTML = indicators.map(ind => `
                <tr>
                    <td>
                        <span class="badge ${ind.enabled ? 'badge-active' : 'badge-inactive'}"
                              onclick="toggleIndicator('${ind.id}', ${!ind.enabled})"
                              style="cursor: pointer;" title="Klicken zum ${ind.enabled ? 'Deaktivieren' : 'Aktivieren'}">
                            ${ind.enabled ? 'Aktiv' : 'Inaktiv'}
                        </span>
                    </td>
                    <td><code>${ind.id}</code></td>
                    <td><strong>${ind.name}</strong></td>
                    <td>
                        <span class="badge badge-${getCategoryBadgeClass(ind.category)}">
                            ${INDICATOR_CATEGORY_LABELS[ind.category] || ind.category}
                        </span>
                    </td>
                    <td>
                        ${ind.twelvedata_name ?
                            `<span class="badge" style="background: rgba(33, 150, 243, 0.2); color: #64b5f6;">${ind.twelvedata_name}</span>` :
                            '<span style="color: #666;">-</span>'}
                    </td>
                    <td>
                        ${ind.easyinsight_name ?
                            `<span class="badge" style="background: rgba(76, 175, 80, 0.2); color: #81c784;">${ind.easyinsight_name}</span>` :
                            '<span style="color: #666;">-</span>'}
                    </td>
                    <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${ind.description}">
                        ${ind.description}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showIndicatorDetails('${ind.id}')">
                            Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Get badge class for category
        function getCategoryBadgeClass(category) {
            const classes = {
                'trend': 'forex',
                'momentum': 'crypto',
                'volatility': 'index',
                'volume': 'commodity',
                'trend_filter': 'stock',
                'price_transform': 'etf',
                'ml_features': 'active',
                'pattern': 'other'
            };
            return classes[category] || 'other';
        }

        // Toggle indicator enabled/disabled
        async function toggleIndicator(indicatorId, enabled) {
            try {
                const response = await fetch(`${API_BASE}/indicators/${indicatorId}/toggle?enabled=${enabled}`, {
                    method: 'PUT'
                });
                if (response.ok) {
                    showToast(`Indikator ${enabled ? 'aktiviert' : 'deaktiviert'}`, 'success');
                    loadIndicators();
                } else {
                    throw new Error('Toggle failed');
                }
            } catch (error) {
                console.error('Error toggling indicator:', error);
                showToast('Fehler beim Ändern des Status', 'error');
            }
        }

        // Show indicator details modal
        async function showIndicatorDetails(indicatorId) {
            try {
                const response = await fetch(`${API_BASE}/indicators/${indicatorId}`);
                const data = await response.json();
                const ind = data.indicator;
                const catInfo = data.category_info;

                document.getElementById('indicator-detail-title').textContent = ind.name;
                document.getElementById('indicator-detail-content').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div class="form-label">ID</div>
                            <code style="font-size: 1rem;">${ind.id}</code>
                        </div>
                        <div>
                            <div class="form-label">Status</div>
                            <span class="badge ${ind.enabled ? 'badge-active' : 'badge-inactive'}">
                                ${ind.enabled ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </div>
                        <div>
                            <div class="form-label">Kategorie</div>
                            <span class="badge badge-${getCategoryBadgeClass(ind.category)}">
                                ${catInfo.name}
                            </span>
                        </div>
                        <div>
                            <div class="form-label">Kategorie-Beschreibung</div>
                            <span style="color: #a0a0a0;">${catInfo.description || '-'}</span>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: rgba(33, 150, 243, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(33, 150, 243, 0.3);">
                            <div style="color: #64b5f6; font-weight: 600; margin-bottom: 0.5rem;">TwelveData API</div>
                            ${ind.twelvedata_name ?
                                `<code style="font-size: 1rem;">${ind.twelvedata_name}</code>` :
                                '<span style="color: #888;">Nicht unterstützt</span>'}
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.3);">
                            <div style="color: #81c784; font-weight: 600; margin-bottom: 0.5rem;">EasyInsight API</div>
                            ${ind.easyinsight_name ?
                                `<code style="font-size: 1rem;">${ind.easyinsight_name}</code>` :
                                '<span style="color: #888;">Nicht unterstützt</span>'}
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label">Beschreibung</div>
                        <p style="color: #e8e8e8; line-height: 1.5;">${ind.description}</p>
                    </div>

                    ${ind.calculation ? `
                        <div class="form-group">
                            <div class="form-label">Berechnung</div>
                            <div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; font-family: monospace; color: #64c8ff;">
                                ${ind.calculation}
                            </div>
                        </div>
                    ` : ''}

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div class="form-label" style="color: #81c784;">Stärken</div>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #a0a0a0;">
                                ${ind.strengths.length > 0 ?
                                    ind.strengths.map(s => `<li style="margin-bottom: 0.25rem;">${s}</li>`).join('') :
                                    '<li>Keine angegeben</li>'}
                            </ul>
                        </div>
                        <div>
                            <div class="form-label" style="color: #e57373;">Schwächen</div>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #a0a0a0;">
                                ${ind.weaknesses.length > 0 ?
                                    ind.weaknesses.map(w => `<li style="margin-bottom: 0.25rem;">${w}</li>`).join('') :
                                    '<li>Keine angegeben</li>'}
                            </ul>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label" style="color: #64c8ff;">Anwendungsgebiete</div>
                        <ul style="margin: 0; padding-left: 1.2rem; color: #a0a0a0;">
                            ${ind.use_cases.length > 0 ?
                                ind.use_cases.map(u => `<li style="margin-bottom: 0.25rem;">${u}</li>`).join('') :
                                '<li>Keine angegeben</li>'}
                        </ul>
                    </div>

                    ${Object.keys(ind.default_params).length > 0 ? `
                        <div class="form-group">
                            <div class="form-label">Standard-Parameter</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${Object.entries(ind.default_params).map(([key, value]) => `
                                    <span class="badge" style="background: rgba(100, 200, 255, 0.1); color: #64c8ff;">
                                        ${key}: ${value}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                document.getElementById('indicator-detail-modal').classList.add('active');
            } catch (error) {
                console.error('Error loading indicator details:', error);
                showToast('Fehler beim Laden der Details', 'error');
            }
        }

        // Close indicator detail modal
        function closeIndicatorDetailModal() {
            document.getElementById('indicator-detail-modal').classList.remove('active');
        }

        // Clear indicator filters
        function clearIndicatorFilters() {
            document.getElementById('indicator-search').value = '';
            document.getElementById('indicator-category-filter').value = '';
            document.getElementById('indicator-source-filter').value = '';
            document.getElementById('indicator-status-filter').value = '';
            filterIndicators();
        }

        // ==================== END INDICATORS ====================

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
            });
        });

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast toast-' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Load symbols
        async function loadSymbols() {
            try {
                const response = await fetch(`${API_BASE}/managed-symbols?favorites_only=false&with_data_only=false`);
                allSymbols = await response.json();
                updateSymbolStats();
                // Apply current filters instead of rendering all
                filterSymbols();
            } catch (error) {
                console.error('Error loading symbols:', error);
                showToast('Fehler beim Laden der Symbole', 'error');
            }
        }

        function updateSymbolStats() {
            const active = allSymbols.filter(s => s.status === 'active').length;
            const favorites = allSymbols.filter(s => s.is_favorite).length;
            const crypto = allSymbols.filter(s => s.category === 'crypto').length;
            const forex = allSymbols.filter(s => s.category === 'forex').length;
            const index = allSymbols.filter(s => s.category === 'index').length;
            const commodity = allSymbols.filter(s => s.category === 'commodity').length;
            const stock = allSymbols.filter(s => s.category === 'stock').length;
            const etf = allSymbols.filter(s => s.category === 'etf').length;
            const other = allSymbols.filter(s => s.category === 'other').length;

            document.getElementById('total-symbols').textContent = allSymbols.length;
            document.getElementById('active-symbols').textContent = active;
            document.getElementById('favorite-symbols').textContent = favorites;
            document.getElementById('crypto-count').textContent = crypto;
            document.getElementById('forex-count').textContent = forex;
            document.getElementById('index-count').textContent = index;
            document.getElementById('commodity-count').textContent = commodity;
            document.getElementById('stock-count').textContent = stock;
            document.getElementById('etf-count').textContent = etf;
            document.getElementById('other-count').textContent = other;
        }

        function filterSymbols() {
            const search = document.getElementById('symbol-search').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const subcategory = document.getElementById('subcategory-filter').value;
            const status = document.getElementById('status-filter').value;
            const favoritesOnly = document.getElementById('favorites-only').checked;

            const filtered = allSymbols.filter(s => {
                if (search) {
                    const matchesSymbol = s.symbol.toLowerCase().includes(search);
                    const matchesDisplayName = (s.display_name || '').toLowerCase().includes(search);
                    const matchesAlias = (s.aliases || []).some(a => a.toLowerCase().includes(search));
                    if (!matchesSymbol && !matchesDisplayName && !matchesAlias) return false;
                }
                if (category && s.category !== category) return false;
                if (subcategory && s.subcategory !== subcategory) return false;
                if (status && s.status !== status) return false;
                if (favoritesOnly && !s.is_favorite) return false;
                return true;
            });

            renderSymbols(filtered);
        }

        function renderSymbols(symbols = allSymbols) {
            const tbody = document.getElementById('symbols-body');

            if (symbols.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="empty-state">
                    <div class="empty-state-icon">&#128202;</div>
                    Keine Symbole gefunden
                </td></tr>`;
                return;
            }

            tbody.innerHTML = symbols.map(s => {
                const aliasesDisplay = (s.aliases && s.aliases.length > 0)
                    ? s.aliases.map(a => `<span class="badge" style="background: rgba(180, 180, 180, 0.15); color: #aaa; margin-right: 3px;">${a}</span>`).join('')
                    : '';
                const apiSymbols = `
                    <span class="badge" style="background: rgba(33, 150, 243, 0.15); color: #64b5f6; margin-right: 3px;" title="TwelveData">${s.twelvedata_symbol || s.symbol}</span>
                    <span class="badge" style="background: rgba(76, 175, 80, 0.15); color: #81c784;" title="EasyInsight">${s.easyinsight_symbol || s.symbol}</span>
                `;
                return `
                <tr data-id="${s.symbol}">
                    <td>
                        <span class="favorite-star ${s.is_favorite ? 'active' : ''}"
                              onclick="toggleFavorite('${s.symbol.replace(/'/g, "\\'")}', ${!s.is_favorite})">
                            ${s.is_favorite ? '&#9733;' : '&#9734;'}
                        </span>
                    </td>
                    <td><strong>${s.symbol}</strong></td>
                    <td style="max-width: 200px;">${apiSymbols}${aliasesDisplay ? '<br>' + aliasesDisplay : ''}</td>
                    <td><span class="badge badge-${s.category}">${CATEGORY_LABELS[s.category] || s.category}</span></td>
                    <td>${s.subcategory ? `<span class="badge" style="background: rgba(100, 200, 255, 0.15); color: #64c8ff;">${getSubcategoryLabel(s.category, s.subcategory)}</span>` : '-'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${s.description || '-'}</td>
                    <td><span class="badge badge-${s.status}">${s.status === 'active' ? 'Aktiv' : 'Inaktiv'}</span></td>
                    <td>
                        <span class="data-stats-link" onclick="showDataStats('${s.symbol.replace(/'/g, "\\'")}')"
                              style="cursor: pointer; color: ${s.total_records > 0 ? '#64c8ff' : '#888'}; text-decoration: underline;"
                              title="Klicken für Details">
                            ${s.total_records ? s.total_records.toLocaleString() : '-'}
                        </span>
                    </td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-warning btn-sm" onclick="showDataStats('${s.symbol.replace(/'/g, "\\'")}')" style="background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3);" title="Datenpunkte anzeigen">&#128202;</button>
                        <button class="btn btn-info btn-sm" onclick="showLiveData('${s.symbol.replace(/'/g, "\\'")}')" style="background: #17a2b8;" title="Live-Daten anzeigen">&#128200;</button>
                        <button class="btn btn-primary btn-sm" onclick="editSymbol('${s.symbol.replace(/'/g, "\\'")}')">Bearbeiten</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSymbol('${s.symbol.replace(/'/g, "\\'")}')">Löschen</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function toggleFavorite(id, isFavorite) {
            try {
                const response = await fetch(`${API_BASE}/managed-symbols/${encodeURIComponent(id)}/favorite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_favorite: isFavorite })
                });
                await loadSymbols();
                showToast(isFavorite ? 'Favorit hinzugefugt' : 'Favorit entfernt', 'success');
            } catch (error) {
                showToast('Fehler beim Aktualisieren', 'error');
            }
        }

        function openSymbolModal(symbolData = null) {
            document.getElementById('symbol-modal-title').textContent = symbolData ? 'Symbol bearbeiten' : 'Neues Symbol';
            document.getElementById('symbol-id').value = symbolData?.symbol || '';
            document.getElementById('symbol-name').value = symbolData?.symbol || '';
            document.getElementById('symbol-display-name').value = symbolData?.display_name || '';
            document.getElementById('symbol-category').value = symbolData?.category || 'forex';
            // Update subcategory options based on category
            updateModalSubcategories();
            document.getElementById('symbol-subcategory').value = symbolData?.subcategory || '';
            document.getElementById('symbol-status').value = symbolData?.status || 'active';
            document.getElementById('symbol-description').value = symbolData?.description || '';
            document.getElementById('symbol-twelvedata').value = symbolData?.twelvedata_symbol || '';
            document.getElementById('symbol-easyinsight').value = symbolData?.easyinsight_symbol || '';
            document.getElementById('symbol-base-currency').value = symbolData?.base_currency || '';
            document.getElementById('symbol-quote-currency').value = symbolData?.quote_currency || '';
            document.getElementById('symbol-aliases').value = (symbolData?.aliases || []).join(', ');
            document.getElementById('symbol-favorite').checked = symbolData?.is_favorite || false;
            document.getElementById('symbol-name').disabled = !!symbolData;
            document.getElementById('symbol-modal').classList.add('active');
        }

        function closeSymbolModal() {
            document.getElementById('symbol-modal').classList.remove('active');
        }

        function editSymbol(symbolId) {
            const symbolData = allSymbols.find(s => s.symbol === symbolId);
            if (symbolData) openSymbolModal(symbolData);
        }

        async function saveSymbol(event) {
            event.preventDefault();
            const id = document.getElementById('symbol-id').value;
            // Parse aliases from comma-separated string
            const aliasesStr = document.getElementById('symbol-aliases').value;
            const aliases = aliasesStr
                ? aliasesStr.split(',').map(a => a.trim()).filter(a => a.length > 0)
                : [];

            const data = {
                symbol: document.getElementById('symbol-name').value,
                display_name: document.getElementById('symbol-display-name').value || null,
                category: document.getElementById('symbol-category').value,
                subcategory: document.getElementById('symbol-subcategory').value || null,
                status: document.getElementById('symbol-status').value,
                description: document.getElementById('symbol-description').value || null,
                twelvedata_symbol: document.getElementById('symbol-twelvedata').value || null,
                easyinsight_symbol: document.getElementById('symbol-easyinsight').value || null,
                base_currency: document.getElementById('symbol-base-currency').value || null,
                quote_currency: document.getElementById('symbol-quote-currency').value || null,
                aliases: aliases,
                is_favorite: document.getElementById('symbol-favorite').checked
            };

            try {
                const url = id ? `${API_BASE}/managed-symbols/${id}` : `${API_BASE}/managed-symbols`;
                const method = id ? 'PUT' : 'POST';
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeSymbolModal();
                await loadSymbols();
                showToast('Symbol gespeichert', 'success');
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteSymbol(id) {
            if (!confirm(`Symbol "${id}" wirklich löschen?`)) return;
            try {
                const response = await fetch(`${API_BASE}/managed-symbols/${encodeURIComponent(id)}`, { method: 'DELETE' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Löschen fehlgeschlagen');
                }
                await loadSymbols();
                showToast('Symbol gelöscht', 'success');
            } catch (error) {
                console.error('Delete error:', error);
                showToast(`Fehler beim Löschen: ${error.message}`, 'error');
            }
        }

        // ==================== Symbol Import Modal ====================

        let importSymbols = [];
        let selectedImportSymbols = new Set();

        function openImportModal(source = 'easyinsight') {
            document.getElementById('import-source').value = source;
            document.getElementById('import-search').value = '';
            document.getElementById('import-hide-existing').checked = false;
            selectedImportSymbols.clear();
            updateImportSelectedCount();

            // Show/hide Twelve Data category selector
            const categoryGroup = document.getElementById('twelvedata-category-group');
            categoryGroup.style.display = source === 'twelvedata' ? 'block' : 'none';

            document.getElementById('import-modal').classList.add('active');
            loadImportSymbols();
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.remove('active');
            importSymbols = [];
            selectedImportSymbols.clear();
        }

        async function loadImportSymbols() {
            const source = document.getElementById('import-source').value;
            const tbody = document.getElementById('import-symbols-body');

            tbody.innerHTML = `<tr><td colspan="5" class="loading"><div class="spinner"></div><br>Lade Symbole...</td></tr>`;

            // Show/hide Twelve Data category selector
            const categoryGroup = document.getElementById('twelvedata-category-group');
            categoryGroup.style.display = source === 'twelvedata' ? 'block' : 'none';

            try {
                let url;
                if (source === 'easyinsight') {
                    url = `${API_BASE}/managed-symbols/available/easyinsight`;
                } else {
                    const category = document.getElementById('import-category').value;
                    url = `${API_BASE}/managed-symbols/available/twelvedata?category=${category}`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Fehler beim Laden');
                }

                const data = await response.json();
                importSymbols = data.symbols || [];

                // Update stats
                document.getElementById('import-total').textContent = data.total || 0;
                document.getElementById('import-already').textContent = data.already_imported || 0;

                // Clear selection
                selectedImportSymbols.clear();
                updateImportSelectedCount();

                // Update category filter dropdown
                updateImportCategoryFilter();

                filterImportSymbols();
            } catch (error) {
                console.error('Error loading import symbols:', error);
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state">Fehler: ${error.message}</td></tr>`;
                showToast('Fehler beim Laden der Symbole', 'error');
            }
        }

        function updateImportCategoryFilter() {
            const categoryFilter = document.getElementById('import-category-filter');
            const exchangeFilter = document.getElementById('import-exchange-filter');
            const source = document.getElementById('import-source').value;

            // Collect unique categories from loaded symbols
            const categories = new Set();
            const exchanges = new Set();

            importSymbols.forEach(s => {
                if (s.category) {
                    categories.add(s.category);
                }
                if (s.exchange) {
                    exchanges.add(s.exchange);
                }
            });

            // Sort categories alphabetically
            const sortedCategories = Array.from(categories).sort();
            const sortedExchanges = Array.from(exchanges).sort();

            // Rebuild category dropdown
            categoryFilter.innerHTML = '<option value="">Alle Kategorien</option>';
            sortedCategories.forEach(cat => {
                // Use CATEGORY_LABELS if available, otherwise use the raw category
                const label = CATEGORY_LABELS[cat.toLowerCase()] || cat;
                categoryFilter.innerHTML += `<option value="${cat}">${label}</option>`;
            });

            // Rebuild exchange dropdown
            exchangeFilter.innerHTML = '<option value="">Alle Exchanges</option>';
            sortedExchanges.forEach(ex => {
                exchangeFilter.innerHTML += `<option value="${ex}">${ex}</option>`;
            });

            // Show/hide exchange filter based on data availability
            const exchangeGroup = document.getElementById('exchange-filter-group');
            exchangeGroup.style.display = sortedExchanges.length > 0 ? 'block' : 'none';
        }

        function filterImportSymbols() {
            const search = document.getElementById('import-search').value.toLowerCase();
            const hideExisting = document.getElementById('import-hide-existing').checked;
            const categoryFilter = document.getElementById('import-category-filter').value;
            const exchangeFilter = document.getElementById('import-exchange-filter').value;

            let filtered = importSymbols;

            // Apply category filter
            if (categoryFilter) {
                filtered = filtered.filter(s => s.category === categoryFilter);
            }

            // Apply exchange filter
            if (exchangeFilter) {
                filtered = filtered.filter(s => s.exchange === exchangeFilter);
            }

            // Apply search filter
            if (search) {
                filtered = filtered.filter(s =>
                    s.symbol.toLowerCase().includes(search) ||
                    (s.name || '').toLowerCase().includes(search) ||
                    (s.category || '').toLowerCase().includes(search) ||
                    (s.exchange || '').toLowerCase().includes(search) ||
                    (s.country || '').toLowerCase().includes(search)
                );
            }

            // Hide already imported
            if (hideExisting) {
                filtered = filtered.filter(s => !s.already_imported);
            }

            // Update filtered count in stats
            updateFilteredStats(filtered);

            renderImportSymbols(filtered);
        }

        function updateFilteredStats(filtered) {
            const total = importSymbols.length;
            const filteredCount = filtered.length;
            const totalLabel = document.getElementById('import-total');

            if (filteredCount < total) {
                totalLabel.textContent = `${filteredCount} / ${total}`;
            } else {
                totalLabel.textContent = total;
            }
        }

        function renderImportSymbols(symbols) {
            const tbody = document.getElementById('import-symbols-body');
            const source = document.getElementById('import-source').value;

            if (symbols.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state">Keine Symbole gefunden</td></tr>`;
                return;
            }

            tbody.innerHTML = symbols.map(s => {
                const isSelected = selectedImportSymbols.has(s.symbol);
                const isImported = s.already_imported;

                let detailsCol = '';
                if (source === 'easyinsight') {
                    detailsCol = s.count ? `${s.count.toLocaleString()} Datenpunkte` : '-';
                } else {
                    detailsCol = [s.exchange, s.currency, s.country].filter(Boolean).join(' | ') || '-';
                }

                return `
                    <tr class="${isImported ? 'imported-row' : ''}" style="${isImported ? 'opacity: 0.6;' : ''}">
                        <td>
                            <input type="checkbox"
                                   ${isSelected ? 'checked' : ''}
                                   ${isImported ? 'disabled' : ''}
                                   onchange="toggleImportSymbol('${s.symbol}', this.checked)">
                        </td>
                        <td><strong>${s.symbol}</strong></td>
                        <td>${s.name || s.category || '-'}</td>
                        <td style="font-size: 0.85rem; color: #888;">${detailsCol}</td>
                        <td>
                            ${isImported
                                ? '<span class="badge badge-active">Importiert</span>'
                                : '<span class="badge" style="background: rgba(255,193,7,0.2); color: #ffc107;">Neu</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleImportSymbol(symbol, checked) {
            if (checked) {
                selectedImportSymbols.add(symbol);
            } else {
                selectedImportSymbols.delete(symbol);
            }
            updateImportSelectedCount();
        }

        function updateImportSelectedCount() {
            document.getElementById('import-selected').textContent = selectedImportSymbols.size;
        }

        function selectAllImportSymbols(select) {
            if (select) {
                importSymbols.filter(s => !s.already_imported).forEach(s => selectedImportSymbols.add(s.symbol));
            } else {
                selectedImportSymbols.clear();
            }
            updateImportSelectedCount();
            filterImportSymbols();
        }

        function selectNewImportSymbols() {
            selectedImportSymbols.clear();
            importSymbols.filter(s => !s.already_imported).forEach(s => selectedImportSymbols.add(s.symbol));
            updateImportSelectedCount();
            filterImportSymbols();
        }

        function toggleAllVisibleImportSymbols(checked) {
            const search = document.getElementById('import-search').value.toLowerCase();
            const hideExisting = document.getElementById('import-hide-existing').checked;
            const categoryFilter = document.getElementById('import-category-filter').value;
            const exchangeFilter = document.getElementById('import-exchange-filter').value;

            let filtered = importSymbols;

            // Apply category filter
            if (categoryFilter) {
                filtered = filtered.filter(s => s.category === categoryFilter);
            }

            // Apply exchange filter
            if (exchangeFilter) {
                filtered = filtered.filter(s => s.exchange === exchangeFilter);
            }

            // Apply search filter
            if (search) {
                filtered = filtered.filter(s =>
                    s.symbol.toLowerCase().includes(search) ||
                    (s.name || '').toLowerCase().includes(search) ||
                    (s.exchange || '').toLowerCase().includes(search)
                );
            }

            // Hide existing
            if (hideExisting) {
                filtered = filtered.filter(s => !s.already_imported);
            }

            filtered.filter(s => !s.already_imported).forEach(s => {
                if (checked) {
                    selectedImportSymbols.add(s.symbol);
                } else {
                    selectedImportSymbols.delete(s.symbol);
                }
            });

            updateImportSelectedCount();
            filterImportSymbols();
        }

        async function importSelectedSymbols() {
            if (selectedImportSymbols.size === 0) {
                showToast('Bitte mindestens ein Symbol auswählen', 'error');
                return;
            }

            const source = document.getElementById('import-source').value;
            const symbols = Array.from(selectedImportSymbols);

            try {
                showToast(`Importiere ${symbols.length} Symbole...`, 'info');

                const response = await fetch(`${API_BASE}/managed-symbols/import/selected?source=${source}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(symbols)
                });

                const result = await response.json();

                if (result.errors && result.errors.length > 0) {
                    console.warn('Import errors:', result.errors);
                }

                showToast(`${result.imported} Symbole importiert, ${result.skipped} ubersprungen`, 'success');
                closeImportModal();
                await loadSymbols();
            } catch (error) {
                console.error('Import error:', error);
                showToast('Fehler beim Import', 'error');
            }
        }

        // Legacy function for backwards compatibility
        async function importFromEasyInsight() {
            openImportModal('easyinsight');
        }

        // ==================== Strategies ====================
        async function loadStrategies() {
            try {
                const response = await fetch(`${API_BASE}/strategies`);
                allStrategies = await response.json();
                renderStrategies();
            } catch (error) {
                console.error('Error loading strategies:', error);
                showToast('Fehler beim Laden der Strategien', 'error');
            }
        }

        function renderStrategies() {
            const container = document.getElementById('strategies-list');

            if (allStrategies.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">&#128200;</div>
                    Keine Strategien vorhanden
                </div>`;
                return;
            }

            container.innerHTML = allStrategies.map(s => `
                <div class="strategy-card ${s.is_default ? 'default' : ''}">
                    <div class="strategy-header">
                        <div>
                            <div class="strategy-name">${s.name}</div>
                        </div>
                        <div class="strategy-badges">
                            ${s.is_default ? '<span class="badge badge-active">Standard</span>' : ''}
                            <span class="badge risk-${s.risk_level}">${getRiskLabel(s.risk_level)}</span>
                            <span class="badge badge-forex">${getTypeLabel(s.strategy_type)}</span>
                        </div>
                    </div>
                    <div class="strategy-desc">${s.description || 'Keine Beschreibung'}</div>
                    <div class="strategy-meta">
                        <span>Min. Kaufsignale: ${s.min_buy_signals}</span>
                        <span>Min. Verkaufsignale: ${s.min_sell_signals}</span>
                        <span>Stop-Loss: ${s.stop_loss_atr_multiplier}x ATR</span>
                        <span>Take-Profit: ${s.take_profit_atr_multiplier}x ATR</span>
                    </div>
                    <div class="strategy-actions">
                        <button class="btn btn-primary btn-sm" onclick="editStrategy('${s.id}')">Bearbeiten</button>
                        ${!s.is_default ? `<button class="btn btn-success btn-sm" onclick="setDefault('${s.id}')">Als Standard</button>` : ''}
                        <button class="btn btn-warning btn-sm" onclick="exportStrategy('${s.id}')">Exportieren</button>
                        ${!s.id.startsWith('default_') ? `<button class="btn btn-danger btn-sm" onclick="deleteStrategy('${s.id}')">Löschen</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getRiskLabel(risk) {
            const labels = { low: 'Niedrig', moderate: 'Moderat', high: 'Hoch', aggressive: 'Aggressiv' };
            return labels[risk] || risk;
        }

        function getTypeLabel(type) {
            const labels = {
                trend_following: 'Trend Following',
                mean_reversion: 'Mean Reversion',
                momentum: 'Momentum',
                breakout: 'Breakout',
                scalping: 'Scalping',
                swing: 'Swing Trading',
                custom: 'Custom'
            };
            return labels[type] || type;
        }

        function openStrategyModal(strategy = null) {
            document.getElementById('strategy-modal-title').textContent = strategy ? 'Strategie bearbeiten' : 'Neue Strategie';
            document.getElementById('strategy-id').value = strategy?.id || '';
            document.getElementById('strategy-name').value = strategy?.name || '';
            document.getElementById('strategy-description').value = strategy?.description || '';
            document.getElementById('strategy-type').value = strategy?.strategy_type || 'custom';
            document.getElementById('strategy-risk').value = strategy?.risk_level || 'moderate';
            document.getElementById('strategy-min-buy').value = strategy?.min_buy_signals || 3;
            document.getElementById('strategy-min-sell').value = strategy?.min_sell_signals || 3;
            document.getElementById('strategy-stop-loss').value = strategy?.stop_loss_atr_multiplier || 2.0;
            document.getElementById('strategy-take-profit').value = strategy?.take_profit_atr_multiplier || 3.0;
            document.getElementById('strategy-modal').classList.add('active');
        }

        function closeStrategyModal() {
            document.getElementById('strategy-modal').classList.remove('active');
        }

        function editStrategy(id) {
            const strategy = allStrategies.find(s => s.id === id);
            if (strategy) openStrategyModal(strategy);
        }

        async function saveStrategy(event) {
            event.preventDefault();
            const id = document.getElementById('strategy-id').value;
            const data = {
                id: id || 'custom_' + Date.now(),
                name: document.getElementById('strategy-name').value,
                description: document.getElementById('strategy-description').value,
                strategy_type: document.getElementById('strategy-type').value,
                risk_level: document.getElementById('strategy-risk').value,
                min_buy_signals: parseInt(document.getElementById('strategy-min-buy').value),
                min_sell_signals: parseInt(document.getElementById('strategy-min-sell').value),
                stop_loss_atr_multiplier: parseFloat(document.getElementById('strategy-stop-loss').value),
                take_profit_atr_multiplier: parseFloat(document.getElementById('strategy-take-profit').value),
                indicators: []
            };

            try {
                const url = id ? `${API_BASE}/strategies/${id}` : `${API_BASE}/strategies`;
                const method = id ? 'PUT' : 'POST';
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeStrategyModal();
                await loadStrategies();
                showToast('Strategie gespeichert', 'success');
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteStrategy(id) {
            if (!confirm('Strategie wirklich löschen?')) return;
            try {
                await fetch(`${API_BASE}/strategies/${id}`, { method: 'DELETE' });
                await loadStrategies();
                showToast('Strategie geloscht', 'success');
            } catch (error) {
                showToast('Fehler beim Löschen', 'error');
            }
        }

        async function setDefault(id) {
            try {
                await fetch(`${API_BASE}/strategies/${id}/set-default`, { method: 'POST' });
                await loadStrategies();
                showToast('Standard-Strategie gesetzt', 'success');
            } catch (error) {
                showToast('Fehler beim Setzen', 'error');
            }
        }

        async function exportStrategy(id) {
            try {
                const response = await fetch(`${API_BASE}/strategies/${id}/export`);
                const text = await response.text();
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `strategy_${id}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Strategie exportiert', 'success');
            } catch (error) {
                showToast('Fehler beim Export', 'error');
            }
        }

        // ==================== Export/Import Functions ====================

        let allExports = [];

        async function loadExports() {
            try {
                const response = await fetch(`${API_BASE}/config/exports`);
                allExports = await response.json();
                renderExports();
                updateExportStats();
            } catch (error) {
                console.error('Error loading exports:', error);
                showToast('Fehler beim Laden der Exports', 'error');
            }
        }

        function updateExportStats() {
            document.getElementById('export-count').textContent = allExports.length;
            document.getElementById('export-symbols-total').textContent = allSymbols.length;
            document.getElementById('export-strategies-total').textContent = allStrategies.length;
        }

        function renderExports() {
            const tbody = document.getElementById('exports-body');

            if (allExports.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state">
                    <div class="empty-state-icon">&#128230;</div>
                    Keine gespeicherten Exports vorhanden
                </td></tr>`;
                return;
            }

            tbody.innerHTML = allExports.map(e => `
                <tr data-filename="${e.filename}">
                    <td><strong>${e.filename}</strong></td>
                    <td>${e.description || '-'}</td>
                    <td>${formatDate(e.created_at)}</td>
                    <td>${e.symbols_count}</td>
                    <td>${e.strategies_count}</td>
                    <td>${formatFileSize(e.file_size)}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="downloadExport('${e.filename}')" title="Herunterladen">&#8681;</button>
                        <button class="btn btn-primary btn-sm" onclick="importFromSaved('${e.filename}')" title="Importieren">&#8678;</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteExport('${e.filename}')" title="Löschen">&#10006;</button>
                    </td>
                </tr>
            `).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatFileSize(bytes) {
            if (!bytes) return '-';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function createExport() {
            const description = document.getElementById('export-description').value;
            const filename = document.getElementById('export-filename').value;
            const includeSymbols = document.getElementById('export-symbols').checked;
            const includeStrategies = document.getElementById('export-strategies').checked;

            if (!includeSymbols && !includeStrategies) {
                showToast('Bitte mindestens eine Option wählen', 'error');
                return;
            }

            try {
                showToast('Erstelle Export...', 'info');
                const params = new URLSearchParams();
                if (description) params.append('description', description);
                if (filename) params.append('filename', filename);
                params.append('include_symbols', includeSymbols);
                params.append('include_strategies', includeStrategies);

                const response = await fetch(`${API_BASE}/config/export?${params}`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    document.getElementById('export-description').value = '';
                    document.getElementById('export-filename').value = '';
                    await loadExports();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Fehler beim Export', 'error');
            }
        }

        async function downloadCurrentConfig() {
            const includeSymbols = document.getElementById('export-symbols').checked;
            const includeStrategies = document.getElementById('export-strategies').checked;

            if (!includeSymbols && !includeStrategies) {
                showToast('Bitte mindestens eine Option wählen', 'error');
                return;
            }

            try {
                // Create config object locally
                const config = {
                    version: '1.0',
                    exported_at: new Date().toISOString(),
                    description: document.getElementById('export-description').value || 'Direkter Download',
                    symbols: includeSymbols ? allSymbols : [],
                    strategies: includeStrategies ? allStrategies : []
                };

                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = document.getElementById('export-filename').value || `config_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Konfiguration heruntergeladen', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Fehler beim Download', 'error');
            }
        }

        async function downloadExport(filename) {
            try {
                const response = await fetch(`${API_BASE}/config/exports/${filename}`);
                const data = await response.json();

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Export heruntergeladen', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Fehler beim Download', 'error');
            }
        }

        async function deleteExport(filename) {
            if (!confirm(`Export "${filename}" wirklich löschen?`)) return;

            try {
                const response = await fetch(`${API_BASE}/config/exports/${filename}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    showToast('Export gelöscht', 'success');
                    await loadExports();
                } else {
                    showToast('Fehler beim Löschen', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Fehler beim Löschen', 'error');
            }
        }

        async function uploadAndImport() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];

            if (!file) {
                showToast('Bitte eine Datei auswählen', 'error');
                return;
            }

            const importSymbols = document.getElementById('import-symbols').checked;
            const importStrategies = document.getElementById('import-strategies').checked;
            const overwrite = document.getElementById('import-overwrite').checked;

            if (!importSymbols && !importStrategies) {
                showToast('Bitte mindestens eine Import-Option wählen', 'error');
                return;
            }

            try {
                showToast('Importiere Konfiguration...', 'info');

                const formData = new FormData();
                formData.append('file', file);

                const params = new URLSearchParams();
                params.append('import_symbols', importSymbols);
                params.append('import_strategies', importStrategies);
                params.append('overwrite_existing', overwrite);

                const response = await fetch(`${API_BASE}/config/import?${params}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    fileInput.value = '';
                    // Reload data
                    await loadSymbols();
                    await loadStrategies();
                    updateExportStats();
                } else {
                    showToast(result.message, 'error');
                }

                if (result.errors && result.errors.length > 0) {
                    console.warn('Import warnings:', result.errors);
                }
            } catch (error) {
                console.error('Import error:', error);
                showToast('Fehler beim Import', 'error');
            }
        }

        async function importFromSaved(filename) {
            const overwrite = confirm('Bestehende Einträge überschreiben?\n\nOK = Überschreiben\nAbbrechen = Nur neue hinzufügen');

            try {
                showToast('Importiere aus gespeichertem Export...', 'info');

                const params = new URLSearchParams();
                params.append('import_symbols', true);
                params.append('import_strategies', true);
                params.append('overwrite_existing', overwrite);

                const response = await fetch(`${API_BASE}/config/import/${filename}?${params}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    await loadSymbols();
                    await loadStrategies();
                    updateExportStats();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showToast('Fehler beim Import', 'error');
            }
        }

        // ==================== Data Stats Modal ====================

        function closeDataStatsModal() {
            document.getElementById('data-stats-modal').classList.remove('active');
        }

        async function showDataStats(symbol) {
            document.getElementById('data-stats-modal-title').textContent = `Datenpunkte: ${symbol}`;
            document.getElementById('data-stats-content').innerHTML = `
                <div class="loading"><div class="spinner"></div><br>Lade Datenstatistiken...</div>
            `;
            document.getElementById('data-stats-modal').classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/managed-symbols/data-stats/${encodeURIComponent(symbol)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderDataStats(data);
            } catch (error) {
                console.error('Error loading data stats:', error);
                document.getElementById('data-stats-content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9888;</div>
                        Fehler beim Laden der Datenstatistiken: ${error.message}
                    </div>
                `;
            }
        }

        function renderDataStats(data) {
            const content = document.getElementById('data-stats-content');
            const errors = data.errors && data.errors.length > 0
                ? `<div style="background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; color: #dc3545;">
                    <strong>Hinweise:</strong> ${data.errors.join(', ')}
                   </div>`
                : '';

            // Format timestamps
            const firstDate = data.first_timestamp ? new Date(data.first_timestamp).toLocaleString('de-DE') : '-';
            const lastDate = data.last_timestamp ? new Date(data.last_timestamp).toLocaleString('de-DE') : '-';

            // Calculate data range in days
            let dataRangeDays = 0;
            if (data.first_timestamp && data.last_timestamp) {
                const first = new Date(data.first_timestamp);
                const last = new Date(data.last_timestamp);
                dataRangeDays = Math.round((last - first) / (1000 * 60 * 60 * 24));
            }

            // Create progress bar helper
            function progressBar(pct, color = '#64c8ff') {
                return `
                    <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden; margin-top: 4px;">
                        <div style="background: ${color}; width: ${Math.min(100, pct)}%; height: 100%; transition: width 0.3s;"></div>
                    </div>
                `;
            }

            // Quality color
            function qualityColor(pct) {
                if (pct >= 90) return '#4caf50';
                if (pct >= 70) return '#ffc107';
                return '#f44336';
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="color: #888;">Abgerufen: ${new Date(data.timestamp).toLocaleString('de-DE')}</span>
                    <button class="btn btn-secondary btn-sm" onclick="showDataStats('${data.symbol}')">&#8635; Aktualisieren</button>
                </div>
                ${errors}

                <!-- Overview Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: rgba(100, 200, 255, 0.1); border-radius: 8px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #64c8ff;">${data.total_records.toLocaleString()}</div>
                        <div style="color: #888; font-size: 0.85rem;">Gesamt Datenpunkte</div>
                    </div>
                    <div style="background: rgba(76, 175, 80, 0.1); border-radius: 8px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #4caf50;">${dataRangeDays}</div>
                        <div style="color: #888; font-size: 0.85rem;">Tage Datenbereich</div>
                    </div>
                    <div style="background: rgba(156, 39, 176, 0.1); border-radius: 8px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: ${qualityColor(data.data_quality.completeness_pct)};">${data.data_quality.completeness_pct}%</div>
                        <div style="color: #888; font-size: 0.85rem;">Vollständigkeit</div>
                    </div>
                    <div style="background: rgba(255, 152, 0, 0.1); border-radius: 8px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: ${data.data_quality.gaps_detected > 5 ? '#f44336' : '#ffc107'};">${data.data_quality.gaps_detected}</div>
                        <div style="color: #888; font-size: 0.85rem;">Datenlücken</div>
                    </div>
                </div>

                <!-- Date Range -->
                <div style="background: rgba(30,30,30,0.5); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="color: #64c8ff; margin-bottom: 1rem; font-size: 1rem;">&#128197; Datenbereich</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <div style="color: #888; font-size: 0.85rem;">Erster Datenpunkt</div>
                            <div style="font-size: 1.1rem; color: #fff;">${firstDate}</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.85rem;">Letzter Datenpunkt</div>
                            <div style="font-size: 1.1rem; color: #fff;">${lastDate}</div>
                        </div>
                    </div>
                    <!-- Timeline Visualization -->
                    <div style="margin-top: 1rem; position: relative;">
                        <div style="background: rgba(100, 200, 255, 0.2); height: 24px; border-radius: 12px; position: relative; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #64c8ff 0%, #4caf50 100%); height: 100%; width: 100%; opacity: 0.8;"></div>
                            <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: #fff;">Start</div>
                            <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: #fff;">Aktuell</div>
                        </div>
                    </div>
                </div>

                <!-- Timeframe Breakdown -->
                <div style="background: rgba(30,30,30,0.5); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="color: #64c8ff; margin-bottom: 1rem; font-size: 1rem;">&#128202; Datenpunkte pro Zeitrahmen</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500;">M15 (15 Min)</span>
                                <span style="color: #64c8ff; font-weight: bold;">${data.timeframes.M15.count.toLocaleString()}</span>
                            </div>
                            ${progressBar(data.timeframes.M15.coverage_pct)}
                            <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">Abdeckung: ${data.timeframes.M15.coverage_pct}%</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500;">H1 (Stündlich)</span>
                                <span style="color: #4caf50; font-weight: bold;">${data.timeframes.H1.count.toLocaleString()}</span>
                            </div>
                            ${progressBar(data.timeframes.H1.coverage_pct, '#4caf50')}
                            <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">Abdeckung: ${data.timeframes.H1.coverage_pct}%</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500;">D1 (Täglich)</span>
                                <span style="color: #9c27b0; font-weight: bold;">${data.timeframes.D1.count.toLocaleString()}</span>
                            </div>
                            ${progressBar(data.timeframes.D1.coverage_pct, '#9c27b0')}
                            <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">Abdeckung: ${data.timeframes.D1.coverage_pct}%</div>
                        </div>
                    </div>
                </div>

                <!-- Data Quality -->
                <div style="background: rgba(30,30,30,0.5); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="color: #64c8ff; margin-bottom: 1rem; font-size: 1rem;">&#128270; Datenqualität</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div>
                            <div style="color: #888; font-size: 0.85rem;">Erkannte Lücken (&gt;2h)</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: ${data.data_quality.gaps_detected > 5 ? '#f44336' : data.data_quality.gaps_detected > 0 ? '#ffc107' : '#4caf50'};">
                                ${data.data_quality.gaps_detected}
                            </div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.85rem;">Durchschn. Lücke</div>
                            <div style="font-size: 1.2rem; font-weight: 500;">${data.data_quality.avg_gap_hours}h</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.85rem;">Max. Lücke</div>
                            <div style="font-size: 1.2rem; font-weight: 500; color: ${data.data_quality.max_gap_hours > 24 ? '#f44336' : '#fff'};">${data.data_quality.max_gap_hours}h</div>
                        </div>
                    </div>
                </div>

                <!-- Mini Chart (if sample data available) -->
                ${data.sample_data && (data.sample_data.M15?.length > 0 || data.sample_data.H1?.length > 0 || data.sample_data.D1?.length > 0) ? `
                <div style="background: rgba(30,30,30,0.5); border-radius: 12px; padding: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #64c8ff; font-size: 1rem; margin: 0;">&#128200; Letzte Datenpunkte (Vorschau)</h4>
                        <div class="chart-timeframe-tabs" style="display: flex; gap: 0.25rem;">
                            <button class="chart-tf-btn active" data-tf="M15" onclick="switchChartTimeframe('M15')"
                                    style="padding: 0.3rem 0.75rem; border: 1px solid rgba(100, 200, 255, 0.3); background: rgba(100, 200, 255, 0.2); color: #64c8ff; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                M15
                            </button>
                            <button class="chart-tf-btn" data-tf="H1" onclick="switchChartTimeframe('H1')"
                                    style="padding: 0.3rem 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); background: transparent; color: #888; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                H1
                            </button>
                            <button class="chart-tf-btn" data-tf="D1" onclick="switchChartTimeframe('D1')"
                                    style="padding: 0.3rem 0.75rem; border: 1px solid rgba(255, 255, 255, 0.1); background: transparent; color: #888; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                D1
                            </button>
                        </div>
                    </div>
                    <div id="mini-chart-container" style="height: 120px; position: relative; overflow: hidden;">
                        ${renderMiniChart(data.sample_data.M15, 'M15')}
                    </div>
                    <div id="chart-info" style="font-size: 0.75rem; color: #888; margin-top: 0.5rem; text-align: center;">
                        Zeigt die letzten ${data.sample_data.M15?.length || 0} M15-Schlusskurse
                    </div>
                </div>
                ` : ''}
            `;

            content.innerHTML = html;

            // Store sample data globally for timeframe switching
            window.currentChartData = data.sample_data;
        }

        let currentChartTimeframe = 'M15';

        function switchChartTimeframe(tf) {
            currentChartTimeframe = tf;

            // Update button styles
            document.querySelectorAll('.chart-tf-btn').forEach(btn => {
                if (btn.dataset.tf === tf) {
                    btn.style.background = 'rgba(100, 200, 255, 0.2)';
                    btn.style.borderColor = 'rgba(100, 200, 255, 0.3)';
                    btn.style.color = '#64c8ff';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'transparent';
                    btn.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                    btn.style.color = '#888';
                    btn.classList.remove('active');
                }
            });

            // Update chart
            const container = document.getElementById('mini-chart-container');
            const info = document.getElementById('chart-info');

            if (window.currentChartData && window.currentChartData[tf]) {
                container.innerHTML = renderMiniChart(window.currentChartData[tf], tf);
                const count = window.currentChartData[tf].length;
                const tfLabels = { 'M15': '15-Minuten', 'H1': 'Stunden', 'D1': 'Tages' };
                info.textContent = `Zeigt die letzten ${count} ${tfLabels[tf]}-Schlusskurse`;
            } else {
                container.innerHTML = '<div style="text-align: center; color: #888; padding: 2rem;">Keine Daten für diesen Zeitrahmen verfügbar</div>';
                info.textContent = '';
            }
        }

        function renderMiniChart(sampleData, timeframe = 'M15') {
            if (!sampleData || sampleData.length === 0) return '<div style="text-align: center; color: #888; padding: 2rem;">Keine Daten verfügbar</div>';

            // Get close prices
            const prices = sampleData
                .filter(d => d.close !== null && d.close !== undefined)
                .map(d => parseFloat(d.close))
                .reverse(); // Oldest first

            if (prices.length < 2) return '<div style="text-align: center; color: #888; padding: 2rem;">Zu wenige Datenpunkte</div>';

            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const range = maxPrice - minPrice || 1;
            const width = 100 / (prices.length - 1);

            // Create SVG path
            let path = '';
            let areaPath = `M 0,100 `;
            prices.forEach((price, i) => {
                const x = (i * width);
                const y = 100 - ((price - minPrice) / range * 80 + 10); // Leave margins
                if (i === 0) {
                    path = `M ${x},${y}`;
                    areaPath += `L ${x},${y} `;
                } else {
                    path += ` L ${x},${y}`;
                    areaPath += `L ${x},${y} `;
                }
            });
            areaPath += `L 100,100 Z`;

            // Determine color based on trend
            const trendColor = prices[prices.length - 1] >= prices[0] ? '#4caf50' : '#f44336';

            // Timeframe-specific colors
            const tfColors = { 'M15': '#64c8ff', 'H1': '#4caf50', 'D1': '#9c27b0' };
            const lineColor = tfColors[timeframe] || trendColor;

            // Generate unique gradient ID to avoid conflicts
            const gradientId = `chartGradient_${timeframe}_${Date.now()}`;

            return `
                <svg viewBox="0 0 100 100" preserveAspectRatio="none" style="width: 100%; height: 100%;">
                    <defs>
                        <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:${lineColor};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${lineColor};stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    <path d="${areaPath}" fill="url(#${gradientId})" />
                    <path d="${path}" fill="none" stroke="${lineColor}" stroke-width="0.5" />
                </svg>
                <div style="position: absolute; top: 5px; left: 10px; font-size: 0.75rem; color: #888;">
                    High: ${maxPrice.toFixed(maxPrice < 10 ? 5 : 2)}
                </div>
                <div style="position: absolute; bottom: 5px; left: 10px; font-size: 0.75rem; color: #888;">
                    Low: ${minPrice.toFixed(minPrice < 10 ? 5 : 2)}
                </div>
                <div style="position: absolute; top: 5px; right: 10px; font-size: 0.75rem; color: ${trendColor};">
                    ${prices[prices.length - 1] >= prices[0] ? '▲' : '▼'} ${((prices[prices.length - 1] - prices[0]) / prices[0] * 100).toFixed(2)}%
                </div>
            `;
        }

        // ==================== Live Data Modal ====================

        function closeLiveDataModal() {
            document.getElementById('live-data-modal').classList.remove('active');
        }

        async function showLiveData(symbol) {
            document.getElementById('live-data-modal-title').textContent = `Live-Daten: ${symbol}`;
            document.getElementById('live-data-content').innerHTML = `
                <div class="loading"><div class="spinner"></div><br>Lade Live-Daten von EasyInsight und TwelveData...</div>
            `;
            document.getElementById('live-data-modal').classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/managed-symbols/live-data/${encodeURIComponent(symbol)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderLiveData(data);
            } catch (error) {
                console.error('Error loading live data:', error);
                document.getElementById('live-data-content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9888;</div>
                        Fehler beim Laden der Live-Daten: ${error.message}
                    </div>
                `;
            }
        }

        function renderLiveData(data) {
            const content = document.getElementById('live-data-content');
            const errors = data.errors && data.errors.length > 0
                ? `<div style="background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; color: #dc3545;">
                    <strong>Hinweise:</strong> ${data.errors.join(', ')}
                   </div>`
                : '';

            const ei = data.easyinsight;
            const td = data.twelvedata;
            const yf = data.yfinance;
            const changeColor = td && parseFloat(td.change) >= 0 ? '#4caf50' : '#f44336';
            const yfChangeColor = yf && parseFloat(yf.change) >= 0 ? '#4caf50' : '#f44336';

            // Helper to create comparison row with 3 data sources
            function compareRow(label, eiValue, tdValue, yfValue, options = {}) {
                const eiFormatted = options.formatter ? options.formatter(eiValue, 'ei') : formatValue(eiValue, options.decimals);
                const tdFormatted = options.formatter ? options.formatter(tdValue, 'td') : formatValue(tdValue, options.decimals);
                const yfFormatted = options.formatter ? options.formatter(yfValue, 'yf') : formatValue(yfValue, options.decimals);
                const eiStyle = options.eiStyle || '';
                const tdStyle = options.tdStyle || '';
                const yfStyle = options.yfStyle || '';

                // Check if values match (within tolerance for floats)
                let matchIndicator = '';
                const values = [eiValue, tdValue, yfValue].filter(v => v !== null && v !== undefined);
                if (values.length >= 2) {
                    const nums = values.map(v => parseFloat(v)).filter(n => !isNaN(n));
                    if (nums.length >= 2) {
                        const max = Math.max(...nums);
                        const min = Math.min(...nums);
                        const avg = nums.reduce((a, b) => a + b, 0) / nums.length;
                        const pctDiff = avg > 0 ? ((max - min) / avg) * 100 : 0;
                        if (pctDiff < 0.01) {
                            matchIndicator = '<span style="color: #4caf50;" title="Werte stimmen überein">&#10003;</span>';
                        } else if (pctDiff < 1) {
                            matchIndicator = '<span style="color: #ffc107;" title="Kleine Abweichung">&#8776;</span>';
                        } else {
                            matchIndicator = '<span style="color: #f44336;" title="Unterschiedliche Werte">&#10007;</span>';
                        }
                    }
                }

                return `<tr>
                    <td style="color: #aaa; padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">${label}</td>
                    <td style="text-align: right; font-family: monospace; padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(33, 150, 243, 0.03); ${eiStyle}">${eiFormatted}</td>
                    <td style="text-align: right; font-family: monospace; padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(156, 39, 176, 0.03); ${tdStyle}">${tdFormatted}</td>
                    <td style="text-align: right; font-family: monospace; padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(255, 152, 0, 0.03); ${yfStyle}">${yfFormatted}</td>
                    <td style="text-align: center; padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); width: 30px;">${matchIndicator}</td>
                </tr>`;
            }

            // Section header row
            function sectionHeader(title) {
                return `<tr>
                    <td colspan="5" style="background: rgba(255,255,255,0.03); padding: 10px 12px; font-weight: bold; color: #fff; border-bottom: 2px solid rgba(255,255,255,0.1);">
                        ${title}
                    </td>
                </tr>`;
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="color: #888;">Abgerufen: ${new Date(data.timestamp).toLocaleString('de-DE')}</span>
                    <button class="btn btn-secondary btn-sm" onclick="showLiveData('${data.symbol}')">&#8635; Aktualisieren</button>
                </div>
                ${errors}

                <!-- Timestamp Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: rgba(33, 150, 243, 0.1); border-radius: 8px; padding: 0.75rem; text-align: center;">
                        <div style="color: #2196f3; font-weight: bold; margin-bottom: 0.25rem;">&#128202; EasyInsight</div>
                        <div style="color: #888; font-size: 0.8rem;">${ei?.snapshot_time_display || 'Keine Daten'}</div>
                    </div>
                    <div style="background: rgba(156, 39, 176, 0.1); border-radius: 8px; padding: 0.75rem; text-align: center;">
                        <div style="color: #9c27b0; font-weight: bold; margin-bottom: 0.25rem;">&#128200; TwelveData${td?.symbol_used ? ` (${td.symbol_used})` : ''}</div>
                        <div style="color: #888; font-size: 0.8rem;">${td?.indicator_datetime_display || td?.datetime_display || 'Keine Daten'}</div>
                    </div>
                    <div style="background: rgba(255, 152, 0, 0.1); border-radius: 8px; padding: 0.75rem; text-align: center;">
                        <div style="color: #ff9800; font-weight: bold; margin-bottom: 0.25rem;">&#128200; Yahoo Finance${yf?.symbol_used ? ` (${yf.symbol_used})` : ''}</div>
                        <div style="color: #888; font-size: 0.8rem;">${yf?.datetime_display || 'Keine Daten'}</div>
                    </div>
                </div>

                <!-- Comparison Table -->
                <div style="background: rgba(30,30,30,0.5); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.05);">
                                <th style="text-align: left; padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.1); width: 20%;">Indikator</th>
                                <th style="text-align: right; padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.1); color: #2196f3; width: 22%;">EasyInsight</th>
                                <th style="text-align: right; padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.1); color: #9c27b0; width: 22%;">TwelveData</th>
                                <th style="text-align: right; padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.1); color: #ff9800; width: 22%;">Yahoo Finance</th>
                                <th style="text-align: center; padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.1); width: 14%;" title="Vergleich">&#8596;</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sectionHeader('&#128181; Bid/Ask & Spread')}
                            <tr>
                                <td colspan="5" style="padding: 6px 12px; background: rgba(156,39,176,0.05); border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span style="color: #9c27b0; font-size: 0.75rem;">&#9432; TwelveData/Yahoo Finance liefern keine Bid/Ask-Daten (nur Exchange OHLCV)</span>
                                </td>
                            </tr>
                            ${compareRow('Bid', ei?.price?.bid, td?.bid_ask?.bid, null)}
                            ${compareRow('Ask', ei?.price?.ask, td?.bid_ask?.ask, null)}
                            ${compareRow('Spread', ei?.price?.spread, td?.bid_ask?.spread, null)}
                            ${compareRow('Spread %', ei?.price?.spread_pct, td?.bid_ask?.spread_pct, null, {decimals: 4})}

                            ${sectionHeader('&#128176; Preisdaten (OHLC)')}
                            ${compareRow('Open', ei?.ohlc?.d1?.open, td?.price?.open, yf?.price?.open)}
                            ${compareRow('High', ei?.ohlc?.d1?.high, td?.price?.high, yf?.price?.high, {eiStyle: 'color: #4caf50;', tdStyle: 'color: #4caf50;', yfStyle: 'color: #4caf50;'})}
                            ${compareRow('Low', ei?.ohlc?.d1?.low, td?.price?.low, yf?.price?.low, {eiStyle: 'color: #f44336;', tdStyle: 'color: #f44336;', yfStyle: 'color: #f44336;'})}
                            ${compareRow('Close', ei?.ohlc?.d1?.close, td?.price?.close, yf?.price?.close)}
                            ${compareRow('Prev. Close', null, td?.price?.previous_close, yf?.price?.previous_close)}

                            ${sectionHeader('&#128200; Änderung')}
                            ${compareRow('Änderung', null, td?.change, yf?.change, {tdStyle: `color: ${changeColor};`, yfStyle: `color: ${yfChangeColor};`})}
                            ${compareRow('Änderung %', null, td?.percent_change, yf?.change_percent, {decimals: 2, tdStyle: `color: ${changeColor};`, yfStyle: `color: ${yfChangeColor};`})}

                            ${sectionHeader('&#128202; Technische Indikatoren')}
                            ${compareRow('RSI (14)', ei?.indicators?.rsi, td?.indicators?.rsi, null, {
                                formatter: (v) => {
                                    if (v === null || v === undefined) return '-';
                                    const num = parseFloat(v);
                                    let color = '#ffc107';
                                    if (num >= 70) color = '#f44336';
                                    else if (num <= 30) color = '#4caf50';
                                    return `<span style="color: ${color};">${num.toFixed(2)}</span>`;
                                }
                            })}
                            ${compareRow('MACD Main', ei?.indicators?.macd?.main, td?.indicators?.macd?.main, null, {decimals: 5})}
                            ${compareRow('MACD Signal', ei?.indicators?.macd?.signal, td?.indicators?.macd?.signal, null, {decimals: 5})}
                            ${compareRow('MACD Histogram', null, td?.indicators?.macd?.histogram, null, {decimals: 5})}
                            ${compareRow('Stochastic %K', ei?.indicators?.stochastic?.main, td?.indicators?.stochastic?.k, null, {decimals: 2})}
                            ${compareRow('Stochastic %D', ei?.indicators?.stochastic?.signal, td?.indicators?.stochastic?.d, null, {decimals: 2})}
                            ${compareRow('CCI', ei?.indicators?.cci, null, null, {decimals: 2})}
                            ${compareRow('ADX', ei?.indicators?.adx?.main, td?.indicators?.adx, null, {decimals: 2})}
                            ${compareRow('MA/EMA (10)', ei?.indicators?.ma_10, td?.indicators?.ema_10, null)}
                            ${compareRow('ATR (D1)', ei?.indicators?.atr?.d1, td?.indicators?.atr, null)}
                            ${compareRow('ATR % (D1)', ei?.indicators?.atr?.d1_pct, null, null, {decimals: 2})}

                            ${sectionHeader('&#128200; Bollinger Bands')}
                            ${compareRow('Upper Band', ei?.indicators?.bollinger?.upper, td?.indicators?.bollinger?.upper, null)}
                            ${compareRow('Middle Band', ei?.indicators?.bollinger?.base, td?.indicators?.bollinger?.middle, null)}
                            ${compareRow('Lower Band', ei?.indicators?.bollinger?.lower, td?.indicators?.bollinger?.lower, null)}

                            ${sectionHeader('&#9729; Ichimoku Cloud')}
                            ${compareRow('Tenkan-sen', ei?.indicators?.ichimoku?.tenkan, td?.indicators?.ichimoku?.tenkan, null)}
                            ${compareRow('Kijun-sen', ei?.indicators?.ichimoku?.kijun, td?.indicators?.ichimoku?.kijun, null)}
                            ${compareRow('Senkou Span A', ei?.indicators?.ichimoku?.senkou_a, td?.indicators?.ichimoku?.senkou_a, null)}
                            ${compareRow('Senkou Span B', ei?.indicators?.ichimoku?.senkou_b, td?.indicators?.ichimoku?.senkou_b, null)}
                            ${compareRow('Chikou Span', ei?.indicators?.ichimoku?.chikou, td?.indicators?.ichimoku?.chikou, null)}

                            ${sectionHeader('&#128200; Trend-Stärke')}
                            ${compareRow('4H Trend', ei?.indicators?.strength?.h4, null, null, {
                                formatter: (v) => formatStrength(v)
                            })}
                            ${compareRow('1D Trend', ei?.indicators?.strength?.d1, null, null, {
                                formatter: (v) => formatStrength(v)
                            })}
                            ${compareRow('1W Trend', ei?.indicators?.strength?.w1, null, null, {
                                formatter: (v) => formatStrength(v)
                            })}

                            ${sectionHeader('&#128202; Volumen & Markt')}
                            ${compareRow('Volumen', null, td?.volume, yf?.price?.volume, {
                                formatter: (v) => v ? parseInt(v).toLocaleString() : '-'
                            })}
                            ${compareRow('Avg. Volumen', null, td?.average_volume, null, {
                                formatter: (v) => v ? parseInt(v).toLocaleString() : '-'
                            })}
                            ${compareRow('Markt offen', null, td?.is_market_open, null, {
                                formatter: (v) => v === true ? '<span style="color: #4caf50;">Ja</span>' : (v === false ? '<span style="color: #f44336;">Nein</span>' : '-')
                            })}

                            ${sectionHeader('&#128197; 52-Wochen Range')}
                            ${compareRow('52W Low', null, td?.fifty_two_week?.low, null, {tdStyle: 'color: #f44336;'})}
                            ${compareRow('52W High', null, td?.fifty_two_week?.high, null, {tdStyle: 'color: #4caf50;'})}

                            ${sectionHeader('&#127970; Stammdaten')}
                            ${compareRow('Name', null, td?.name, yf?.name, {formatter: (v) => v || '-'})}
                            ${compareRow('Exchange', null, td?.exchange, yf?.exchange, {formatter: (v) => v || '-'})}
                            ${compareRow('Währung', null, td?.currency, yf?.currency, {formatter: (v) => v || '-'})}
                        </tbody>
                    </table>
                </div>

                <!-- Legend -->
                <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: center; font-size: 0.75rem; color: #888;">
                    <span><span style="color: #2196f3;">&#9632;</span> EasyInsight</span>
                    <span><span style="color: #9c27b0;">&#9632;</span> TwelveData</span>
                    <span><span style="color: #ff9800;">&#9632;</span> Yahoo Finance</span>
                    <span style="margin-left: 1rem;"><span style="color: #4caf50;">&#10003;</span> Identisch (&lt;0.01%)</span>
                    <span><span style="color: #ffc107;">&#8776;</span> Abweichung (&lt;1%)</span>
                    <span><span style="color: #f44336;">&#10007;</span> Unterschiedlich (&gt;1%)</span>
                </div>
            `;

            content.innerHTML = html;
        }

        function formatValue(value, decimals = 5) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            // Format with Swiss locale (apostrophe as thousand separator)
            const parts = num.toFixed(decimals).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "'");
            return parts.join('.');
        }

        function formatIndicator(value, type) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return value;

            let color = '#fff';
            if (type === 'rsi') {
                if (num >= 70) color = '#f44336';
                else if (num <= 30) color = '#4caf50';
                else color = '#ffc107';
            }
            return `<span style="color: ${color};">${num.toFixed(2)}</span>`;
        }

        function formatStrength(value) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return value;

            let color = '#ffc107';
            let label = 'Neutral';
            if (num > 0.3) { color = '#4caf50'; label = 'Bullish'; }
            else if (num < -0.3) { color = '#f44336'; label = 'Bearish'; }

            return `<span style="color: ${color};">${num.toFixed(2)} (${label})</span>`;
        }

        // ==================== Daten-Explorer ====================

        let explorerData = [];

        function populateExplorerSymbols() {
            const select = document.getElementById('explorer-symbol');
            select.innerHTML = '<option value="">Symbol wählen...</option>';

            // Category labels
            const catLabels = {
                'crypto': 'Krypto',
                'forex': 'Forex',
                'index': 'Indizes',
                'commodity': 'Rohstoffe',
                'stock': 'Aktien',
                'etf': 'ETFs',
                'other': 'Andere'
            };

            // Subcategory labels
            const subcatLabels = {
                'major': 'Major', 'minor': 'Minor', 'exotic': 'Exotic',
                'large_cap': 'Large Cap', 'mid_cap': 'Mid Cap', 'small_cap': 'Small Cap',
                'defi': 'DeFi', 'meme': 'Meme', 'stablecoin': 'Stablecoin',
                'tech': 'Tech', 'finance': 'Finance', 'healthcare': 'Healthcare',
                'energy': 'Energy', 'consumer': 'Consumer', 'industrial': 'Industrial',
                'global': 'Global', 'regional': 'Regional', 'sector': 'Sektor',
                'precious_metal': 'Edelmetalle', 'base_metal': 'Basismetalle',
                'agriculture': 'Agrar', 'energy_commodity': 'Energie',
                'other': 'Andere'
            };

            // Category order for display
            const catOrder = ['forex', 'crypto', 'index', 'commodity', 'stock', 'etf', 'other'];

            // Group by category, then by subcategory
            const grouped = {};
            allSymbols.forEach(s => {
                const cat = s.category || 'other';
                const subcat = s.subcategory || 'other';
                if (!grouped[cat]) grouped[cat] = {};
                if (!grouped[cat][subcat]) grouped[cat][subcat] = [];
                grouped[cat][subcat].push(s);
            });

            // Build optgroups - category with subcategory
            catOrder.forEach(cat => {
                if (!grouped[cat]) return;
                const subcats = Object.keys(grouped[cat]).sort();

                subcats.forEach(subcat => {
                    const symbols = grouped[cat][subcat];
                    if (!symbols.length) return;

                    const group = document.createElement('optgroup');
                    const catLabel = catLabels[cat] || cat;
                    const subcatLabel = subcatLabels[subcat] || subcat;
                    group.label = subcat === 'other' ? catLabel : `${catLabel} - ${subcatLabel}`;

                    symbols.sort((a, b) => a.symbol.localeCompare(b.symbol)).forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.symbol;
                        // Store TwelveData symbol as data attribute for direct API access
                        if (s.twelvedata_symbol) {
                            opt.dataset.twelvedata = s.twelvedata_symbol;
                        }
                        opt.textContent = s.display_name || s.symbol;
                        group.appendChild(opt);
                    });
                    select.appendChild(group);
                });
            });
        }

        // Convert training data response to explorer format (supports TwelveData and EasyInsight formats)
        function convertEasyInsightHistoricalData(trainingData, indicators, timeframe) {
            const data = trainingData.data || [];
            if (!data.length) return [];

            // Check source - TwelveData uses direct OHLC, EasyInsight uses prefixed fields
            const source = trainingData.source || 'unknown';
            const isTwelveData = source === 'twelvedata' || (data[0] && data[0].open !== undefined);

            // Map timeframe to field prefix (for EasyInsight format)
            // Note: EasyInsight primarily stores H1 data, so M1/M5/M30 will fallback to h1
            const tfPrefix = {
                'M1': 'h1', '1min': 'h1',     // EasyInsight doesn't have M1, use H1 as fallback
                'M5': 'h1', '5min': 'h1',     // EasyInsight doesn't have M5, use H1 as fallback
                'M15': 'm15', '15min': 'm15',
                'M30': 'h1', '30min': 'h1',   // EasyInsight doesn't have M30, use H1 as fallback
                'H1': 'h1', '1h': 'h1',
                'H4': 'h4', '4h': 'h4',
                'D1': 'd1', '1day': 'd1',
                'W1': 'd1', '1week': 'd1'     // EasyInsight doesn't have W1, use D1 as fallback
            };
            const prefix = tfPrefix[timeframe] || 'h1';

            return data.map(row => {
                // TwelveData format: direct open/high/low/close/datetime fields
                // EasyInsight format: snapshot_time, h1_open, h1_high, etc.
                const result = {
                    datetime: row.datetime || row.snapshot_time || row.timestamp,
                    open: isTwelveData ? parseFloat(row.open) : (row[`${prefix}_open`] ? parseFloat(row[`${prefix}_open`]) : null),
                    high: isTwelveData ? parseFloat(row.high) : (row[`${prefix}_high`] ? parseFloat(row[`${prefix}_high`]) : null),
                    low: isTwelveData ? parseFloat(row.low) : (row[`${prefix}_low`] ? parseFloat(row[`${prefix}_low`]) : null),
                    close: isTwelveData ? parseFloat(row.close) : (row[`${prefix}_close`] ? parseFloat(row[`${prefix}_close`]) : (row.bid ? parseFloat(row.bid) : null)),
                    volume: row.volume ? parseFloat(row.volume) : null
                };

                // Bid/Ask/Spread
                if (indicators.includes('bidask')) {
                    result.bid = row.bid ? parseFloat(row.bid) : null;
                    result.ask = row.ask ? parseFloat(row.ask) : null;
                    result.spread = row.spread ? parseFloat(row.spread) : null;
                    result.spread_pct = row.spread_pct ? parseFloat(row.spread_pct) : null;
                }

                // M15 OHLC
                if (indicators.includes('ohlc_m15')) {
                    result.m15_open = row.m15_open ? parseFloat(row.m15_open) : null;
                    result.m15_high = row.m15_high ? parseFloat(row.m15_high) : null;
                    result.m15_low = row.m15_low ? parseFloat(row.m15_low) : null;
                    result.m15_close = row.m15_close ? parseFloat(row.m15_close) : null;
                }

                // H1 OHLC
                if (indicators.includes('ohlc_h1')) {
                    result.h1_open = row.h1_open ? parseFloat(row.h1_open) : null;
                    result.h1_high = row.h1_high ? parseFloat(row.h1_high) : null;
                    result.h1_low = row.h1_low ? parseFloat(row.h1_low) : null;
                    result.h1_close = row.h1_close ? parseFloat(row.h1_close) : null;
                }

                // D1 OHLC
                if (indicators.includes('ohlc_d1')) {
                    result.d1_open = row.d1_open ? parseFloat(row.d1_open) : null;
                    result.d1_high = row.d1_high ? parseFloat(row.d1_high) : null;
                    result.d1_low = row.d1_low ? parseFloat(row.d1_low) : null;
                    result.d1_close = row.d1_close ? parseFloat(row.d1_close) : null;
                }

                // S1/R1 Support/Resistance Levels (M5)
                if (indicators.includes('sr_levels')) {
                    result.s1_level = row.s1_level_m5 ? parseFloat(row.s1_level_m5) : null;
                    result.r1_level = row.r1_level_m5 ? parseFloat(row.r1_level_m5) : null;
                }

                // RSI
                if (indicators.includes('rsi') && row.rsi !== undefined) {
                    result.rsi = parseFloat(row.rsi);
                }

                // MACD
                if (indicators.includes('macd')) {
                    result.macd = row.macd_main ? parseFloat(row.macd_main) : null;
                    result.macd_signal = row.macd_signal ? parseFloat(row.macd_signal) : null;
                }

                // Stochastic
                if (indicators.includes('stoch')) {
                    result.stoch_k = row.sto_main ? parseFloat(row.sto_main) : null;
                    result.stoch_d = row.sto_signal ? parseFloat(row.sto_signal) : null;
                }

                // CCI
                if (indicators.includes('cci') && row.cci !== undefined) {
                    result.cci = parseFloat(row.cci);
                }

                // ADX with +DI/-DI
                if (indicators.includes('adx')) {
                    result.adx = row.adx_main ? parseFloat(row.adx_main) : null;
                    result.adx_plus = row.adx_plusdi ? parseFloat(row.adx_plusdi) : null;
                    result.adx_minus = row.adx_minusdi ? parseFloat(row.adx_minusdi) : null;
                }

                // MA(10)
                if (indicators.includes('ma10') && row.ma_10 !== undefined) {
                    result.ma10 = parseFloat(row.ma_10);
                }

                // Ichimoku (5 components)
                if (indicators.includes('ichimoku')) {
                    result.ichi_tenkan = row.ichimoku_tenkan ? parseFloat(row.ichimoku_tenkan) : null;
                    result.ichi_kijun = row.ichimoku_kijun ? parseFloat(row.ichimoku_kijun) : null;
                    result.ichi_senkou_a = row.ichimoku_senkoua ? parseFloat(row.ichimoku_senkoua) : null;
                    result.ichi_senkou_b = row.ichimoku_senkoub ? parseFloat(row.ichimoku_senkoub) : null;
                    result.ichi_chikou = row.ichimoku_chikou ? parseFloat(row.ichimoku_chikou) : null;
                }

                // Bollinger Bands
                if (indicators.includes('bbands')) {
                    result.bb_upper = row.bb_upper ? parseFloat(row.bb_upper) : null;
                    result.bb_middle = row.bb_base ? parseFloat(row.bb_base) : null;
                    result.bb_lower = row.bb_lower ? parseFloat(row.bb_lower) : null;
                }

                // ATR/Range D1
                if (indicators.includes('atr')) {
                    result.atr_d1 = row.atr_d1 ? parseFloat(row.atr_d1) : null;
                    result.range_d1 = row.range_d1 ? parseFloat(row.range_d1) : null;
                    result.atr_pct_d1 = row.atr_pct_d1 ? parseFloat(row.atr_pct_d1) : null;
                }

                // Strength (4H/D1/W1)
                if (indicators.includes('strength')) {
                    result.strength_4h = row.strength_4h ? parseFloat(row.strength_4h) : null;
                    result.strength_1d = row.strength_1d ? parseFloat(row.strength_1d) : null;
                    result.strength_1w = row.strength_1w ? parseFloat(row.strength_1w) : null;
                }

                return result;
            });
        }

        // Update indicator options based on selected source
        function updateIndicatorOptions() {
            const source = document.getElementById('explorer-source').value;
            document.getElementById('indicators-easyinsight').style.display = source === 'easyinsight' ? 'block' : 'none';
            document.getElementById('indicators-twelvedata').style.display = source === 'twelvedata' ? 'block' : 'none';
            document.getElementById('indicators-yfinance').style.display = source === 'yfinance' ? 'block' : 'none';

            // EasyInsight now supports historical data with timeframe selection
            const intervalGroup = document.getElementById('explorer-interval').parentElement;
            const limitGroup = document.getElementById('explorer-limit').parentElement;
            intervalGroup.style.opacity = '1';
            limitGroup.style.opacity = '1';
            intervalGroup.title = '';
            limitGroup.title = '';

            // Update interval label based on source
            if (source === 'easyinsight') {
                intervalGroup.querySelector('.form-label').textContent = 'Timeframe';
            } else {
                intervalGroup.querySelector('.form-label').textContent = 'Interval';
            }
        }

        // Convert symbol to TwelveData format (EURUSD -> EUR/USD, BTCUSD -> BTC/USD)
        function toTwelveDataSymbol(symbol) {
            // Forex pairs (6 chars)
            const forexCurrencies = ['EUR', 'USD', 'GBP', 'JPY', 'CHF', 'AUD', 'NZD', 'CAD'];
            if (symbol.length === 6) {
                const base = symbol.substring(0, 3);
                const quote = symbol.substring(3, 6);
                if (forexCurrencies.includes(base) && forexCurrencies.includes(quote)) {
                    return `${base}/${quote}`;
                }
            }
            // Crypto pairs (e.g., BTCUSD, ETHUSD)
            const cryptoCurrencies = ['BTC', 'ETH', 'SOL', 'ADA', 'BNB', 'XRP', 'DOT', 'LTC', 'LINK', 'AVAX'];
            for (const crypto of cryptoCurrencies) {
                if (symbol.startsWith(crypto) && symbol.length > crypto.length) {
                    const quote = symbol.substring(crypto.length);
                    return `${crypto}/${quote}`;
                }
            }
            // Indices and others - keep as is
            return symbol;
        }

        async function loadExplorerData() {
            const selectEl = document.getElementById('explorer-symbol');
            const rawSymbol = selectEl.value;
            const interval = document.getElementById('explorer-interval').value;
            const limit = document.getElementById('explorer-limit').value;
            const source = document.getElementById('explorer-source').value;
            const bypassCache = document.getElementById('explorer-bypass-cache')?.checked || false;

            if (!rawSymbol) {
                showToast('Bitte ein Symbol auswählen', 'error');
                return;
            }

            // Get TwelveData symbol from data attribute (set in populateExplorerSymbols)
            // Falls back to toTwelveDataSymbol() conversion if not available
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const twelvedataSymbol = selectedOption?.dataset?.twelvedata;
            const symbol = source === 'twelvedata'
                ? (twelvedataSymbol || toTwelveDataSymbol(rawSymbol))
                : rawSymbol;

            // Get selected indicators based on source
            const indicators = [];
            if (source === 'easyinsight') {
                // EasyInsight indicators - Price & Spread
                if (document.getElementById('ei-bidask')?.checked) indicators.push('bidask');
                if (document.getElementById('ei-ohlc-m15')?.checked) indicators.push('ohlc_m15');
                if (document.getElementById('ei-ohlc-h1')?.checked) indicators.push('ohlc_h1');
                if (document.getElementById('ei-ohlc-d1')?.checked) indicators.push('ohlc_d1');
                if (document.getElementById('ei-sr-levels')?.checked) indicators.push('sr_levels');
                // Momentum
                if (document.getElementById('ei-rsi')?.checked) indicators.push('rsi');
                if (document.getElementById('ei-macd')?.checked) indicators.push('macd');
                if (document.getElementById('ei-stoch')?.checked) indicators.push('stoch');
                if (document.getElementById('ei-cci')?.checked) indicators.push('cci');
                if (document.getElementById('ei-adx')?.checked) indicators.push('adx');
                // Trend & Volatility
                if (document.getElementById('ei-ma10')?.checked) indicators.push('ma10');
                if (document.getElementById('ei-ichimoku')?.checked) indicators.push('ichimoku');
                if (document.getElementById('ei-bbands')?.checked) indicators.push('bbands');
                if (document.getElementById('ei-atr')?.checked) indicators.push('atr');
                if (document.getElementById('ei-strength')?.checked) indicators.push('strength');
            } else if (source === 'twelvedata') {
                // TwelveData indicators - Trend
                if (document.getElementById('ind-ema')?.checked) indicators.push('ema');
                if (document.getElementById('ind-sma')?.checked) indicators.push('sma');
                if (document.getElementById('ind-supertrend')?.checked) indicators.push('supertrend');
                if (document.getElementById('ind-ichimoku')?.checked) indicators.push('ichimoku');
                if (document.getElementById('ind-ht_trendmode')?.checked) indicators.push('ht_trendmode');
                if (document.getElementById('ind-linearregslope')?.checked) indicators.push('linearregslope');
                // Momentum
                if (document.getElementById('ind-rsi')?.checked) indicators.push('rsi');
                if (document.getElementById('ind-crsi')?.checked) indicators.push('crsi');
                if (document.getElementById('ind-macd')?.checked) indicators.push('macd');
                if (document.getElementById('ind-stoch')?.checked) indicators.push('stoch');
                if (document.getElementById('ind-willr')?.checked) indicators.push('willr');
                if (document.getElementById('ind-adx')?.checked) indicators.push('adx');
                if (document.getElementById('ind-aroon')?.checked) indicators.push('aroon');
                if (document.getElementById('ind-mfi')?.checked) indicators.push('mfi');
                // Volatility & Volume
                if (document.getElementById('ind-bbands')?.checked) indicators.push('bbands');
                if (document.getElementById('ind-percent_b')?.checked) indicators.push('percent_b');
                if (document.getElementById('ind-atr')?.checked) indicators.push('atr');
                if (document.getElementById('ind-obv')?.checked) indicators.push('obv');
                if (document.getElementById('ind-vwap')?.checked) indicators.push('vwap');
            }

            document.getElementById('explorer-results').style.display = 'none';
            document.getElementById('explorer-error').style.display = 'none';
            document.getElementById('explorer-loading').style.display = 'block';

            try {
                let data;
                if (source === 'easyinsight') {
                    // Map interval to timeframe for EasyInsight API
                    // Note: EasyInsight primarily provides H1 data with pre-calculated indicators
                    const timeframeMap = {
                        '1min': 'M1', '5min': 'M5', '15min': 'M15', '30min': 'M30',
                        '1h': 'H1', '4h': 'H4', '1day': 'D1', '1week': 'W1',
                        'M1': 'M1', 'M5': 'M5', 'M15': 'M15', 'M30': 'M30',
                        'H1': 'H1', 'H4': 'H4', 'D1': 'D1', 'W1': 'W1'
                    };
                    const timeframe = timeframeMap[interval] || 'H1';

                    // EasyInsight primarily stores H1 data - show warning for other timeframes
                    if (!['1h', 'H1'].includes(interval)) {
                        console.warn(`[loadExplorerData] EasyInsight primarily provides H1 data. Selected interval ${interval} may have limited indicator support.`);
                    }

                    // Fetch from EasyInsight indicators endpoint (includes all indicators)
                    const cacheParam = bypassCache ? '&bypass_cache=true' : '';
                    const res = await fetch(`${API_BASE}/easyinsight/indicators/${rawSymbol}?limit=${limit}${cacheParam}`);
                    if (!res.ok) throw new Error('Fehler beim Laden der EasyInsight-Daten');
                    const easyInsightData = await res.json();

                    // Convert EasyInsight response to explorer format (pass timeframe for OHLC mapping)
                    data = convertEasyInsightHistoricalData({ data: easyInsightData.data, source: 'easyinsight' }, indicators, timeframe);

                } else if (source === 'twelvedata') {
                    // Fetch OHLCV data (bypassCache parameter for future cache implementation)
                    // URL-encode symbol as it may contain slashes (e.g., BTC/USD)
                    const encodedSymbol = encodeURIComponent(symbol);
                    const cacheParam = bypassCache ? '&bypass_cache=true' : '';
                    const ohlcvRes = await fetch(`${API_BASE}/twelvedata/time_series/${encodedSymbol}?interval=${interval}&outputsize=${limit}${cacheParam}`);
                    if (!ohlcvRes.ok) throw new Error('Fehler beim Laden der OHLCV-Daten');
                    const ohlcv = await ohlcvRes.json();

                    // Fetch indicators in parallel - dynamic configuration
                    const indicatorConfig = {
                        // Trend indicators
                        'ema': { endpoint: 'ema', params: '&time_period=20' },
                        'sma': { endpoint: 'sma', params: '&time_period=20' },
                        'supertrend': { endpoint: 'supertrend', params: '' },
                        'ichimoku': { endpoint: 'ichimoku', params: '' },
                        'ht_trendmode': { endpoint: 'ht_trendmode', params: '' },
                        'linearregslope': { endpoint: 'linearregslope', params: '' },
                        // Momentum indicators
                        'rsi': { endpoint: 'rsi', params: '' },
                        'crsi': { endpoint: 'crsi', params: '' },
                        'macd': { endpoint: 'macd', params: '' },
                        'stoch': { endpoint: 'stoch', params: '' },
                        'willr': { endpoint: 'willr', params: '' },
                        'adx': { endpoint: 'adx', params: '' },
                        'aroon': { endpoint: 'aroon', params: '' },
                        'mfi': { endpoint: 'mfi', params: '' },
                        // Volatility & Volume
                        'bbands': { endpoint: 'bbands', params: '' },
                        'percent_b': { endpoint: 'percent_b', params: '' },
                        'atr': { endpoint: 'atr', params: '' },
                        'obv': { endpoint: 'obv', params: '' },
                        'vwap': { endpoint: 'vwap', params: '' }
                    };

                    const indicatorPromises = indicators.map(ind => {
                        const config = indicatorConfig[ind];
                        if (!config) {
                            console.warn(`[loadExplorerData] No config for indicator: ${ind}`);
                            return null;
                        }
                        const url = `${API_BASE}/twelvedata/${config.endpoint}/${encodedSymbol}?interval=${interval}&outputsize=${limit}${config.params}`;
                        return fetch(url)
                            .then(r => r.json())
                            .then(d => ({ name: ind, data: d }))
                            .catch(err => {
                                console.error(`[loadExplorerData] Indicator ${ind} fetch error:`, err);
                                return null;
                            });
                    }).filter(p => p !== null);

                    const indicatorResults = await Promise.all(indicatorPromises);

                    // Merge data
                    data = mergeExplorerData(ohlcv, indicatorResults.filter(r => r !== null));
                } else {
                    // Yahoo Finance - use rawSymbol (not TwelveData formatted)
                    const res = await fetch(`${API_BASE}/yfinance/time-series/${rawSymbol}?interval=${interval}&outputsize=${limit}`);
                    if (!res.ok) throw new Error('Fehler beim Laden der Yahoo Finance Daten');
                    const yData = await res.json();
                    // Yahoo Finance returns {symbol, interval, values: [...]}
                    data = (yData.values || []).map(v => ({
                        datetime: v.datetime,
                        open: v.open,
                        high: v.high,
                        low: v.low,
                        close: v.close,
                        volume: v.volume || null
                    }));
                }

                explorerData = data;
                renderExplorerTable(rawSymbol, interval, source, indicators);

                document.getElementById('explorer-loading').style.display = 'none';
                document.getElementById('explorer-results').style.display = 'block';

            } catch (err) {
                console.error('Explorer error:', err);
                document.getElementById('explorer-loading').style.display = 'none';
                document.getElementById('explorer-error').style.display = 'block';
                document.getElementById('explorer-error-msg').textContent = err.message;
            }
        }

        function mergeExplorerData(ohlcv, indicators) {
            if (!ohlcv.data && !ohlcv.values) {
                console.warn('[mergeExplorerData] No OHLCV data found!');
                return [];
            }

            const values = ohlcv.data || ohlcv.values || [];

            const result = values.map(v => ({
                datetime: v.datetime,
                open: parseFloat(v.open),
                high: parseFloat(v.high),
                low: parseFloat(v.low),
                close: parseFloat(v.close),
                volume: v.volume ? parseInt(v.volume) : null
            }));

            // Create datetime index map
            const dtMap = {};
            result.forEach((r, i) => dtMap[r.datetime] = i);

            // Merge indicators - mapping for all indicator types
            const indicatorFieldMap = {
                'ema': v => ({ ema: parseFloat(v.ema) }),
                'sma': v => ({ sma: parseFloat(v.sma) }),
                'supertrend': v => ({ supertrend: parseFloat(v.supertrend), supertrend_dir: v.supertrend_direction }),
                'ichimoku': v => ({
                    ichi_tenkan: parseFloat(v.tenkan_sen),
                    ichi_kijun: parseFloat(v.kijun_sen),
                    ichi_senkou_a: parseFloat(v.senkou_span_a),
                    ichi_senkou_b: parseFloat(v.senkou_span_b)
                }),
                'ht_trendmode': v => ({ ht_trend: parseInt(v.integer || v.ht_trendmode) }),
                'linearregslope': v => ({ linreg_slope: parseFloat(v.linearregslope) }),
                'rsi': v => ({ rsi: parseFloat(v.rsi) }),
                'crsi': v => ({ crsi: parseFloat(v.crsi) }),
                'macd': v => ({
                    macd: parseFloat(v.macd),
                    macd_signal: parseFloat(v.macd_signal),
                    macd_hist: parseFloat(v.macd_hist)
                }),
                'stoch': v => ({ stoch_k: parseFloat(v.slow_k), stoch_d: parseFloat(v.slow_d) }),
                'willr': v => ({ willr: parseFloat(v.willr) }),
                'adx': v => ({ adx: parseFloat(v.adx) }),
                'aroon': v => ({ aroon_up: parseFloat(v.aroon_up), aroon_down: parseFloat(v.aroon_down) }),
                'mfi': v => ({ mfi: parseFloat(v.mfi) }),
                'bbands': v => ({
                    bb_upper: parseFloat(v.upper_band),
                    bb_middle: parseFloat(v.middle_band),
                    bb_lower: parseFloat(v.lower_band)
                }),
                'percent_b': v => ({ percent_b: parseFloat(v.percent_b) }),
                'atr': v => ({ atr: parseFloat(v.atr) }),
                'obv': v => ({ obv: parseInt(v.obv) }),
                'vwap': v => ({ vwap: parseFloat(v.vwap) })
            };

            indicators.forEach(ind => {
                if (!ind || !ind.data) return;
                const rawValues = ind.data.data || ind.data.values || ind.data;

                // Ensure indValues is always an array
                const indValues = Array.isArray(rawValues) ? rawValues : [];
                const mapper = indicatorFieldMap[ind.name];
                if (!mapper) {
                    console.warn(`[mergeExplorerData] No mapper for indicator: ${ind.name}`);
                    return;
                }
                if (!indValues.length) {
                    console.warn(`[mergeExplorerData] Empty values for indicator: ${ind.name}`);
                    return;
                }

                let matchCount = 0;
                indValues.forEach(v => {
                    const idx = dtMap[v.datetime];
                    if (idx !== undefined) {
                        try {
                            Object.assign(result[idx], mapper(v));
                            matchCount++;
                        } catch (e) {
                            console.error(`[mergeExplorerData] Error mapping ${ind.name}:`, e.message);
                        }
                    }
                });
            });

            return result;
        }

        function renderExplorerTable(symbol, interval, source, indicators) {
            const thead = document.getElementById('explorer-thead');
            const tbody = document.getElementById('explorer-tbody');

            const sourceLabels = {
                'easyinsight': 'EasyInsight',
                'twelvedata': 'TwelveData',
                'yfinance': 'Yahoo Finance'
            };

            document.getElementById('explorer-title').textContent = `${symbol} - ${interval}`;
            document.getElementById('explorer-info').textContent =
                `${explorerData.length} Datenpunkte | Quelle: ${sourceLabels[source] || source}`;

            // Common header cell style
            const thStyle = 'padding: 8px 10px; text-align: right; white-space: nowrap; background: #1a1a2e; border-bottom: 2px solid #333;';
            const thStyleHighlight = (color) => `${thStyle} background: linear-gradient(180deg, rgba(${color},0.15) 0%, #1a1a2e 100%);`;

            // Build header - organized by category
            let headerHtml = '<tr>';
            // First column is sticky both horizontally and vertically
            headerHtml += `<th style="${thStyle} position: sticky; left: 0; z-index: 3; min-width: 160px; text-align: left;">Datum/Zeit</th>`;

            // Standard OHLC
            headerHtml += `<th style="${thStyle}">Open</th><th style="${thStyle}">High</th><th style="${thStyle}">Low</th>`;
            headerHtml += `<th style="${thStyleHighlight('100,200,255')}">Close</th>`;
            if (source !== 'easyinsight') {
                headerHtml += `<th style="${thStyle}">Volume</th>`;
            }

            // EasyInsight specific: Bid/Ask/Spread
            if (indicators.includes('bidask')) {
                headerHtml += `<th style="${thStyle}">Bid</th><th style="${thStyle}">Ask</th><th style="${thStyle}">Spread</th><th style="${thStyle}">Spread%</th>`;
            }

            // EasyInsight: M15 OHLC
            if (indicators.includes('ohlc_m15')) {
                headerHtml += `<th style="${thStyle}">M15 O</th><th style="${thStyle}">M15 H</th><th style="${thStyle}">M15 L</th><th style="${thStyle}">M15 C</th>`;
            }

            // EasyInsight: H1 OHLC
            if (indicators.includes('ohlc_h1')) {
                headerHtml += `<th style="${thStyle}">H1 O</th><th style="${thStyle}">H1 H</th><th style="${thStyle}">H1 L</th><th style="${thStyle}">H1 C</th>`;
            }

            // EasyInsight: D1 OHLC
            if (indicators.includes('ohlc_d1')) {
                headerHtml += `<th style="${thStyle}">D1 O</th><th style="${thStyle}">D1 H</th><th style="${thStyle}">D1 L</th><th style="${thStyle}">D1 C</th>`;
            }

            // EasyInsight: S1/R1 Levels
            if (indicators.includes('sr_levels')) {
                headerHtml += `<th style="${thStyleHighlight('255,87,34')}">S1 (M5)</th><th style="${thStyleHighlight('76,175,80')}">R1 (M5)</th>`;
            }

            // Trend indicators
            if (indicators.includes('ma10')) headerHtml += `<th style="${thStyleHighlight('33,150,243')}">MA(10)</th>`;
            if (indicators.includes('ema')) headerHtml += `<th style="${thStyleHighlight('33,150,243')}">EMA(20)</th>`;
            if (indicators.includes('sma')) headerHtml += `<th style="${thStyleHighlight('33,150,243')}">SMA(20)</th>`;
            if (indicators.includes('supertrend')) headerHtml += `<th style="${thStyleHighlight('33,150,243')}">Supertrend</th><th style="${thStyle}">Dir</th>`;
            if (indicators.includes('ichimoku')) {
                headerHtml += `<th style="${thStyle}">Tenkan</th><th style="${thStyle}">Kijun</th><th style="${thStyle}">Senkou A</th><th style="${thStyle}">Senkou B</th>`;
                if (source === 'easyinsight') headerHtml += `<th style="${thStyle}">Chikou</th>`;
            }
            if (indicators.includes('ht_trendmode')) headerHtml += `<th style="${thStyle}">HT Trend</th>`;
            if (indicators.includes('linearregslope')) headerHtml += `<th style="${thStyle}">LinReg Slope</th>`;

            // Momentum indicators
            if (indicators.includes('rsi')) headerHtml += `<th style="${thStyleHighlight('156,39,176')}">RSI</th>`;
            if (indicators.includes('crsi')) headerHtml += `<th style="${thStyleHighlight('156,39,176')}">CRSI</th>`;
            if (indicators.includes('cci')) headerHtml += `<th style="${thStyleHighlight('156,39,176')}">CCI</th>`;
            if (indicators.includes('macd')) headerHtml += `<th style="${thStyle}">MACD</th><th style="${thStyle}">Signal</th>`;
            if (source !== 'easyinsight' && indicators.includes('macd')) headerHtml += `<th style="${thStyle}">Hist</th>`;
            if (indicators.includes('stoch')) headerHtml += `<th style="${thStyle}">Stoch %K</th><th style="${thStyle}">Stoch %D</th>`;
            if (indicators.includes('willr')) headerHtml += `<th style="${thStyle}">Williams %R</th>`;
            if (indicators.includes('adx')) {
                headerHtml += `<th style="${thStyle}">ADX</th>`;
                if (source === 'easyinsight') headerHtml += `<th style="${thStyle}">+DI</th><th style="${thStyle}">-DI</th>`;
            }
            if (indicators.includes('aroon')) headerHtml += `<th style="${thStyle}">Aroon Up</th><th style="${thStyle}">Aroon Down</th>`;
            if (indicators.includes('mfi')) headerHtml += `<th style="${thStyle}">MFI</th>`;

            // Volatility & Volume
            if (indicators.includes('bbands')) headerHtml += `<th style="${thStyleHighlight('255,152,0')}">BB Upper</th><th style="${thStyle}">BB Mid</th><th style="${thStyleHighlight('255,152,0')}">BB Lower</th>`;
            if (indicators.includes('percent_b')) headerHtml += `<th style="${thStyleHighlight('255,152,0')}">%B</th>`;
            if (indicators.includes('atr')) {
                if (source === 'easyinsight') {
                    headerHtml += `<th style="${thStyle}">ATR D1</th><th style="${thStyle}">Range D1</th><th style="${thStyle}">ATR%</th>`;
                } else {
                    headerHtml += `<th style="${thStyle}">ATR</th>`;
                }
            }
            if (indicators.includes('obv')) headerHtml += `<th style="${thStyle}">OBV</th>`;
            if (indicators.includes('vwap')) headerHtml += `<th style="${thStyle}">VWAP</th>`;

            // EasyInsight: Strength indicators
            if (indicators.includes('strength')) {
                headerHtml += `<th style="${thStyleHighlight('0,188,212')}">Str 4H</th><th style="${thStyle}">Str D1</th><th style="${thStyle}">Str W1</th>`;
            }

            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // Common cell styles
            const tdStyle = 'padding: 6px 10px; text-align: right; font-family: monospace; white-space: nowrap; border-bottom: 1px solid #2a2a3e;';
            const tdStyleSticky = `${tdStyle} position: sticky; left: 0; background: #1a1a2e; z-index: 1; text-align: left;`;

            // Build body
            let bodyHtml = '';
            explorerData.forEach((row, idx) => {
                const changeColor = row.close >= row.open ? '#4caf50' : '#f44336';
                const rowBg = idx % 2 === 0 ? '' : 'background: rgba(255,255,255,0.02);';

                bodyHtml += `<tr style="${rowBg}">`;
                // Format datetime for display
                const dtDisplay = formatDateTime(row.datetime);
                bodyHtml += `<td style="${tdStyleSticky}">${dtDisplay}</td>`;

                // Standard OHLC
                bodyHtml += `<td style="${tdStyle}">${formatPrice(row.open)}</td>`;
                bodyHtml += `<td style="${tdStyle} color: #4caf50;">${formatPrice(row.high)}</td>`;
                bodyHtml += `<td style="${tdStyle} color: #f44336;">${formatPrice(row.low)}</td>`;
                bodyHtml += `<td style="${tdStyle} background: rgba(100,200,255,0.05); color: ${changeColor}; font-weight: bold;">${formatPrice(row.close)}</td>`;

                if (source !== 'easyinsight') {
                    bodyHtml += `<td style="${tdStyle} color: #888;">${row.volume ? row.volume.toLocaleString() : '-'}</td>`;
                }

                // EasyInsight: Bid/Ask/Spread
                if (indicators.includes('bidask')) {
                    bodyHtml += `<td style="${tdStyle} color: #4caf50;">${formatPrice(row.bid)}</td>`;
                    bodyHtml += `<td style="${tdStyle} color: #f44336;">${formatPrice(row.ask)}</td>`;
                    bodyHtml += `<td style="${tdStyle} color: #888;">${row.spread?.toFixed(5) || '-'}</td>`;
                    bodyHtml += `<td style="${tdStyle} color: #888;">${row.spread_pct?.toFixed(4) || '-'}%</td>`;
                }

                // EasyInsight: M15 OHLC
                if (indicators.includes('ohlc_m15')) {
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.m15_open)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.m15_high)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.m15_low)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.m15_close)}</td>`;
                }

                // EasyInsight: H1 OHLC
                if (indicators.includes('ohlc_h1')) {
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.h1_open)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.h1_high)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.h1_low)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.h1_close)}</td>`;
                }

                // EasyInsight: D1 OHLC
                if (indicators.includes('ohlc_d1')) {
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.d1_open)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.d1_high)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.d1_low)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.d1_close)}</td>`;
                }

                // EasyInsight: S1/R1 Levels
                if (indicators.includes('sr_levels')) {
                    bodyHtml += `<td style="${tdStyle} background: rgba(255,87,34,0.05); color: #ff5722;">${formatPrice(row.s1_level)}</td>`;
                    bodyHtml += `<td style="${tdStyle} background: rgba(76,175,80,0.05); color: #4caf50;">${formatPrice(row.r1_level)}</td>`;
                }

                // Trend indicators
                if (indicators.includes('ma10')) {
                    bodyHtml += `<td style="${tdStyle} background: rgba(33,150,243,0.03);">${formatPrice(row.ma10)}</td>`;
                }
                if (indicators.includes('ema')) {
                    bodyHtml += `<td style="${tdStyle} background: rgba(33,150,243,0.03);">${formatPrice(row.ema)}</td>`;
                }
                if (indicators.includes('sma')) {
                    bodyHtml += `<td style="${tdStyle} background: rgba(33,150,243,0.03);">${formatPrice(row.sma)}</td>`;
                }
                if (indicators.includes('supertrend')) {
                    const stColor = row.supertrend_dir === 'up' ? '#4caf50' : '#f44336';
                    bodyHtml += `<td style="${tdStyle} background: rgba(33,150,243,0.03);">${formatPrice(row.supertrend)}</td>`;
                    bodyHtml += `<td style="${tdStyle} color: ${stColor};">${row.supertrend_dir || '-'}</td>`;
                }
                if (indicators.includes('ichimoku')) {
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.ichi_tenkan)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.ichi_kijun)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.ichi_senkou_a)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.ichi_senkou_b)}</td>`;
                    if (source === 'easyinsight') {
                        bodyHtml += `<td style="${tdStyle}">${formatPrice(row.ichi_chikou)}</td>`;
                    }
                }
                if (indicators.includes('ht_trendmode')) {
                    const htColor = row.ht_trend === 1 ? '#4caf50' : '#f44336';
                    bodyHtml += `<td style="${tdStyle} color: ${htColor};">${row.ht_trend !== undefined ? row.ht_trend : '-'}</td>`;
                }
                if (indicators.includes('linearregslope')) {
                    const slopeColor = row.linreg_slope > 0 ? '#4caf50' : '#f44336';
                    bodyHtml += `<td style="${tdStyle} color: ${slopeColor};">${row.linreg_slope?.toFixed(6) || '-'}</td>`;
                }

                // Momentum indicators
                if (indicators.includes('rsi')) {
                    const rsiColor = row.rsi > 70 ? '#f44336' : (row.rsi < 30 ? '#4caf50' : '#ffc107');
                    bodyHtml += `<td style="${tdStyle} background: rgba(156,39,176,0.05); color: ${rsiColor};">${row.rsi?.toFixed(2) || '-'}</td>`;
                }
                if (indicators.includes('crsi')) {
                    const crsiColor = row.crsi > 80 ? '#f44336' : (row.crsi < 20 ? '#4caf50' : '#ffc107');
                    bodyHtml += `<td style="${tdStyle} background: rgba(156,39,176,0.05); color: ${crsiColor};">${row.crsi?.toFixed(2) || '-'}</td>`;
                }
                if (indicators.includes('cci')) {
                    const cciColor = row.cci > 100 ? '#f44336' : (row.cci < -100 ? '#4caf50' : '#ffc107');
                    bodyHtml += `<td style="${tdStyle} background: rgba(156,39,176,0.05); color: ${cciColor};">${row.cci?.toFixed(2) || '-'}</td>`;
                }
                if (indicators.includes('macd')) {
                    const macdColor = row.macd_hist > 0 ? '#4caf50' : '#f44336';
                    bodyHtml += `<td style="${tdStyle}">${row.macd?.toFixed(5) || '-'}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${row.macd_signal?.toFixed(5) || '-'}</td>`;
                    if (source !== 'easyinsight') {
                        bodyHtml += `<td style="${tdStyle} color: ${macdColor};">${row.macd_hist?.toFixed(5) || '-'}</td>`;
                    }
                }
                if (indicators.includes('stoch')) {
                    bodyHtml += `<td style="${tdStyle}">${row.stoch_k?.toFixed(2) || '-'}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${row.stoch_d?.toFixed(2) || '-'}</td>`;
                }
                if (indicators.includes('willr')) {
                    const willrColor = row.willr < -80 ? '#4caf50' : (row.willr > -20 ? '#f44336' : '#ffc107');
                    bodyHtml += `<td style="${tdStyle} color: ${willrColor};">${row.willr?.toFixed(2) || '-'}</td>`;
                }
                if (indicators.includes('adx')) {
                    const adxColor = row.adx > 25 ? '#4caf50' : '#888';
                    bodyHtml += `<td style="${tdStyle} color: ${adxColor};">${row.adx?.toFixed(2) || '-'}</td>`;
                    // EasyInsight also has +DI/-DI
                    if (source === 'easyinsight') {
                        bodyHtml += `<td style="${tdStyle} color: #4caf50;">${row.adx_plus?.toFixed(2) || '-'}</td>`;
                        bodyHtml += `<td style="${tdStyle} color: #f44336;">${row.adx_minus?.toFixed(2) || '-'}</td>`;
                    }
                }
                if (indicators.includes('aroon')) {
                    bodyHtml += `<td style="${tdStyle} color: #4caf50;">${row.aroon_up?.toFixed(2) || '-'}</td>`;
                    bodyHtml += `<td style="${tdStyle} color: #f44336;">${row.aroon_down?.toFixed(2) || '-'}</td>`;
                }
                if (indicators.includes('mfi')) {
                    const mfiColor = row.mfi > 80 ? '#f44336' : (row.mfi < 20 ? '#4caf50' : '#ffc107');
                    bodyHtml += `<td style="${tdStyle} color: ${mfiColor};">${row.mfi?.toFixed(2) || '-'}</td>`;
                }

                // Volatility & Volume
                if (indicators.includes('bbands')) {
                    bodyHtml += `<td style="${tdStyle} background: rgba(255,152,0,0.03);">${formatPrice(row.bb_upper)}</td>`;
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.bb_middle)}</td>`;
                    bodyHtml += `<td style="${tdStyle} background: rgba(255,152,0,0.03);">${formatPrice(row.bb_lower)}</td>`;
                }
                if (indicators.includes('percent_b')) {
                    const pbColor = row.percent_b > 1 ? '#f44336' : (row.percent_b < 0 ? '#4caf50' : '#ffc107');
                    bodyHtml += `<td style="${tdStyle} background: rgba(255,152,0,0.03); color: ${pbColor};">${row.percent_b?.toFixed(4) || '-'}</td>`;
                }
                if (indicators.includes('atr')) {
                    if (source === 'easyinsight') {
                        bodyHtml += `<td style="${tdStyle}">${row.atr_d1?.toFixed(5) || '-'}</td>`;
                        bodyHtml += `<td style="${tdStyle}">${row.range_d1?.toFixed(5) || '-'}</td>`;
                        bodyHtml += `<td style="${tdStyle}">${row.atr_pct_d1?.toFixed(2) || '-'}%</td>`;
                    } else {
                        bodyHtml += `<td style="${tdStyle}">${row.atr?.toFixed(5) || '-'}</td>`;
                    }
                }
                if (indicators.includes('obv')) {
                    const obvColor = row.obv > 0 ? '#4caf50' : '#f44336';
                    bodyHtml += `<td style="${tdStyle} color: ${obvColor};">${row.obv?.toLocaleString() || '-'}</td>`;
                }
                if (indicators.includes('vwap')) {
                    bodyHtml += `<td style="${tdStyle}">${formatPrice(row.vwap)}</td>`;
                }

                // EasyInsight: Strength indicators
                if (indicators.includes('strength')) {
                    const str4hColor = row.strength_4h > 0 ? '#4caf50' : (row.strength_4h < 0 ? '#f44336' : '#888');
                    const str1dColor = row.strength_1d > 0 ? '#4caf50' : (row.strength_1d < 0 ? '#f44336' : '#888');
                    const str1wColor = row.strength_1w > 0 ? '#4caf50' : (row.strength_1w < 0 ? '#f44336' : '#888');
                    bodyHtml += `<td style="${tdStyle} background: rgba(0,188,212,0.05); color: ${str4hColor};">${row.strength_4h?.toFixed(2) || '-'}</td>`;
                    bodyHtml += `<td style="${tdStyle} color: ${str1dColor};">${row.strength_1d?.toFixed(2) || '-'}</td>`;
                    bodyHtml += `<td style="${tdStyle} color: ${str1wColor};">${row.strength_1w?.toFixed(2) || '-'}</td>`;
                }

                bodyHtml += '</tr>';
            });
            tbody.innerHTML = bodyHtml;
        }

        function formatDateTime(dt) {
            if (!dt) return '-';
            // API returns datetime in format "YYYY-MM-DD HH:MM:SS" (UTC)
            // Convert to Date object, treating input as UTC
            let d;
            if (typeof dt === 'string' && !dt.includes('T') && !dt.includes('Z')) {
                // Format: "2025-12-27 14:30:00" - treat as UTC
                d = new Date(dt.replace(' ', 'T') + 'Z');
            } else {
                d = new Date(dt);
            }
            // Format for Swiss timezone (Europe/Zurich)
            return d.toLocaleString('de-CH', {
                timeZone: 'Europe/Zurich',
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatPrice(val) {
            if (val === null || val === undefined || isNaN(val)) return '-';
            // Auto-detect decimal places based on magnitude
            let decimals;
            if (val < 0.01) decimals = 6;
            else if (val < 1) decimals = 5;
            else if (val < 100) decimals = 4;
            else decimals = 2;

            // Format with Swiss locale (apostrophe as thousand separator)
            const parts = val.toFixed(decimals).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "'");
            return parts.join('.');
        }

        function exportExplorerData() {
            if (!explorerData || explorerData.length === 0) {
                showToast('Keine Daten zum Exportieren', 'error');
                return;
            }

            const symbol = document.getElementById('explorer-symbol').value;
            const interval = document.getElementById('explorer-interval').value;

            // Get all columns
            const columns = Object.keys(explorerData[0]);

            // Build CSV
            let csv = columns.join(',') + '\n';
            explorerData.forEach(row => {
                csv += columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string' && val.includes(',')) return `"${val}"`;
                    return val;
                }).join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${symbol}_${interval}_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            showToast('CSV Export erfolgreich', 'success');
        }

        // =====================================================
        // EXTERNAL SOURCES FUNCTIONS
        // =====================================================

        const SOURCE_NAMES = {
            'economic-calendar': 'Economic Calendar',
            'sentiment': 'Sentiment',
            'onchain': 'On-Chain',
            'orderbook': 'Orderbook',
            'macro': 'Macro',
            'historical-patterns': 'Historical Patterns',
            'technical-levels': 'Technical Levels',
            'regulatory': 'Regulatory',
            'easyinsight': 'EasyInsight',
            'correlations': 'Correlations',
            'volatility-regime': 'Volatility Regime',
            'institutional-flow': 'Institutional Flow'
        };

        // Update source options visibility
        function updateExternalSourceOptions() {
            const source = document.getElementById('external-source-select').value;
            document.querySelectorAll('.source-options').forEach(el => el.style.display = 'none');
            const optionsEl = document.getElementById(`options-${source}`);
            if (optionsEl) optionsEl.style.display = 'block';
        }

        // Populate external symbol dropdown
        function populateExternalSymbols() {
            const select = document.getElementById('external-symbol');
            if (!select || !allSymbols) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">Alle / Kein Symbol</option>';

            const activeSymbols = allSymbols.filter(s => s.status === 'active');
            activeSymbols.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.symbol;
                opt.textContent = s.symbol + (s.display_name ? ` (${s.display_name})` : '');
                select.appendChild(opt);
            });

            if (currentValue) select.value = currentValue;
        }

        // Show loading state
        function showExternalLoading(show) {
            document.getElementById('external-loading').style.display = show ? 'block' : 'none';
            document.getElementById('external-results').style.display = 'none';
            document.getElementById('external-error').style.display = 'none';
        }

        // Show error state
        function showExternalError(message) {
            document.getElementById('external-loading').style.display = 'none';
            document.getElementById('external-results').style.display = 'none';
            document.getElementById('external-error').style.display = 'block';
            document.getElementById('external-error-msg').textContent = message;
        }

        // Clear results
        function clearExternalResults() {
            document.getElementById('external-results').style.display = 'none';
            document.getElementById('external-loading').style.display = 'none';
            document.getElementById('external-error').style.display = 'none';
        }

        // Build query params for each source
        function buildExternalParams(source, symbol) {
            const params = new URLSearchParams();
            if (symbol) params.append('symbol', symbol);

            switch (source) {
                case 'economic-calendar':
                    params.append('days_ahead', document.getElementById('ec-days-ahead').value);
                    params.append('high_impact_only', document.getElementById('ec-high-impact').checked);
                    break;
                case 'sentiment':
                    params.append('include_fear_greed', document.getElementById('sent-fear-greed').checked);
                    params.append('include_social', document.getElementById('sent-social').checked);
                    params.append('include_vix', document.getElementById('sent-vix').checked);
                    break;
                case 'onchain':
                    params.append('include_whale_alerts', document.getElementById('oc-whale').checked);
                    params.append('include_exchange_flows', document.getElementById('oc-exchange').checked);
                    break;
                case 'orderbook':
                    params.append('depth', document.getElementById('ob-depth').value);
                    params.append('include_liquidations', document.getElementById('ob-liquidations').checked);
                    break;
                case 'macro':
                    params.append('include_dxy', document.getElementById('macro-dxy').checked);
                    params.append('include_yields', document.getElementById('macro-yields').checked);
                    params.append('include_correlations', document.getElementById('macro-corr').checked);
                    break;
                case 'historical-patterns':
                    params.append('include_seasonality', document.getElementById('hp-seasonality').checked);
                    params.append('include_drawdowns', document.getElementById('hp-drawdowns').checked);
                    break;
                case 'technical-levels':
                    params.append('include_sr', document.getElementById('tl-sr').checked);
                    params.append('include_fibonacci', document.getElementById('tl-fib').checked);
                    params.append('include_pivots', document.getElementById('tl-pivots').checked);
                    break;
                case 'regulatory':
                    params.append('include_sec', document.getElementById('reg-sec').checked);
                    params.append('include_etf', document.getElementById('reg-etf').checked);
                    break;
                case 'easyinsight':
                    params.append('include_symbols', document.getElementById('ei-symbols').checked);
                    params.append('include_logs', document.getElementById('ei-logs').checked);
                    break;
                case 'correlations':
                    params.append('timeframe', document.getElementById('corr-timeframe').value);
                    params.append('include_matrix', document.getElementById('corr-matrix').checked);
                    params.append('include_regime', document.getElementById('corr-regime').checked);
                    break;
                case 'volatility-regime':
                    params.append('include_vix', document.getElementById('vol-vix').checked);
                    params.append('include_atr', document.getElementById('vol-atr').checked);
                    params.append('include_bollinger', document.getElementById('vol-bbands').checked);
                    params.append('include_regime', document.getElementById('vol-regime').checked);
                    break;
                case 'institutional-flow':
                    params.append('include_cot', document.getElementById('inst-cot').checked);
                    params.append('include_etf', document.getElementById('inst-etf').checked);
                    params.append('include_whale', document.getElementById('inst-whale').checked);
                    params.append('include_13f', document.getElementById('inst-13f').checked);
                    break;
            }
            return params;
        }

        // Fetch single external source
        async function fetchExternalSource() {
            const source = document.getElementById('external-source-select').value;
            const symbol = document.getElementById('external-symbol').value;

            // Check if symbol is required
            const requiresSymbol = ['onchain', 'orderbook', 'technical-levels'];
            if (requiresSymbol.includes(source) && !symbol) {
                showToast(`${SOURCE_NAMES[source]} benötigt ein Symbol`, 'error');
                return;
            }

            showExternalLoading(true);

            try {
                const params = buildExternalParams(source, symbol);
                let url;

                if (['onchain', 'orderbook', 'technical-levels'].includes(source)) {
                    url = `${API_BASE}/external-sources/${source}/${symbol}?${params.toString()}`;
                } else {
                    url = `${API_BASE}/external-sources/${source}?${params.toString()}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayExternalResults(source, data, symbol);
                updateExternalStats();

            } catch (error) {
                console.error('Error fetching external source:', error);
                showExternalError(`Fehler: ${error.message}`);
            }
        }

        // Quick fetch from source cards
        async function quickFetchSource(source) {
            const symbol = document.getElementById('external-symbol')?.value || '';

            const requiresSymbol = ['onchain', 'orderbook', 'technical-levels'];
            if (requiresSymbol.includes(source) && !symbol) {
                showToast(`${SOURCE_NAMES[source]} benötigt ein Symbol - bitte zuerst auswählen`, 'error');
                return;
            }

            showExternalLoading(true);
            const statusEl = document.getElementById(`status-${source}`);
            if (statusEl) statusEl.textContent = '...';

            try {
                let url;
                if (['onchain', 'orderbook', 'technical-levels'].includes(source)) {
                    url = `${API_BASE}/external-sources/${source}/${symbol}`;
                } else {
                    url = `${API_BASE}/external-sources/${source}${symbol ? '?symbol=' + symbol : ''}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayExternalResults(source, data, symbol);

                if (statusEl) statusEl.textContent = 'OK';
                updateExternalStats();

            } catch (error) {
                console.error('Error fetching:', error);
                if (statusEl) statusEl.textContent = 'Err';
                showExternalError(`Fehler bei ${SOURCE_NAMES[source]}: ${error.message}`);
            }
        }

        // Fetch all sources
        async function fetchAllExternalSources() {
            const symbol = document.getElementById('external-symbol')?.value || '';
            const url = symbol
                ? `${API_BASE}/external-sources/fetch-all?symbol=${encodeURIComponent(symbol)}`
                : `${API_BASE}/external-sources/fetch-all`;

            showExternalLoading(true);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(null)
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayAllSourcesResults(data);
                updateExternalStats();

            } catch (error) {
                console.error('Error fetching all sources:', error);
                showExternalError(`Fehler: ${error.message}`);
            }
        }

        // Fetch trading context for symbol
        async function fetchTradingContext() {
            const symbol = document.getElementById('external-symbol')?.value;

            if (!symbol) {
                showToast('Trading Context benötigt ein Symbol', 'error');
                return;
            }

            showExternalLoading(true);

            try {
                const response = await fetch(`${API_BASE}/external-sources/trading-context/${encodeURIComponent(symbol)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(null)
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayTradingContext(data, symbol);
                updateExternalStats();

            } catch (error) {
                console.error('Error fetching trading context:', error);
                showExternalError(`Fehler: ${error.message}`);
            }
        }

        // Display results for a single source
        function displayExternalResults(source, data, symbol) {
            document.getElementById('external-loading').style.display = 'none';
            document.getElementById('external-error').style.display = 'none';
            document.getElementById('external-results').style.display = 'block';

            const titleEl = document.getElementById('external-result-title');
            const infoEl = document.getElementById('external-result-info');
            const contentEl = document.getElementById('external-result-content');

            titleEl.textContent = SOURCE_NAMES[source] || source;
            infoEl.textContent = symbol ? `Symbol: ${symbol}` : 'Alle Symbole';

            contentEl.innerHTML = formatDataAsHtml(data);
        }

        // Display all sources results
        function displayAllSourcesResults(data) {
            document.getElementById('external-loading').style.display = 'none';
            document.getElementById('external-error').style.display = 'none';
            document.getElementById('external-results').style.display = 'block';

            const titleEl = document.getElementById('external-result-title');
            const infoEl = document.getElementById('external-result-info');
            const contentEl = document.getElementById('external-result-content');

            titleEl.textContent = 'Alle Datenquellen';

            const successCount = Object.values(data).filter(v => v && !v.error).length;
            infoEl.textContent = `${successCount} von ${Object.keys(data).length} erfolgreich`;

            let html = '';
            for (const [source, sourceData] of Object.entries(data)) {
                html += `
                    <div style="margin-bottom: 1.5rem; border-left: 3px solid #64c8ff; padding-left: 1rem;">
                        <h4 style="color: #64c8ff; margin-bottom: 0.5rem;">${SOURCE_NAMES[source] || source}</h4>
                        ${formatDataAsHtml(sourceData)}
                    </div>
                `;
            }
            contentEl.innerHTML = html;
        }

        // Display trading context
        function displayTradingContext(data, symbol) {
            document.getElementById('external-loading').style.display = 'none';
            document.getElementById('external-error').style.display = 'none';
            document.getElementById('external-results').style.display = 'block';

            const titleEl = document.getElementById('external-result-title');
            const infoEl = document.getElementById('external-result-info');
            const contentEl = document.getElementById('external-result-content');

            titleEl.textContent = `Trading Context: ${symbol}`;
            infoEl.textContent = new Date().toLocaleString('de-CH');

            contentEl.innerHTML = formatDataAsHtml(data);
        }

        // Format data object as readable HTML
        function formatDataAsHtml(data) {
            if (!data) return '<p style="color: #888;">Keine Daten verfügbar</p>';
            if (data.error) return `<p style="color: #e57373;">Fehler: ${data.error}</p>`;

            // If it's an array
            if (Array.isArray(data)) {
                if (data.length === 0) return '<p style="color: #888;">Keine Einträge</p>';
                return `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; font-size: 0.85rem;">
                            <thead>
                                <tr style="background: rgba(0,0,0,0.2);">
                                    ${Object.keys(data[0]).map(k => `<th style="padding: 0.5rem; text-align: left; color: #888;">${k}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.slice(0, 50).map(row => `
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        ${Object.values(row).map(v => `<td style="padding: 0.5rem;">${formatValue(v)}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${data.length > 50 ? `<p style="color: #888; margin-top: 0.5rem;">... und ${data.length - 50} weitere Einträge</p>` : ''}
                    </div>
                `;
            }

            // If it's an object
            if (typeof data === 'object') {
                let html = '<div style="display: grid; gap: 0.5rem;">';
                for (const [key, value] of Object.entries(data)) {
                    if (value === null || value === undefined) continue;

                    if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object') {
                        html += `
                            <div style="margin-top: 1rem;">
                                <strong style="color: #64c8ff;">${key}</strong>
                                ${formatDataAsHtml(value)}
                            </div>
                        `;
                    } else if (typeof value === 'object' && !Array.isArray(value)) {
                        html += `
                            <div style="margin-top: 1rem;">
                                <strong style="color: #64c8ff;">${key}</strong>
                                <div style="padding-left: 1rem; border-left: 1px solid rgba(255,255,255,0.1);">
                                    ${formatDataAsHtml(value)}
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="display: flex; gap: 1rem;">
                                <span style="color: #888; min-width: 150px;">${key}:</span>
                                <span>${formatValue(value)}</span>
                            </div>
                        `;
                    }
                }
                html += '</div>';
                return html;
            }

            return `<pre style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>`;
        }

        // Format individual values
        function formatValue(value) {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'boolean') return value ? '&#10003;' : '&#10007;';
            if (typeof value === 'number') {
                if (Number.isInteger(value)) return value.toLocaleString();
                return value.toFixed(4);
            }
            if (Array.isArray(value)) {
                if (value.length === 0) return '-';
                if (typeof value[0] === 'object') return `[${value.length} Einträge]`;
                return value.join(', ');
            }
            if (typeof value === 'object') return '[Objekt]';

            // Check if it's a date string
            if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                try {
                    return new Date(value).toLocaleString('de-CH');
                } catch {
                    return value;
                }
            }

            return String(value);
        }

        // Update stats
        function updateExternalStats() {
            document.getElementById('external-available').textContent = '9';
            document.getElementById('external-last-fetch').textContent = new Date().toLocaleTimeString('de-CH');
        }

        // Check source availability on load
        async function checkExternalSourcesAvailability() {
            try {
                const response = await fetch(`${API_BASE}/external-sources`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('external-available').textContent = data.available_sources?.length || 9;
                }
            } catch (error) {
                console.error('Error checking sources:', error);
            }
        }

        // ==================== Cache Management Functions ====================

        // Cache category labels
        const CACHE_CATEGORY_LABELS = {
            'market': 'Marktdaten',
            'ohlcv': 'OHLCV Kerzen',
            'indicators': 'Indikatoren',
            'symbols': 'Symbole',
            'metadata': 'Metadaten',
            'sentiment': 'Sentiment',
            'economic': 'Wirtschaft',
            'onchain': 'On-Chain',
            'training': 'Training'
        };

        // Cache category descriptions
        const CACHE_CATEGORY_DESCRIPTIONS = {
            'market': 'Echtzeit-Kursdaten und Quotes',
            'ohlcv': 'Kerzendaten (Open, High, Low, Close, Volume)',
            'indicators': 'Technische Indikatoren (RSI, MACD, etc.)',
            'symbols': 'Symbol-Listen und -Konfigurationen',
            'metadata': 'Service-Metadaten',
            'sentiment': 'Sentiment-Daten und Fear & Greed',
            'economic': 'Wirtschaftskalender-Events',
            'onchain': 'Blockchain und On-Chain Daten',
            'training': 'ML-Training Daten'
        };

        let currentCacheData = null;
        let selectedCacheCategory = null;

        // Load cache overview
        async function loadCacheOverview() {
            const overviewContent = document.getElementById('cache-overview-content');
            overviewContent.innerHTML = '<div class="loading"><div class="spinner"></div><br>Lade Cache-Übersicht...</div>';

            try {
                const response = await fetch(`${API_BASE}/cache/overview`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                currentCacheData = await response.json();
                updateCacheStats(currentCacheData);
                renderCacheOverview(currentCacheData);
                renderCacheCategories(currentCacheData);
            } catch (error) {
                console.error('Error loading cache overview:', error);
                overviewContent.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    Fehler beim Laden: ${error.message}
                </div>`;
            }
        }

        // Update cache stats bar
        function updateCacheStats(data) {
            const backend = data.cache_backend || 'memory';
            const isRedis = data.redis?.connected;

            document.getElementById('cache-backend').innerHTML =
                `<span class="cache-status-indicator ${isRedis ? 'connected' : 'disconnected'}"></span>${backend.toUpperCase()}`;
            document.getElementById('cache-total-entries').textContent = data.summary?.total_entries || 0;
            document.getElementById('cache-total-symbols').textContent = data.summary?.total_symbol_count || 0;
            document.getElementById('cache-hit-rate').textContent =
                (data.statistics?.hit_rate_percent || 0).toFixed(1) + '%';
            document.getElementById('cache-memory').textContent = data.redis?.memory_used || 'N/A';
        }

        // Render cache overview content
        function renderCacheOverview(data) {
            const overviewContent = document.getElementById('cache-overview-content');
            const stats = data.statistics || {};

            overviewContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div class="stat-mini">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #81c784;">${stats.hits || 0}</div>
                        <div style="font-size: 0.8rem; color: #888;">Cache Hits</div>
                    </div>
                    <div class="stat-mini">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #e57373;">${stats.misses || 0}</div>
                        <div style="font-size: 0.8rem; color: #888;">Cache Misses</div>
                    </div>
                    <div class="stat-mini">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #64c8ff;">${stats.sets || 0}</div>
                        <div style="font-size: 0.8rem; color: #888;">Sets</div>
                    </div>
                    <div class="stat-mini">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #ffb74d;">${formatBytes(stats.bytes_saved || 0)}</div>
                        <div style="font-size: 0.8rem; color: #888;">Bytes gespart</div>
                    </div>
                    <div class="stat-mini">
                        <div style="font-size: 1.5rem; font-weight: 600; color: ${stats.redis_errors > 0 ? '#e57373' : '#81c784'};">${stats.redis_errors || 0}</div>
                        <div style="font-size: 0.8rem; color: #888;">Redis Fehler</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <strong style="color: #64c8ff;">Gecachte Timeframes:</strong>
                    <div style="margin-top: 0.5rem;">
                        ${(data.summary?.total_timeframes || []).map(tf =>
                            `<span class="badge" style="background: rgba(76, 175, 80, 0.15); color: #81c784; margin-right: 0.25rem;">${tf}</span>`
                        ).join('') || '<span style="color: #888;">Keine</span>'}
                    </div>
                </div>
            `;
        }

        // Render cache categories
        function renderCacheCategories(data) {
            const container = document.getElementById('cache-categories');
            const categories = data.categories || {};
            const ttlConfig = data.ttl_config || {};

            // Get all possible categories
            const allCategories = Object.keys(CACHE_CATEGORY_LABELS);

            container.innerHTML = allCategories.map(cat => {
                const catData = categories[cat] || { entries: 0, symbol_count: 0, timeframe_count: 0, symbols: [], timeframes: [] };
                const ttl = ttlConfig[cat] || { ttl_display: '?' };
                const isEmpty = catData.entries === 0;

                return `
                    <div class="cache-category-card ${isEmpty ? 'empty' : ''}"
                         onclick="${isEmpty ? '' : `showCategoryDetails('${cat}')`}"
                         title="${CACHE_CATEGORY_DESCRIPTIONS[cat] || ''}">
                        <div class="cache-category-header">
                            <span class="cache-category-name">${CACHE_CATEGORY_LABELS[cat] || cat}</span>
                            <span class="cache-category-ttl">TTL: ${ttl.ttl_display}</span>
                        </div>
                        <div class="cache-category-stats">
                            <div class="cache-stat-item">
                                <div class="cache-stat-value">${catData.entries}</div>
                                <div class="cache-stat-label">Einträge</div>
                            </div>
                            <div class="cache-stat-item">
                                <div class="cache-stat-value">${catData.symbol_count}</div>
                                <div class="cache-stat-label">Symbole</div>
                            </div>
                            <div class="cache-stat-item">
                                <div class="cache-stat-value">${catData.timeframe_count}</div>
                                <div class="cache-stat-label">Timeframes</div>
                            </div>
                        </div>
                        ${catData.symbols && catData.symbols.length > 0 ? `
                            <div class="cache-symbols-preview">
                                <strong>Symbole:</strong>
                                ${catData.symbols.slice(0, 8).map(s => `<span class="symbol-tag">${s}</span>`).join('')}
                                ${catData.symbols.length > 8 ? `<span style="color: #888;">+${catData.symbols.length - 8} weitere</span>` : ''}
                            </div>
                        ` : ''}
                        ${catData.timeframes && catData.timeframes.length > 0 ? `
                            <div class="cache-timeframes-row">
                                ${catData.timeframes.map(tf => `<span class="tf-tag">${tf}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Show category details
        async function showCategoryDetails(category) {
            selectedCacheCategory = category;
            document.getElementById('cache-detail-category').textContent =
                CACHE_CATEGORY_LABELS[category] || category;
            document.getElementById('cache-details-card').style.display = 'block';

            const tbody = document.getElementById('cache-entries-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div></td></tr>';

            try {
                const response = await fetch(`${API_BASE}/cache/category/${category}?limit=100`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                renderCategoryEntries(data.entries || []);
            } catch (error) {
                console.error('Error loading category entries:', error);
                tbody.innerHTML = `<tr><td colspan="4" style="color: #e57373;">Fehler: ${error.message}</td></tr>`;
            }
        }

        // Render category entries
        function renderCategoryEntries(entries) {
            const tbody = document.getElementById('cache-entries-body');

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Keine Einträge</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td><strong>${entry.symbol || '-'}</strong></td>
                    <td><span class="badge" style="background: rgba(76, 175, 80, 0.15); color: #81c784;">${entry.timeframe || '-'}</span></td>
                    <td>${formatTTL(entry.ttl_remaining)}</td>
                    <td style="font-size: 0.75rem; color: #888; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${entry.key}</td>
                </tr>
            `).join('');
        }

        // Hide cache details
        function hideCacheDetails() {
            document.getElementById('cache-details-card').style.display = 'none';
            selectedCacheCategory = null;
        }

        // Clear selected category
        async function clearSelectedCategory() {
            if (!selectedCacheCategory) return;

            const categoryName = CACHE_CATEGORY_LABELS[selectedCacheCategory] || selectedCacheCategory;
            if (!confirm(`Alle ${categoryName} Cache-Einträge löschen?`)) return;

            try {
                const response = await fetch(`${API_BASE}/cache/category/${selectedCacheCategory}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                showToast(`${data.deleted_entries} Einträge gelöscht`, 'success');
                hideCacheDetails();
                loadCacheOverview();
            } catch (error) {
                console.error('Error clearing category:', error);
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Confirm clear all cache
        async function confirmClearAllCache() {
            if (!confirm('WARNUNG: Den gesamten Cache leeren? Dies entfernt alle gecachten Daten!')) return;
            if (!confirm('Sind Sie sicher? Diese Aktion kann nicht rückgängig gemacht werden.')) return;

            try {
                const response = await fetch(`${API_BASE}/cache/all`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                showToast(`Gesamter Cache geleert: ${data.deleted_entries} Einträge gelöscht`, 'success');
                loadCacheOverview();
            } catch (error) {
                console.error('Error clearing all cache:', error);
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Format TTL
        function formatTTL(seconds) {
            if (!seconds || seconds <= 0) return '<span style="color: #e57373;">abgelaufen</span>';
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
            return `${Math.floor(seconds / 86400)}d ${Math.floor((seconds % 86400) / 3600)}h`;
        }

        // ============================================
        // Pre-Fetching Functions
        // ============================================

        let prefetchData = null;

        async function loadPrefetchStatus() {
            try {
                const response = await fetch(`${API_BASE}/prefetch/status`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                prefetchData = await response.json();
                updatePrefetchUI(prefetchData);
            } catch (error) {
                console.error('Error loading prefetch status:', error);
                showToast(`Fehler beim Laden des Pre-Fetch-Status: ${error.message}`, 'error');
            }
        }

        function updatePrefetchUI(data) {
            const badge = document.getElementById('prefetch-status-badge');
            const isRunning = data.running;

            badge.textContent = isRunning ? 'Aktiv' : 'Gestoppt';
            badge.style.background = isRunning ? 'rgba(76, 175, 80, 0.2)' : 'rgba(158, 158, 158, 0.2)';
            badge.style.color = isRunning ? '#81c784' : '#bbb';

            // Update buttons
            document.getElementById('prefetch-start-btn').disabled = isRunning;
            document.getElementById('prefetch-stop-btn').disabled = !isRunning;

            // Update stats
            const stats = data.statistics || {};
            document.getElementById('prefetch-last-run').textContent =
                stats.last_run ? formatDateTime(stats.last_run) : 'Nie';
            document.getElementById('prefetch-total-runs').textContent = stats.total_runs || 0;
            document.getElementById('prefetch-symbols').textContent = stats.symbols_fetched || 0;
            document.getElementById('prefetch-entries').textContent = stats.cache_entries_created || 0;
            document.getElementById('prefetch-errors').textContent = stats.errors || 0;

            // Update config fields
            const config = data.config || {};
            document.getElementById('prefetch-interval').value = config.refresh_interval || 300;
            document.getElementById('prefetch-max-symbols').value = config.max_symbols || 50;
            document.getElementById('pf-favorites-only').checked = config.favorites_only || false;

            // Update timeframe checkboxes
            const timeframes = config.timeframes || ['1h', '4h', '1day'];
            document.getElementById('pf-tf-1h').checked = timeframes.includes('1h');
            document.getElementById('pf-tf-4h').checked = timeframes.includes('4h');
            document.getElementById('pf-tf-1day').checked = timeframes.includes('1day');
            document.getElementById('pf-tf-15min').checked = timeframes.includes('15min');
            document.getElementById('pf-tf-1week').checked = timeframes.includes('1week');
        }

        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('de-CH', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
            });
        }

        async function startPrefetch() {
            try {
                const response = await fetch(`${API_BASE}/prefetch/start`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                showToast('Pre-Fetch Service gestartet', 'success');
                setTimeout(loadPrefetchStatus, 500);
            } catch (error) {
                console.error('Error starting prefetch:', error);
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function stopPrefetch() {
            try {
                const response = await fetch(`${API_BASE}/prefetch/stop`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                showToast('Pre-Fetch Service gestoppt', 'success');
                setTimeout(loadPrefetchStatus, 500);
            } catch (error) {
                console.error('Error stopping prefetch:', error);
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function triggerPrefetch() {
            try {
                const response = await fetch(`${API_BASE}/prefetch/run`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                showToast('Pre-Fetch gestartet (läuft im Hintergrund)', 'success');
                // Refresh status after a few seconds
                setTimeout(loadPrefetchStatus, 3000);
            } catch (error) {
                console.error('Error triggering prefetch:', error);
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        async function savePrefetchConfig() {
            try {
                // Build timeframes array
                const timeframes = [];
                if (document.getElementById('pf-tf-1h').checked) timeframes.push('1h');
                if (document.getElementById('pf-tf-4h').checked) timeframes.push('4h');
                if (document.getElementById('pf-tf-1day').checked) timeframes.push('1day');
                if (document.getElementById('pf-tf-15min').checked) timeframes.push('15min');
                if (document.getElementById('pf-tf-1week').checked) timeframes.push('1week');

                const interval = parseInt(document.getElementById('prefetch-interval').value) || 300;
                const maxSymbols = parseInt(document.getElementById('prefetch-max-symbols').value) || 50;
                const favoritesOnly = document.getElementById('pf-favorites-only').checked;

                // Build query params
                const params = new URLSearchParams();
                params.append('refresh_interval', interval);
                params.append('max_symbols', maxSymbols);
                params.append('favorites_only', favoritesOnly);
                timeframes.forEach(tf => params.append('timeframes', tf));

                const response = await fetch(`${API_BASE}/prefetch/configure?${params.toString()}`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                showToast('Pre-Fetch Konfiguration gespeichert', 'success');
                loadPrefetchStatus();
            } catch (error) {
                console.error('Error saving prefetch config:', error);
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // Initialize
        loadSymbols();
        loadStrategies();
        loadIndicators();
        loadExports();

        // Populate explorer symbols after loading and init indicator options for TwelveData
        setTimeout(() => {
            populateExplorerSymbols();
            updateIndicatorOptions();
        }, 1000);
        // Populate external symbols
        setTimeout(populateExternalSymbols, 1200);
        // Check external sources availability
        setTimeout(checkExternalSourcesAvailability, 1500);
        // Load cache overview and prefetch status when tab is visible
        setTimeout(() => {
            // Check if cache tab is active on load
            const cacheTab = document.querySelector('[data-tab="cache"]');
            if (cacheTab) {
                cacheTab.addEventListener('click', () => {
                    setTimeout(() => {
                        loadCacheOverview();
                        loadPrefetchStatus();
                    }, 100);
                });
            }
        }, 500);
    </script>
</body>
</html>
