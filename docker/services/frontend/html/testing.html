<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>KI Trading Model - Test Suite v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
            margin-bottom: 1.5rem;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .back-link {
            color: #64c8ff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(100, 200, 255, 0.1);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .back-link:hover {
            background: rgba(100, 200, 255, 0.2);
        }

        /* Test Controls */
        .test-controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .controls-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Test Summary */
        .test-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .summary-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .summary-card .label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .summary-card.passed .value { color: #10b981; }
        .summary-card.failed .value { color: #ef4444; }
        .summary-card.skipped .value { color: #f59e0b; }
        .summary-card.total .value { color: #64c8ff; }

        /* Test Categories */
        .test-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .category-card:hover {
            border-color: rgba(100, 200, 255, 0.3);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .category-header h3 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-status {
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .category-status.pending {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .category-status.running {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .category-status.passed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .category-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .category-status.skipped {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .category-description {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-bottom: 0.75rem;
        }

        .category-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }

        .category-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .category-stat.passed { color: #34d399; }
        .category-stat.failed { color: #f87171; }
        .category-stat.skipped { color: #fbbf24; }

        .category-progress {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .category-progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .category-progress-bar.passed { background: #10b981; }
        .category-progress-bar.failed { background: #ef4444; }
        .category-progress-bar.running {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            animation: progress-pulse 1.5s ease-in-out infinite;
        }

        @keyframes progress-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Test Results */
        .test-results {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #e8e8e8;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: rgba(100, 200, 255, 0.2);
            border-color: rgba(100, 200, 255, 0.4);
        }

        .test-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .test-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 3px solid transparent;
        }

        .test-item.passed { border-left-color: #10b981; }
        .test-item.failed { border-left-color: #ef4444; }
        .test-item.skipped { border-left-color: #f59e0b; }

        .test-icon {
            font-size: 1.2rem;
            width: 28px;
            text-align: center;
        }

        .test-icon.passed { color: #10b981; }
        .test-icon.failed { color: #ef4444; }
        .test-icon.skipped { color: #f59e0b; }

        .test-content {
            flex: 1;
        }

        .test-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .test-path {
            font-size: 0.75rem;
            opacity: 0.5;
            font-family: monospace;
            margin-bottom: 0.5rem;
        }

        .test-message {
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .test-message.error {
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .test-duration {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        /* Recommendations */
        .recommendations {
            margin-top: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .recommendations h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recommendation-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 3px solid;
        }

        .recommendation-item.critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .recommendation-item.warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .recommendation-item.info {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .recommendation-item.success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .recommendation-icon {
            font-size: 1.5rem;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .recommendation-description {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .recommendation-action {
            font-size: 0.85rem;
            color: #64c8ff;
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 4px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            opacity: 0.6;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 1.5rem;
            opacity: 0.5;
            font-size: 0.8rem;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 8px;
            border-left: 4px solid #64c8ff;
            display: none;
            z-index: 1000;
            max-width: 400px;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal for Test Details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1e2746 0%, #1a1f35 100%);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .modal-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }

        .modal-description {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .modal-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .modal-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .modal-stat-icon { font-size: 1.1rem; }
        .modal-stat.tests { color: #64c8ff; }
        .modal-stat.files { color: #a78bfa; }

        .test-group {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .test-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: background 0.2s;
        }

        .test-group-header:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .test-group-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-group-title .file-icon {
            color: #a78bfa;
        }

        .test-group-count {
            font-size: 0.8rem;
            color: #9ca3af;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
        }

        .test-group-toggle {
            color: #9ca3af;
            transition: transform 0.2s;
        }

        .test-group.expanded .test-group-toggle {
            transform: rotate(180deg);
        }

        .test-group-body {
            display: none;
            padding: 0.5rem;
        }

        .test-group.expanded .test-group-body {
            display: block;
        }

        .test-case {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            transition: background 0.2s;
        }

        .test-case:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .test-case-marker {
            width: 4px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .test-case-marker.function { background: #10b981; }
        .test-case-marker.class { background: #3b82f6; }

        .test-case-content {
            flex: 1;
            min-width: 0;
        }

        .test-case-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: #e8e8e8;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .test-case-desc {
            font-size: 0.82rem;
            color: #9ca3af;
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        .test-case-tags {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.4rem;
            flex-wrap: wrap;
        }

        .test-case-tag {
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
        }

        .test-case-tag.param { background: rgba(167, 139, 250, 0.15); color: #a78bfa; }
        .test-case-tag.slow { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-run-btn {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .modal-run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .modal-info {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* Clickable category cards */
        .category-card {
            cursor: pointer;
        }

        .category-card:hover {
            border-color: rgba(100, 200, 255, 0.4);
            transform: translateY(-2px);
        }

        .category-card .view-tests-hint {
            font-size: 0.75rem;
            color: #64c8ff;
            opacity: 0;
            transition: opacity 0.2s;
            margin-top: 0.5rem;
        }

        .category-card:hover .view-tests-hint {
            opacity: 1;
        }
    </style>
</head>
<body>
    <header>
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="/index.html" class="back-link">&#8592; Dashboard</a>
            <h1>&#128203; Test Suite</h1>
            <div class="header-actions"></div>
        </div>
    </header>

    <div class="container">
        <!-- Test Controls -->
        <div class="test-controls">
            <div class="controls-header">
                <h2>&#9881; Test-Steuerung</h2>
                <div class="test-buttons">
                    <button class="btn btn-primary" id="run-all-btn" onclick="runAllTests()">
                        <span>&#9654;</span> Alle Tests starten
                    </button>
                    <button class="btn btn-secondary" id="run-unit-btn" onclick="runTestCategory('unit')">
                        <span>&#128300;</span> Unit
                    </button>
                    <button class="btn btn-secondary" id="run-smoke-btn" onclick="runTestCategory('smoke')">
                        <span>&#128168;</span> Smoke
                    </button>
                    <button class="btn btn-secondary" id="run-api-btn" onclick="runTestCategory('api')">
                        <span>&#128279;</span> API
                    </button>
                    <button class="btn btn-secondary" id="run-integration-btn" onclick="runTestCategory('integration')">
                        <span>&#128200;</span> Integration
                    </button>
                    <button class="btn btn-secondary" id="run-contract-btn" onclick="runTestCategory('contract')">
                        <span>&#128221;</span> Contract
                    </button>
                    <button class="btn btn-danger" id="stop-btn" onclick="stopTests()" disabled>
                        <span>&#9632;</span> Abbrechen
                    </button>
                </div>
            </div>

            <!-- Summary -->
            <div class="test-summary" id="test-summary">
                <div class="summary-card total">
                    <div class="value" id="total-tests">0</div>
                    <div class="label">Tests gesamt</div>
                </div>
                <div class="summary-card passed">
                    <div class="value" id="passed-tests">0</div>
                    <div class="label">Bestanden</div>
                </div>
                <div class="summary-card failed">
                    <div class="value" id="failed-tests">0</div>
                    <div class="label">Fehlgeschlagen</div>
                </div>
                <div class="summary-card skipped">
                    <div class="value" id="skipped-tests">0</div>
                    <div class="label">Übersprungen</div>
                </div>
                <div class="summary-card duration" id="duration-card" style="display: none;">
                    <div class="value" id="test-duration" style="color: #a78bfa;">00:00</div>
                    <div class="label" id="duration-label">Laufzeit</div>
                </div>
            </div>
        </div>

        <!-- Test Categories - Reihenfolge: Unit -> Smoke -> API -> Integration -> Contract -->
        <div class="test-categories">
            <!-- 1. Unit Tests - Schnell, isoliert, keine Abhängigkeiten -->
            <div class="category-card" id="cat-unit" onclick="showTestDetails('unit')">
                <div class="category-header">
                    <h3>&#128300; 1. Unit Tests</h3>
                    <span class="category-status pending" id="status-unit">Bereit</span>
                </div>
                <div class="category-description">
                    Isolierte Tests ohne Service-Abhängigkeiten - prüft Geschäftslogik mit Mocks. Schnellste Tests.
                </div>
                <div class="category-stats">
                    <span class="category-stat passed">&#10003; <span id="unit-passed">0</span></span>
                    <span class="category-stat failed">&#10007; <span id="unit-failed">0</span></span>
                    <span class="category-stat skipped">&#8680; <span id="unit-skipped">0</span></span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" id="progress-unit" style="width: 0%"></div>
                </div>
                <div class="view-tests-hint">Klicken für Testfälle</div>
            </div>

            <!-- 2. Smoke Tests - Prüft ob Services laufen -->
            <div class="category-card" id="cat-smoke" onclick="showTestDetails('smoke')">
                <div class="category-header">
                    <h3>&#128168; 2. Smoke Tests</h3>
                    <span class="category-status pending" id="status-smoke">Bereit</span>
                </div>
                <div class="category-description">
                    Health Checks für alle 8 Microservices - prüft ob Services erreichbar und funktional sind.
                </div>
                <div class="category-stats">
                    <span class="category-stat passed">&#10003; <span id="smoke-passed">0</span></span>
                    <span class="category-stat failed">&#10007; <span id="smoke-failed">0</span></span>
                    <span class="category-stat skipped">&#8680; <span id="smoke-skipped">0</span></span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" id="progress-smoke" style="width: 0%"></div>
                </div>
                <div class="view-tests-hint">Klicken für Testfälle</div>
            </div>

            <!-- 3. API Tests - Endpoint-Tests -->
            <div class="category-card" id="cat-api" onclick="showTestDetails('api')">
                <div class="category-header">
                    <h3>&#128279; 3. API Tests</h3>
                    <span class="category-status pending" id="status-api">Bereit</span>
                </div>
                <div class="category-description">
                    Endpoint-Tests für alle Service-APIs - OHLCV, Forecasts, Patterns, Regime, Embeddings, RAG, LLM.
                </div>
                <div class="category-stats">
                    <span class="category-stat passed">&#10003; <span id="api-passed">0</span></span>
                    <span class="category-stat failed">&#10007; <span id="api-failed">0</span></span>
                    <span class="category-stat skipped">&#8680; <span id="api-skipped">0</span></span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" id="progress-api" style="width: 0%"></div>
                </div>
                <div class="view-tests-hint">Klicken für Testfälle</div>
            </div>

            <!-- 4. Integration Tests - Service-übergreifend -->
            <div class="category-card" id="cat-integration" onclick="showTestDetails('integration')">
                <div class="category-header">
                    <h3>&#128200; 4. Integration Tests</h3>
                    <span class="category-status pending" id="status-integration">Bereit</span>
                </div>
                <div class="category-description">
                    Service-übergreifende Tests - Data Gateway Pattern, Service-Chain, Fallback-Logik.
                </div>
                <div class="category-stats">
                    <span class="category-stat passed">&#10003; <span id="integration-passed">0</span></span>
                    <span class="category-stat failed">&#10007; <span id="integration-failed">0</span></span>
                    <span class="category-stat skipped">&#8680; <span id="integration-skipped">0</span></span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" id="progress-integration" style="width: 0%"></div>
                </div>
                <div class="view-tests-hint">Klicken für Testfälle</div>
            </div>

            <!-- 5. Contract Tests - Schema-Validierung -->
            <div class="category-card" id="cat-contract" onclick="showTestDetails('contract')">
                <div class="category-header">
                    <h3>&#128221; 5. Contract Tests</h3>
                    <span class="category-status pending" id="status-contract">Bereit</span>
                </div>
                <div class="category-description">
                    API-Schema-Validierung - prüft Response-Formate gegen definierte Pydantic-Schemas.
                </div>
                <div class="category-stats">
                    <span class="category-stat passed">&#10003; <span id="contract-passed">0</span></span>
                    <span class="category-stat failed">&#10007; <span id="contract-failed">0</span></span>
                    <span class="category-stat skipped">&#8680; <span id="contract-skipped">0</span></span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" id="progress-contract" style="width: 0%"></div>
                </div>
                <div class="view-tests-hint">Klicken für Testfälle</div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="recommendations" id="recommendations-section" style="display: none;">
            <h2>&#128161; Empfehlungen</h2>
            <div id="recommendations-list"></div>
        </div>

        <!-- Test Results -->
        <div class="test-results">
            <div class="results-header">
                <h2>&#128203; Test-Ergebnisse</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterResults('all')">Alle</button>
                    <button class="filter-btn" onclick="filterResults('passed')">Bestanden</button>
                    <button class="filter-btn" onclick="filterResults('failed')">Fehlgeschlagen</button>
                    <button class="filter-btn" onclick="filterResults('skipped')">Übersprungen</button>
                </div>
            </div>
            <div class="test-list" id="test-list">
                <div class="empty-state">
                    <div class="empty-state-icon">&#128203;</div>
                    <div>Noch keine Tests ausgeführt</div>
                    <div style="font-size: 0.85rem; margin-top: 0.5rem;">Klicke auf "Alle Tests starten" um die Test-Suite zu starten</div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        KI Trading Model Test Suite | pytest + httpx | Automatisierte Qualitätssicherung
    </footer>

    <div class="toast" id="toast"></div>

    <!-- Test Details Modal -->
    <div class="modal-overlay" id="test-modal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title">Test Details</h2>
                <button class="modal-close" onclick="closeTestModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content wird dynamisch generiert -->
            </div>
            <div class="modal-footer">
                <div class="modal-info" id="modal-info">Tests werden ausgeführt mit pytest</div>
                <button class="modal-run-btn" id="modal-run-btn" onclick="runModalTests()">
                    <span>&#9654;</span> Tests starten
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let testResults = [];
        let isRunning = false;
        let currentFilter = 'all';
        let timerInterval = null;
        let testStartTime = null;

        // API Base URL - use data service as test runner host
        const TEST_API = '/data/api/v1/testing';

        // Helper Functions
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function updateButton(btnId, loading, text) {
            const btn = document.getElementById(btnId);
            if (loading) {
                btn.innerHTML = `<span class="spinner"></span> ${text}`;
                btn.disabled = true;
            } else {
                btn.disabled = false;
            }
        }

        function setRunningState(running, startTime = null) {
            isRunning = running;
            document.getElementById('run-all-btn').disabled = running;
            document.getElementById('run-unit-btn').disabled = running;
            document.getElementById('run-smoke-btn').disabled = running;
            document.getElementById('run-api-btn').disabled = running;
            document.getElementById('run-integration-btn').disabled = running;
            document.getElementById('run-contract-btn').disabled = running;
            document.getElementById('stop-btn').disabled = !running;

            // Disable/enable category cards
            const categoryCards = document.querySelectorAll('.category-card');
            categoryCards.forEach(card => {
                if (running) {
                    card.classList.add('disabled');
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.6';
                } else {
                    card.classList.remove('disabled');
                    card.style.pointerEvents = 'auto';
                    card.style.opacity = '1';
                }
            });

            // Handle timer
            const durationCard = document.getElementById('duration-card');
            if (running) {
                document.getElementById('run-all-btn').innerHTML = '<span class="spinner"></span> Läuft...';
                durationCard.style.display = 'block';
                document.getElementById('duration-label').textContent = 'Laufzeit';
                startTimer(startTime);
            } else {
                document.getElementById('run-all-btn').innerHTML = '<span>&#9654;</span> Alle Tests starten';
                stopTimer();
                document.getElementById('duration-label').textContent = 'Dauer';
            }
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer(existingStartTime = null) {
            testStartTime = existingStartTime ? new Date(existingStartTime) : new Date();
            updateTimerDisplay();

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            if (!testStartTime) return;
            const elapsed = (new Date() - testStartTime) / 1000;
            document.getElementById('test-duration').textContent = formatDuration(elapsed);
        }

        function updateCategoryStatus(category, status) {
            const statusEl = document.getElementById(`status-${category}`);
            statusEl.textContent = {
                'pending': 'Bereit',
                'running': 'Läuft...',
                'passed': 'Bestanden',
                'failed': 'Fehlgeschlagen',
                'skipped': 'Übersprungen'
            }[status];
            statusEl.className = `category-status ${status}`;

            const progressBar = document.getElementById(`progress-${category}`);
            if (status === 'running') {
                progressBar.className = 'category-progress-bar running';
                progressBar.style.width = '100%';
            } else if (status === 'passed') {
                progressBar.className = 'category-progress-bar passed';
            } else if (status === 'failed') {
                progressBar.className = 'category-progress-bar failed';
            }
        }

        function updateCategoryStats(category, passed, failed, skipped) {
            document.getElementById(`${category}-passed`).textContent = passed;
            document.getElementById(`${category}-failed`).textContent = failed;
            document.getElementById(`${category}-skipped`).textContent = skipped;
        }

        function updateSummary() {
            const passed = testResults.filter(t => t.outcome === 'passed').length;
            const failed = testResults.filter(t => t.outcome === 'failed').length;
            const skipped = testResults.filter(t => t.outcome === 'skipped').length;
            const total = testResults.length;

            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
            document.getElementById('skipped-tests').textContent = skipped;
        }

        function getTestIcon(outcome) {
            switch (outcome) {
                case 'passed': return '&#10003;';
                case 'failed': return '&#10007;';
                case 'skipped': return '&#8680;';
                default: return '&#8226;';
            }
        }

        function renderTestResults() {
            const container = document.getElementById('test-list');

            if (testResults.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128203;</div>
                        <div>Noch keine Tests ausgeführt</div>
                    </div>
                `;
                return;
            }

            let filteredResults = testResults;
            if (currentFilter !== 'all') {
                filteredResults = testResults.filter(t => t.outcome === currentFilter);
            }

            if (filteredResults.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128269;</div>
                        <div>Keine Tests mit diesem Filter</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredResults.map(test => `
                <div class="test-item ${test.outcome}">
                    <div class="test-icon ${test.outcome}">${getTestIcon(test.outcome)}</div>
                    <div class="test-content">
                        <div class="test-name">${test.name}</div>
                        <div class="test-path">${test.nodeid || test.path || ''}</div>
                        ${test.duration ? `<div class="test-duration">${test.duration.toFixed(2)}s</div>` : ''}
                        ${test.message ? `<div class="test-message ${test.outcome === 'failed' ? 'error' : ''}">${escapeHtml(test.message)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function filterResults(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(filter) ||
                    (filter === 'all' && btn.textContent === 'Alle'));
            });
            renderTestResults();
        }

        function generateRecommendations() {
            const recommendations = [];
            const failedTests = testResults.filter(t => t.outcome === 'failed');
            const skippedTests = testResults.filter(t => t.outcome === 'skipped');

            // Analyze failed tests
            const healthChecksFailed = failedTests.filter(t =>
                t.name.includes('health') || t.nodeid?.includes('smoke'));

            if (healthChecksFailed.length > 0) {
                const services = healthChecksFailed.map(t => {
                    const match = t.name.match(/(\w+)_service|(\w+)-config/);
                    return match ? (match[1] || match[2]) : 'unknown';
                });
                recommendations.push({
                    type: 'critical',
                    icon: '&#9888;',
                    title: 'Services nicht erreichbar',
                    description: `Die folgenden Services antworten nicht auf Health Checks: ${[...new Set(services)].join(', ')}`,
                    action: 'sudo docker compose -f docker-compose.microservices.yml up -d'
                });
            }

            // Check for connection errors
            const connectionErrors = failedTests.filter(t =>
                t.message?.includes('ConnectError') || t.message?.includes('Connection refused'));

            if (connectionErrors.length > 0 && healthChecksFailed.length === 0) {
                recommendations.push({
                    type: 'warning',
                    icon: '&#128268;',
                    title: 'Netzwerk-Probleme',
                    description: 'Einige Tests konnten keine Verbindung zu den Services herstellen.',
                    action: 'docker network inspect trading-net'
                });
            }

            // Check for API validation errors
            const validationErrors = failedTests.filter(t =>
                t.message?.includes('422') || t.message?.includes('validation'));

            if (validationErrors.length > 0) {
                recommendations.push({
                    type: 'warning',
                    icon: '&#128221;',
                    title: 'API-Validierungsfehler',
                    description: 'Einige API-Requests haben ungültige Parameter. Prüfe die API-Dokumentation.',
                    action: 'Öffne /data/docs für die Swagger-Dokumentation'
                });
            }

            // Check for skipped tests
            if (skippedTests.length > testResults.length * 0.5) {
                recommendations.push({
                    type: 'info',
                    icon: '&#128161;',
                    title: 'Viele Tests übersprungen',
                    description: 'Mehr als 50% der Tests wurden übersprungen. Dies passiert wenn Services nicht laufen.',
                    action: 'Starte alle Services und führe die Tests erneut aus'
                });
            }

            // Check for model-related errors
            const modelErrors = failedTests.filter(t =>
                t.message?.includes('model') || t.message?.includes('404'));

            if (modelErrors.length > 0) {
                recommendations.push({
                    type: 'info',
                    icon: '&#129302;',
                    title: 'Modelle nicht verfügbar',
                    description: 'Einige ML-Modelle sind nicht trainiert. Das ist normal bei frischer Installation.',
                    action: 'POST /nhits/api/v1/train mit {"symbol": "BTCUSD", "epochs": 10}'
                });
            }

            // Success message if all tests passed
            if (failedTests.length === 0 && testResults.length > 0) {
                recommendations.push({
                    type: 'success',
                    icon: '&#127881;',
                    title: 'Alle Tests bestanden!',
                    description: 'Die Microservices-Architektur funktioniert einwandfrei.',
                    action: ''
                });
            }

            return recommendations;
        }

        function renderRecommendations() {
            const recommendations = generateRecommendations();
            const section = document.getElementById('recommendations-section');
            const list = document.getElementById('recommendations-list');

            if (recommendations.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item ${rec.type}">
                    <div class="recommendation-icon">${rec.icon}</div>
                    <div class="recommendation-content">
                        <div class="recommendation-title">${rec.title}</div>
                        <div class="recommendation-description">${rec.description}</div>
                        ${rec.action ? `<div class="recommendation-action">${rec.action}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // API Functions
        // Reihenfolge: unit -> smoke -> api -> integration -> contract
        async function runAllTests() {
            await runTests(['unit', 'smoke', 'api', 'integration', 'contract']);
        }

        async function runTestCategory(category) {
            await runTests([category]);
        }

        async function runTests(categories) {
            // Validate input
            if (!categories || !Array.isArray(categories) || categories.length === 0) {
                showToast('Fehler: Keine Testkategorie ausgewählt', 'error');
                return;
            }

            setRunningState(true);
            testResults = [];
            renderTestResults();

            // Hide recommendations section when starting new tests
            document.getElementById('recommendations-section').style.display = 'none';

            // Reset all categories (in correct order)
            ['unit', 'smoke', 'api', 'integration', 'contract'].forEach(cat => {
                if (categories.includes(cat)) {
                    updateCategoryStatus(cat, 'running');
                } else {
                    updateCategoryStatus(cat, 'pending');
                }
                updateCategoryStats(cat, 0, 0, 0);
            });

            const requestBody = { categories: categories };

            try {
                const response = await fetch(`${TEST_API}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                testResults = data.tests || [];

                // Update category stats
                categories.forEach(cat => {
                    const catTests = testResults.filter(t =>
                        t.nodeid?.includes(cat) || t.category === cat);
                    const passed = catTests.filter(t => t.outcome === 'passed').length;
                    const failed = catTests.filter(t => t.outcome === 'failed').length;
                    const skipped = catTests.filter(t => t.outcome === 'skipped').length;

                    updateCategoryStats(cat, passed, failed, skipped);
                    updateCategoryStatus(cat, failed > 0 ? 'failed' : (passed > 0 ? 'passed' : 'skipped'));
                });

                updateSummary();
                renderTestResults();
                renderRecommendations();

                const passed = testResults.filter(t => t.outcome === 'passed').length;
                const failed = testResults.filter(t => t.outcome === 'failed').length;

                if (failed === 0) {
                    showToast(`Alle ${passed} Tests bestanden!`, 'success');
                } else {
                    showToast(`${failed} von ${testResults.length} Tests fehlgeschlagen`, 'error');
                }

            } catch (error) {
                console.error('Test error:', error);
                showToast(`Fehler: ${error.message}`, 'error');

                categories.forEach(cat => {
                    updateCategoryStatus(cat, 'failed');
                });
            } finally {
                setRunningState(false);
            }
        }

        async function stopTests() {
            try {
                await fetch(`${TEST_API}/stop`, { method: 'POST' });
                showToast('Tests werden abgebrochen...', 'info');
            } catch (error) {
                console.error('Stop error:', error);
            }
            setRunningState(false);
        }

        // ==========================================
        // TEST CASE DEFINITIONS
        // ==========================================

        let currentModalCategory = null;

        const TEST_DEFINITIONS = {
            unit: {
                title: 'Unit Tests',
                icon: '&#128300;',
                description: 'Isolierte Tests ohne Service-Abhängigkeiten. Prüft Geschäftslogik mit Mocks - schnellste Tests, keine laufenden Services erforderlich.',
                files: [
                    {
                        name: 'test_forecast_service.py',
                        path: 'tests/unit/nhits_service/',
                        description: 'NHITS Forecast Service Geschäftslogik - Datenaufbereitung, Modellkonfiguration und Metriken',
                        tests: [
                            { name: 'test_prepare_close_prices', desc: 'Extrahiert Close-Preise aus OHLCV-Rohdaten und validiert die korrekte Anzahl und Werte' },
                            { name: 'test_convert_to_numpy_array', desc: 'Konvertiert Python-Listen zu NumPy float32 Arrays für ML-Verarbeitung' },
                            { name: 'test_normalize_prices', desc: 'Wendet Min-Max Normalisierung an: Werte zwischen 0 und 1 für stabiles Training' },
                            { name: 'test_valid_horizons', desc: 'Akzeptiert gültige Forecast-Horizonte: 1h, 12h, 24h, 48h, 168h (1 Woche)' },
                            { name: 'test_invalid_horizon_zero', desc: 'Lehnt Horizon=0 ab: Forecast-Horizont muss positiv sein' },
                            { name: 'test_invalid_horizon_negative', desc: 'Lehnt negative Horizonte ab: Forecast in die Vergangenheit ist ungültig' },
                            { name: 'test_horizon_too_large', desc: 'Lehnt Horizonte >720h (30 Tage) ab: Maximale Vorhersageweite begrenzt' },
                            { name: 'test_default_config', desc: 'Validiert Standard-NHITS-Konfiguration: input_size=168, output_size=24, hidden_size=128, n_stacks=3' },
                            { name: 'test_config_validation', desc: 'Prüft Constraint: input_size > output_size und hidden_size >= 32' },
                            { name: 'test_create_sliding_windows', desc: 'Erstellt überlappende Fenster aus Zeitreihen: (86 Samples, 10 Window, 5 Horizon)' },
                            { name: 'test_insufficient_data_for_window', desc: 'Erkennt wenn Datenmenge < window_size: Keine Fenster erstellbar' },
                            { name: 'test_window_with_multiple_features', desc: 'Erstellt Fenster mit 5 OHLCV-Features: Shape (n_windows, window_size, 5)' },
                            { name: 'test_mae_calculation', desc: 'Berechnet Mean Absolute Error: |actual - predicted| gemittelt' },
                            { name: 'test_mse_calculation', desc: 'Berechnet Mean Squared Error: (actual - predicted)² gemittelt' },
                            { name: 'test_rmse_calculation', desc: 'Berechnet Root Mean Squared Error: √MSE für interpretierbare Einheit' },
                            { name: 'test_mape_calculation', desc: 'Berechnet Mean Absolute Percentage Error: Prozentuale Abweichung' },
                            { name: 'test_forecast_result_structure', desc: 'Validiert Forecast-Output: symbol, predictions, timestamps, confidence (0-1), model_version' },
                            { name: 'test_predictions_are_numeric', desc: 'Prüft dass alle Predictions numerisch sind: Kein NaN, kein Inf' }
                        ]
                    },
                    {
                        name: 'test_symbol_service.py',
                        path: 'tests/unit/data_service/',
                        description: 'Symbol Management - Kategorisierung, Parsing und TwelveData-Mapping',
                        tests: [
                            { name: 'test_detect_forex_pair', desc: 'Erkennt Forex-Paare anhand 6-Zeichen-Format: EURUSD, GBPJPY, USDCHF → forex' },
                            { name: 'test_detect_crypto', desc: 'Erkennt Crypto anhand Basis-Symbol: BTCUSD, ETHUSD, SOLUSD → crypto' },
                            { name: 'test_detect_indices', desc: 'Erkennt Indizes anhand bekannter Namen: US500, GER40, US30 → index' },
                            { name: 'test_detect_commodities', desc: 'Erkennt Rohstoffe: XAUUSD (Gold), XAGUSD (Silber) → commodity' },
                            { name: 'test_parse_valid_forex_pair', desc: 'Zerlegt EURUSD in base=EUR, quote=USD (case-insensitive)' },
                            { name: 'test_parse_invalid_forex_pair', desc: 'Gibt (None, None) für ungültige Längen: EUR (3), EURUSDD (7)' },
                            { name: 'test_generate_forex_symbol', desc: 'Generiert TwelveData-Format: EURUSD → EUR/USD, GBPJPY → GBP/JPY' },
                            { name: 'test_generate_crypto_symbol', desc: 'Generiert TwelveData-Format: BTCUSD → BTC/USD' },
                            { name: 'test_generate_special_symbol', desc: 'Mappt Spezial-Symbole: GER40→GDAXI, US500→SPX, US30→DJI, DOGUSD→DOGE/USD' },
                            { name: 'test_valid_symbol_formats', desc: 'Akzeptiert: BTCUSD (6 Zeichen), EURUSD, GER40 - alphanumerisch, min. 3 Zeichen' },
                            { name: 'test_invalid_symbol_formats', desc: 'Lehnt ab: "" (leer), "AB" (zu kurz), "BTC/USD" (Sonderzeichen)' },
                            { name: 'test_search_exact_match', desc: 'Exakter Treffer hat höchste Priorität (Score 100): "btcusd" findet BTCUSD zuerst' },
                            { name: 'test_search_partial_match', desc: 'Prefix-Treffer vor Substring: "btc" findet BTCUSD und BTCEUR' },
                            { name: 'test_search_with_limit', desc: 'Begrenzt Ergebnisse: limit=5 bei 10 Treffern gibt 5 zurück' },
                            { name: 'test_symbol_status_values', desc: 'Enum-Werte: active, inactive, suspended für Symbol-Lebenszyklus' },
                            { name: 'test_symbol_category_values', desc: 'Enum-Werte: forex, crypto, index, commodity, other' }
                        ]
                    }
                ]
            },
            smoke: {
                title: 'Smoke Tests',
                icon: '&#128168;',
                description: 'Health Checks für alle 10 Microservices. Schnelle Überprüfung ob Services erreichbar und funktional sind - sollte vor allen anderen Tests laufen.',
                files: [
                    {
                        name: 'test_health_checks.py',
                        path: 'tests/smoke/',
                        description: 'Prüft /health Endpoint jedes Services auf HTTP 200 und korrekten Status',
                        tests: [
                            { name: 'test_service_health[frontend]', desc: 'Frontend (Port 3000): nginx Health Check, erwartet "healthy" im Response-Text', tags: ['parametrized'] },
                            { name: 'test_service_health[data]', desc: 'Data Service (Port 3001): JSON Response mit status="healthy" oder "ok"', tags: ['parametrized'] },
                            { name: 'test_service_health[nhits]', desc: 'NHITS Service (Port 3002): Preis-Forecast-Modell Health Check', tags: ['parametrized'] },
                            { name: 'test_service_health[tcn]', desc: 'TCN Service (Port 3003): Pattern-Erkennung Health Check', tags: ['parametrized'] },
                            { name: 'test_service_health[tcn-train]', desc: 'TCN-Train Service (Port 3013): Training-Container Health Check', tags: ['parametrized'] },
                            { name: 'test_service_health[hmm]', desc: 'HMM Service (Port 3004): Regime-Erkennung Health Check', tags: ['parametrized'] },
                            { name: 'test_service_health[embedder]', desc: 'Embedder Service (Port 3005): Text/Zeitreihen-Embedding Health Check', tags: ['parametrized'] },
                            { name: 'test_service_health[rag]', desc: 'RAG Service (Port 3008): Retrieval-Augmented Generation Health Check', tags: ['parametrized'] },
                            { name: 'test_service_health[llm]', desc: 'LLM Service (Port 3009): Ollama LLM Gateway Health Check', tags: ['parametrized'] },
                            { name: 'test_all_services_up', desc: 'Parallele Health-Checks aller 10 Services, zeigt Running/Failed Übersicht' },
                            { name: 'test_data_service_health_details', desc: 'Data Service Response hat "status" und "service/name" Felder' },
                            { name: 'test_nhits_service_health_details', desc: 'NHITS Service Response enthält "status" Feld' },
                            { name: 'test_rag_service_health_details', desc: 'RAG Service Response enthält "status" Feld' },
                            { name: 'test_llm_service_health_details', desc: 'LLM Service Response enthält "status" Feld' },
                            { name: 'test_tcn_service_health_details', desc: 'TCN Service Response enthält "status" Feld' },
                            { name: 'test_tcn_train_service_health_details', desc: 'TCN-Train Service Response enthält "status" und "training_active" Felder' },
                            { name: 'test_hmm_service_health_details', desc: 'HMM Service Response enthält "status" Feld' },
                            { name: 'test_embedder_service_health_details', desc: 'Embedder Service Response enthält "status" Feld' },
                            { name: 'test_frontend_health', desc: 'Frontend nginx antwortet mit HTTP 200 auf /health' }
                        ]
                    }
                ]
            },
            api: {
                title: 'API Tests',
                icon: '&#128279;',
                description: 'Endpoint-Tests für alle Service-APIs. Testet HTTP-Methoden, Parameter-Validierung, Response-Formate und Fehlerfälle.',
                files: [
                    {
                        name: 'test_data_api.py',
                        path: 'tests/api/',
                        description: 'Data Service: Symbol-Management, OHLCV-Daten, TwelveData-Indikatoren, Externe Quellen',
                        tests: [
                            { name: 'test_get_managed_symbols', desc: 'GET /managed-symbols: Liste aller verwalteten Trading-Symbole als Array' },
                            { name: 'test_get_managed_symbols_stats', desc: 'GET /managed-symbols/stats: Statistiken (Anzahl aktiv, inaktiv, nach Kategorie)' },
                            { name: 'test_search_symbols', desc: 'GET /managed-symbols/search?q=BTC: Fuzzy-Suche nach Symbolen' },
                            { name: 'test_get_available_easyinsight_symbols', desc: 'GET /managed-symbols/available/easyinsight: Von EasyInsight verfügbare Symbole' },
                            { name: 'test_get_yfinance_symbols', desc: 'GET /yfinance/symbols: Von Yahoo Finance verfügbare Symbole' },
                            { name: 'test_get_time_series_data', desc: 'GET /twelvedata/time_series/{symbol}: Historische OHLCV-Daten mit interval und outputsize' },
                            { name: 'test_get_yfinance_time_series', desc: 'GET /yfinance/time-series/AAPL: Yahoo Finance Zeitreihen mit period Parameter' },
                            { name: 'test_get_training_data', desc: 'GET /training-data/{symbol}: Gecachte Trainingsdaten für ML-Modelle' },
                            { name: 'test_get_live_data', desc: 'GET /managed-symbols/live-data/{symbol}: Echtzeit-Kursdaten' },
                            { name: 'test_technical_indicators[rsi]', desc: 'GET /twelvedata/rsi/{symbol}: Relative Strength Index (0-100)', tags: ['parametrized'] },
                            { name: 'test_technical_indicators[macd]', desc: 'GET /twelvedata/macd/{symbol}: Moving Average Convergence Divergence', tags: ['parametrized'] },
                            { name: 'test_technical_indicators[sma]', desc: 'GET /twelvedata/sma/{symbol}: Simple Moving Average', tags: ['parametrized'] },
                            { name: 'test_technical_indicators[ema]', desc: 'GET /twelvedata/ema/{symbol}: Exponential Moving Average', tags: ['parametrized'] },
                            { name: 'test_technical_indicators[bbands]', desc: 'GET /twelvedata/bbands/{symbol}: Bollinger Bands (upper, middle, lower)', tags: ['parametrized'] },
                            { name: 'test_rsi_indicator', desc: 'GET /twelvedata/rsi/EURUSD?time_period=14: RSI mit konfigurierbarer Periode' },
                            { name: 'test_macd_indicator', desc: 'GET /twelvedata/macd/EURUSD: MACD mit Standard-Parametern (12, 26, 9)' },
                            { name: 'test_indicator_generic_endpoint', desc: 'GET /twelvedata/indicator/{symbol}/{indicator}: Generischer Indikator-Endpoint' },
                            { name: 'test_list_external_sources', desc: 'GET /external-sources: Liste verfügbarer externer Datenquellen' },
                            { name: 'test_get_economic_calendar', desc: 'GET /external-sources/economic-calendar: Fed, ECB, CPI, NFP, GDP Events' },
                            { name: 'test_get_sentiment_data', desc: 'GET /external-sources/sentiment: Fear & Greed Index, Social Media Sentiment' },
                            { name: 'test_get_onchain_data', desc: 'GET /external-sources/onchain/{symbol}: Whale Alerts, Exchange Flows (Crypto)' },
                            { name: 'test_get_technical_levels', desc: 'GET /external-sources/technical-levels/{symbol}: Support/Resistance, Fibonacci, Pivots' },
                            { name: 'test_get_macro_data', desc: 'GET /external-sources/macro: DXY, Bond Yields, Korrelationen' },
                            { name: 'test_get_regulatory_data', desc: 'GET /external-sources/regulatory: SEC News, ETF Updates, Regulierung' },
                            { name: 'test_get_correlations', desc: 'GET /external-sources/correlations: Asset-Korrelationsmatrix' },
                            { name: 'test_fetch_all_sources', desc: 'POST /external-sources/fetch-all: Paralleler Abruf mehrerer Quellen' },
                            { name: 'test_get_trading_context', desc: 'POST /external-sources/trading-context/{symbol}: Aggregierter Trading-Kontext' },
                            { name: 'test_scan_patterns', desc: 'GET /patterns/scan/{symbol}: Candlestick-Pattern-Erkennung' },
                            { name: 'test_get_pattern_summary', desc: 'GET /patterns/summary/{symbol}: Pattern-Übersicht mit Statistiken' },
                            { name: 'test_get_timezone', desc: 'GET /config/timezone: Aktuell konfigurierte Anzeige-Zeitzone' },
                            { name: 'test_list_timezones', desc: 'GET /config/timezones: Liste verfügbarer Zeitzonen' },
                            { name: 'test_list_exports', desc: 'GET /config/exports: Verfügbare Konfigurationsexporte' }
                        ]
                    },
                    {
                        name: 'test_nhits_api.py',
                        path: 'tests/api/',
                        description: 'NHITS Service: Preis-Forecasts, Modell-Training, Favorites, Performance-Metriken',
                        tests: [
                            { name: 'test_get_forecast', desc: 'GET /forecast/{symbol}?horizon=24: 24h Preis-Forecast mit Konfidenz' },
                            { name: 'test_list_trained_models', desc: 'GET /forecast/models: Liste aller trainierten NHITS-Modelle' },
                            { name: 'test_get_model_info', desc: 'GET /forecast/{symbol}/model: Modell-Metadaten (Training-Datum, Epochs, Metriken)' },
                            { name: 'test_get_training_status', desc: 'GET /forecast/training/status: Aktueller Training-Status (idle/running)' },
                            { name: 'test_get_training_symbols', desc: 'GET /forecast/training/symbols: Für Training verfügbare Symbole' },
                            { name: 'test_get_auto_status', desc: 'GET /forecast/auto/status: Auto-Forecast Scheduler Status' },
                            { name: 'test_get_favorites', desc: 'GET /forecast/favorites: Favorisierte Symbole für Dashboard' },
                            { name: 'test_get_performance', desc: 'GET /forecast/performance: Aggregierte Modell-Performance (MAE, RMSE)' },
                            { name: 'test_get_evaluated_forecasts', desc: 'GET /forecast/evaluated: Vergangene Forecasts mit Evaluation' },
                            { name: 'test_trigger_training', desc: 'POST /forecast/{symbol}/train: Startet Modell-Training (epochs=1 für Test)', tags: ['slow'] },
                            { name: 'test_get_backup_status', desc: 'GET /backup/status: Modell-Backup Status' },
                            { name: 'test_get_training_cache_stats', desc: 'GET /forecast/training/cache/stats: Trainingsdata-Cache Statistiken' }
                        ]
                    },
                    {
                        name: 'test_rag_api.py',
                        path: 'tests/api/',
                        description: 'RAG Service: Semantische Suche, Dokumente, Trading-Kontext, Scheduler',
                        tests: [
                            { name: 'test_semantic_search', desc: 'POST /rag/query: Semantische Suche in Trading-Dokumenten (top_k=5)' },
                            { name: 'test_detailed_query', desc: 'POST /rag/query/detailed: Erweiterte Suche mit Kontext und Metadaten' },
                            { name: 'test_get_stats', desc: 'GET /rag/stats: RAG-Statistiken (Dokumente, Chunks, Embedding-Modell)' },
                            { name: 'test_list_sources', desc: 'GET /rag/sources: Liste verfügbarer Datenquellen für RAG' },
                            { name: 'test_get_documents', desc: 'GET /rag/documents: Index aller gespeicherten Dokumente' },
                            { name: 'test_get_sentiment', desc: 'GET /rag/sentiment: Aggregierte Markt-Sentiment Daten' },
                            { name: 'test_get_economic_calendar', desc: 'GET /rag/economic-calendar: Wirtschaftskalender für Trading' },
                            { name: 'test_get_macro', desc: 'GET /rag/macro: Makroökonomische Indikatoren' },
                            { name: 'test_get_regulatory', desc: 'GET /rag/regulatory: Regulatorische Updates' },
                            { name: 'test_get_historical_patterns', desc: 'GET /rag/historical-patterns: Historische Muster und Saisonalität' },
                            { name: 'test_get_scheduler_status', desc: 'GET /rag/scheduler/status: Daten-Refresh Scheduler Status' },
                            { name: 'test_get_candlestick_types', desc: 'GET /rag/candlestick-patterns/types: Verfügbare Candlestick-Pattern-Typen' },
                            { name: 'test_get_onchain_data', desc: 'GET /rag/onchain/{symbol}: On-Chain Metriken für Crypto' },
                            { name: 'test_get_easyinsight', desc: 'GET /rag/easyinsight: EasyInsight-Daten via RAG Gateway' }
                        ]
                    },
                    {
                        name: 'test_llm_api.py',
                        path: 'tests/api/',
                        description: 'LLM Service: Trading-Analyse, Chat, Signale, Markt-Zusammenfassung',
                        tests: [
                            { name: 'test_trading_analysis', desc: 'POST /analyze: KI-Trading-Analyse mit RAG-Kontext und Forecast' },
                            { name: 'test_chat_completion', desc: 'POST /chat: Chat-Completion mit Trading-Wissen' },
                            { name: 'test_trading_signal', desc: 'POST /signal: Generiert Buy/Sell/Hold Signal mit Confidence' },
                            { name: 'test_market_summary', desc: 'GET /market-summary: KI-generierte Marktübersicht' },
                            { name: 'test_analyze_with_context', desc: 'POST /analyze: Volle Analyse mit use_rag, include_forecast, include_patterns, include_regime' },
                            { name: 'test_empty_chat_message', desc: 'POST /chat mit leeren messages[]: Erwartet 400/422 Fehler' },
                            { name: 'test_get_available_models', desc: 'GET /models: Liste verfügbarer Ollama-Modelle (8b, 70b, etc.)' }
                        ]
                    },
                    {
                        name: 'test_tcn_api.py',
                        path: 'tests/api/',
                        description: 'TCN Pattern Service: Chart-Pattern-Erkennung mit Temporal Convolutional Networks',
                        tests: [
                            { name: 'test_detect_patterns', desc: 'POST /detect: Erkennt Head&Shoulders, Double Top/Bottom, Triangles, etc.' },
                            { name: 'test_scan_patterns', desc: 'POST /patterns/scan: Multi-Timeframe Scan (1h, 4h) mit min_confidence Filter' },
                            { name: 'test_list_patterns', desc: 'GET /patterns: Liste aller erkennbaren Pattern-Typen' },
                            { name: 'test_get_pattern_history', desc: 'GET /patterns/history/{symbol}: Historische Pattern-Erkennungen' },
                            { name: 'test_detect_with_empty_symbol', desc: 'POST /detect mit leerem Symbol: Fehlerbehandlung testen' }
                        ]
                    },
                    {
                        name: 'test_tcn_train_api.py',
                        path: 'tests/api/',
                        description: 'TCN Training Service: Dedizierter Container für Modell-Training ohne API-Blockierung',
                        tests: [
                            { name: 'test_get_training_status', desc: 'GET /train/status: Aktueller Training-Status (idle/training/preparing)' },
                            { name: 'test_get_training_history', desc: 'GET /train/history: Historie aller bisherigen Trainingsläufe' },
                            { name: 'test_list_models', desc: 'GET /models: Liste aller trainierten TCN-Modelle mit Metadaten' },
                            { name: 'test_get_auto_training_status', desc: 'GET /auto-training/status: Auto-Training Scheduler Konfiguration' },
                            { name: 'test_get_scheduler_status', desc: 'GET /scheduler: Scheduler-Status (Alias für auto-training)' },
                            { name: 'test_health_endpoint', desc: 'GET /health: Health Check mit training_active Flag' },
                            { name: 'test_root_endpoint', desc: 'GET /: Service-Info mit Version und verfügbaren Endpoints' },
                            { name: 'test_train_endpoint_validation', desc: 'POST /train: Training-Parameter Validierung (ohne echtes Training)' },
                            { name: 'test_stop_training_when_idle', desc: 'POST /train/stop: Stop-Anfrage wenn kein Training läuft' }
                        ]
                    },
                    {
                        name: 'test_hmm_api.py',
                        path: 'tests/api/',
                        description: 'HMM Regime Service: Markt-Regime-Erkennung mit Hidden Markov Models',
                        tests: [
                            { name: 'test_detect_regime', desc: 'POST /regime: Erkennt Bull/Bear/Sideways Regime' },
                            { name: 'test_get_regime_history', desc: 'GET /regime/history/{symbol}: Historische Regime-Wechsel' },
                            { name: 'test_score_signal', desc: 'POST /score: Bewertet Trading-Signal basierend auf aktuellem Regime' },
                            { name: 'test_get_regime_probabilities', desc: 'GET /regime/probabilities/{symbol}: Regime-Wahrscheinlichkeiten (Bull: 60%, etc.)' },
                            { name: 'test_list_regimes', desc: 'GET /regimes: Definierte Regime-Typen und Beschreibungen' }
                        ]
                    },
                    {
                        name: 'test_embedder_api.py',
                        path: 'tests/api/',
                        description: 'Embedder Service: Text- und Zeitreihen-Embeddings für RAG und Similarity Search',
                        tests: [
                            { name: 'test_text_embedding', desc: 'POST /embed/text: Generiert 768-dim Vektor für Trading-Text' },
                            { name: 'test_batch_text_embedding', desc: 'POST /embed/text/batch: Batch-Verarbeitung mehrerer Texte' },
                            { name: 'test_timeseries_embedding', desc: 'POST /embed/timeseries: Embedding für OHLCV-Zeitreihe' },
                            { name: 'test_feature_embedding', desc: 'POST /embed/features: Embedding für technische Indikatoren (RSI, MACD, etc.)' },
                            { name: 'test_similarity_search', desc: 'POST /similarity: Findet ähnliche Embeddings (top_k=5)' },
                            { name: 'test_empty_text_embedding', desc: 'POST /embed/text mit leerem Text: Fehlerbehandlung' },
                            { name: 'test_get_embedding_info', desc: 'GET /info: Embedding-Modell Info (Dimensionen, Modellname)' }
                        ]
                    },
                    {
                        name: 'test_easyinsight_api.py',
                        path: 'tests/api/',
                        description: 'EasyInsight Integration: MT5-Daten via EasyInsight Gateway',
                        tests: [
                            { name: 'test_get_available_easyinsight_symbols', desc: 'GET /managed-symbols/available/easyinsight: Verfügbare MT5-Symbole' },
                            { name: 'test_get_managed_symbols_stats', desc: 'GET /managed-symbols/stats: Symbol-Statistiken' },
                            { name: 'test_search_easyinsight_symbols', desc: 'GET /managed-symbols/search?query=BTC: Symbol-Suche' },
                            { name: 'test_get_easyinsight_ohlcv', desc: 'GET /easyinsight/ohlcv/{symbol}: OHLCV-Daten von EasyInsight' },
                            { name: 'test_get_easyinsight_latest', desc: 'GET /easyinsight/latest/{symbol}: Aktueller Preis von MT5' },
                            { name: 'test_easyinsight_intervals[M1]', desc: 'OHLCV mit M1 Intervall (1 Minute)', tags: ['parametrized'] },
                            { name: 'test_easyinsight_intervals[M5]', desc: 'OHLCV mit M5 Intervall (5 Minuten)', tags: ['parametrized'] },
                            { name: 'test_easyinsight_intervals[M15]', desc: 'OHLCV mit M15 Intervall (15 Minuten)', tags: ['parametrized'] },
                            { name: 'test_easyinsight_intervals[M30]', desc: 'OHLCV mit M30 Intervall (30 Minuten)', tags: ['parametrized'] },
                            { name: 'test_easyinsight_intervals[H1]', desc: 'OHLCV mit H1 Intervall (1 Stunde)', tags: ['parametrized'] },
                            { name: 'test_easyinsight_intervals[H4]', desc: 'OHLCV mit H4 Intervall (4 Stunden)', tags: ['parametrized'] },
                            { name: 'test_easyinsight_intervals[D1]', desc: 'OHLCV mit D1 Intervall (1 Tag)', tags: ['parametrized'] },
                            { name: 'test_get_easyinsight_status', desc: 'GET /easyinsight/status: Verbindungsstatus zu EasyInsight' },
                            { name: 'test_get_rag_easyinsight_data', desc: 'GET /rag/easyinsight: EasyInsight-Daten via RAG Service' },
                            { name: 'test_easyinsight_health', desc: 'Direkter Health Check auf EasyInsight Server (10.1.19.102:3000)' },
                            { name: 'test_easyinsight_symbols_direct', desc: 'Direkter /api/symbols Aufruf auf EasyInsight' },
                            { name: 'test_easyinsight_mt5_status', desc: 'MT5-Verbindungsstatus auf EasyInsight prüfen' }
                        ]
                    },
                    {
                        name: 'test_twelvedata_api.py',
                        path: 'tests/api/',
                        description: 'TwelveData Integration: Umfassende technische Indikatoren',
                        tests: [
                            { name: 'test_get_time_series', desc: 'GET /twelvedata/time_series/EURUSD: OHLCV von TwelveData' },
                            { name: 'test_time_series_various_symbols[EUR/USD]', desc: 'Zeitreihe für EUR/USD (Forex Format)', tags: ['parametrized'] },
                            { name: 'test_time_series_various_symbols[BTC/USD]', desc: 'Zeitreihe für BTC/USD (Crypto Format)', tags: ['parametrized'] },
                            { name: 'test_time_series_various_symbols[AAPL]', desc: 'Zeitreihe für AAPL (Aktie)', tags: ['parametrized'] },
                            { name: 'test_time_series_various_symbols[GDAXI]', desc: 'Zeitreihe für GDAXI (DAX Index)', tags: ['parametrized'] },
                            { name: 'test_time_series_intervals[1min]', desc: 'Zeitreihe mit 1-Minuten Intervall', tags: ['parametrized'] },
                            { name: 'test_time_series_intervals[5min]', desc: 'Zeitreihe mit 5-Minuten Intervall', tags: ['parametrized'] },
                            { name: 'test_time_series_intervals[15min]', desc: 'Zeitreihe mit 15-Minuten Intervall', tags: ['parametrized'] },
                            { name: 'test_time_series_intervals[30min]', desc: 'Zeitreihe mit 30-Minuten Intervall', tags: ['parametrized'] },
                            { name: 'test_time_series_intervals[1h]', desc: 'Zeitreihe mit 1-Stunden Intervall', tags: ['parametrized'] },
                            { name: 'test_time_series_intervals[4h]', desc: 'Zeitreihe mit 4-Stunden Intervall', tags: ['parametrized'] },
                            { name: 'test_time_series_intervals[1day]', desc: 'Zeitreihe mit Tages-Intervall', tags: ['parametrized'] },
                            { name: 'test_rsi_indicator', desc: 'RSI Indikator (Relative Strength Index) mit time_period' },
                            { name: 'test_macd_indicator', desc: 'MACD Indikator (Moving Average Convergence Divergence)' },
                            { name: 'test_stoch_indicator', desc: 'Stochastic Oscillator (%K, %D)' },
                            { name: 'test_cci_indicator', desc: 'Commodity Channel Index mit time_period' },
                            { name: 'test_adx_indicator', desc: 'Average Directional Index (Trendstärke)' },
                            { name: 'test_willr_indicator', desc: 'Williams %R (Momentum-Oszillator)' },
                            { name: 'test_moving_averages[sma]', desc: 'Simple Moving Average', tags: ['parametrized'] },
                            { name: 'test_moving_averages[ema]', desc: 'Exponential Moving Average', tags: ['parametrized'] },
                            { name: 'test_moving_averages[wma]', desc: 'Weighted Moving Average', tags: ['parametrized'] },
                            { name: 'test_moving_averages[dema]', desc: 'Double Exponential Moving Average', tags: ['parametrized'] },
                            { name: 'test_moving_averages[tema]', desc: 'Triple Exponential Moving Average', tags: ['parametrized'] },
                            { name: 'test_supertrend_indicator', desc: 'Supertrend Indikator (Trend-Following)' },
                            { name: 'test_ichimoku_indicator', desc: 'Ichimoku Cloud (Tenkan, Kijun, Senkou, Chikou)' },
                            { name: 'test_sar_indicator', desc: 'Parabolic SAR (Stop and Reverse)' },
                            { name: 'test_bbands_indicator', desc: 'Bollinger Bands (upper, middle, lower)' },
                            { name: 'test_atr_indicator', desc: 'Average True Range (Volatilität)' },
                            { name: 'test_percent_b_indicator', desc: 'Percent B (%B) - Position innerhalb Bollinger Bands' },
                            { name: 'test_obv_indicator', desc: 'On Balance Volume (Volumen-Indikator)' },
                            { name: 'test_vwap_indicator', desc: 'Volume Weighted Average Price' },
                            { name: 'test_ad_indicator', desc: 'Accumulation/Distribution Line' },
                            { name: 'test_crsi_indicator', desc: 'Connors RSI (3-Komponenten RSI für Mean-Reversion)' },
                            { name: 'test_linearregslope_indicator', desc: 'Linear Regression Slope (Trendstärke als Zahl)' },
                            { name: 'test_ht_trendmode_indicator', desc: 'Hilbert Transform Trend Mode (Trend=1, Range=0)' },
                            { name: 'test_generic_indicator_endpoint', desc: 'Generischer Indikator-Endpoint /indicator/{symbol}/{indicator}' },
                            { name: 'test_multiple_indicators', desc: 'POST /twelvedata/multiple: Mehrere Indikatoren auf einmal' },
                            { name: 'test_invalid_symbol', desc: 'Ungültiges Symbol INVALID_SYMBOL_XYZ → Fehlerbehandlung' },
                            { name: 'test_invalid_interval', desc: 'Ungültiges Intervall "invalid" → Fehlerbehandlung' },
                            { name: 'test_rate_limit_handling', desc: 'Rate Limit (429) wird korrekt behandelt' }
                        ]
                    }
                ]
            },
            integration: {
                title: 'Integration Tests',
                icon: '&#128200;',
                description: 'Service-übergreifende Tests. Prüft Data Gateway Pattern, Service-Kommunikation, Fallback-Logik und End-to-End Datenflüsse.',
                files: [
                    {
                        name: 'test_service_communication.py',
                        path: 'tests/integration/',
                        description: 'Inter-Service-Kommunikation und Error Propagation',
                        tests: [
                            { name: 'test_all_services_respond', desc: 'Parallele Health-Checks: Alle 8 Services antworten auf /health' },
                            { name: 'test_data_service_provides_ohlcv', desc: 'Data Service liefert OHLCV-Daten: Response-Struktur validiert' },
                            { name: 'test_concurrent_service_requests', desc: 'Concurrent Requests: Alle Services gleichzeitig ansprechen' },
                            { name: 'test_data_service_symbols_endpoint', desc: 'Data Service /managed-symbols Endpoint funktioniert' },
                            { name: 'test_nhits_service_models_endpoint', desc: 'NHITS Service /models Endpoint funktioniert' },
                            { name: 'test_rag_service_stats_endpoint', desc: 'RAG Service /stats Endpoint funktioniert' },
                            { name: 'test_invalid_symbol_handling', desc: 'Ungültiges Symbol INVALID_SYMBOL_12345 → 400/404/422 bei allen Services' },
                            { name: 'test_missing_required_parameters', desc: 'Fehlende Parameter → 422 Validation Error' }
                        ]
                    },
                    {
                        name: 'test_data_gateway.py',
                        path: 'tests/integration/',
                        description: 'Data Gateway Pattern: Alle Services nutzen Data Service als einziges Gateway für externe Daten',
                        tests: [
                            { name: 'test_nhits_uses_data_service', desc: 'NHITS Service ruft Trainingsdaten über Data Service ab (nicht direkt)' },
                            { name: 'test_rag_uses_data_service_for_context', desc: 'RAG Service holt Trading-Kontext via Data Service Gateway' },
                            { name: 'test_llm_uses_data_service', desc: 'LLM Service nutzt Data Service für Marktdaten in Analysen' },
                            { name: 'test_data_to_nhits_chain', desc: 'Kette funktioniert: Data OHLCV → NHITS Forecast' },
                            { name: 'test_full_analysis_chain', desc: 'E2E Kette: Data → NHITS → RAG → LLM für vollständige Analyse' },
                            { name: 'test_data_source_fallback', desc: 'Fallback-Logik: EasyInsight → TwelveData → Yahoo Finance' },
                            { name: 'test_multiple_symbols_data_fetch', desc: 'Paralleler Abruf: BTCUSD, ETHUSD, EURUSD gleichzeitig' },
                            { name: 'test_fetch_all_external_sources', desc: 'POST /fetch-all: Sentiment, Macro, OnChain parallel' },
                            { name: 'test_trading_context_aggregation', desc: 'Trading-Kontext aggregiert Daten aus allen Quellen' }
                        ]
                    }
                ]
            },
            contract: {
                title: 'Contract Tests',
                icon: '&#128221;',
                description: 'API-Schema-Validierung. Prüft dass Response-Formate exakt den definierten Schemas entsprechen.',
                files: [
                    {
                        name: 'test_api_contracts.py',
                        path: 'tests/contract/',
                        description: 'Response Schema Validierung für alle Services',
                        tests: [
                            { name: 'test_health_response_contract[data]', desc: 'Data Service: /health Response hat "status" Feld mit healthy/ok/running', tags: ['parametrized'] },
                            { name: 'test_health_response_contract[nhits]', desc: 'NHITS Service: /health Response Schema konform', tags: ['parametrized'] },
                            { name: 'test_health_response_contract[tcn]', desc: 'TCN Service: /health Response Schema konform', tags: ['parametrized'] },
                            { name: 'test_health_response_contract[tcn-train]', desc: 'TCN-Train Service: /health Response hat training_active Feld', tags: ['parametrized'] },
                            { name: 'test_health_response_contract[hmm]', desc: 'HMM Service: /health Response Schema konform', tags: ['parametrized'] },
                            { name: 'test_health_response_contract[embedder]', desc: 'Embedder Service: /health Response Schema konform', tags: ['parametrized'] },
                            { name: 'test_health_response_contract[rag]', desc: 'RAG Service: /health Response Schema konform', tags: ['parametrized'] },
                            { name: 'test_health_response_contract[llm]', desc: 'LLM Service: /health Response Schema konform', tags: ['parametrized'] },
                            { name: 'test_ohlcv_response_contract', desc: 'OHLCV Response: Array oder {data: [...]} mit OHLCV-Objekten' },
                            { name: 'test_managed_symbols_response_contract', desc: 'Managed Symbols: Array oder Dict mit Symbol-Objekten' },
                            { name: 'test_forecast_response_contract', desc: 'Forecast Response: predicted_prices/predictions/forecast Feld vorhanden' },
                            { name: 'test_models_response_contract', desc: 'Models Response: Liste oder Dict mit Modell-Informationen' },
                            { name: 'test_context_response_contract', desc: 'RAG Context: Dict mit aggregierten Kontextdaten' },
                            { name: 'test_stats_response_contract', desc: 'RAG Stats: Dict mit Statistik-Feldern' },
                            { name: 'test_analyze_response_contract', desc: 'LLM Analyze: Dict mit Analyse-Ergebnis' }
                        ]
                    }
                ]
            }
        };

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================

        function showTestDetails(category) {
            currentModalCategory = category;
            const def = TEST_DEFINITIONS[category];
            if (!def) return;

            const modal = document.getElementById('test-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const info = document.getElementById('modal-info');

            // Count total tests
            let totalTests = 0;
            def.files.forEach(f => totalTests += f.tests.length);

            title.innerHTML = `${def.icon} ${def.title}`;

            let html = `
                <div class="modal-description">${def.description}</div>
                <div class="modal-stats">
                    <div class="modal-stat tests">
                        <span class="modal-stat-icon">&#128203;</span>
                        <span>${totalTests} Testfälle</span>
                    </div>
                    <div class="modal-stat files">
                        <span class="modal-stat-icon">&#128196;</span>
                        <span>${def.files.length} Testdateien</span>
                    </div>
                </div>
            `;

            // Render test files
            def.files.forEach((file, idx) => {
                html += `
                    <div class="test-group ${idx === 0 ? 'expanded' : ''}" onclick="toggleTestGroup(this)">
                        <div class="test-group-header">
                            <div class="test-group-title">
                                <span class="file-icon">&#128196;</span>
                                <span>${file.name}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span class="test-group-count">${file.tests.length} Tests</span>
                                <span class="test-group-toggle">&#9660;</span>
                            </div>
                        </div>
                        <div class="test-group-body">
                            <div style="padding: 0.5rem 1rem 0.75rem; font-size: 0.8rem; color: #9ca3af; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 0.5rem;">
                                <code style="color: #a78bfa;">${file.path}${file.name}</code>
                                <div style="margin-top: 0.25rem;">${file.description}</div>
                            </div>
                            ${file.tests.map(test => `
                                <div class="test-case">
                                    <div class="test-case-marker function"></div>
                                    <div class="test-case-content">
                                        <div class="test-case-name">${test.name}</div>
                                        <div class="test-case-desc">${test.desc}</div>
                                        ${test.tags ? `
                                            <div class="test-case-tags">
                                                ${test.tags.map(tag => `<span class="test-case-tag ${tag}">${tag}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
            info.textContent = `pytest -m ${category} | ${totalTests} Tests`;

            modal.classList.add('show');
        }

        function toggleTestGroup(element) {
            // Don't toggle if clicking inside the body
            if (event.target.closest('.test-group-body')) return;
            element.classList.toggle('expanded');
        }

        function closeTestModal() {
            document.getElementById('test-modal').classList.remove('show');
            currentModalCategory = null;
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeTestModal();
            }
        }

        function runModalTests() {
            if (currentModalCategory) {
                const category = currentModalCategory;  // Save before closeTestModal() clears it
                closeTestModal();
                runTestCategory(category);
            }
        }

        // Keyboard handler for ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTestModal();
            }
        });

        // Initial page load - check if test API is available and restore running state
        async function checkTestAPI() {
            try {
                const response = await fetch(`${TEST_API}/status`);
                if (!response.ok) {
                    showToast('Test-API nicht verfügbar. Starte Data Service.', 'error');
                    return;
                }

                const status = await response.json();

                // If tests are running, update UI to reflect that
                if (status.running) {
                    setRunningState(true, status.last_run);
                    if (status.current_category) {
                        updateCategoryStatus(status.current_category, 'running');
                    }
                    showToast(`Tests laufen bereits (${status.current_category || 'unbekannt'})`, 'info');

                    // Start polling for results
                    pollTestStatus();
                } else {
                    // Load last result if available
                    await loadLastResult();
                }
            } catch (error) {
                console.error('Test API check failed:', error);
                showToast('Verbindung zur Test-API fehlgeschlagen', 'error');
            }
        }

        // Load the last test result
        async function loadLastResult() {
            try {
                const response = await fetch(`${TEST_API}/last-result`);
                if (response.ok) {
                    const result = await response.json();
                    if (result && result.total > 0) {
                        processTestResults(result);
                        // Show duration card with final time
                        document.getElementById('duration-card').style.display = 'block';
                        document.getElementById('test-duration').textContent = formatDuration(result.duration);
                        document.getElementById('duration-label').textContent = 'Letzte Dauer';
                    }
                }
            } catch (error) {
                console.error('Failed to load last result:', error);
            }
        }

        // Poll for test completion when tests are already running
        async function pollTestStatus() {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${TEST_API}/status`);
                    const status = await response.json();

                    if (!status.running) {
                        clearInterval(pollInterval);
                        setRunningState(false);

                        // Load last result
                        const resultResponse = await fetch(`${TEST_API}/last-result`);
                        if (resultResponse.ok) {
                            const result = await resultResponse.json();
                            if (result) {
                                processTestResults(result);
                            }
                        }
                    }
                } catch (error) {
                    clearInterval(pollInterval);
                    setRunningState(false);
                }
            }, 2000);
        }

        // Run check on load
        checkTestAPI();
    </script>
</body>
</html>
