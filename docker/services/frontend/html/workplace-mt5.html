<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT5 Connector - Trading Workplace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.85rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .status-badge.online {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .status-badge.offline {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-badge.online .status-dot {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-badge.offline .status-dot {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 0.4rem 0.9rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stat-card-title {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .stat-card-icon {
            font-size: 1.1rem;
        }

        .stat-card-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-card-value.positive {
            color: #34d399;
        }

        .stat-card-value.negative {
            color: #f87171;
        }

        .stat-card-subtitle {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        /* Sidebar - Terminals */
        .sidebar {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .terminal-list {
            padding: 0.5rem;
        }

        .terminal-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .terminal-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(100, 200, 255, 0.2);
        }

        .terminal-item.selected {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .terminal-name {
            font-weight: 500;
        }

        .terminal-status {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }

        .terminal-status.online {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .terminal-status.offline {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .terminal-info {
            font-size: 0.75rem;
            color: #64748b;
        }

        .terminal-account {
            display: flex;
            justify-content: space-between;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Trades Table */
        .trades-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .section-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .section-filters {
            display: flex;
            gap: 0.5rem;
        }

        .filter-select {
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
            font-size: 0.8rem;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th,
        .trades-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .trades-table th {
            background: rgba(0, 0, 0, 0.2);
            color: #94a3b8;
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .trades-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .trade-symbol {
            font-weight: 600;
            color: #64c8ff;
        }

        .trade-type {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .trade-type.buy {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .trade-type.sell {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .trade-profit.positive {
            color: #34d399;
        }

        .trade-profit.negative {
            color: #f87171;
        }

        .trade-link {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            cursor: pointer;
        }

        .trade-link.no-link {
            background: rgba(148, 163, 184, 0.1);
            color: #64748b;
        }

        .trade-link:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Performance Section */
        .performance-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 1rem;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .perf-item {
            text-align: center;
        }

        .perf-value {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .perf-value.recommendation {
            font-size: 0.85rem;
            font-weight: 500;
            color: #94a3b8;
            line-height: 1.3;
        }

        .perf-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state-text {
            font-size: 0.9rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #64c8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }
        }

        .trade-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            cursor: pointer;
            border: none;
            margin-left: 0.5rem;
        }

        .trade-action-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Active trades section highlight */
        .active-trades-section {
            border: 1px solid rgba(16, 185, 129, 0.2);
            background: rgba(16, 185, 129, 0.03);
        }

        .active-trades-section .section-title {
            color: #34d399;
        }

        .trade-count {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .no-active-trades {
            text-align: center;
            padding: 1.5rem;
            color: #64748b;
            font-size: 0.85rem;
        }

        /* Detail Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: #1a1a2e;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-header .symbol-badge { font-size: 1rem; color: #64c8ff; }
        .modal-header .tf-badge {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            background: rgba(100, 200, 255, 0.15);
            border-radius: 4px;
            color: #94a3b8;
        }

        .modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }

        .modal-close:hover { color: #fff; }
        .modal-body { padding: 1.5rem; }

        .detail-section { margin-bottom: 1.5rem; }
        .detail-section:last-child { margin-bottom: 0; }
        .detail-section-header {
            font-size: 0.8rem;
            font-weight: 600;
            color: #64c8ff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(100, 200, 255, 0.2);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .overview-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .overview-item .label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .overview-item .value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .overview-item .value.score-high { color: #10b981; }
        .overview-item .value.score-med { color: #f59e0b; }
        .overview-item .value.score-low { color: #ef4444; }
        .overview-item .value.long { color: #10b981; }
        .overview-item .value.short { color: #ef4444; }
        .overview-item .value.neutral { color: #94a3b8; }

        .key-drivers-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .key-driver {
            background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            color: #e8e8e8;
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .signal-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 1rem;
        }

        .signal-card.unavailable { opacity: 0.5; }

        .signal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .signal-card-title { font-weight: 600; font-size: 0.9rem; color: #e8e8e8; }

        .signal-card-badge {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .signal-card-badge.long { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .signal-card-badge.short { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .signal-card-badge.neutral { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }
        .signal-card-badge.unavailable { background: rgba(100, 100, 100, 0.2); color: #64748b; }

        .signal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .signal-detail {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        .signal-detail .label { color: #64748b; }
        .signal-detail .value { color: #e8e8e8; font-weight: 500; }
        .signal-detail.full-width { grid-column: 1 / -1; }

        .signal-patterns {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .signal-patterns .label { color: #64748b; font-size: 0.75rem; margin-bottom: 0.25rem; }
        .signal-patterns .patterns-list { display: flex; flex-wrap: wrap; gap: 0.25rem; }

        .pattern-tag {
            background: rgba(100, 200, 255, 0.1);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #64c8ff;
        }

        .price-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .price-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .price-item .label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .price-item .value { font-size: 1rem; font-weight: 600; color: #e8e8e8; }

        .meta-info { display: flex; flex-wrap: wrap; gap: 1.5rem; }
        .meta-item { font-size: 0.85rem; }
        .meta-item .label { color: #64748b; margin-right: 0.5rem; }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #64c8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-row">
                <div class="header-left">
                    <a href="workplace.html" class="back-link">‚Üê Trading Workplace</a>
                    <h1>MT5 Connector</h1>
                </div>
                <div class="header-right">
                    <div class="status-badge" id="connectionStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">Verbindung...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        ‚Üª Aktualisieren
                    </button>
                    <button class="btn btn-primary" onclick="triggerAutoLink()">
                        Auto-Link Trades
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Overview -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Offene Trades</span>
                </div>
                <div class="stat-card-value" id="statOpenTrades">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Gesamt-Trades</span>
                </div>
                <div class="stat-card-value" id="statTotalTrades">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Win-Rate</span>
                </div>
                <div class="stat-card-value positive" id="statWinRate">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Net Profit</span>
                </div>
                <div class="stat-card-value" id="statNetProfit">-</div>
                <div class="stat-card-subtitle" id="statProfitFactor">PF: -</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Setup-Befolgung</span>
                </div>
                <div class="stat-card-value" id="statSetupFollow">-</div>
                <div class="stat-card-subtitle" id="statSetupAccuracy">Genauigkeit: -</div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar: Terminals -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">MT5 Terminals</span>
                    <span id="terminalCount">0</span>
                </div>
                <div class="terminal-list" id="terminalList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Active Trades -->
                <div class="trades-section active-trades-section">
                    <div class="section-header">
                        <span class="section-title">Aktive Trades</span>
                        <span class="trade-count" id="activeTradeCount">0</span>
                    </div>
                    <div id="activeTradesContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Closed Trades -->
                <div class="trades-section">
                    <div class="section-header">
                        <span class="section-title">Abgeschlossene Trades</span>
                        <div class="section-filters">
                            <select class="filter-select" id="filterSymbol" onchange="loadTrades()">
                                <option value="">Alle Symbole</option>
                            </select>
                        </div>
                    </div>
                    <div id="closedTradesContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Performance by Setup -->
                <div class="performance-section">
                    <div class="section-header" style="padding: 0; border: none; margin-bottom: 1rem;">
                        <span class="section-title">Performance nach Setup-Befolgung</span>
                    </div>
                    <div class="performance-grid" id="setupPerformance">
                        <div class="perf-item">
                            <div class="perf-value positive" id="perfFollowed">-</div>
                            <div class="perf-label">Win-Rate (Setup befolgt)</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-value" id="perfAgainst">-</div>
                            <div class="perf-label">Win-Rate (gegen Setup)</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-value" id="perfNoLink">-</div>
                            <div class="perf-label">Win-Rate (kein Link)</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-value recommendation" id="perfRecommendation">-</div>
                            <div class="perf-label">Empfehlung</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Detail Modal -->
    <div class="modal-overlay" id="detailModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>
                    <span class="symbol-badge" id="modalSymbol">-</span>
                    <span class="tf-badge" id="modalTimeframe">-</span>
                    Setup Details
                    <span class="setup-id-badge" id="modalSetupId" style="display: none; font-size: 0.7rem; padding: 0.2rem 0.5rem; background: rgba(100, 200, 255, 0.1); border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 4px; color: #64c8ff; margin-left: 0.5rem;"></span>
                </h2>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Lade Details...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WORKPLACE_API = '/workplace/api/v1/mt5';
        const DATA_API = '/data/api/v1/mt5';
        const DATA_SERVICE_URL = '/data';

        let currentTerminalId = null;
        let tradesCache = {}; // Trade-Daten f√ºr Modal

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOverview();
            loadPerformance();
        });

        async function loadOverview() {
            try {
                const response = await fetch(`${WORKPLACE_API}/overview`);
                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();

                // Update connection status
                updateConnectionStatus(data.terminals_online > 0);

                // Update stats
                updateStats(data.metrics, data.open_trades, data.terminals_online);

                // Update terminals
                renderTerminals(data.terminals);

                // Load trades
                await loadTrades();

                console.log('Overview loaded successfully');

            } catch (error) {
                console.error('Error loading overview:', error);
                updateConnectionStatus(false);
                throw error; // Re-throw f√ºr refreshData()
            }
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connectionStatus');
            const text = badge.querySelector('.status-text');

            if (connected) {
                badge.className = 'status-badge online';
                text.textContent = 'Verbunden';
            } else {
                badge.className = 'status-badge offline';
                text.textContent = 'Nicht verbunden';
            }
        }

        function updateStats(metrics, openTrades, terminalsOnline) {
            document.getElementById('statOpenTrades').textContent = openTrades || 0;
            document.getElementById('statTotalTrades').textContent = metrics.total_trades || 0;
            document.getElementById('statWinRate').textContent = (metrics.win_rate || 0).toFixed(1) + '%';

            const netProfit = metrics.net_profit || 0;
            const profitEl = document.getElementById('statNetProfit');
            profitEl.textContent = netProfit >= 0 ? `+${netProfit.toFixed(2)}` : netProfit.toFixed(2);
            profitEl.className = 'stat-card-value ' + (netProfit >= 0 ? 'positive' : 'negative');

            document.getElementById('statProfitFactor').textContent =
                `PF: ${(metrics.profit_factor || 0).toFixed(2)}`;

            document.getElementById('statSetupFollow').textContent =
                (metrics.setup_follow_rate || 0).toFixed(1) + '%';
            document.getElementById('statSetupAccuracy').textContent =
                `Genauigkeit: ${(metrics.setup_prediction_accuracy || 0).toFixed(1)}%`;
        }

        function renderTerminals(terminals) {
            const container = document.getElementById('terminalList');
            document.getElementById('terminalCount').textContent = terminals.length;

            if (terminals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì°</div>
                        <div class="empty-state-text">
                            Keine Terminals registriert.<br>
                            Starten Sie den MT5 Agent.
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = terminals.map(t => `
                <div class="terminal-item ${t.terminal_id === currentTerminalId ? 'selected' : ''}"
                     onclick="selectTerminal('${t.terminal_id}')">
                    <div class="terminal-header">
                        <span class="terminal-name">${t.name}</span>
                        <span class="terminal-status ${t.status}">
                            <span class="status-dot"></span>
                            ${t.status === 'online' ? 'Online' : 'Offline'}
                        </span>
                    </div>
                    <div class="terminal-info">
                        <div class="terminal-account">
                            <span>${t.broker_name || 'Unbekannt'}</span>
                            <span>#${t.account_number}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectTerminal(terminalId) {
            currentTerminalId = currentTerminalId === terminalId ? null : terminalId;
            loadOverview();
        }

        async function loadTrades() {
            const activeContainer = document.getElementById('activeTradesContainer');
            const closedContainer = document.getElementById('closedTradesContainer');
            activeContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            closedContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const symbol = document.getElementById('filterSymbol').value;

                let url = `${WORKPLACE_API}/trades?limit=100`;
                if (symbol) url += `&symbol=${symbol}`;
                if (currentTerminalId) url += `&terminal_id=${currentTerminalId}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('API error');

                const data = await response.json();

                // Split trades by status
                const activeTrades = data.trades.filter(t => t.status === 'open');
                const closedTrades = data.trades.filter(t => t.status === 'closed');

                // Cache all trades f√ºr Modal-Zugriff
                tradesCache = {};
                data.trades.forEach(t => tradesCache[t.trade_id] = t);

                // Render both sections
                renderActiveTrades(activeTrades);
                renderClosedTrades(closedTrades);

                // Update symbol filter
                updateSymbolFilter(data.trades);

            } catch (error) {
                console.error('Error loading trades:', error);
                activeContainer.innerHTML = `<div class="empty-state"><div class="empty-state-text">Fehler beim Laden</div></div>`;
                closedContainer.innerHTML = `<div class="empty-state"><div class="empty-state-text">Fehler beim Laden</div></div>`;
            }
        }

        function renderActiveTrades(trades) {
            const container = document.getElementById('activeTradesContainer');
            document.getElementById('activeTradeCount').textContent = trades.length;

            if (trades.length === 0) {
                container.innerHTML = `<div class="no-active-trades">Keine aktiven Trades</div>`;
                return;
            }

            container.innerHTML = `
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Typ</th>
                            <th>Volume</th>
                            <th>Entry</th>
                            <th>Laufzeit</th>
                            <th>P/L</th>
                            <th>Setup-Link</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(t => renderActiveTradeRow(t)).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderActiveTradeRow(trade) {
            const profit = trade.profit || 0;
            const profitClass = profit >= 0 ? 'positive' : 'negative';
            const profitSign = profit >= 0 ? '+' : '';

            const entryTime = new Date(trade.entry_time);
            const entryTimeStr = entryTime.toLocaleString('de-CH', {
                day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            // Calculate duration
            const now = new Date();
            const durationMs = now - entryTime;
            const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
            const durationMins = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            const durationStr = durationHours > 0 ? `${durationHours}h ${durationMins}m` : `${durationMins}m`;

            const setupIdShort = trade.setup?.setup_id ? trade.setup.setup_id.split('-').slice(-2).join('-') : '';
            const linkHtml = trade.setup
                ? `<span class="trade-link" onclick="viewSetupLink('${trade.trade_id}')" title="Setup-ID: ${trade.setup.setup_id || ''}">${setupIdShort ? setupIdShort + ' ' : ''}(${trade.setup.setup_score.toFixed(0)}%)</span>`
                : `<span class="trade-link no-link" onclick="linkTrade('${trade.trade_id}')">+ Verkn√ºpfen</span>`;

            const formatPrice = (price) => {
                if (!price) return '-';
                if (trade.symbol.includes('JPY')) return price.toFixed(3);
                if (trade.symbol.includes('BTC') || trade.symbol.includes('ETH')) return price.toFixed(2);
                return price.toFixed(5);
            };

            return `
                <tr>
                    <td class="trade-symbol">${trade.symbol}</td>
                    <td><span class="trade-type ${trade.trade_type}">${trade.trade_type.toUpperCase()}</span></td>
                    <td>${trade.volume}</td>
                    <td>${entryTimeStr}<br><small>${formatPrice(trade.entry_price)}</small></td>
                    <td>${durationStr}</td>
                    <td class="trade-profit ${profitClass}">${profitSign}${profit.toFixed(2)}</td>
                    <td>${linkHtml}</td>
                    <td><button class="trade-action-btn" onclick="closeTrade('${trade.trade_id}')">‚úó Schliessen</button></td>
                </tr>
            `;
        }

        function renderClosedTrades(trades) {
            const container = document.getElementById('closedTradesContainer');

            if (trades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">Keine abgeschlossenen Trades</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Typ</th>
                            <th>Volume</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>P/L</th>
                            <th>Setup-Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(t => renderClosedTradeRow(t)).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderClosedTradeRow(trade) {
            const profit = trade.profit || 0;
            const profitClass = profit >= 0 ? 'positive' : 'negative';
            const profitSign = profit >= 0 ? '+' : '';

            const entryTime = new Date(trade.entry_time).toLocaleString('de-CH', {
                day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            const exitTime = trade.exit_time
                ? new Date(trade.exit_time).toLocaleString('de-CH', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                })
                : '-';

            const setupIdShort = trade.setup?.setup_id ? trade.setup.setup_id.split('-').slice(-2).join('-') : '';
            const linkHtml = trade.setup
                ? `<span class="trade-link" onclick="viewSetupLink('${trade.trade_id}')" title="Setup-ID: ${trade.setup.setup_id || ''}">${setupIdShort ? setupIdShort + ' ' : ''}(${trade.setup.setup_score.toFixed(0)}%)</span>`
                : `<span class="trade-link no-link" onclick="linkTrade('${trade.trade_id}')">+ Verkn√ºpfen</span>`;

            const formatPrice = (price) => {
                if (!price) return '-';
                if (trade.symbol.includes('JPY')) return price.toFixed(3);
                if (trade.symbol.includes('BTC') || trade.symbol.includes('ETH')) return price.toFixed(2);
                return price.toFixed(5);
            };

            return `
                <tr>
                    <td class="trade-symbol">${trade.symbol}</td>
                    <td><span class="trade-type ${trade.trade_type}">${trade.trade_type.toUpperCase()}</span></td>
                    <td>${trade.volume}</td>
                    <td>${entryTime}<br><small>${formatPrice(trade.entry_price)}</small></td>
                    <td>${exitTime}<br><small>${formatPrice(trade.exit_price)}</small></td>
                    <td class="trade-profit ${profitClass}">${profitSign}${profit.toFixed(2)}</td>
                    <td>${linkHtml}</td>
                </tr>
            `;
        }

        function updateSymbolFilter(trades) {
            const symbols = [...new Set(trades.map(t => t.symbol))].sort();
            const select = document.getElementById('filterSymbol');
            const currentValue = select.value;

            select.innerHTML = '<option value="">Alle Symbole</option>' +
                symbols.map(s => `<option value="${s}" ${s === currentValue ? 'selected' : ''}>${s}</option>`).join('');
        }

        async function loadPerformance() {
            try {
                const response = await fetch(`${WORKPLACE_API}/performance/by-setup?days=30`);
                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();

                document.getElementById('perfFollowed').textContent =
                    (data.followed_setup?.win_rate || 0).toFixed(1) + '%';
                document.getElementById('perfAgainst').textContent =
                    (data.against_setup?.win_rate || 0).toFixed(1) + '%';
                document.getElementById('perfNoLink').textContent =
                    (data.no_setup_link?.win_rate || 0).toFixed(1) + '%';

                const rec = data.recommendation || 'Nicht gen√ºgend Daten';
                document.getElementById('perfRecommendation').textContent =
                    rec.length > 50 ? rec.substring(0, 47) + '...' : rec;

                console.log('Performance loaded successfully');

            } catch (error) {
                console.error('Error loading performance:', error);
                throw error; // Re-throw f√ºr refreshData()
            }
        }

        async function triggerAutoLink() {
            try {
                const response = await fetch(`${WORKPLACE_API}/trades/auto-link`, { method: 'POST' });
                if (!response.ok) throw new Error('API error');

                const data = await response.json();
                alert(`${data.linked_count} Trades wurden mit Setups verkn√ºpft.`);

                loadTrades();
                loadOverview();

            } catch (error) {
                console.error('Error auto-linking:', error);
                alert('Fehler beim Auto-Linking');
            }
        }

        async function viewSetupLink(tradeId) {
            const trade = tradesCache[tradeId];
            if (!trade || !trade.setup) {
                alert('Setup nicht gefunden');
                return;
            }

            const setup = trade.setup;

            // Modal √∂ffnen und Lade-Anzeige zeigen
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalSymbol').textContent = setup.setup_symbol;
            document.getElementById('modalTimeframe').textContent = setup.setup_timeframe;
            // Setup-ID im Header anzeigen
            const setupIdEl = document.getElementById('modalSetupId');
            if (setupIdEl) {
                setupIdEl.textContent = setup.setup_id || '';
                setupIdEl.style.display = setup.setup_id ? 'inline' : 'none';
            }
            modal.classList.add('active');
            modalBody.innerHTML = `<div class="loading"><div class="loading-spinner"></div><p>Lade Details...</p></div>`;

            // Suche passende Prediction via API (mit trailing slash!)
            try {
                const params = new URLSearchParams({
                    service: 'workplace',
                    symbol: setup.setup_symbol,
                    timeframe: setup.setup_timeframe,
                    limit: 100
                });

                const response = await fetch(`${DATA_SERVICE_URL}/api/v1/predictions/?${params.toString()}`);
                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const predictions = await response.json();

                // Finde Prediction mit passendem Timestamp (¬±5 Minuten)
                const targetTime = new Date(setup.setup_timestamp).getTime();
                const tolerance = 5 * 60 * 1000;

                const matching = predictions.find(p => {
                    const predTime = new Date(p.created_at).getTime();
                    return Math.abs(predTime - targetTime) <= tolerance;
                });

                if (matching) {
                    // Lade vollst√§ndige Prediction-Details
                    const detailResponse = await fetch(`${DATA_SERVICE_URL}/api/v1/predictions/${matching.prediction_id}`);
                    if (!detailResponse.ok) throw new Error('Details nicht verf√ºgbar');
                    const data = await detailResponse.json();
                    renderDetailContent(data, setup.setup_id);
                } else {
                    // Keine passende Prediction gefunden - zeige Setup-Info aus Trade
                    renderBasicSetupInfo(setup, trade);
                }
            } catch (error) {
                console.error('Error loading setup details:', error);
                // Bei Fehler: zeige zumindest die verf√ºgbaren Setup-Info
                renderBasicSetupInfo(setup, trade, error.message);
            }
        }

        function renderBasicSetupInfo(setup, trade, errorMsg = null) {
            const modalBody = document.getElementById('modalBody');
            const direction = setup.setup_direction || 'neutral';
            const score = setup.setup_score || 0;
            const scoreClass = score >= 75 ? 'score-high' : score >= 50 ? 'score-med' : 'score-low';

            let html = '';

            if (errorMsg) {
                html += `<div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; color: #f87171;">
                    <strong>Hinweis:</strong> Prediction-Details konnten nicht geladen werden. (${errorMsg})
                </div>`;
            } else {
                html += `<div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; color: #fbbf24;">
                    <strong>Hinweis:</strong> Keine detaillierte Prediction f√ºr diesen Zeitpunkt verf√ºgbar. Zeige gespeicherte Setup-Daten.
                </div>`;
            }

            html += `
            <div class="detail-section">
                <div class="detail-section-header">Setup-√úbersicht</div>
                ${setup.setup_id ? `
                <div style="margin-bottom: 0.75rem;">
                    <span style="font-size: 0.75rem; color: #64748b;">Setup-ID:</span>
                    <span style="font-size: 0.9rem; font-weight: 600; color: #64c8ff; margin-left: 0.5rem;">${setup.setup_id}</span>
                </div>
                ` : ''}
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="label">Score</div>
                        <div class="value ${scoreClass}">${score.toFixed(1)}</div>
                    </div>
                    <div class="overview-item">
                        <div class="label">Richtung</div>
                        <div class="value ${direction}">${direction.toUpperCase()}</div>
                    </div>
                    <div class="overview-item">
                        <div class="label">Symbol</div>
                        <div class="value">${setup.setup_symbol}</div>
                    </div>
                    <div class="overview-item">
                        <div class="label">Timeframe</div>
                        <div class="value">${setup.setup_timeframe}</div>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-header">Trade-Info</div>
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="label">Typ</div>
                        <div class="value ${trade.trade_type}">${trade.trade_type.toUpperCase()}</div>
                    </div>
                    <div class="overview-item">
                        <div class="label">Volume</div>
                        <div class="value">${trade.volume}</div>
                    </div>
                    <div class="overview-item">
                        <div class="label">Entry</div>
                        <div class="value">${trade.entry_price ? trade.entry_price.toFixed(5) : '-'}</div>
                    </div>
                    <div class="overview-item">
                        <div class="label">P/L</div>
                        <div class="value ${trade.profit >= 0 ? 'positive' : 'negative'}">${trade.profit >= 0 ? '+' : ''}${(trade.profit || 0).toFixed(2)}</div>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-header">Zeitstempel</div>
                <div class="meta-info">
                    <div class="meta-item">
                        <span class="label">Setup-Zeit:</span>
                        <span>${setup.setup_timestamp ? formatDateTime(setup.setup_timestamp) : '-'}</span>
                    </div>
                    <div class="meta-item">
                        <span class="label">Trade-Entry:</span>
                        <span>${trade.entry_time ? formatDateTime(trade.entry_time) : '-'}</span>
                    </div>
                    ${trade.exit_time ? `<div class="meta-item"><span class="label">Trade-Exit:</span><span>${formatDateTime(trade.exit_time)}</span></div>` : ''}
                </div>
            </div>`;

            modalBody.innerHTML = html;
        }

        // ==================== Detail Modal Functions ====================

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function closeModal(event) {
            if (event.target === event.currentTarget) {
                closeDetailModal();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDetailModal();
        });

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('de-CH', {
                day: '2-digit', month: '2-digit', year: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatPriceModal(price, symbol) {
            let decimals = 2;
            if (symbol && (symbol.includes('JPY') || symbol.includes('XAU'))) decimals = 3;
            else if (symbol && symbol.includes('BTC')) decimals = 1;
            else if (symbol && symbol.includes('USD') && !symbol.includes('BTC') && !symbol.includes('ETH')) decimals = 5;
            return price.toLocaleString('de-CH', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        function analyzeSignals(signals, setupDirection) {
            const serviceNames = ['nhits', 'hmm', 'tcn', 'candlestick', 'technical', 'cnn_lstm'];
            let availableCount = 0, sameDirection = 0, oppositeDirection = 0;

            serviceNames.forEach(name => {
                const sig = signals[name];
                if (sig && sig.available) {
                    availableCount++;
                    let sigDir = 'neutral';
                    if (sig.direction) sigDir = sig.direction;
                    else if (sig.price_direction) sigDir = sig.price_direction;
                    else if (sig.alignment === 'aligned') sigDir = setupDirection;
                    else if (sig.alignment === 'contrary') sigDir = setupDirection === 'long' ? 'short' : 'long';

                    if (sigDir === setupDirection) sameDirection++;
                    else if (sigDir !== 'neutral' && sigDir !== setupDirection) oppositeDirection++;
                }
            });

            let alignment = 'mixed';
            if (availableCount === 0) alignment = '-';
            else if (oppositeDirection === 0 && sameDirection >= 2) alignment = 'strong';
            else if (sameDirection > oppositeDirection) alignment = 'moderate';
            else if (oppositeDirection > sameDirection) alignment = 'contrary';

            return { signalsCount: availableCount, alignment };
        }

        function renderSignalCard(name, signal, detailsFn, unavailableMsg = 'Signal nicht verf√ºgbar') {
            const isAvailable = signal && signal.available;
            const direction = signal?.direction || signal?.price_direction || 'neutral';
            const dirClass = isAvailable ? direction : 'unavailable';
            const dirLabel = isAvailable ? direction.toUpperCase() : 'N/A';

            let html = `
            <div class="signal-card ${!isAvailable ? 'unavailable' : ''}">
                <div class="signal-card-header">
                    <span class="signal-card-title">${name}</span>
                    <span class="signal-card-badge ${dirClass}">${dirLabel}</span>
                </div>`;

            if (isAvailable) {
                html += `<div class="signal-details">${detailsFn(signal)}</div>`;
            } else {
                html += `<div class="signal-details"><span style="color: #64748b;">${unavailableMsg}</span></div>`;
            }

            html += `</div>`;
            return html;
        }

        function renderDetailContent(data, setupId = null) {
            const pred = data.prediction || {};
            const signals = pred.signals || {};

            document.getElementById('modalSymbol').textContent = data.symbol;
            document.getElementById('modalTimeframe').textContent = data.timeframe;

            const direction = pred.direction || 'neutral';
            const score = Number(pred.composite_score) || 0;
            const confidence = pred.confidence_level || 'low';
            const keyDrivers = pred.key_drivers || [];

            const { signalsCount, alignment } = analyzeSignals(signals, direction);
            const signalsAvailable = pred.signals_available || signalsCount;
            const signalAlignment = pred.signal_alignment || alignment;

            const scoreClass = score >= 75 ? 'score-high' : score >= 50 ? 'score-med' : 'score-low';
            const alignmentClass = signalAlignment === 'strong' ? 'score-high' : signalAlignment === 'moderate' ? 'score-med' : '';

            let html = `
            <div class="detail-section">
                <div class="detail-section-header">√úbersicht</div>
                ${setupId ? `
                <div style="margin-bottom: 0.75rem;">
                    <span style="font-size: 0.75rem; color: #64748b;">Setup-ID:</span>
                    <span style="font-size: 0.9rem; font-weight: 600; color: #64c8ff; margin-left: 0.5rem;">${setupId}</span>
                </div>
                ` : ''}
                <div class="overview-grid">
                    <div class="overview-item"><div class="label">Score</div><div class="value ${scoreClass}">${score.toFixed(1)}</div></div>
                    <div class="overview-item"><div class="label">Richtung</div><div class="value ${direction}">${direction.toUpperCase()}</div></div>
                    <div class="overview-item"><div class="label">Konfidenz</div><div class="value">${confidence.toUpperCase()}</div></div>
                    <div class="overview-item"><div class="label">Alignment</div><div class="value ${alignmentClass}">${signalAlignment.toUpperCase()}</div></div>
                </div>
                <div class="overview-grid" style="margin-top: 0.75rem;">
                    <div class="overview-item"><div class="label">Signale</div><div class="value">${signalsAvailable}/6</div></div>
                    <div class="overview-item"><div class="label">Timeframe</div><div class="value">${data.timeframe}</div></div>
                    <div class="overview-item"><div class="label">Horizon</div><div class="value">${data.horizon || '-'}</div></div>
                    <div class="overview-item"><div class="label">Status</div><div class="value ${data.is_correct === true ? 'score-high' : data.is_correct === false ? 'score-low' : ''}">${data.evaluated_at ? (data.is_correct ? 'Korrekt' : 'Falsch') : 'Offen'}</div></div>
                </div>
            </div>`;

            if (keyDrivers.length > 0) {
                html += `<div class="detail-section"><div class="detail-section-header">Key Drivers</div>
                    <div class="key-drivers-list">${keyDrivers.map(d => `<span class="key-driver">${d}</span>`).join('')}</div></div>`;
            }

            // Signale
            html += `<div class="detail-section"><div class="detail-section-header">Signale</div><div class="signals-grid">`;

            html += renderSignalCard('NHITS', signals.nhits, (sig) => `
                <div class="signal-detail"><span class="label">Trend Prob.</span><span class="value">${((Number(sig.trend_probability) || 0) * 100).toFixed(0)}%</span></div>
                <div class="signal-detail"><span class="label">Modell-Konf.</span><span class="value">${sig.model_confidence != null ? (Number(sig.model_confidence) * 100).toFixed(0) + '%' : '-'}</span></div>
                <div class="signal-detail"><span class="label">Prognose 1h</span><span class="value">${sig.forecast_change_1h != null ? Number(sig.forecast_change_1h).toFixed(2) + '%' : '-'}</span></div>
                <div class="signal-detail"><span class="label">Prognose 24h</span><span class="value">${sig.forecast_change_24h != null ? Number(sig.forecast_change_24h).toFixed(2) + '%' : '-'}</span></div>
            `);

            html += renderSignalCard('HMM', signals.hmm, (sig) => `
                <div class="signal-detail"><span class="label">Regime</span><span class="value">${sig.regime || '-'}</span></div>
                <div class="signal-detail"><span class="label">Wahrsch.</span><span class="value">${((Number(sig.regime_probability) || 0) * 100).toFixed(0)}%</span></div>
                <div class="signal-detail"><span class="label">Score</span><span class="value">${(Number(sig.signal_score) || 0).toFixed(1)}</span></div>
                <div class="signal-detail"><span class="label">Dauer</span><span class="value">${sig.regime_duration ? sig.regime_duration + ' Bars' : '-'}</span></div>
                <div class="signal-detail full-width"><span class="label">Alignment</span><span class="value">${sig.alignment || '-'}</span></div>
            `);

            html += renderSignalCard('Technisch', signals.technical, (sig) => `
                <div class="signal-detail"><span class="label">RSI</span><span class="value">${sig.rsi != null ? Number(sig.rsi).toFixed(1) : '-'} (${sig.rsi_signal || '-'})</span></div>
                <div class="signal-detail"><span class="label">MACD</span><span class="value">${sig.macd_signal || '-'}</span></div>
                <div class="signal-detail"><span class="label">Trend Align.</span><span class="value">${((sig.trend_alignment || 0) * 100).toFixed(0)}%</span></div>
                <div class="signal-detail"><span class="label">BB Position</span><span class="value">${sig.bb_position != null ? (Number(sig.bb_position) * 100).toFixed(0) + '%' : '-'}</span></div>
            `);

            html += renderSignalCard('CNN-LSTM', signals.cnn_lstm, (sig) => {
                let details = `
                <div class="signal-detail"><span class="label">Preis-Richt.</span><span class="value">${sig.price_direction || '-'}</span></div>
                <div class="signal-detail"><span class="label">Preis-Konf.</span><span class="value">${((Number(sig.price_confidence) || 0) * 100).toFixed(0)}%</span></div>
                <div class="signal-detail"><span class="label">Regime</span><span class="value">${sig.regime || '-'}</span></div>
                <div class="signal-detail"><span class="label">Regime-Prob.</span><span class="value">${((Number(sig.regime_probability) || 0) * 100).toFixed(0)}%</span></div>`;
                if (sig.patterns && sig.patterns.length > 0) {
                    details += `<div class="signal-patterns"><div class="label">Patterns</div><div class="patterns-list">${sig.patterns.map(p => `<span class="pattern-tag">${p}</span>`).join('')}</div></div>`;
                }
                return details;
            });

            html += renderSignalCard('TCN', signals.tcn, (sig) => {
                let details = `
                <div class="signal-detail"><span class="label">Konfidenz</span><span class="value">${((Number(sig.pattern_confidence) || 0) * 100).toFixed(0)}%</span></div>
                <div class="signal-detail"><span class="label">Kursziel</span><span class="value">${sig.price_target != null ? Number(sig.price_target).toFixed(2) : '-'}</span></div>`;
                if (sig.patterns && sig.patterns.length > 0) {
                    details += `<div class="signal-patterns"><div class="label">Patterns</div><div class="patterns-list">${sig.patterns.map(p => `<span class="pattern-tag">${p}</span>`).join('')}</div></div>`;
                }
                return details;
            }, 'kein Pattern erkannt');

            html += renderSignalCard('Candlestick', signals.candlestick, (sig) => {
                let details = `<div class="signal-detail full-width"><span class="label">St√§rke</span><span class="value">${((Number(sig.pattern_strength) || 0) * 100).toFixed(0)}%</span></div>`;
                if (sig.patterns && sig.patterns.length > 0) {
                    details += `<div class="signal-patterns"><div class="label">Patterns</div><div class="patterns-list">${sig.patterns.map(p => `<span class="pattern-tag">${p}</span>`).join('')}</div></div>`;
                }
                return details;
            }, 'kein Pattern erkannt');

            html += `</div></div>`;

            // Preis-Info
            const entryPrice = pred.entry_price;
            const stopLoss = pred.stop_loss;
            const takeProfit1 = pred.take_profit_1;

            if (entryPrice) {
                html += `<div class="detail-section"><div class="detail-section-header">Preis-Info</div><div class="price-info-grid">
                    <div class="price-item"><div class="label">Entry-Preis</div><div class="value">${formatPriceModal(entryPrice, data.symbol)}</div></div>
                    ${stopLoss ? `<div class="price-item"><div class="label">Stop-Loss</div><div class="value">${formatPriceModal(stopLoss, data.symbol)}</div></div>` : ''}
                    ${takeProfit1 ? `<div class="price-item"><div class="label">Take-Profit 1</div><div class="value">${formatPriceModal(takeProfit1, data.symbol)}</div></div>` : ''}
                </div></div>`;
            }

            // Zeitstempel
            html += `<div class="detail-section"><div class="detail-section-header">Zeitstempel</div>
                <div class="meta-info">
                    <div class="meta-item"><span class="label">Erstellt:</span><span>${data.predicted_at ? formatDateTime(data.predicted_at) : '-'}</span></div>
                    <div class="meta-item"><span class="label">Ziel-Zeit:</span><span>${data.target_time ? formatDateTime(data.target_time) : '-'}</span></div>
                    ${data.evaluated_at ? `<div class="meta-item"><span class="label">Ausgewertet:</span><span>${formatDateTime(data.evaluated_at)}</span></div>` : ''}
                </div>
            </div>`;

            document.getElementById('modalBody').innerHTML = html;
        }

        async function closeTrade(tradeId) {
            if (!confirm('Trade wirklich als geschlossen markieren?')) return;

            try {
                // Aktuellen Preis holen
                const trade = tradesCache[tradeId];
                if (!trade) {
                    alert('Trade nicht gefunden');
                    return;
                }

                // Trade √ºber Data Service schliessen
                const response = await fetch(`${DATA_API}/trades/${tradeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'closed',
                        exit_time: new Date().toISOString(),
                        close_reason: 'manual_close'
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                alert('Trade wurde geschlossen');
                await refreshData();

            } catch (error) {
                console.error('Error closing trade:', error);
                alert('Fehler beim Schliessen: ' + error.message);
            }
        }

        function linkTrade(tradeId) {
            // TODO: Modal zum manuellen Verkn√ºpfen √∂ffnen
            alert('Manuelles Verkn√ºpfen f√ºr Trade: ' + tradeId);
        }

        async function refreshData() {
            const btn = document.querySelector('.btn-secondary');
            const originalText = btn.textContent;
            btn.textContent = '‚Üª Lade...';
            btn.disabled = true;

            try {
                await Promise.all([loadOverview(), loadPerformance()]);
                btn.textContent = '‚úì Aktualisiert';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1500);
            } catch (error) {
                console.error('Refresh error:', error);
                btn.textContent = '‚úó Fehler';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
