<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Workplace - Setups & Analyse</title>
    <!-- TradingView Widget Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- Lightweight Charts for custom indicators -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0.75rem 1rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.85rem;
        }

        h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Market Hours Section */
        .market-hours {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .market-hours-title {
            color: #94a3b8;
            margin-right: 0.25rem;
        }

        .market {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }

        .market.open {
            background: rgba(16, 185, 129, 0.15);
        }

        .market.closed {
            background: rgba(239, 68, 68, 0.1);
            opacity: 0.6;
        }

        .market-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ef4444;
        }

        .market.open .market-dot {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .market-name {
            font-weight: 500;
        }

        .market-time {
            color: #94a3b8;
            font-size: 0.7rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scanner-badge {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: rgba(16, 185, 129, 0.15);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .scanner-badge.stopped {
            background: rgba(239, 68, 68, 0.15);
        }

        .scanner-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
        }

        .scanner-badge.stopped .scanner-dot {
            background: #ef4444;
        }

        .btn {
            padding: 0.35rem 0.7rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .btn-sm {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .btn-sm:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-secondary {
            background: rgba(100, 200, 255, 0.15);
            border-color: rgba(100, 200, 255, 0.3);
            color: #64c8ff;
        }

        .btn-secondary:hover {
            background: rgba(100, 200, 255, 0.25);
        }

        /* Stats Row - Compact */
        .stats-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34d399;
        }

        .stat-value.warning {
            color: #fbbf24;
        }

        .stat-label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 0.75rem;
        }

        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .section-header select {
            padding: 0.25rem 0.5rem;
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            color: #e8e8e8;
            font-size: 0.75rem;
        }

        .section-header select option {
            background: #1a1a2e;
            color: #e8e8e8;
        }

        /* Setups Grid - Ultra Compact */
        .setups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.4rem;
        }

        .setup-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 0.5rem 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s;
        }

        .setup-card:hover {
            transform: translateY(-1px);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .setup-card.long {
            border-left: 2px solid #10b981;
        }

        .setup-card.short {
            border-left: 2px solid #ef4444;
        }

        .setup-card.neutral {
            border-left: 2px solid #fbbf24;
        }

        .setup-card.market-closed {
            opacity: 0.5;
        }

        .setup-card.selected {
            border: 1px solid #64c8ff;
            background: rgba(100, 200, 255, 0.1);
        }

        /* TradingView Chart Section */
        .chart-section {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .chart-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-symbol {
            color: #64c8ff;
            font-size: 1rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-controls select {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e8e8e8;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .chart-controls select option {
            background: #1a1a2e;
            color: #e8e8e8;
            padding: 0.5rem;
        }

        .chart-container {
            height: 400px;
            background: #131722;
        }

        /* Chart Fullscreen Mode */
        .chart-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            margin: 0;
            border-radius: 0;
            border: none;
        }

        .chart-section.fullscreen .chart-container {
            height: calc(100vh - 50px);
        }

        .chart-section.fullscreen .chart-header {
            padding: 0.8rem 1.5rem;
        }

        .chart-expand-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e8e8e8;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }

        .chart-expand-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .chart-expand-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Multi-Timeframe Strength Chart */
        .strength-chart-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .strength-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .strength-header h4 {
            font-size: 0.85rem;
            color: #64c8ff;
            margin: 0;
        }

        .strength-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .legend-item.h4 { color: #f59e0b; }
        .legend-item.d1 { color: #10b981; }
        .legend-item.w1 { color: #8b5cf6; }

        .strength-chart-container {
            height: 120px;
            background: #131722;
        }

        .strength-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .chart-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .chart-placeholder .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.3;
        }

        .setup-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }

        .setup-symbol {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .setup-symbol .market-indicator {
            font-size: 0.55rem;
            padding: 0.05rem 0.2rem;
            border-radius: 2px;
            margin-left: 0.2rem;
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .setup-symbol .market-indicator.open {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .setup-score {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .score-value {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .score-value.high { color: #10b981; }
        .score-value.moderate { color: #fbbf24; }
        .score-value.low { color: #94a3b8; }

        .setup-direction {
            padding: 0.1rem 0.3rem;
            border-radius: 2px;
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .setup-direction.long {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .setup-direction.short {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .setup-direction.neutral {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .setup-signals {
            display: flex;
            gap: 0.15rem;
            margin-bottom: 0.25rem;
            flex-wrap: wrap;
        }

        .signal-tag {
            padding: 0.05rem 0.25rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            font-size: 0.6rem;
            opacity: 0.5;
        }

        .signal-tag.available {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
            opacity: 1;
        }

        .setup-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.65rem;
            opacity: 0.6;
            gap: 0.5rem;
        }

        .setup-age {
            font-family: 'Courier New', monospace;
            font-size: 0.6rem;
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            opacity: 1;
            font-weight: 600;
        }

        .setup-id {
            font-family: 'Courier New', monospace;
            font-size: 0.55rem;
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            opacity: 1;
        }

        /* Entry/Exit Levels - Compact */
        .setup-levels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.2rem;
            margin-top: 0.3rem;
            font-size: 0.6rem;
        }

        .setup-levels .level {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.15rem 0.2rem;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.04);
        }

        .setup-levels .level-label {
            font-size: 0.5rem;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .setup-levels .level-value {
            font-weight: 600;
            font-size: 0.6rem;
        }

        .setup-levels .level.entry .level-value {
            color: #64c8ff;
        }

        .setup-levels .level.sl .level-value {
            color: #f87171;
        }

        .setup-levels .level.tp .level-value {
            color: #34d399;
        }

        .setup-levels .level.rr .level-value {
            color: #a78bfa;
        }

        /* Sidebar - Compact */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-card h3 {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            color: #94a3b8;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .sidebar-header h3 {
            margin-bottom: 0;
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            color: #64c8ff;
            background: rgba(255, 255, 255, 0.1);
        }

        .refresh-btn svg {
            width: 14px;
            height: 14px;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }

        .watchlist-item:last-child {
            border-bottom: none;
        }

        .watchlist-symbol {
            font-weight: 500;
        }

        .watchlist-symbol.favorite::before {
            content: '‚òÖ ';
            color: #fbbf24;
        }

        .watchlist-score {
            font-weight: 600;
        }

        .watchlist-score.high { color: #10b981; }
        .watchlist-score.moderate { color: #fbbf24; }
        .watchlist-score.low { color: #94a3b8; }

        .direction-arrow {
            font-size: 0.7rem;
            margin-right: 0.15rem;
        }

        .direction-arrow.long { color: #10b981; }
        .direction-arrow.short { color: #ef4444; }
        .direction-arrow.neutral { color: #fbbf24; }

        .scanner-info p {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
            font-size: 0.75rem;
        }

        .scanner-info .label {
            opacity: 0.6;
        }

        /* Scan Progress Bar */
        .scan-progress {
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .scan-progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.3rem;
        }

        .scan-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .scan-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #94a3b8;
        }

        .scan-progress-text span:first-child {
            color: #64c8ff;
            font-weight: 500;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 2rem;
            opacity: 0.6;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            opacity: 0.6;
            font-size: 0.85rem;
        }

        /* Modal - Compact */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 95vh;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            font-size: 0.95rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #e8e8e8;
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .modal-body {
            padding: 1rem;
        }

        .analysis-section {
            margin-bottom: 1rem;
        }

        .analysis-section h4 {
            color: #34d399;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .analysis-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            line-height: 1.5;
            font-size: 0.85rem;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .level-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .level-item .value {
            font-size: 1rem;
            font-weight: 600;
            color: #ffd54f;
        }

        .level-item .label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Detail Button in Setup Card */
        .setup-detail-btn {
            background: rgba(100, 200, 255, 0.15);
            border: 1px solid rgba(100, 200, 255, 0.3);
            color: #64c8ff;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.15rem;
        }

        .setup-detail-btn:hover {
            background: rgba(100, 200, 255, 0.25);
            border-color: rgba(100, 200, 255, 0.5);
        }

        .setup-detail-btn svg {
            width: 10px;
            height: 10px;
        }

        /* Detail Modal - Kompaktes, breites Modal f√ºr alle Details */
        .detail-modal {
            max-width: 1200px;
            width: 98%;
            max-height: 95vh;
            height: 90vh;
            overflow-x: hidden;
        }

        .detail-modal .modal-body {
            padding: 0;
        }

        .detail-content {
            padding: 0.6rem 0.8rem;
            height: calc(90vh - 2.5rem);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Single-Column Layout: Alles untereinander, volle Breite */
        .detail-columns {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        /* Hauptinhalt: Volle Breite */
        .detail-column {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            width: 100%;
        }

        /* LLM Column: Am Ende, mit mehr Platz */
        .detail-column.llm-column {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-column.llm-column .consolidated-section {
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .detail-column.llm-column #llmContent {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .detail-column.llm-column .llm-analysis-box {
            max-height: 350px;
        }

        /* Consolidated Section Styles - Volle Breite */
        .consolidated-section {
            margin-bottom: 0;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            padding: 0.5rem 0.6rem;
        }

        .section-title {
            font-size: 0.8rem;
            color: #10b981;
            margin-bottom: 0.35rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .section-title .icon {
            font-size: 0.85rem;
        }

        /* Setup-ID Display im Detail Modal */
        .setup-id-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.35rem 0.5rem;
            background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 5px;
        }

        .setup-id-label {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .setup-id-value {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #64c8ff;
            font-weight: 600;
        }

        .section-divider {
            display: none;
        }

        .llm-prompt-box {
            background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 4px;
            padding: 0.4rem;
            text-align: center;
        }

        .llm-prompt-box p {
            margin-bottom: 0.25rem;
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .llm-prompt-box .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        /* Detail Sections - Volle Breite */
        .detail-section {
            margin-bottom: 0.3rem;
        }

        .detail-section h4 {
            font-size: 0.75rem;
            color: #64c8ff;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .detail-section h4 .icon {
            font-size: 0.8rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.4rem;
        }

        .detail-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 4px;
            padding: 0.4rem 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.1rem;
        }

        .detail-card-title {
            font-size: 0.65rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-card-badge {
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .detail-card-badge.available {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .detail-card-badge.unavailable {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .detail-card-value {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.1rem;
            line-height: 1.2;
        }

        .detail-card-sub {
            font-size: 0.65rem;
            color: #94a3b8;
            line-height: 1.3;
        }

        /* Pattern List */
        .pattern-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.2rem;
        }

        .pattern-tag {
            padding: 0.2rem 0.4rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .pattern-tag.bullish {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .pattern-tag.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* Copyable Price - Click to copy */
        .copyable-price {
            transition: all 0.15s ease;
            border-radius: 3px;
            padding: 0.1rem 0.2rem;
            margin: -0.1rem -0.2rem;
        }

        .copyable-price:hover {
            background: rgba(100, 200, 255, 0.15);
            transform: scale(1.02);
        }

        .copyable-price:active {
            transform: scale(0.98);
        }

        /* Copy Toast Notification */
        .copy-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 39, 64, 0.95);
            border: 1px solid rgba(52, 211, 153, 0.3);
            color: #e8e8e8;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-size: 0.85rem;
            z-index: 10000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .copy-toast.fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
        }

        /* LLM Analysis Box */
        .llm-analysis-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 0.4rem;
            border-left: 2px solid #64c8ff;
        }

        .llm-analysis-box p {
            line-height: 1.4;
            font-size: 0.7rem;
        }

        .llm-loading {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .llm-loading .spinner {
            width: 14px;
            height: 14px;
        }

        /* Score Meter */
        .score-meter {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .score-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .score-bar-fill.high {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .score-bar-fill.moderate {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .score-bar-fill.low {
            background: linear-gradient(90deg, #6b7280, #9ca3af);
        }

        .score-value-large {
            font-size: 0.9rem;
            font-weight: 700;
            min-width: 30px;
            text-align: right;
        }

        /* Forecast Table - Kompakter */
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
        }

        .forecast-table th,
        .forecast-table td {
            padding: 0.25rem 0.35rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.7rem;
        }

        .forecast-table th {
            font-size: 0.6rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 500;
        }

        .forecast-table td {
            font-size: 0.85rem;
        }

        .forecast-positive {
            color: #34d399;
        }

        .forecast-negative {
            color: #f87171;
        }

        /* Symbol Picker */
        .symbol-picker {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .symbol-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .symbol-search {
            width: 100%;
            padding: 0.4rem 0.6rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #e8e8e8;
            font-size: 0.75rem;
            margin-bottom: 0.4rem;
        }

        .symbol-search:focus {
            outline: none;
            border-color: #64c8ff;
        }

        .symbol-search::placeholder {
            color: #64748b;
        }

        .symbol-categories {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-bottom: 0.4rem;
        }

        .category-btn {
            padding: 0.2rem 0.4rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            color: #94a3b8;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
        }

        .category-btn.active {
            background: rgba(100, 200, 255, 0.2);
            border-color: #64c8ff;
            color: #64c8ff;
        }

        .symbol-list {
            max-height: 180px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .symbol-list::-webkit-scrollbar {
            width: 4px;
        }

        .symbol-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        .symbol-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .symbol-btn {
            padding: 0.25rem 0.4rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            color: #e8e8e8;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .symbol-btn:hover {
            background: rgba(100, 200, 255, 0.15);
            border-color: rgba(100, 200, 255, 0.3);
        }

        .symbol-btn.in-watchlist {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .symbol-btn.in-watchlist::before {
            content: '‚òÖ ';
            color: #fbbf24;
            font-size: 0.6rem;
        }

        /* Timeframe Selector in Symbol Picker Modal */
        .timeframe-selector {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeframe-btn {
            padding: 0.3rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #94a3b8;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
        }

        .timeframe-btn.active {
            background: rgba(100, 200, 255, 0.2);
            border-color: #64c8ff;
            color: #64c8ff;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .market-hours {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .header-row {
                flex-wrap: wrap;
            }
            .setups-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-row">
                <div class="header-left">
                    <a href="index.html" class="back-link">‚Üê Dashboard</a>
                </div>

                <h1>Trading Workplace</h1>

                <!-- Market Hours -->
                <div class="market-hours" id="marketHours">
                    <span class="market-hours-title">M√§rkte:</span>
                    <div class="market" id="market-crypto">
                        <span class="market-dot"></span>
                        <span class="market-name">Crypto</span>
                    </div>
                    <div class="market" id="market-forex">
                        <span class="market-dot"></span>
                        <span class="market-name">Forex</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-us">
                        <span class="market-dot"></span>
                        <span class="market-name">US</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-eu">
                        <span class="market-dot"></span>
                        <span class="market-name">EU</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-asia">
                        <span class="market-dot"></span>
                        <span class="market-name">Asia</span>
                        <span class="market-time"></span>
                    </div>
                </div>

                <div class="header-right">
                    <div class="scanner-badge" id="scannerBadge">
                        <span class="scanner-dot"></span>
                        <span id="scannerText">Scanner</span>
                    </div>
                    <button class="btn btn-sm" onclick="triggerScan()">Scan</button>
                    <button class="btn btn-sm" onclick="toggleScanner()" id="toggleBtn">Stop</button>
                    <a href="workplace-mt5.html" class="btn btn-sm btn-secondary">MT5 Trades</a>
                    <a href="workplace-journal.html" class="btn btn-sm btn-secondary">Journal</a>
                    <a href="workplace-analytics.html" class="btn btn-sm btn-secondary">Analytics</a>
                    <a href="config-strategies.html" class="btn btn-sm btn-secondary">Strategien</a>
                    <a href="config-workplace.html" class="btn btn-sm">Config</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" id="totalScanned">-</div>
                <div class="stat-label">Gescannt</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highConfidence">-</div>
                <div class="stat-label">High Conf.</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="openMarketsCount">-</div>
                <div class="stat-label">M√§rkte offen</div>
            </div>
            <div class="stat-item">
                <div class="stat-value warning" id="alertsTriggered">-</div>
                <div class="stat-label">Alerts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastScan">-</div>
                <div class="stat-label">Letzter Scan</div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Setups Section -->
            <div class="setups-section">
                <div class="section-header">
                    <span>Top Trading-Setups</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="marketFilter" onchange="loadSetups()">
                            <option value="open" selected>Nur offene M√§rkte</option>
                            <option value="">Alle M√§rkte</option>
                            <option value="crypto">Crypto</option>
                            <option value="forex">Forex</option>
                            <option value="stocks">Aktien/Indizes</option>
                        </select>
                        <select id="directionFilter" onchange="loadSetups()">
                            <option value="longshort" selected>Long/Short</option>
                            <option value="">Alle</option>
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                        <select id="minScoreFilter" onchange="loadSetups()">
                            <option value="70">‚â•70</option>
                            <option value="60" selected>‚â•60</option>
                            <option value="50">‚â•50</option>
                            <option value="0">Alle</option>
                        </select>
                    </div>
                </div>
                <div id="setupsContainer" class="setups-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Lade Setups...</p>
                    </div>
                </div>

                <!-- TradingView Chart -->
                <div class="chart-section" id="chartSection">
                    <div class="chart-header">
                        <h3>
                            <span>Chart:</span>
                            <span class="chart-symbol" id="chartSymbol">Kein Symbol ausgew√§hlt</span>
                        </h3>
                        <div class="chart-controls">
                            <select id="chartInterval" onchange="updateChart()">
                                <option value="1">1 Min</option>
                                <option value="5">5 Min</option>
                                <option value="15">15 Min</option>
                                <option value="60" selected>1 Std</option>
                                <option value="240">4 Std</option>
                                <option value="D">1 Tag</option>
                                <option value="W">1 Woche</option>
                            </select>
                            <select id="chartStyle" onchange="updateChart()">
                                <option value="1" selected>Kerzen</option>
                                <option value="8">Heikin-Ashi</option>
                                <option value="0">Balken</option>
                                <option value="3">Linie</option>
                                <option value="9">Hollow Kerzen</option>
                            </select>
                            <button class="chart-expand-btn" id="chartExpandBtn" onclick="toggleChartFullscreen()" title="Vollbild (Esc zum Schliessen)">
                                <svg id="expandIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                                </svg>
                                <span id="expandText">Vollbild</span>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" id="chartContainer">
                        <div class="chart-placeholder">
                            <div class="icon">üìä</div>
                            <p>Klicken Sie auf ein Setup, um das Chart anzuzeigen</p>
                        </div>
                    </div>
                </div>

                <!-- Multi-Timeframe Strength Chart -->
                <div class="strength-chart-section" id="strengthChartSection">
                    <div class="strength-header">
                        <h4>üìä EasyInsight St√§rke</h4>
                        <div class="strength-legend">
                            <span class="legend-item h4">‚îÅ H4</span>
                            <span class="legend-item d1">‚îÅ D1</span>
                            <span class="legend-item w1">‚îÅ W1</span>
                        </div>
                    </div>
                    <div class="strength-chart-container" id="strengthChartContainer">
                        <div class="strength-placeholder">W√§hlen Sie ein Symbol</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3>Watchlist</h3>
                        <button class="refresh-btn" onclick="loadWatchlist()" title="Aktualisieren">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                        </button>
                    </div>
                    <div id="watchlistContainer">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3>Scanner-Status</h3>
                        <button class="btn btn-sm" onclick="scanAllSymbols()" id="scanAllBtn" title="Alle bekannten Symbole scannen">Alle scannen</button>
                    </div>
                    <!-- Fortschrittsbalken -->
                    <div class="scan-progress" id="scanProgress" style="display: none;">
                        <div class="scan-progress-bar">
                            <div class="scan-progress-fill" id="scanProgressFill"></div>
                        </div>
                        <div class="scan-progress-text">
                            <span id="scanProgressSymbol">-</span>
                            <span id="scanProgressCount">0/0</span>
                        </div>
                    </div>
                    <div class="scanner-info" id="scannerInfo">
                        <p><span class="label">Status</span><span id="scanStatus">-</span></p>
                        <p><span class="label">Intervall</span><span id="scanInterval">-</span></p>
                        <p><span class="label">Letzter Scan</span><span id="lastScanTime">-</span></p>
                        <p><span class="label">N√§chster Scan</span><span id="nextScanTime">-</span></p>
                        <p><span class="label">Fehler</span><span id="errorCount">-</span></p>
                    </div>
                </div>

                <!-- Symbol Picker -->
                <div class="sidebar-card">
                    <h3>Symbol-Auswahl <span id="symbolCount" style="font-weight: normal; font-size: 0.7rem; opacity: 0.6;"></span></h3>
                    <div class="symbol-picker">
                        <input type="text" class="symbol-search" id="symbolSearch" placeholder="Symbol suchen..." oninput="filterSymbols()">
                        <div class="symbol-categories">
                            <button class="category-btn active" data-category="all" onclick="selectCategory('all')">Alle</button>
                            <button class="category-btn" data-category="crypto" onclick="selectCategory('crypto')">Crypto</button>
                            <button class="category-btn" data-category="forex" onclick="selectCategory('forex')">Forex</button>
                            <button class="category-btn" data-category="indices" onclick="selectCategory('indices')">Indizes</button>
                            <button class="category-btn" data-category="metals" onclick="selectCategory('metals')">Metalle</button>
                        </div>
                        <div class="symbol-list" id="symbolList">
                            <!-- Wird dynamisch vom Data Service geladen -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Analyse</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analysiere...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal - Alle Signal-Informationen -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal detail-modal">
            <div class="modal-header">
                <h2 id="detailModalTitle">Setup Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="detail-content" id="detailAllContent">
                <div class="loading"><div class="spinner"></div><p>Lade Details...</p></div>
            </div>
        </div>
    </div>

    <!-- Timeframe Selection Modal -->
    <div class="modal-overlay" id="timeframeModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="timeframeModalTitle">Timeframe w√§hlen</h2>
                <button class="modal-close" onclick="closeTimeframeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 0.75rem; font-size: 0.85rem; opacity: 0.7;">
                    W√§hlen Sie einen Timeframe f√ºr die Analyse:
                </p>
                <div class="timeframe-selector" style="margin-top: 0; padding-top: 0; border-top: none;">
                    <button class="timeframe-btn" onclick="selectTimeframeAndAnalyze('M1')">M1</button>
                    <button class="timeframe-btn" onclick="selectTimeframeAndAnalyze('M5')">M5</button>
                    <button class="timeframe-btn" onclick="selectTimeframeAndAnalyze('M15')">M15</button>
                    <button class="timeframe-btn" onclick="selectTimeframeAndAnalyze('M30')">M30</button>
                    <button class="timeframe-btn active" onclick="selectTimeframeAndAnalyze('H1')">H1</button>
                    <button class="timeframe-btn" onclick="selectTimeframeAndAnalyze('H4')">H4</button>
                    <button class="timeframe-btn" onclick="selectTimeframeAndAnalyze('D1')">D1</button>
                    <button class="timeframe-btn" onclick="selectTimeframeAndAnalyze('W1')">W1</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/workplace/api/v1';
        let scannerRunning = true;
        let marketStatus = {};

        // Symbol-Kategorien f√ºr Markt-Filterung
        const SYMBOL_CATEGORIES = {
            crypto: ['BTCUSD', 'ETHUSD', 'XRPUSD', 'SOLUSD', 'ADAUSD', 'DOTUSD', 'LINKUSD', 'BNBUSD'],
            forex: ['EURUSD', 'GBPUSD', 'USDJPY', 'USDCHF', 'AUDUSD', 'USDCAD', 'NZDUSD', 'EURGBP', 'EURJPY', 'GBPJPY'],
            us_stocks: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'US500', 'US100', 'US30'],
            eu_stocks: ['DE40', 'UK100', 'FR40', 'EU50'],
            asia_stocks: ['JP225', 'HK50', 'AU200'],
            metals: ['XAUUSD', 'XAGUSD']
        };

        // Display timezone from settings (Europe/Zurich)
        const DISPLAY_TIMEZONE = 'Europe/Zurich';

        // TradingView Chart State
        let currentChartSymbol = null;
        let tvWidget = null;
        let tradingViewConfig = {
            default_interval: '60',
            default_style: '1',
            theme: 'dark',
            indicators: {
                sma: true,
                ema: false,
                rsi: true,
                macd: false,
                bollinger: false,
                volume: true
            },
            exchanges: {
                crypto: 'BITSTAMP',
                forex: 'FX',
                stocks: 'NASDAQ'
            }
        };

        // TradingView Indikator-Mapping
        const TV_INDICATOR_MAP = {
            sma: 'MASimple@tv-basicstudies',
            ema: 'MAExp@tv-basicstudies',
            rsi: 'RSI@tv-basicstudies',
            macd: 'MACD@tv-basicstudies',
            bollinger: 'BB@tv-basicstudies',
            volume: 'Volume@tv-basicstudies'
        };

        // Symbol mapping for TradingView (unser Format -> TradingView Format)
        const TV_SYMBOL_MAP = {
            'BTCUSD': 'BITSTAMP:BTCUSD',
            'ETHUSD': 'BITSTAMP:ETHUSD',
            'XRPUSD': 'BITSTAMP:XRPUSD',
            'SOLUSD': 'COINBASE:SOLUSD',
            'ADAUSD': 'COINBASE:ADAUSD',
            'DOTUSD': 'KRAKEN:DOTUSD',
            'LINKUSD': 'COINBASE:LINKUSD',
            'BNBUSD': 'BINANCE:BNBUSD',
            'EURUSD': 'FX:EURUSD',
            'GBPUSD': 'FX:GBPUSD',
            'USDJPY': 'FX:USDJPY',
            'USDCHF': 'FX:USDCHF',
            'AUDUSD': 'FX:AUDUSD',
            'USDCAD': 'FX:USDCAD',
            'NZDUSD': 'FX:NZDUSD',
            'EURGBP': 'FX:EURGBP',
            'EURJPY': 'FX:EURJPY',
            'GBPJPY': 'FX:GBPJPY',
            'XAUUSD': 'TVC:GOLD',
            'XAGUSD': 'TVC:SILVER',
            'AAPL': 'NASDAQ:AAPL',
            'MSFT': 'NASDAQ:MSFT',
            'GOOGL': 'NASDAQ:GOOGL',
            'AMZN': 'NASDAQ:AMZN',
            'NVDA': 'NASDAQ:NVDA',
            'TSLA': 'NASDAQ:TSLA',
            'META': 'NASDAQ:META',
            'US500': 'FOREXCOM:SPXUSD',
            'US100': 'NASDAQ:NDX',
            'US30': 'DJ:DJI',
            'DE40': 'XETR:DAX',
            'UK100': 'CAPITALCOM:UK100',
            'FR40': 'EURONEXT:PX1',
            'EU50': 'TVC:SX5E',
            'JP225': 'TVC:NI225',
            'HK50': 'HSI:HSI',
            'AU200': 'PEPPERSTONE:AUS200'
        };

        // Market Hours (in UTC) - will be converted to local time for display
        const MARKET_HOURS_UTC = {
            crypto: { open: 0, close: 24 }, // 24/7
            forex: { sundayOpen: 22, fridayClose: 21 }, // Sun 22:00 - Fri 21:00 UTC
            us: { open: 14.5, close: 21 }, // 14:30-21:00 UTC
            eu: { open: 8, close: 16.5 }, // 08:00-16:30 UTC
            asia: { open: 0, close: 6 } // 00:00-06:00 UTC
        };

        // TradingView-Konfiguration laden
        async function loadTradingViewConfig() {
            try {
                const response = await fetch(`${API_BASE}/config/tradingview`);
                if (response.ok) {
                    const config = await response.json();
                    // Merge mit Defaults
                    tradingViewConfig = {
                        ...tradingViewConfig,
                        ...config,
                        indicators: { ...tradingViewConfig.indicators, ...config.indicators },
                        exchanges: { ...tradingViewConfig.exchanges, ...config.exchanges }
                    };

                    // Default-Werte f√ºr Dropdowns setzen
                    if (config.default_interval) {
                        document.getElementById('chartInterval').value = config.default_interval;
                    }
                    if (config.default_style) {
                        document.getElementById('chartStyle').value = config.default_style;
                    }

                    console.log('TradingView-Konfiguration geladen:', tradingViewConfig);
                }
            } catch (error) {
                console.warn('TradingView-Konfiguration konnte nicht geladen werden:', error);
            }
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTradingViewConfig();
            updateMarketHours();
            loadSetups();
            loadWatchlist();
            loadScannerStatus();

            // Regelm√§ssige Updates
            setInterval(updateMarketHours, 60000); // Jede Minute
            setInterval(loadScannerStatus, 5000);  // Alle 5 Sekunden
            setInterval(loadSetups, 15000);        // Alle 15 Sekunden
            setInterval(loadWatchlist, 30000);     // Alle 30 Sekunden
        });

        // Convert UTC hour to local timezone hour
        function utcToLocal(utcHour, utcMinutes = 0) {
            const now = new Date();
            const utcDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), Math.floor(utcHour), utcMinutes));
            const localTime = utcDate.toLocaleTimeString('de-CH', { timeZone: DISPLAY_TIMEZONE, hour: '2-digit', minute: '2-digit' });
            return localTime;
        }

        function updateMarketHours() {
            const now = new Date();
            const utcHour = now.getUTCHours() + now.getUTCMinutes() / 60;
            const utcDay = now.getUTCDay();
            let openCount = 0;

            // Crypto - 24/7
            const cryptoOpen = true;
            updateMarketDisplay('crypto', cryptoOpen, '24/7');
            if (cryptoOpen) openCount++;
            marketStatus.crypto = cryptoOpen;

            // Forex - Sun 22:00 UTC bis Fri 21:00 UTC (Sun 23:00 - Fri 22:00 CET)
            let forexOpen = false;
            if (utcDay === 0 && utcHour >= 22) forexOpen = true;
            else if (utcDay > 0 && utcDay < 5) forexOpen = true;
            else if (utcDay === 5 && utcHour < 21) forexOpen = true;
            const forexCloseLocal = utcToLocal(21, 0);
            const forexOpenLocal = utcToLocal(22, 0);
            updateMarketDisplay('forex', forexOpen, forexOpen ? `bis Fr ${forexCloseLocal}` : `ab So ${forexOpenLocal}`);
            if (forexOpen) openCount++;
            marketStatus.forex = forexOpen;

            // US Markets - 14:30-21:00 UTC (15:30-22:00 CET)
            const usOpen = utcDay >= 1 && utcDay <= 5 && utcHour >= 14.5 && utcHour < 21;
            const usOpenLocal = utcToLocal(14, 30);
            const usCloseLocal = utcToLocal(21, 0);
            updateMarketDisplay('us', usOpen, usOpen ? `bis ${usCloseLocal}` : `ab ${usOpenLocal}`);
            if (usOpen) openCount++;
            marketStatus.us = usOpen;

            // EU Markets - 08:00-16:30 UTC (09:00-17:30 CET)
            const euOpen = utcDay >= 1 && utcDay <= 5 && utcHour >= 8 && utcHour < 16.5;
            const euOpenLocal = utcToLocal(8, 0);
            const euCloseLocal = utcToLocal(16, 30);
            updateMarketDisplay('eu', euOpen, euOpen ? `bis ${euCloseLocal}` : `ab ${euOpenLocal}`);
            if (euOpen) openCount++;
            marketStatus.eu = euOpen;

            // Asia Markets - 00:00-06:00 UTC (01:00-07:00 CET)
            const asiaOpen = utcDay >= 1 && utcDay <= 5 && utcHour < 6;
            const asiaOpenLocal = utcToLocal(0, 0);
            const asiaCloseLocal = utcToLocal(6, 0);
            updateMarketDisplay('asia', asiaOpen, asiaOpen ? `bis ${asiaCloseLocal}` : `ab ${asiaOpenLocal}`);
            if (asiaOpen) openCount++;
            marketStatus.asia = asiaOpen;

            document.getElementById('openMarketsCount').textContent = openCount;
        }

        function updateMarketDisplay(marketId, isOpen, timeText) {
            const el = document.getElementById(`market-${marketId}`);
            if (!el) return;

            el.classList.remove('open', 'closed');
            el.classList.add(isOpen ? 'open' : 'closed');

            const timeEl = el.querySelector('.market-time');
            if (timeEl) timeEl.textContent = timeText;
        }

        function getSymbolMarket(symbol) {
            const upperSymbol = symbol.toUpperCase();
            if (SYMBOL_CATEGORIES.crypto.includes(upperSymbol)) return 'crypto';
            if (SYMBOL_CATEGORIES.forex.includes(upperSymbol)) return 'forex';
            if (SYMBOL_CATEGORIES.metals.includes(upperSymbol)) return 'forex'; // Metals follow forex hours
            if (SYMBOL_CATEGORIES.us_stocks.includes(upperSymbol)) return 'us';
            if (SYMBOL_CATEGORIES.eu_stocks.includes(upperSymbol)) return 'eu';
            if (SYMBOL_CATEGORIES.asia_stocks.includes(upperSymbol)) return 'asia';
            return 'unknown';
        }

        function isMarketOpen(symbol) {
            const market = getSymbolMarket(symbol);
            return marketStatus[market] !== false;
        }

        // TradingView Chart Functions
        function selectSetup(symbol, timeframe) {
            // Highlight selected card
            document.querySelectorAll('.setup-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Timeframe automatisch √ºbernehmen
            const intervalSelect = document.getElementById('chartInterval');
            const intervalMap = {
                'M1': '1', 'M5': '5', 'M15': '15', 'M30': '30',
                'H1': '60', 'H4': '240', 'D1': 'D', 'W1': 'W', 'MN': 'M'
            };
            if (intervalMap[timeframe]) {
                intervalSelect.value = intervalMap[timeframe];
            }

            // Load chart with the selected timeframe
            loadChart(symbol);
        }

        function getTradingViewSymbol(symbol) {
            const upperSymbol = symbol.toUpperCase();

            // Wenn ein festes Mapping existiert, verwende es
            if (TV_SYMBOL_MAP[upperSymbol]) {
                return TV_SYMBOL_MAP[upperSymbol];
            }

            // Dynamisches Mapping basierend auf konfigurierter Exchange
            const exchanges = tradingViewConfig.exchanges || {};

            // Crypto-Symbole
            if (SYMBOL_CATEGORIES.crypto.includes(upperSymbol)) {
                const exchange = exchanges.crypto || 'BITSTAMP';
                return `${exchange}:${upperSymbol}`;
            }

            // Forex-Symbole
            if (SYMBOL_CATEGORIES.forex.includes(upperSymbol)) {
                const provider = exchanges.forex || 'FX';
                return `${provider}:${upperSymbol}`;
            }

            // US-Aktien
            if (SYMBOL_CATEGORIES.us_stocks.includes(upperSymbol)) {
                const exchange = exchanges.stocks || 'NASDAQ';
                return `${exchange}:${upperSymbol}`;
            }

            return symbol;
        }

        function getActiveIndicators() {
            const studies = [];
            if (tradingViewConfig.indicators) {
                for (const [key, enabled] of Object.entries(tradingViewConfig.indicators)) {
                    // Volume wird √ºber hide_volume gesteuert, nicht als Studie
                    if (enabled && TV_INDICATOR_MAP[key] && key !== 'volume') {
                        studies.push(TV_INDICATOR_MAP[key]);
                    }
                }
            }
            // Kein Fallback - nur explizit aktivierte Indikatoren anzeigen
            return studies;
        }

        // Chart Fullscreen Toggle
        let isChartFullscreen = false;

        function toggleChartFullscreen() {
            const chartSection = document.getElementById('chartSection');
            const expandText = document.getElementById('expandText');
            const expandIcon = document.getElementById('expandIcon');

            isChartFullscreen = !isChartFullscreen;

            if (isChartFullscreen) {
                chartSection.classList.add('fullscreen');
                expandText.textContent = 'Verkleinern';
                expandIcon.innerHTML = '<path d="M4 14h6v6m10-10h-6V4m0 6l7-7M3 21l7-7"/>';
                document.body.style.overflow = 'hidden';
            } else {
                chartSection.classList.remove('fullscreen');
                expandText.textContent = 'Vollbild';
                expandIcon.innerHTML = '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>';
                document.body.style.overflow = '';
            }

            // Chart neu laden um Gr√∂√üe anzupassen
            if (currentChartSymbol) {
                setTimeout(() => loadChart(currentChartSymbol), 100);
            }
        }

        // ESC-Taste zum Schlie√üen des Fullscreen-Modus
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isChartFullscreen) {
                toggleChartFullscreen();
            }
        });

        function loadChart(symbol) {
            currentChartSymbol = symbol;
            const tvSymbol = getTradingViewSymbol(symbol);
            const interval = document.getElementById('chartInterval').value;
            const style = document.getElementById('chartStyle').value;

            document.getElementById('chartSymbol').textContent = symbol;

            // Get active indicators from config
            const activeStudies = getActiveIndicators();

            // Create TradingView Widget
            const container = document.getElementById('chartContainer');
            container.innerHTML = '';

            // Volumen nur anzeigen wenn in Config aktiviert
            const hideVolume = !tradingViewConfig.indicators?.volume;

            new TradingView.widget({
                "autosize": true,
                "symbol": tvSymbol,
                "interval": interval,
                "timezone": DISPLAY_TIMEZONE,
                "theme": tradingViewConfig.theme || "dark",
                "style": style,
                "locale": "de_DE",
                "toolbar_bg": "#1a1a2e",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "hide_volume": hideVolume,
                "save_image": true,
                "container_id": "chartContainer",
                "studies": activeStudies,
                "show_popup_button": true,
                "popup_width": "1000",
                "popup_height": "650"
            });

            // Load Multi-Timeframe Strength Chart (pass interval for time sync)
            loadStrengthChart(symbol, interval);
        }

        function updateChart() {
            if (currentChartSymbol) {
                loadChart(currentChartSymbol);
            }
        }

        // =============================================
        // Multi-Timeframe Strength Chart (Lightweight Charts)
        // =============================================

        let strengthChart = null;
        let strengthSeries = { h4: null, d1: null, w1: null };
        let strengthResizeObserver = null;

        async function loadStrengthChart(symbol, tvInterval = '60') {
            const container = document.getElementById('strengthChartContainer');

            // Calculate days to fetch based on TradingView interval
            // Goal: Strength chart should cover approximately the same calendar period as TradingView chart
            // TradingView typically shows ~100-200 candles, so we estimate the visible days
            let days = 14; // Default: ~2 weeks
            switch(tvInterval) {
                case '1':    days = 7;   break;  // 1min chart -> ~1 week visible
                case '5':    days = 10;  break;  // 5min chart -> ~10 days
                case '15':   days = 14;  break;  // 15min chart -> ~2 weeks
                case '60':   days = 14;  break;  // 1h chart -> ~2 weeks
                case '240':  days = 30;  break;  // 4h chart -> ~1 month
                case 'D':    days = 60;  break;  // Daily chart -> ~2 months
                case 'W':    days = 180; break;  // Weekly chart -> ~6 months
                default:     days = 14;
            }

            try {
                // Fetch multi-timeframe strength data from Data Service
                const response = await fetch(`/data/api/v1/easyinsight/multi-strength/${symbol}?days=${days}`);

                if (!response.ok) {
                    throw new Error('Strength data not available');
                }

                const data = await response.json();

                // Destroy existing chart if present (important for re-renders)
                if (strengthChart) {
                    if (strengthResizeObserver) {
                        strengthResizeObserver.disconnect();
                        strengthResizeObserver = null;
                    }
                    strengthChart.remove();
                    strengthChart = null;
                    strengthSeries = { h4: null, d1: null, w1: null };
                }

                // Clear container
                container.innerHTML = '';

                // Create new chart
                strengthChart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 120,
                    layout: {
                        background: { color: '#131722' },
                        textColor: '#d1d4dc',
                    },
                    grid: {
                        vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                        horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    },
                    rightPriceScale: {
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        scaleMargins: { top: 0.1, bottom: 0.1 },
                    },
                    timeScale: {
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                });

                // Add series for each timeframe
                strengthSeries.h4 = strengthChart.addLineSeries({
                    color: '#f59e0b',
                    lineWidth: 2,
                    title: 'H4',
                });
                strengthSeries.d1 = strengthChart.addLineSeries({
                    color: '#10b981',
                    lineWidth: 2,
                    title: 'D1',
                });
                strengthSeries.w1 = strengthChart.addLineSeries({
                    color: '#8b5cf6',
                    lineWidth: 2,
                    title: 'W1',
                });

                // Handle resize
                strengthResizeObserver = new ResizeObserver(entries => {
                    if (strengthChart) {
                        const { width } = entries[0].contentRect;
                        strengthChart.applyOptions({ width });
                    }
                });
                strengthResizeObserver.observe(container);

                // Set data for each timeframe
                const timeframes = data.timeframes || {};

                if (timeframes.H4 && Array.isArray(timeframes.H4) && timeframes.H4.length > 0) {
                    strengthSeries.h4.setData(timeframes.H4);
                }
                if (timeframes.D1 && Array.isArray(timeframes.D1) && timeframes.D1.length > 0) {
                    strengthSeries.d1.setData(timeframes.D1);
                }
                if (timeframes.W1 && Array.isArray(timeframes.W1) && timeframes.W1.length > 0) {
                    strengthSeries.w1.setData(timeframes.W1);
                }

                // Fit content
                strengthChart.timeScale().fitContent();

            } catch (error) {
                console.warn('Strength chart error:', error);
                // Clean up chart state on error
                if (strengthChart) {
                    strengthChart.remove();
                    strengthChart = null;
                    strengthSeries = { h4: null, d1: null, w1: null };
                }
                container.innerHTML = '<div class="strength-placeholder">St√§rke-Daten nicht verf√ºgbar</div>';
            }
        }

        async function loadSetups() {
            const directionFilter = document.getElementById('directionFilter').value;
            const marketFilter = document.getElementById('marketFilter').value;
            const minScore = parseInt(document.getElementById('minScoreFilter').value) || 0;
            const container = document.getElementById('setupsContainer');

            try {
                // min_score aus Filter verwenden
                // Bei "longshort" keinen direction-Parameter senden, sp√§ter clientseitig filtern
                let url = `${API_BASE}/setups/?limit=50&min_score=${minScore}`;
                if (directionFilter && directionFilter !== 'longshort') {
                    url += `&direction=${directionFilter}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                console.log('Setups loaded:', data);

                if (data.setups && data.setups.length > 0) {
                    let setups = data.setups;

                    // Filter Long/Short (Neutral ausschliessen)
                    if (directionFilter === 'longshort') {
                        setups = setups.filter(s => s.direction === 'long' || s.direction === 'short');
                    }

                    console.log('Before filter:', setups.length, 'setups, marketFilter:', marketFilter);

                    // Filter nach Markt
                    if (marketFilter === 'open') {
                        setups = setups.filter(s => {
                            const open = isMarketOpen(s.symbol);
                            return open;
                        });
                    } else if (marketFilter === 'crypto') {
                        setups = setups.filter(s => getSymbolMarket(s.symbol) === 'crypto');
                    } else if (marketFilter === 'forex') {
                        setups = setups.filter(s => ['forex'].includes(getSymbolMarket(s.symbol)));
                    } else if (marketFilter === 'stocks') {
                        setups = setups.filter(s => ['us', 'eu', 'asia'].includes(getSymbolMarket(s.symbol)));
                    }

                    // Sortiere: Offene M√§rkte zuerst, dann nach Score
                    setups.sort((a, b) => {
                        const aOpen = isMarketOpen(a.symbol) ? 1 : 0;
                        const bOpen = isMarketOpen(b.symbol) ? 1 : 0;
                        if (aOpen !== bOpen) return bOpen - aOpen;
                        return b.composite_score - a.composite_score;
                    });

                    if (setups.length > 0) {
                        container.innerHTML = setups.map(setup => createSetupCard(setup)).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>Keine Setups f√ºr diesen Filter</p></div>';
                    }

                    document.getElementById('totalScanned').textContent = data.total_scanned;
                    document.getElementById('highConfidence').textContent = data.high_confidence_count;
                } else {
                    container.innerHTML = '<div class="empty-state"><p>Keine Setups gefunden</p></div>';
                }
            } catch (error) {
                console.error('Fehler:', error);
                container.innerHTML = '<div class="empty-state"><p>Fehler beim Laden</p></div>';
            }
        }

        // Cache f√ºr geladene Setups (f√ºr Detail-Modal)
        let setupsCache = {};

        // Richtungs-Pfeil Symbol
        function getDirectionArrow(direction) {
            if (direction === 'long') return '‚ñ≤';
            if (direction === 'short') return '‚ñº';
            return '‚ñ∂';
        }

        // Setup-Alter formatieren (Minuten seit Erkennung)
        function formatSetupAge(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const setupTime = new Date(timestamp);
            const diffMs = now - setupTime;
            const diffMinutes = Math.floor(diffMs / 60000);

            if (diffMinutes < 1) return '<1m';
            if (diffMinutes < 60) return `${diffMinutes}m`;
            if (diffMinutes < 1440) {
                const hours = Math.floor(diffMinutes / 60);
                const mins = diffMinutes % 60;
                return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
            }
            const days = Math.floor(diffMinutes / 1440);
            return `${days}d`;
        }

        function createSetupCard(setup) {
            const scoreClass = setup.composite_score >= 75 ? 'high' :
                              setup.composite_score >= 60 ? 'moderate' : 'low';

            const market = getSymbolMarket(setup.symbol);
            const isOpen = isMarketOpen(setup.symbol);
            const marketClosedClass = isOpen ? '' : 'market-closed';

            const signals = [
                { name: 'N', available: setup.nhits_signal?.available, tooltip: 'NHITS: Preis-Prognose (25%)' },
                { name: 'H', available: setup.hmm_signal?.available, tooltip: 'HMM: Regime-Erkennung (20%)' },
                { name: 'L', available: setup.cnn_lstm_signal?.available, tooltip: 'CNN-LSTM: Multi-Task (20%)' },
                { name: 'T', available: setup.tcn_signal?.available && setup.tcn_signal?.patterns?.length > 0, tooltip: 'TCN: Chart-Patterns (15%)' },
                { name: 'C', available: setup.candlestick_signal?.available && setup.candlestick_signal?.patterns?.length > 0, tooltip: 'Candlestick: Kerzen-Patterns (10%)' },
            ];

            const arrow = getDirectionArrow(setup.direction);

            // Setup im Cache speichern f√ºr Detail-Modal
            setupsCache[setup.symbol] = setup;

            return `
                <div class="setup-card ${setup.direction} ${marketClosedClass}" onclick="selectSetup('${setup.symbol}', '${setup.timeframe}')" ondblclick="openAnalysis('${setup.symbol}', '${setup.timeframe}')">
                    <div class="setup-top">
                        <span class="setup-symbol">
                            ${setup.symbol}
                            <span class="market-indicator ${isOpen ? 'open' : ''}">${isOpen ? 'OPEN' : 'CLOSED'}</span>
                        </span>
                        <div class="setup-score">
                            <span class="score-value ${scoreClass}">${setup.composite_score.toFixed(0)}</span>
                            <span class="setup-direction ${setup.direction}">${arrow} ${setup.direction.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="setup-signals">
                        ${signals.map(s => `<span class="signal-tag ${s.available ? 'available' : ''}" title="${s.tooltip}">${s.name}</span>`).join('')}
                    </div>
                    <div class="setup-meta">
                        <span class="setup-age" title="Alter seit Erkennung: ${setup.timestamp ? new Date(setup.timestamp).toLocaleString('de-CH') : ''}">${formatSetupAge(setup.timestamp)}</span>
                        <span>${setup.timeframe} | ${setup.confidence_level}</span>
                        <button class="setup-detail-btn" onclick="event.stopPropagation(); openDetailModal('${setup.symbol}', '${setup.timeframe}')" title="Alle Details anzeigen">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            Details
                        </button>
                    </div>
                    ${setup.entry_exit_levels ? `
                    <div class="setup-levels">
                        <div class="level sl" title="Stop Loss">
                            <span class="level-label">SL</span>
                            <span class="level-value">${formatLevelPrice(setup.entry_exit_levels.stop_loss, setup.symbol)}</span>
                        </div>
                        <div class="level entry" title="Entry Price">
                            <span class="level-label">Entry</span>
                            <span class="level-value">${formatLevelPrice(setup.entry_exit_levels.entry_price, setup.symbol)}</span>
                        </div>
                        <div class="level tp" title="Take Profit 1">
                            <span class="level-label">TP1</span>
                            <span class="level-value">${formatLevelPrice(setup.entry_exit_levels.take_profit_1, setup.symbol)}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Formatiert Preise f√ºr die Level-Anzeige (kompakt)
        function formatLevelPrice(price, symbol) {
            if (!price) return '-';

            // F√ºr grosse Preise (BTC, Indizes): keine Dezimalen
            if (price > 1000) {
                return price.toFixed(0);
            }
            // F√ºr mittlere Preise: 2 Dezimalen
            if (price > 10) {
                return price.toFixed(2);
            }
            // F√ºr kleine Preise: 4 Dezimalen
            if (price > 0.01) {
                return price.toFixed(4);
            }
            // F√ºr sehr kleine Preise: 6 Dezimalen
            return price.toFixed(6);
        }

        async function loadWatchlist() {
            const container = document.getElementById('watchlistContainer');

            try {
                const response = await fetch(`${API_BASE}/watchlist/`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    // Sortiere nach Score (h√∂chste zuerst)
                    const sortedItems = [...data.items].sort((a, b) => (b.last_score || 0) - (a.last_score || 0));

                    container.innerHTML = sortedItems.slice(0, 8).map(item => {
                        const scoreClass = item.last_score >= 75 ? 'high' :
                                          item.last_score >= 60 ? 'moderate' : 'low';
                        const arrow = getDirectionArrow(item.last_direction);
                        const directionClass = item.last_direction || 'neutral';
                        return `
                            <div class="watchlist-item">
                                <span class="watchlist-symbol ${item.is_favorite ? 'favorite' : ''}">${item.symbol}</span>
                                <span class="watchlist-score ${scoreClass}"><span class="direction-arrow ${directionClass}">${arrow}</span> ${item.last_score ? item.last_score.toFixed(0) : '-'}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="opacity: 0.6; text-align: center; font-size: 0.8rem;">Leer</p>';
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function loadScannerStatus() {
            try {
                const response = await fetch(`${API_BASE}/scan/status`);
                const data = await response.json();

                scannerRunning = data.is_running;

                const badge = document.getElementById('scannerBadge');
                const toggleBtn = document.getElementById('toggleBtn');

                if (data.is_running) {
                    badge.classList.remove('stopped');
                    document.getElementById('scannerText').textContent = 'Scanner';
                    toggleBtn.textContent = 'Stop';
                } else {
                    badge.classList.add('stopped');
                    document.getElementById('scannerText').textContent = 'Gestoppt';
                    toggleBtn.textContent = 'Start';
                }

                document.getElementById('scanStatus').textContent = data.status;
                document.getElementById('scanInterval').textContent = `${data.scan_interval_seconds}s`;
                document.getElementById('lastScanTime').textContent = data.last_scan_time
                    ? new Date(data.last_scan_time).toLocaleTimeString('de-CH')
                    : '-';
                document.getElementById('nextScanTime').textContent = data.next_scan_time
                    ? new Date(data.next_scan_time).toLocaleTimeString('de-CH')
                    : '-';
                document.getElementById('errorCount').textContent = data.errors_count;
                document.getElementById('alertsTriggered').textContent = data.alerts_triggered;

                if (data.last_scan_time) {
                    document.getElementById('lastScan').textContent =
                        new Date(data.last_scan_time).toLocaleTimeString('de-CH');
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function toggleScanner() {
            const endpoint = scannerRunning ? 'stop' : 'start';
            try {
                await fetch(`${API_BASE}/scan/${endpoint}`, { method: 'POST' });
                loadScannerStatus();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function triggerScan() {
            try {
                await fetch(`${API_BASE}/scan/trigger`, { method: 'POST' });
                loadScannerStatus();
                setTimeout(loadSetups, 2000);
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function openAnalysis(symbol, timeframe) {
            const modal = document.getElementById('analysisModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modal.classList.add('active');
            modalTitle.textContent = `${symbol} Analyse`;
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analysiere...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/analyze/${symbol}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeframe, include_rag: true, include_llm: true })
                });
                const data = await response.json();

                const isOpen = isMarketOpen(symbol);

                modalBody.innerHTML = `
                    <div class="analysis-section">
                        <h4>Score: ${data.setup.composite_score.toFixed(1)} | ${data.setup.direction.toUpperCase()} | ${data.setup.confidence_level}</h4>
                        <div class="analysis-content">
                            <p><strong>Markt:</strong> ${isOpen ? 'üü¢ Offen' : 'üî¥ Geschlossen'}</p>
                            <p><strong>Signal-Alignment:</strong> ${data.setup.signal_alignment}</p>
                            <p><strong>Key Drivers:</strong> ${data.setup.key_drivers?.join(', ') || '-'}</p>
                        </div>
                    </div>

                    ${data.entry_exit_levels ? `
                    <div class="analysis-section">
                        <h4>Levels</h4>
                        <div class="levels-grid">
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.entry_price?.toFixed(2) || '-'}</div>
                                <div class="label">Entry</div>
                            </div>
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.stop_loss?.toFixed(2) || '-'}</div>
                                <div class="label">Stop</div>
                            </div>
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.take_profit_1?.toFixed(2) || '-'}</div>
                                <div class="label">TP1</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${data.analysis_summary ? `
                    <div class="analysis-section">
                        <h4>LLM-Analyse</h4>
                        <div class="analysis-content">${data.analysis_summary}</div>
                    </div>
                    ` : ''}

                    ${data.risk_assessment ? `
                    <div class="analysis-section">
                        <h4>Risiko</h4>
                        <div class="analysis-content">${data.risk_assessment}</div>
                    </div>
                    ` : ''}

                    <p style="opacity: 0.5; font-size: 0.75rem; margin-top: 0.5rem;">
                        ${data.analysis_duration_ms?.toFixed(0) || '-'}ms | RAG: ${data.rag_sources_used || 0}
                    </p>
                `;
            } catch (error) {
                console.error('Fehler:', error);
                modalBody.innerHTML = '<div class="empty-state"><p>Fehler bei der Analyse</p></div>';
            }
        }

        function closeModal() {
            document.getElementById('analysisModal').classList.remove('active');
        }

        document.getElementById('analysisModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeModal();
        });

        // =============================================
        // Detail Modal Funktionen
        // =============================================

        let currentDetailSymbol = null;
        let currentDetailTimeframe = null;
        let llmAnalysisLoaded = false;
        let currentTrendStrength = null; // Cached trend strength data

        async function openDetailModal(symbol, timeframe) {
            // Validierung: Symbol muss vorhanden sein
            if (!symbol) {
                console.error('openDetailModal: Symbol ist nicht definiert');
                showToast('Fehler: Symbol nicht gefunden', 'error');
                return;
            }

            currentDetailSymbol = symbol;
            currentDetailTimeframe = timeframe;
            llmAnalysisLoaded = false;

            const modal = document.getElementById('detailModal');
            document.getElementById('detailModalTitle').textContent = `${symbol} ${timeframe} - Setup Details`;

            // Loading state
            document.getElementById('detailAllContent').innerHTML = `
                <div class="loading"><div class="spinner"></div><p>Lade Details...</p></div>
            `;

            modal.classList.add('active');

            // Lade Setup-Details
            await loadDetailContent(symbol, timeframe);
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            currentDetailSymbol = null;
            currentDetailTimeframe = null;
        }

        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeDetailModal();
        });

        async function fetchTrendStrength(symbol) {
            // Fetch latest trend strength values for H4, D1, W1
            try {
                const response = await fetch(`/data/api/v1/easyinsight/multi-strength/${symbol}?days=7`);
                if (!response.ok) return null;

                const data = await response.json();

                // Extract latest value from each timeframe
                const getLatest = (tf) => {
                    const arr = data.timeframes?.[tf];
                    if (!arr || arr.length === 0) return null;
                    return arr[arr.length - 1].value;
                };

                return {
                    h4: getLatest('H4'),
                    d1: getLatest('D1'),
                    w1: getLatest('W1')
                };
            } catch (error) {
                console.error('Error fetching trend strength:', error);
                return null;
            }
        }

        async function loadDetailContent(symbol, timeframe) {
            // Cache-Key mit Symbol und Timeframe
            const cacheKey = `${symbol}:${timeframe}`;

            // Versuche zuerst aus Cache (nur wenn Timeframe √ºbereinstimmt)
            let cachedSetup = setupsCache[cacheKey];

            // Parallel: Setup und Trend-St√§rke laden
            const [setupResult, trendStrength] = await Promise.all([
                // Setup laden (immer frisch f√ºr korrekte Daten)
                (async () => {
                    try {
                        const response = await fetch(`${API_BASE}/setups/${symbol}?timeframe=${timeframe}&force_refresh=true`);
                        if (response.ok) {
                            const data = await response.json();
                            // Cache mit korrektem Timeframe-Key
                            setupsCache[`${symbol}:${data.timeframe}`] = data;
                            return data;
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden des Setups:', error);
                    }
                    // Fallback auf Cache wenn API fehlschl√§gt
                    return cachedSetup || null;
                })(),
                // Trend-St√§rke laden
                fetchTrendStrength(symbol)
            ]);

            setup = setupResult;
            currentTrendStrength = trendStrength;

            if (!setup) {
                document.getElementById('detailAllContent').innerHTML = '<div class="empty-state">Setup nicht gefunden</div>';
                return;
            }

            // Update modal title with actual timeframe from setup data
            const actualTimeframe = setup.timeframe || timeframe;
            document.getElementById('detailModalTitle').textContent = `${symbol} ${actualTimeframe} - Setup Details`;
            currentDetailTimeframe = actualTimeframe;

            // Alle Inhalte in einem einzigen Container rendern
            renderAllContent(setup, trendStrength);
        }

        function renderAllContent(setup, trendStrength = null) {
            const container = document.getElementById('detailAllContent');
            container.innerHTML = `
                <div class="detail-columns">
                    <div class="detail-column">
                        ${renderOverviewSection(setup)}
                        ${renderTrendStrengthSection(trendStrength)}
                        ${renderSignalsSection(setup)}
                        ${renderCnnLstmSection(setup)}
                        ${renderPatternsSection(setup)}
                    </div>
                    <div class="detail-column llm-column">
                        ${renderLlmSection()}
                    </div>
                </div>
            `;
        }

        function renderOverviewSection(setup) {
            const scoreClass = setup.composite_score >= 75 ? 'high' :
                              setup.composite_score >= 60 ? 'moderate' : 'low';

            const directionIcon = setup.direction === 'long' ? 'üìà' :
                                 setup.direction === 'short' ? 'üìâ' : '‚û°Ô∏è';

            const directionColor = setup.direction === 'long' ? '#34d399' :
                                  setup.direction === 'short' ? '#f87171' : '#fbbf24';

            return `
                <div class="consolidated-section">
                    <h3 class="section-title"><span class="icon">üìä</span> √úbersicht</h3>
                    ${setup.setup_id ? `
                    <div class="setup-id-display">
                        <span class="setup-id-label">Setup-ID:</span>
                        <span class="setup-id-value">${setup.setup_id}</span>
                    </div>
                    ` : ''}
                    <div class="score-meter" style="margin-bottom: 0.5rem;">
                        <div class="score-bar">
                            <div class="score-bar-fill ${scoreClass}" style="width: ${setup.composite_score}%"></div>
                        </div>
                        <span class="score-value-large" style="color: ${scoreClass === 'high' ? '#34d399' : scoreClass === 'moderate' ? '#fbbf24' : '#9ca3af'}">${setup.composite_score.toFixed(1)}</span>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-card-title">Richtung</div>
                            <div class="detail-card-value" style="color: ${directionColor}">
                                ${directionIcon} ${setup.direction.toUpperCase()}
                            </div>
                            <div class="detail-card-sub">${setup.signal_alignment}</div>
                        </div>

                        <div class="detail-card">
                            <div class="detail-card-title">Konfidenz</div>
                            <div class="detail-card-value">${setup.confidence_level.toUpperCase()}</div>
                            <div class="detail-card-sub">${setup.signals_available}/5 Signale</div>
                        </div>

                        <div class="detail-card">
                            <div class="detail-card-title">Timeframe</div>
                            <div class="detail-card-value">${setup.timeframe}</div>
                            <div class="detail-card-sub">${new Date(setup.timestamp).toLocaleTimeString('de-CH')}</div>
                        </div>

                        ${setup.current_price ? `
                        <div class="detail-card">
                            <div class="detail-card-title">Preis</div>
                            <div class="detail-card-value">${setup.current_price.toLocaleString('de-CH', {minimumFractionDigits: 2})}</div>
                        </div>
                        ` : ''}
                    </div>

                    ${setup.key_drivers && setup.key_drivers.length > 0 ? `
                    <div style="margin-top: 0.4rem;">
                        <div class="detail-card-title" style="margin-bottom: 0.2rem;">Key Drivers</div>
                        <div class="pattern-list">
                            ${setup.key_drivers.map(driver => `<span class="pattern-tag">${driver}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${renderLevelsSection(setup)}
                </div>
            `;
        }

        function renderLevelsSection(setup) {
            if (!setup.entry_exit_levels) {
                return '';
            }

            const levels = setup.entry_exit_levels;
            const currentPrice = setup.current_price;

            return `
                <div style="margin-top: 0.6rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="detail-card-title" style="margin-bottom: 0.4rem;">
                        <span style="color: #a78bfa;">üéØ</span> Entry/Exit Levels
                        <span style="font-size: 0.6rem; opacity: 0.6; margin-left: 0.5rem;">(Klick zum Kopieren)</span>
                    </div>

                    <!-- Zeile 1: Entry / Actual Price / R:R -->
                    <div class="detail-grid" style="grid-template-columns: 1fr 1fr 0.6fr; margin-bottom: 0.3rem;">
                        <div class="detail-card">
                            <div class="detail-card-title">Entry</div>
                            ${renderCopyablePrice(levels.entry_price, '#64c8ff')}
                        </div>
                        <div class="detail-card">
                            <div class="detail-card-title">Aktueller Preis</div>
                            ${renderCopyablePrice(currentPrice, '#fbbf24')}
                        </div>
                        <div class="detail-card">
                            <div class="detail-card-title">R:R</div>
                            <div class="detail-card-value" style="color: #a78bfa;">
                                ${levels.risk_reward_ratio ? levels.risk_reward_ratio.toFixed(1) + ':1' : '-'}
                            </div>
                        </div>
                    </div>

                    <!-- Zeile 2: Stop Loss -->
                    <div class="detail-grid" style="grid-template-columns: 1fr; margin-bottom: 0.3rem;">
                        <div class="detail-card">
                            <div class="detail-card-title">Stop Loss</div>
                            ${renderCopyablePrice(levels.stop_loss, '#f87171')}
                        </div>
                    </div>

                    <!-- Zeile 3: TP1 / TP2 / TP3 -->
                    <div class="detail-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="detail-card">
                            <div class="detail-card-title">TP1</div>
                            ${renderCopyablePrice(levels.take_profit_1, '#34d399')}
                        </div>
                        <div class="detail-card">
                            <div class="detail-card-title">TP2</div>
                            ${renderCopyablePrice(levels.take_profit_2, '#34d399')}
                        </div>
                        <div class="detail-card">
                            <div class="detail-card-title">TP3</div>
                            ${renderCopyablePrice(levels.take_profit_3, '#34d399')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCopyablePrice(price, color) {
            if (!price) {
                return `<div class="detail-card-value" style="color: ${color};">-</div>`;
            }
            // Raw value without thousand separators for clipboard
            const rawValue = getRawPriceString(price);
            return `
                <div class="detail-card-value copyable-price"
                     style="color: ${color}; cursor: pointer;"
                     onclick="copyToClipboard('${rawValue}')"
                     title="Klicken zum Kopieren: ${rawValue}">
                    ${formatDetailPrice(price)}
                </div>
            `;
        }

        function getRawPriceString(price) {
            if (!price) return '';
            // Return raw number without thousand separators
            if (price > 1000) return price.toFixed(0);
            if (price > 10) return price.toFixed(2);
            if (price > 0.01) return price.toFixed(4);
            return price.toFixed(6);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                showCopyFeedback(text);
            }).catch(err => {
                console.error('Copy failed:', err);
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopyFeedback(text);
            });
        }

        function showCopyFeedback(text) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'copy-toast';
            toast.innerHTML = `<span style="color: #34d399;">‚úì</span> ${text} kopiert`;
            document.body.appendChild(toast);

            // Remove after animation
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 1500);
        }

        function formatDetailPrice(price) {
            if (!price) return '-';
            if (price > 1000) return price.toLocaleString('de-CH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            if (price > 10) return price.toLocaleString('de-CH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (price > 0.01) return price.toLocaleString('de-CH', {minimumFractionDigits: 4, maximumFractionDigits: 4});
            return price.toLocaleString('de-CH', {minimumFractionDigits: 6, maximumFractionDigits: 6});
        }

        function renderTrendStrengthSection(trendStrength) {
            if (!trendStrength) {
                return `
                    <div class="consolidated-section">
                        <h3 class="section-title"><span class="icon">üìà</span> Trend-St√§rke</h3>
                        <div class="detail-card-sub" style="opacity: 0.6;">Nicht verf√ºgbar</div>
                    </div>
                `;
            }

            // Helper function to determine color and icon based on strength value
            const getStrengthStyle = (value) => {
                if (value === null) return { color: '#9ca3af', icon: '‚ûñ', label: 'N/A' };
                const absValue = Math.abs(value);
                if (value > 25) return { color: '#34d399', icon: 'üìà', label: 'Stark Long' };
                if (value > 10) return { color: '#86efac', icon: '‚ÜóÔ∏è', label: 'Long' };
                if (value < -25) return { color: '#f87171', icon: 'üìâ', label: 'Stark Short' };
                if (value < -10) return { color: '#fca5a5', icon: '‚ÜòÔ∏è', label: 'Short' };
                return { color: '#fbbf24', icon: '‚û°Ô∏è', label: 'Neutral' };
            };

            const h4Style = getStrengthStyle(trendStrength.h4);
            const d1Style = getStrengthStyle(trendStrength.d1);
            const w1Style = getStrengthStyle(trendStrength.w1);

            const formatValue = (val) => val !== null ? val.toFixed(1) : 'N/A';

            return `
                <div class="consolidated-section">
                    <h3 class="section-title"><span class="icon">üìà</span> Trend-St√§rke</h3>
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-card-title">4H</div>
                            <div class="detail-card-value" style="color: ${h4Style.color}">
                                ${h4Style.icon} ${formatValue(trendStrength.h4)}
                            </div>
                            <div class="detail-card-sub">${h4Style.label}</div>
                        </div>

                        <div class="detail-card">
                            <div class="detail-card-title">1D</div>
                            <div class="detail-card-value" style="color: ${d1Style.color}">
                                ${d1Style.icon} ${formatValue(trendStrength.d1)}
                            </div>
                            <div class="detail-card-sub">${d1Style.label}</div>
                        </div>

                        <div class="detail-card">
                            <div class="detail-card-title">1W</div>
                            <div class="detail-card-value" style="color: ${w1Style.color}">
                                ${w1Style.icon} ${formatValue(trendStrength.w1)}
                            </div>
                            <div class="detail-card-sub">${w1Style.label}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSignalsSection(setup) {
            const nhits = setup.nhits_signal || {};
            const hmm = setup.hmm_signal || {};
            const technical = setup.technical_signal || {};

            return `
                <div class="consolidated-section">
                    <h3 class="section-title"><span class="icon">üì°</span> Signale</h3>
                    <!-- NHITS Signal -->
                    <div class="detail-section">
                        <h4><span class="icon">üîÆ</span> NHITS (25%) <span class="detail-card-badge ${nhits.available ? 'available' : 'unavailable'}">${nhits.available ? '‚úì' : '‚úó'}</span></h4>
                        ${nhits.available ? `
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-card-title">Richtung</div>
                                <div class="detail-card-value" style="color: ${nhits.direction === 'long' ? '#34d399' : nhits.direction === 'short' ? '#f87171' : '#fbbf24'}">
                                    ${nhits.direction?.toUpperCase() || 'NEUTRAL'}
                                </div>
                                <div class="detail-card-sub">Trend: ${((nhits.trend_probability || 0) * 100).toFixed(0)}%</div>
                            </div>
                            ${nhits.forecast_change_1h !== null || nhits.forecast_change_24h !== null ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Prognose</div>
                                ${nhits.forecast_change_1h !== null ? `<div class="detail-card-sub">1h: <span class="${nhits.forecast_change_1h >= 0 ? 'forecast-positive' : 'forecast-negative'}">${nhits.forecast_change_1h >= 0 ? '+' : ''}${nhits.forecast_change_1h?.toFixed(2)}%</span></div>` : ''}
                                ${nhits.forecast_change_24h !== null ? `<div class="detail-card-sub">24h: <span class="${nhits.forecast_change_24h >= 0 ? 'forecast-positive' : 'forecast-negative'}">${nhits.forecast_change_24h >= 0 ? '+' : ''}${nhits.forecast_change_24h?.toFixed(2)}%</span></div>` : ''}
                            </div>
                            ` : ''}
                            ${nhits.model_confidence !== null ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Konfidenz</div>
                                <div class="detail-card-value">${((nhits.model_confidence || 0) * 100).toFixed(0)}%</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : '<div class="detail-card-sub" style="opacity: 0.6;">Nicht verf√ºgbar</div>'}
                    </div>

                    <!-- HMM Signal -->
                    <div class="detail-section">
                        <h4><span class="icon">üìä</span> HMM (20%) <span class="detail-card-badge ${hmm.available ? 'available' : 'unavailable'}">${hmm.available ? '‚úì' : '‚úó'}</span></h4>
                        ${hmm.available ? `
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-card-title">Regime</div>
                                <div class="detail-card-value">${formatRegime(hmm.regime)}</div>
                                <div class="detail-card-sub">${((hmm.regime_probability || 0) * 100).toFixed(0)}%</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-card-title">Score</div>
                                <div class="detail-card-value">${(hmm.signal_score || 0).toFixed(1)}</div>
                                <div class="detail-card-sub">${hmm.alignment || 'neutral'}</div>
                            </div>
                            ${hmm.regime_duration !== null ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Dauer</div>
                                <div class="detail-card-value">${hmm.regime_duration}</div>
                                <div class="detail-card-sub">Bars</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : '<div class="detail-card-sub" style="opacity: 0.6;">Nicht verf√ºgbar</div>'}
                    </div>

                    <!-- Technical Signal -->
                    <div class="detail-section">
                        <h4><span class="icon">üìà</span> Technisch (10%) <span class="detail-card-badge ${technical.available ? 'available' : 'unavailable'}">${technical.available ? '‚úì' : '‚úó'}</span></h4>
                        ${technical.available ? `
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-card-title">Alignment</div>
                                <div class="detail-card-value">${((technical.trend_alignment || 0) * 100).toFixed(0)}%</div>
                            </div>
                            ${technical.rsi !== null ? `
                            <div class="detail-card">
                                <div class="detail-card-title">RSI</div>
                                <div class="detail-card-value" style="color: ${technical.rsi < 30 ? '#34d399' : technical.rsi > 70 ? '#f87171' : '#fbbf24'}">
                                    ${technical.rsi?.toFixed(1)}
                                </div>
                            </div>
                            ` : ''}
                            <div class="detail-card">
                                <div class="detail-card-title">MACD</div>
                                <div class="detail-card-value" style="color: ${technical.macd_signal === 'bullish' ? '#34d399' : technical.macd_signal === 'bearish' ? '#f87171' : '#fbbf24'}">
                                    ${(technical.macd_signal || 'neutral').toUpperCase()}
                                </div>
                            </div>

                            ${technical.bb_position !== null ? `
                            <div class="detail-card">
                                <div class="detail-card-title">BB</div>
                                <div class="detail-card-value">${((technical.bb_position || 0) * 100).toFixed(0)}%</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : '<div class="detail-card-sub" style="opacity: 0.6;">Nicht verf√ºgbar</div>'}
                    </div>
                </div>
            `;
        }

        function renderPatternsSection(setup) {
            const tcn = setup.tcn_signal || {};
            const candlestick = setup.candlestick_signal || {};

            return `
                <div class="consolidated-section">
                    <h3 class="section-title"><span class="icon">üìê</span> Patterns</h3>
                    <!-- TCN Patterns -->
                    <div class="detail-section">
                        <h4><span class="icon">üìê</span> TCN (15%) <span class="detail-card-badge ${tcn.available ? 'available' : 'unavailable'}">${tcn.available ? '‚úì' : '‚úó'}</span></h4>
                        ${tcn.available ? `
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-card-title">Richtung</div>
                                <div class="detail-card-value" style="color: ${tcn.direction === 'long' ? '#34d399' : tcn.direction === 'short' ? '#f87171' : '#fbbf24'}">
                                    ${tcn.direction?.toUpperCase() || 'NEUTRAL'}
                                </div>
                                <div class="detail-card-sub">${((tcn.pattern_confidence || 0) * 100).toFixed(0)}%</div>
                            </div>
                            ${tcn.price_target ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Kursziel</div>
                                <div class="detail-card-value">${tcn.price_target?.toLocaleString('de-CH', {minimumFractionDigits: 2})}</div>
                            </div>
                            ` : ''}
                        </div>
                        ${tcn.patterns && tcn.patterns.length > 0 ? `
                        <div class="pattern-list">
                            ${tcn.patterns.map(p => `<span class="pattern-tag ${tcn.direction === 'long' ? 'bullish' : tcn.direction === 'short' ? 'bearish' : ''}">${formatPatternName(p)}</span>`).join('')}
                        </div>
                        ` : ''}
                        ` : '<div class="detail-card-sub" style="opacity: 0.6;">Nicht verf√ºgbar</div>'}
                    </div>

                    <!-- Candlestick Patterns -->
                    <div class="detail-section">
                        <h4><span class="icon">üïØÔ∏è</span> Candlestick (10%) <span class="detail-card-badge ${candlestick.available ? 'available' : 'unavailable'}">${candlestick.available ? '‚úì' : '‚úó'}</span></h4>
                        ${candlestick.available ? `
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-card-title">Richtung</div>
                                <div class="detail-card-value" style="color: ${candlestick.direction === 'long' ? '#34d399' : candlestick.direction === 'short' ? '#f87171' : '#fbbf24'}">
                                    ${candlestick.direction?.toUpperCase() || 'NEUTRAL'}
                                </div>
                                <div class="detail-card-sub">${((candlestick.pattern_strength || 0) * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                        ${candlestick.patterns && candlestick.patterns.length > 0 ? `
                        <div class="pattern-list">
                            ${candlestick.patterns.map(p => `<span class="pattern-tag ${candlestick.direction === 'long' ? 'bullish' : candlestick.direction === 'short' ? 'bearish' : ''}">${formatPatternName(p)}</span>`).join('')}
                        </div>
                        ` : ''}
                        ` : '<div class="detail-card-sub" style="opacity: 0.6;">Nicht verf√ºgbar</div>'}
                    </div>
                </div>
            `;
        }

        function renderCnnLstmSection(setup) {
            const cnnLstm = setup.cnn_lstm_signal || {};

            return `
                <div class="consolidated-section">
                    <h3 class="section-title"><span class="icon">üß†</span> CNN-LSTM (20%)</h3>
                    <div class="detail-section">
                        <h4><span class="icon">üß†</span> Multi-Task <span class="detail-card-badge ${cnnLstm.available ? 'available' : 'unavailable'}">${cnnLstm.available ? '‚úì' : '‚úó'}</span></h4>
                        ${cnnLstm.available ? `
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-card-title">Preis-Richtung</div>
                                <div class="detail-card-value" style="color: ${cnnLstm.price_direction === 'long' ? '#34d399' : cnnLstm.price_direction === 'short' ? '#f87171' : '#fbbf24'}">
                                    ${cnnLstm.price_direction?.toUpperCase() || 'NEUTRAL'}
                                </div>
                                <div class="detail-card-sub">${((cnnLstm.price_confidence || 0) * 100).toFixed(0)}%</div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-card-title">Regime</div>
                                <div class="detail-card-value">${formatRegime(cnnLstm.regime)}</div>
                                <div class="detail-card-sub">${((cnnLstm.regime_probability || 0) * 100).toFixed(0)}%</div>
                            </div>
                            ${cnnLstm.forecast_change_1h !== null || cnnLstm.forecast_change_1d !== null ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Prognose</div>
                                ${cnnLstm.forecast_change_1h !== null ? `<div class="detail-card-sub">1h: <span class="${cnnLstm.forecast_change_1h >= 0 ? 'forecast-positive' : 'forecast-negative'}">${cnnLstm.forecast_change_1h >= 0 ? '+' : ''}${cnnLstm.forecast_change_1h?.toFixed(2)}%</span></div>` : ''}
                                ${cnnLstm.forecast_change_1d !== null ? `<div class="detail-card-sub">1d: <span class="${cnnLstm.forecast_change_1d >= 0 ? 'forecast-positive' : 'forecast-negative'}">${cnnLstm.forecast_change_1d >= 0 ? '+' : ''}${cnnLstm.forecast_change_1d?.toFixed(2)}%</span></div>` : ''}
                            </div>
                            ` : ''}
                        </div>
                        ${cnnLstm.patterns && cnnLstm.patterns.length > 0 ? `
                        <div class="pattern-list">
                            ${cnnLstm.patterns.map(p => `<span class="pattern-tag ${cnnLstm.price_direction === 'long' ? 'bullish' : cnnLstm.price_direction === 'short' ? 'bearish' : ''}">${formatPatternName(p)}</span>`).join('')}
                        </div>
                        ` : ''}
                        ${cnnLstm.model_version ? `<div class="detail-card-sub" style="opacity: 0.5; margin-top: 8px; font-size: 11px;">Model: ${cnnLstm.model_version}</div>` : ''}
                        ` : '<div class="detail-card-sub" style="opacity: 0.6;">Nicht verf√ºgbar</div>'}
                    </div>
                </div>
            `;
        }

        function renderLlmSection() {
            return `
                <div class="consolidated-section" id="llmSection">
                    <h3 class="section-title"><span class="icon">ü§ñ</span> LLM Analyse</h3>
                    <div id="llmContent">
                        <div class="llm-prompt-box">
                            <p>Detaillierte Empfehlung mit Entry/Exit-Levels</p>
                            <button class="btn btn-primary" onclick="triggerLlmAnalysis()">
                                ü§ñ Analyse starten
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function triggerLlmAnalysis() {
            if (!currentDetailSymbol) return;

            const container = document.getElementById('llmContent');
            container.innerHTML = `
                <div class="llm-loading">
                    <div class="spinner"></div>
                    <span>LLM-Analyse wird generiert...</span>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/analyze/${currentDetailSymbol}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeframe: currentDetailTimeframe, include_rag: true, include_llm: true })
                });

                if (!response.ok) {
                    throw new Error('Analyse konnte nicht geladen werden');
                }

                const data = await response.json();
                llmAnalysisLoaded = true;

                container.innerHTML = renderLlmContent(data);
            } catch (error) {
                console.error('LLM Analyse Fehler:', error);
                container.innerHTML = `
                    <div class="llm-analysis-box" style="border-left-color: #f87171;">
                        <p>Die LLM-Analyse konnte nicht geladen werden.</p>
                        <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 0.5rem;">${error.message}</p>
                        <button class="btn btn-secondary" style="margin-top: 0.75rem;" onclick="triggerLlmAnalysis()">Erneut versuchen</button>
                    </div>
                `;
            }
        }

        function renderLlmContent(data) {
            return `
                ${data.analysis_summary ? `
                <div class="detail-section">
                    <h4><span class="icon">ü§ñ</span> LLM Kurzanalyse</h4>
                    <div class="llm-analysis-box">
                        <p>${data.analysis_summary}</p>
                    </div>
                </div>
                ` : ''}

                ${data.entry_exit_levels ? `
                <div class="detail-section">
                    <h4><span class="icon">üéØ</span> Entry/Exit</h4>
                    <div class="detail-grid">
                        ${data.entry_exit_levels.entry_price ? `
                        <div class="detail-card">
                            <div class="detail-card-title">Entry</div>
                            <div class="detail-card-value" style="color: #64c8ff">${data.entry_exit_levels.entry_price?.toFixed(2)}</div>
                        </div>
                        ` : ''}
                        ${data.entry_exit_levels.stop_loss ? `
                        <div class="detail-card">
                            <div class="detail-card-title">SL</div>
                            <div class="detail-card-value" style="color: #f87171">${data.entry_exit_levels.stop_loss?.toFixed(2)}</div>
                        </div>
                        ` : ''}
                        ${data.entry_exit_levels.take_profit_1 ? `
                        <div class="detail-card">
                            <div class="detail-card-title">TP1</div>
                            <div class="detail-card-value" style="color: #34d399">${data.entry_exit_levels.take_profit_1?.toFixed(2)}</div>
                        </div>
                        ` : ''}
                        ${data.entry_exit_levels.take_profit_2 ? `
                        <div class="detail-card">
                            <div class="detail-card-title">TP2</div>
                            <div class="detail-card-value" style="color: #34d399">${data.entry_exit_levels.take_profit_2?.toFixed(2)}</div>
                        </div>
                        ` : ''}
                        ${data.entry_exit_levels.risk_reward_ratio ? `
                        <div class="detail-card">
                            <div class="detail-card-title">R:R</div>
                            <div class="detail-card-value">${data.entry_exit_levels.risk_reward_ratio?.toFixed(2)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                ${data.risk_assessment ? `
                <div class="detail-section">
                    <h4><span class="icon">‚ö†Ô∏è</span> Risiko</h4>
                    <div class="llm-analysis-box" style="border-left-color: #f59e0b;">
                        <p>${data.risk_assessment}</p>
                    </div>
                </div>
                ` : ''}

                ${data.rationale ? `
                <div class="detail-section">
                    <h4><span class="icon">üí°</span> Begr√ºndung</h4>
                    <div class="llm-analysis-box" style="border-left-color: #8b5cf6;">
                        <p>${data.rationale}</p>
                    </div>
                </div>
                ` : ''}

                <div style="margin-top: 0.5rem; font-size: 0.65rem; opacity: 0.5;">
                    ${data.analysis_duration_ms ? `${data.analysis_duration_ms?.toFixed(0)}ms` : ''}
                    ${data.rag_sources_used ? `‚Ä¢ ${data.rag_sources_used} RAG` : ''}
                    ${data.llm_model ? `‚Ä¢ ${data.llm_model}` : ''}
                </div>
            `;
        }

        // Hilfsfunktionen
        function formatRegime(regime) {
            const regimeMap = {
                'bull_trend': 'üêÇ Bull Trend',
                'bear_trend': 'üêª Bear Trend',
                'sideways': '‚ÜîÔ∏è Sideways',
                'high_volatility': '‚ö° High Volatility'
            };
            return regimeMap[regime] || regime || 'Unbekannt';
        }

        function formatPatternName(pattern) {
            if (!pattern) return 'Unknown';
            // snake_case zu Title Case
            return pattern
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        // =============================================
        // Symbol Picker Funktionen
        // =============================================

        // Symbole werden dynamisch vom Data Service geladen
        let allSymbolsFromAPI = [];
        let currentPickerCategory = 'all';
        let selectedPickerSymbol = null;
        let watchlistSymbols = [];

        // Kategorisierung der Symbole
        function categorizeSymbol(symbol) {
            // Crypto
            const cryptoPrefixes = ['BTC', 'ETH', 'XRP', 'SOL', 'ADA', 'DOT', 'LNK', 'BNB', 'AVX', 'MTC', 'BCH', 'DOG', 'LTC', 'UNI', 'XLM', 'XTZ', 'KSM'];
            if (cryptoPrefixes.some(p => symbol.startsWith(p))) return 'crypto';

            // Metalle & Commodities
            if (symbol.startsWith('XAU') || symbol.startsWith('XAG')) return 'metals';
            if (symbol.startsWith('XTI') || symbol.startsWith('WTI') || symbol.startsWith('BRENT')) return 'commodities';

            // Indizes
            const indexPatterns = ['US30', 'US500', 'NAS100', 'GER40', 'UK100', 'JP225', 'AUS200', 'FRA40', 'EURO50'];
            if (indexPatterns.some(p => symbol === p || symbol.startsWith(p))) return 'indices';

            // Forex: 6 Zeichen, bekannte W√§hrungspaare
            const currencies = ['USD', 'EUR', 'GBP', 'JPY', 'CHF', 'AUD', 'CAD', 'NZD'];
            if (symbol.length === 6) {
                const base = symbol.substring(0, 3);
                const quote = symbol.substring(3, 6);
                if (currencies.includes(base) && currencies.includes(quote)) return 'forex';
            }

            return 'other';
        }

        // Symbol-Liste initialisieren
        document.addEventListener('DOMContentLoaded', () => {
            loadAllSymbols();
            loadWatchlistSymbols();
        });

        async function loadAllSymbols() {
            try {
                const response = await fetch('/data/api/v1/symbols');
                if (response.ok) {
                    allSymbolsFromAPI = await response.json();
                    renderSymbolList();
                }
            } catch (error) {
                console.error('Fehler beim Laden der Symbole vom Data Service:', error);
                // Fallback
                allSymbolsFromAPI = ['BTCUSD', 'ETHUSD', 'EURUSD', 'GBPUSD', 'USDJPY', 'XAUUSD'];
                renderSymbolList();
            }
        }

        async function loadWatchlistSymbols() {
            try {
                const response = await fetch(`${API_BASE}/watchlist/`);
                const data = await response.json();
                watchlistSymbols = (data.items || []).map(item => item.symbol);
                renderSymbolList();
            } catch (error) {
                console.error('Fehler beim Laden der Watchlist-Symbole:', error);
            }
        }

        function selectCategory(category) {
            currentPickerCategory = category;

            // Button-Status aktualisieren - nur via data-category Attribut
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === category) {
                    btn.classList.add('active');
                }
            });

            renderSymbolList();
        }

        function filterSymbols() {
            renderSymbolList();
        }

        function renderSymbolList() {
            const container = document.getElementById('symbolList');
            if (!container) return;

            const searchTerm = document.getElementById('symbolSearch')?.value?.toUpperCase() || '';

            let symbols = [...allSymbolsFromAPI];

            // Nach Kategorie filtern
            if (currentPickerCategory !== 'all') {
                symbols = symbols.filter(s => categorizeSymbol(s) === currentPickerCategory);
            }

            // Nach Suchbegriff filtern
            if (searchTerm) {
                symbols = symbols.filter(s => s.includes(searchTerm));
            }

            // Sortieren: Watchlist-Symbole zuerst, dann alphabetisch
            symbols.sort((a, b) => {
                const aInWatchlist = watchlistSymbols.includes(a);
                const bInWatchlist = watchlistSymbols.includes(b);
                if (aInWatchlist && !bInWatchlist) return -1;
                if (!aInWatchlist && bInWatchlist) return 1;
                return a.localeCompare(b);
            });

            container.innerHTML = symbols.map(symbol => {
                const inWatchlist = watchlistSymbols.includes(symbol);
                return `<button class="symbol-btn ${inWatchlist ? 'in-watchlist' : ''}"
                                onclick="openSymbolTimeframeModal('${symbol}')"
                                title="${symbol}${inWatchlist ? ' (in Watchlist)' : ''}">${symbol}</button>`;
            }).join('');

            // Anzahl anzeigen
            const countEl = document.getElementById('symbolCount');
            if (countEl) {
                countEl.textContent = `(${symbols.length})`;
            }
        }

        // Timeframe Modal f√ºr Symbol-Auswahl
        function openSymbolTimeframeModal(symbol) {
            selectedPickerSymbol = symbol;
            document.getElementById('timeframeModalTitle').textContent = `${symbol} - Timeframe w√§hlen`;
            document.getElementById('timeframeModal').classList.add('active');
        }

        function closeTimeframeModal() {
            document.getElementById('timeframeModal').classList.remove('active');
            selectedPickerSymbol = null;
        }

        document.getElementById('timeframeModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeTimeframeModal();
        });

        function selectTimeframeAndAnalyze(timeframe) {
            if (!selectedPickerSymbol) {
                console.error('selectTimeframeAndAnalyze: Kein Symbol ausgew√§hlt');
                return;
            }

            // Symbol zwischenspeichern bevor Modal geschlossen wird
            const symbol = selectedPickerSymbol;

            // Timeframe-Modal schliessen (setzt selectedPickerSymbol auf null)
            closeTimeframeModal();

            // Detail-Modal √∂ffnen
            openDetailModal(symbol, timeframe);

            // Auch Chart laden
            loadChart(symbol);

            // Timeframe im Chart-Dropdown setzen
            const intervalMap = {
                'M1': '1', 'M5': '5', 'M15': '15', 'M30': '30',
                'H1': '60', 'H4': '240', 'D1': 'D', 'W1': 'W'
            };
            if (intervalMap[timeframe]) {
                document.getElementById('chartInterval').value = intervalMap[timeframe];
            }
        }

        // =============================================
        // Scan All Symbols Funktion
        // =============================================

        let scanAllRunning = false;
        let scanAllAborted = false;

        async function scanAllSymbols() {
            if (scanAllRunning) {
                // Abbrechen
                scanAllAborted = true;
                return;
            }

            if (allSymbolsFromAPI.length === 0) {
                alert('Keine Symbole geladen. Bitte warten.');
                return;
            }

            scanAllRunning = true;
            scanAllAborted = false;

            const btn = document.getElementById('scanAllBtn');
            const progress = document.getElementById('scanProgress');
            const progressFill = document.getElementById('scanProgressFill');
            const progressSymbol = document.getElementById('scanProgressSymbol');
            const progressCount = document.getElementById('scanProgressCount');

            btn.textContent = 'Abbrechen';
            btn.style.background = 'rgba(239, 68, 68, 0.2)';
            progress.style.display = 'block';

            const symbols = [...allSymbolsFromAPI];
            const total = symbols.length;
            let scanned = 0;
            let errors = 0;

            for (const symbol of symbols) {
                if (scanAllAborted) break;

                progressSymbol.textContent = symbol;
                progressCount.textContent = `${scanned + 1}/${total}`;
                progressFill.style.width = `${((scanned + 1) / total) * 100}%`;

                try {
                    // Setup f√ºr H1 Timeframe abrufen (schnellster Scan)
                    const response = await fetch(`${API_BASE}/setups/${symbol}?timeframe=H1`);
                    if (response.ok) {
                        const setup = await response.json();
                        setupsCache[symbol] = setup;
                    }
                } catch (error) {
                    errors++;
                    console.error(`Scan-Fehler f√ºr ${symbol}:`, error);
                }

                scanned++;

                // Kleine Pause um Server nicht zu √ºberlasten
                await new Promise(r => setTimeout(r, 100));
            }

            // Fertig
            scanAllRunning = false;
            btn.textContent = 'Alle scannen';
            btn.style.background = '';

            if (scanAllAborted) {
                progressSymbol.textContent = 'Abgebrochen';
                progressCount.textContent = `${scanned}/${total}`;
            } else {
                progressSymbol.textContent = 'Fertig';
                progressCount.textContent = `${scanned}/${total}${errors > 0 ? ` (${errors} Fehler)` : ''}`;
                progressFill.style.width = '100%';
            }

            // Setups neu laden
            await loadSetups();

            // Progress nach 3 Sekunden ausblenden
            setTimeout(() => {
                progress.style.display = 'none';
                progressFill.style.width = '0%';
            }, 3000);
        }
    </script>
</body>
</html>
