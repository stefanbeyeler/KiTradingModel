<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Workplace - Setups & Analyse</title>
    <!-- TradingView Widget Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0.75rem 1rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.85rem;
        }

        h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Market Hours Section */
        .market-hours {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .market-hours-title {
            color: #94a3b8;
            margin-right: 0.25rem;
        }

        .market {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }

        .market.open {
            background: rgba(16, 185, 129, 0.15);
        }

        .market.closed {
            background: rgba(239, 68, 68, 0.1);
            opacity: 0.6;
        }

        .market-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ef4444;
        }

        .market.open .market-dot {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .market-name {
            font-weight: 500;
        }

        .market-time {
            color: #94a3b8;
            font-size: 0.7rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scanner-badge {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: rgba(16, 185, 129, 0.15);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .scanner-badge.stopped {
            background: rgba(239, 68, 68, 0.15);
        }

        .scanner-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
        }

        .scanner-badge.stopped .scanner-dot {
            background: #ef4444;
        }

        .btn {
            padding: 0.35rem 0.7rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .btn-sm {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .btn-sm:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Stats Row - Compact */
        .stats-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34d399;
        }

        .stat-value.warning {
            color: #fbbf24;
        }

        .stat-label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 0.75rem;
        }

        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .section-header select {
            padding: 0.25rem 0.5rem;
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            color: #e8e8e8;
            font-size: 0.75rem;
        }

        .section-header select option {
            background: #1a1a2e;
            color: #e8e8e8;
        }

        /* Setups Grid - Compact */
        .setups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.6rem;
        }

        .setup-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s;
        }

        .setup-card:hover {
            transform: translateY(-2px);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .setup-card.long {
            border-left: 3px solid #10b981;
        }

        .setup-card.short {
            border-left: 3px solid #ef4444;
        }

        .setup-card.neutral {
            border-left: 3px solid #fbbf24;
        }

        .setup-card.market-closed {
            opacity: 0.5;
        }

        .setup-card.selected {
            border: 2px solid #64c8ff;
            background: rgba(100, 200, 255, 0.1);
        }

        .setup-card:hover {
            cursor: pointer;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* TradingView Chart Section */
        .chart-section {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .chart-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-symbol {
            color: #64c8ff;
            font-size: 1rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-controls select {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e8e8e8;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .chart-controls select option {
            background: #1a1a2e;
            color: #e8e8e8;
            padding: 0.5rem;
        }

        .chart-container {
            height: 400px;
            background: #131722;
        }

        /* Chart Fullscreen Mode */
        .chart-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            margin: 0;
            border-radius: 0;
            border: none;
        }

        .chart-section.fullscreen .chart-container {
            height: calc(100vh - 50px);
        }

        .chart-section.fullscreen .chart-header {
            padding: 0.8rem 1.5rem;
        }

        .chart-expand-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e8e8e8;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }

        .chart-expand-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .chart-expand-btn svg {
            width: 14px;
            height: 14px;
        }

        .chart-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .chart-placeholder .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.3;
        }

        .setup-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .setup-symbol {
            font-size: 1rem;
            font-weight: 600;
        }

        .setup-symbol .market-indicator {
            font-size: 0.65rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            margin-left: 0.3rem;
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .setup-symbol .market-indicator.open {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .setup-score {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .score-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .score-value.high { color: #10b981; }
        .score-value.moderate { color: #fbbf24; }
        .score-value.low { color: #94a3b8; }

        .setup-direction {
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .setup-direction.long {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .setup-direction.short {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .setup-direction.neutral {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .setup-signals {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.4rem;
            flex-wrap: wrap;
        }

        .signal-tag {
            padding: 0.1rem 0.35rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            font-size: 0.65rem;
            opacity: 0.5;
        }

        .signal-tag.available {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
            opacity: 1;
        }

        .setup-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            opacity: 0.6;
        }

        /* Sidebar - Compact */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-card h3 {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            color: #94a3b8;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .sidebar-header h3 {
            margin-bottom: 0;
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            color: #64c8ff;
            background: rgba(255, 255, 255, 0.1);
        }

        .refresh-btn svg {
            width: 14px;
            height: 14px;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }

        .watchlist-item:last-child {
            border-bottom: none;
        }

        .watchlist-symbol {
            font-weight: 500;
        }

        .watchlist-symbol.favorite::before {
            content: '‚òÖ ';
            color: #fbbf24;
        }

        .watchlist-score {
            font-weight: 600;
        }

        .watchlist-score.high { color: #10b981; }
        .watchlist-score.moderate { color: #fbbf24; }
        .watchlist-score.low { color: #94a3b8; }

        .scanner-info p {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
            font-size: 0.75rem;
        }

        .scanner-info .label {
            opacity: 0.6;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 2rem;
            opacity: 0.6;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            opacity: 0.6;
            font-size: 0.85rem;
        }

        /* Modal - Compact */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #e8e8e8;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .modal-body {
            padding: 1rem;
        }

        .analysis-section {
            margin-bottom: 1rem;
        }

        .analysis-section h4 {
            color: #34d399;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .analysis-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            line-height: 1.5;
            font-size: 0.85rem;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .level-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .level-item .value {
            font-size: 1rem;
            font-weight: 600;
            color: #ffd54f;
        }

        .level-item .label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Detail Button in Setup Card */
        .setup-detail-btn {
            background: rgba(100, 200, 255, 0.15);
            border: 1px solid rgba(100, 200, 255, 0.3);
            color: #64c8ff;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .setup-detail-btn:hover {
            background: rgba(100, 200, 255, 0.25);
            border-color: rgba(100, 200, 255, 0.5);
        }

        .setup-detail-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Detail Modal - Gr√∂sseres Modal f√ºr alle Details */
        .detail-modal {
            max-width: 900px;
            width: 95%;
        }

        .detail-modal .modal-body {
            padding: 0;
        }

        .detail-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .detail-tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .detail-tab:hover {
            color: #e8e8e8;
            background: rgba(255, 255, 255, 0.05);
        }

        .detail-tab.active {
            color: #64c8ff;
            border-bottom-color: #64c8ff;
            background: rgba(100, 200, 255, 0.1);
        }

        .detail-content {
            padding: 1rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .detail-panel {
            display: none;
        }

        .detail-panel.active {
            display: block;
        }

        /* Detail Sections */
        .detail-section {
            margin-bottom: 1.25rem;
        }

        .detail-section h4 {
            font-size: 0.9rem;
            color: #64c8ff;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-section h4 .icon {
            font-size: 1rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .detail-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .detail-card-title {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-card-badge {
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .detail-card-badge.available {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .detail-card-badge.unavailable {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .detail-card-value {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .detail-card-sub {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* Pattern List */
        .pattern-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .pattern-tag {
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .pattern-tag.bullish {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .pattern-tag.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* LLM Analysis Box */
        .llm-analysis-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            border-left: 3px solid #64c8ff;
        }

        .llm-analysis-box p {
            line-height: 1.6;
            font-size: 0.85rem;
        }

        .llm-loading {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .llm-loading .spinner {
            width: 20px;
            height: 20px;
        }

        /* Score Meter */
        .score-meter {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .score-bar-fill.high {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .score-bar-fill.moderate {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .score-bar-fill.low {
            background: linear-gradient(90deg, #6b7280, #9ca3af);
        }

        .score-value-large {
            font-size: 1.5rem;
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }

        /* Forecast Table */
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
        }

        .forecast-table th,
        .forecast-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .forecast-table th {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 500;
        }

        .forecast-table td {
            font-size: 0.85rem;
        }

        .forecast-positive {
            color: #34d399;
        }

        .forecast-negative {
            color: #f87171;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .market-hours {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .header-row {
                flex-wrap: wrap;
            }
            .setups-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-row">
                <div class="header-left">
                    <a href="index.html" class="back-link">‚Üê Dashboard</a>
                    <h1>Trading Workplace</h1>
                </div>

                <!-- Market Hours -->
                <div class="market-hours" id="marketHours">
                    <span class="market-hours-title">M√§rkte:</span>
                    <div class="market" id="market-crypto">
                        <span class="market-dot"></span>
                        <span class="market-name">Crypto</span>
                    </div>
                    <div class="market" id="market-forex">
                        <span class="market-dot"></span>
                        <span class="market-name">Forex</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-us">
                        <span class="market-dot"></span>
                        <span class="market-name">US</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-eu">
                        <span class="market-dot"></span>
                        <span class="market-name">EU</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-asia">
                        <span class="market-dot"></span>
                        <span class="market-name">Asia</span>
                        <span class="market-time"></span>
                    </div>
                </div>

                <div class="header-right">
                    <div class="scanner-badge" id="scannerBadge">
                        <span class="scanner-dot"></span>
                        <span id="scannerText">Scanner</span>
                    </div>
                    <button class="btn btn-sm" onclick="triggerScan()">Scan</button>
                    <button class="btn btn-sm" onclick="toggleScanner()" id="toggleBtn">Stop</button>
                    <a href="config-workplace.html" class="btn btn-sm">Config</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" id="totalScanned">-</div>
                <div class="stat-label">Gescannt</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highConfidence">-</div>
                <div class="stat-label">High Conf.</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="openMarketsCount">-</div>
                <div class="stat-label">M√§rkte offen</div>
            </div>
            <div class="stat-item">
                <div class="stat-value warning" id="alertsTriggered">-</div>
                <div class="stat-label">Alerts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastScan">-</div>
                <div class="stat-label">Letzter Scan</div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Setups Section -->
            <div class="setups-section">
                <div class="section-header">
                    <span>Top Trading-Setups</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="marketFilter" onchange="loadSetups()">
                            <option value="open" selected>Nur offene M√§rkte</option>
                            <option value="">Alle M√§rkte</option>
                            <option value="crypto">Crypto</option>
                            <option value="forex">Forex</option>
                            <option value="stocks">Aktien/Indizes</option>
                        </select>
                        <select id="directionFilter" onchange="loadSetups()">
                            <option value="">Alle</option>
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                    </div>
                </div>
                <div id="setupsContainer" class="setups-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Lade Setups...</p>
                    </div>
                </div>

                <!-- TradingView Chart -->
                <div class="chart-section" id="chartSection">
                    <div class="chart-header">
                        <h3>
                            <span>Chart:</span>
                            <span class="chart-symbol" id="chartSymbol">Kein Symbol ausgew√§hlt</span>
                        </h3>
                        <div class="chart-controls">
                            <select id="chartInterval" onchange="updateChart()">
                                <option value="1">1 Min</option>
                                <option value="5">5 Min</option>
                                <option value="15">15 Min</option>
                                <option value="60" selected>1 Std</option>
                                <option value="240">4 Std</option>
                                <option value="D">1 Tag</option>
                                <option value="W">1 Woche</option>
                            </select>
                            <select id="chartStyle" onchange="updateChart()">
                                <option value="1" selected>Kerzen</option>
                                <option value="8">Heikin-Ashi</option>
                                <option value="0">Balken</option>
                                <option value="3">Linie</option>
                                <option value="9">Hollow Kerzen</option>
                            </select>
                            <button class="chart-expand-btn" id="chartExpandBtn" onclick="toggleChartFullscreen()" title="Vollbild (Esc zum Schliessen)">
                                <svg id="expandIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                                </svg>
                                <span id="expandText">Vollbild</span>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" id="chartContainer">
                        <div class="chart-placeholder">
                            <div class="icon">üìä</div>
                            <p>Klicken Sie auf ein Setup, um das Chart anzuzeigen</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3>Watchlist</h3>
                        <button class="refresh-btn" onclick="loadWatchlist()" title="Aktualisieren">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                        </button>
                    </div>
                    <div id="watchlistContainer">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>Scanner-Status</h3>
                    <div class="scanner-info" id="scannerInfo">
                        <p><span class="label">Status</span><span id="scanStatus">-</span></p>
                        <p><span class="label">Intervall</span><span id="scanInterval">-</span></p>
                        <p><span class="label">Letzter Scan</span><span id="lastScanTime">-</span></p>
                        <p><span class="label">N√§chster Scan</span><span id="nextScanTime">-</span></p>
                        <p><span class="label">Fehler</span><span id="errorCount">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Analyse</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analysiere...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal - Alle Signal-Informationen -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal detail-modal">
            <div class="modal-header">
                <h2 id="detailModalTitle">Setup Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="detail-tabs">
                <button class="detail-tab active" onclick="switchDetailTab('overview')">√úbersicht</button>
                <button class="detail-tab" onclick="switchDetailTab('signals')">Signale</button>
                <button class="detail-tab" onclick="switchDetailTab('patterns')">Patterns</button>
                <button class="detail-tab" onclick="switchDetailTab('llm')">LLM Analyse</button>
            </div>
            <div class="detail-content">
                <!-- Overview Panel -->
                <div class="detail-panel active" id="panel-overview">
                    <div id="detailOverviewContent">
                        <div class="loading"><div class="spinner"></div><p>Lade Details...</p></div>
                    </div>
                </div>

                <!-- Signals Panel -->
                <div class="detail-panel" id="panel-signals">
                    <div id="detailSignalsContent">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Patterns Panel -->
                <div class="detail-panel" id="panel-patterns">
                    <div id="detailPatternsContent">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- LLM Analysis Panel -->
                <div class="detail-panel" id="panel-llm">
                    <div id="detailLlmContent">
                        <div class="llm-loading">
                            <div class="spinner"></div>
                            <span>LLM-Analyse wird geladen...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/workplace/api/v1';
        let scannerRunning = true;
        let marketStatus = {};

        // Symbol-Kategorien f√ºr Markt-Filterung
        const SYMBOL_CATEGORIES = {
            crypto: ['BTCUSD', 'ETHUSD', 'XRPUSD', 'SOLUSD', 'ADAUSD', 'DOTUSD', 'LINKUSD', 'BNBUSD'],
            forex: ['EURUSD', 'GBPUSD', 'USDJPY', 'USDCHF', 'AUDUSD', 'USDCAD', 'NZDUSD', 'EURGBP', 'EURJPY', 'GBPJPY'],
            us_stocks: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'US500', 'US100', 'US30'],
            eu_stocks: ['DE40', 'UK100', 'FR40', 'EU50'],
            asia_stocks: ['JP225', 'HK50', 'AU200'],
            metals: ['XAUUSD', 'XAGUSD']
        };

        // Display timezone from settings (Europe/Zurich)
        const DISPLAY_TIMEZONE = 'Europe/Zurich';

        // TradingView Chart State
        let currentChartSymbol = null;
        let tvWidget = null;
        let tradingViewConfig = {
            default_interval: '60',
            default_style: '1',
            theme: 'dark',
            indicators: {
                sma: true,
                ema: false,
                rsi: true,
                macd: false,
                bollinger: false,
                volume: true
            },
            exchanges: {
                crypto: 'BITSTAMP',
                forex: 'FX',
                stocks: 'NASDAQ'
            }
        };

        // TradingView Indikator-Mapping
        const TV_INDICATOR_MAP = {
            sma: 'MASimple@tv-basicstudies',
            ema: 'MAExp@tv-basicstudies',
            rsi: 'RSI@tv-basicstudies',
            macd: 'MACD@tv-basicstudies',
            bollinger: 'BB@tv-basicstudies',
            volume: 'Volume@tv-basicstudies'
        };

        // Symbol mapping for TradingView (unser Format -> TradingView Format)
        const TV_SYMBOL_MAP = {
            'BTCUSD': 'BITSTAMP:BTCUSD',
            'ETHUSD': 'BITSTAMP:ETHUSD',
            'XRPUSD': 'BITSTAMP:XRPUSD',
            'SOLUSD': 'COINBASE:SOLUSD',
            'ADAUSD': 'COINBASE:ADAUSD',
            'DOTUSD': 'KRAKEN:DOTUSD',
            'LINKUSD': 'COINBASE:LINKUSD',
            'BNBUSD': 'BINANCE:BNBUSD',
            'EURUSD': 'FX:EURUSD',
            'GBPUSD': 'FX:GBPUSD',
            'USDJPY': 'FX:USDJPY',
            'USDCHF': 'FX:USDCHF',
            'AUDUSD': 'FX:AUDUSD',
            'USDCAD': 'FX:USDCAD',
            'NZDUSD': 'FX:NZDUSD',
            'EURGBP': 'FX:EURGBP',
            'EURJPY': 'FX:EURJPY',
            'GBPJPY': 'FX:GBPJPY',
            'XAUUSD': 'TVC:GOLD',
            'XAGUSD': 'TVC:SILVER',
            'AAPL': 'NASDAQ:AAPL',
            'MSFT': 'NASDAQ:MSFT',
            'GOOGL': 'NASDAQ:GOOGL',
            'AMZN': 'NASDAQ:AMZN',
            'NVDA': 'NASDAQ:NVDA',
            'TSLA': 'NASDAQ:TSLA',
            'META': 'NASDAQ:META',
            'US500': 'FOREXCOM:SPXUSD',
            'US100': 'NASDAQ:NDX',
            'US30': 'DJ:DJI',
            'DE40': 'XETR:DAX',
            'UK100': 'CAPITALCOM:UK100',
            'FR40': 'EURONEXT:PX1',
            'EU50': 'TVC:SX5E',
            'JP225': 'TVC:NI225',
            'HK50': 'HSI:HSI',
            'AU200': 'PEPPERSTONE:AUS200'
        };

        // Market Hours (in UTC) - will be converted to local time for display
        const MARKET_HOURS_UTC = {
            crypto: { open: 0, close: 24 }, // 24/7
            forex: { sundayOpen: 22, fridayClose: 21 }, // Sun 22:00 - Fri 21:00 UTC
            us: { open: 14.5, close: 21 }, // 14:30-21:00 UTC
            eu: { open: 8, close: 16.5 }, // 08:00-16:30 UTC
            asia: { open: 0, close: 6 } // 00:00-06:00 UTC
        };

        // TradingView-Konfiguration laden
        async function loadTradingViewConfig() {
            try {
                const response = await fetch(`${API_BASE}/config/tradingview`);
                if (response.ok) {
                    const config = await response.json();
                    // Merge mit Defaults
                    tradingViewConfig = {
                        ...tradingViewConfig,
                        ...config,
                        indicators: { ...tradingViewConfig.indicators, ...config.indicators },
                        exchanges: { ...tradingViewConfig.exchanges, ...config.exchanges }
                    };

                    // Default-Werte f√ºr Dropdowns setzen
                    if (config.default_interval) {
                        document.getElementById('chartInterval').value = config.default_interval;
                    }
                    if (config.default_style) {
                        document.getElementById('chartStyle').value = config.default_style;
                    }

                    console.log('TradingView-Konfiguration geladen:', tradingViewConfig);
                }
            } catch (error) {
                console.warn('TradingView-Konfiguration konnte nicht geladen werden:', error);
            }
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTradingViewConfig();
            updateMarketHours();
            loadSetups();
            loadWatchlist();
            loadScannerStatus();

            // Regelm√§ssige Updates
            setInterval(updateMarketHours, 60000); // Jede Minute
            setInterval(loadScannerStatus, 5000);  // Alle 5 Sekunden
            setInterval(loadSetups, 15000);        // Alle 15 Sekunden
            setInterval(loadWatchlist, 30000);     // Alle 30 Sekunden
        });

        // Convert UTC hour to local timezone hour
        function utcToLocal(utcHour, utcMinutes = 0) {
            const now = new Date();
            const utcDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), Math.floor(utcHour), utcMinutes));
            const localTime = utcDate.toLocaleTimeString('de-CH', { timeZone: DISPLAY_TIMEZONE, hour: '2-digit', minute: '2-digit' });
            return localTime;
        }

        function updateMarketHours() {
            const now = new Date();
            const utcHour = now.getUTCHours() + now.getUTCMinutes() / 60;
            const utcDay = now.getUTCDay();
            let openCount = 0;

            // Crypto - 24/7
            const cryptoOpen = true;
            updateMarketDisplay('crypto', cryptoOpen, '24/7');
            if (cryptoOpen) openCount++;
            marketStatus.crypto = cryptoOpen;

            // Forex - Sun 22:00 UTC bis Fri 21:00 UTC (Sun 23:00 - Fri 22:00 CET)
            let forexOpen = false;
            if (utcDay === 0 && utcHour >= 22) forexOpen = true;
            else if (utcDay > 0 && utcDay < 5) forexOpen = true;
            else if (utcDay === 5 && utcHour < 21) forexOpen = true;
            const forexCloseLocal = utcToLocal(21, 0);
            const forexOpenLocal = utcToLocal(22, 0);
            updateMarketDisplay('forex', forexOpen, forexOpen ? `bis Fr ${forexCloseLocal}` : `ab So ${forexOpenLocal}`);
            if (forexOpen) openCount++;
            marketStatus.forex = forexOpen;

            // US Markets - 14:30-21:00 UTC (15:30-22:00 CET)
            const usOpen = utcDay >= 1 && utcDay <= 5 && utcHour >= 14.5 && utcHour < 21;
            const usOpenLocal = utcToLocal(14, 30);
            const usCloseLocal = utcToLocal(21, 0);
            updateMarketDisplay('us', usOpen, usOpen ? `bis ${usCloseLocal}` : `ab ${usOpenLocal}`);
            if (usOpen) openCount++;
            marketStatus.us = usOpen;

            // EU Markets - 08:00-16:30 UTC (09:00-17:30 CET)
            const euOpen = utcDay >= 1 && utcDay <= 5 && utcHour >= 8 && utcHour < 16.5;
            const euOpenLocal = utcToLocal(8, 0);
            const euCloseLocal = utcToLocal(16, 30);
            updateMarketDisplay('eu', euOpen, euOpen ? `bis ${euCloseLocal}` : `ab ${euOpenLocal}`);
            if (euOpen) openCount++;
            marketStatus.eu = euOpen;

            // Asia Markets - 00:00-06:00 UTC (01:00-07:00 CET)
            const asiaOpen = utcDay >= 1 && utcDay <= 5 && utcHour < 6;
            const asiaOpenLocal = utcToLocal(0, 0);
            const asiaCloseLocal = utcToLocal(6, 0);
            updateMarketDisplay('asia', asiaOpen, asiaOpen ? `bis ${asiaCloseLocal}` : `ab ${asiaOpenLocal}`);
            if (asiaOpen) openCount++;
            marketStatus.asia = asiaOpen;

            document.getElementById('openMarketsCount').textContent = openCount;
        }

        function updateMarketDisplay(marketId, isOpen, timeText) {
            const el = document.getElementById(`market-${marketId}`);
            if (!el) return;

            el.classList.remove('open', 'closed');
            el.classList.add(isOpen ? 'open' : 'closed');

            const timeEl = el.querySelector('.market-time');
            if (timeEl) timeEl.textContent = timeText;
        }

        function getSymbolMarket(symbol) {
            const upperSymbol = symbol.toUpperCase();
            if (SYMBOL_CATEGORIES.crypto.includes(upperSymbol)) return 'crypto';
            if (SYMBOL_CATEGORIES.forex.includes(upperSymbol)) return 'forex';
            if (SYMBOL_CATEGORIES.metals.includes(upperSymbol)) return 'forex'; // Metals follow forex hours
            if (SYMBOL_CATEGORIES.us_stocks.includes(upperSymbol)) return 'us';
            if (SYMBOL_CATEGORIES.eu_stocks.includes(upperSymbol)) return 'eu';
            if (SYMBOL_CATEGORIES.asia_stocks.includes(upperSymbol)) return 'asia';
            return 'unknown';
        }

        function isMarketOpen(symbol) {
            const market = getSymbolMarket(symbol);
            return marketStatus[market] !== false;
        }

        // TradingView Chart Functions
        function selectSetup(symbol, timeframe) {
            // Highlight selected card
            document.querySelectorAll('.setup-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Timeframe automatisch √ºbernehmen
            const intervalSelect = document.getElementById('chartInterval');
            const intervalMap = {
                'M1': '1', 'M5': '5', 'M15': '15', 'M30': '30',
                'H1': '60', 'H4': '240', 'D1': 'D', 'W1': 'W', 'MN': 'M'
            };
            if (intervalMap[timeframe]) {
                intervalSelect.value = intervalMap[timeframe];
            }

            // Load chart with the selected timeframe
            loadChart(symbol);
        }

        function getTradingViewSymbol(symbol) {
            const upperSymbol = symbol.toUpperCase();

            // Wenn ein festes Mapping existiert, verwende es
            if (TV_SYMBOL_MAP[upperSymbol]) {
                return TV_SYMBOL_MAP[upperSymbol];
            }

            // Dynamisches Mapping basierend auf konfigurierter Exchange
            const exchanges = tradingViewConfig.exchanges || {};

            // Crypto-Symbole
            if (SYMBOL_CATEGORIES.crypto.includes(upperSymbol)) {
                const exchange = exchanges.crypto || 'BITSTAMP';
                return `${exchange}:${upperSymbol}`;
            }

            // Forex-Symbole
            if (SYMBOL_CATEGORIES.forex.includes(upperSymbol)) {
                const provider = exchanges.forex || 'FX';
                return `${provider}:${upperSymbol}`;
            }

            // US-Aktien
            if (SYMBOL_CATEGORIES.us_stocks.includes(upperSymbol)) {
                const exchange = exchanges.stocks || 'NASDAQ';
                return `${exchange}:${upperSymbol}`;
            }

            return symbol;
        }

        function getActiveIndicators() {
            const studies = [];
            if (tradingViewConfig.indicators) {
                for (const [key, enabled] of Object.entries(tradingViewConfig.indicators)) {
                    if (enabled && TV_INDICATOR_MAP[key]) {
                        studies.push(TV_INDICATOR_MAP[key]);
                    }
                }
            }
            // Kein Fallback - nur explizit aktivierte Indikatoren anzeigen
            return studies;
        }

        // Chart Fullscreen Toggle
        let isChartFullscreen = false;

        function toggleChartFullscreen() {
            const chartSection = document.getElementById('chartSection');
            const expandText = document.getElementById('expandText');
            const expandIcon = document.getElementById('expandIcon');

            isChartFullscreen = !isChartFullscreen;

            if (isChartFullscreen) {
                chartSection.classList.add('fullscreen');
                expandText.textContent = 'Verkleinern';
                expandIcon.innerHTML = '<path d="M4 14h6v6m10-10h-6V4m0 6l7-7M3 21l7-7"/>';
                document.body.style.overflow = 'hidden';
            } else {
                chartSection.classList.remove('fullscreen');
                expandText.textContent = 'Vollbild';
                expandIcon.innerHTML = '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>';
                document.body.style.overflow = '';
            }

            // Chart neu laden um Gr√∂√üe anzupassen
            if (currentChartSymbol) {
                setTimeout(() => loadChart(currentChartSymbol), 100);
            }
        }

        // ESC-Taste zum Schlie√üen des Fullscreen-Modus
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isChartFullscreen) {
                toggleChartFullscreen();
            }
        });

        function loadChart(symbol) {
            currentChartSymbol = symbol;
            const tvSymbol = getTradingViewSymbol(symbol);
            const interval = document.getElementById('chartInterval').value;
            const style = document.getElementById('chartStyle').value;

            document.getElementById('chartSymbol').textContent = symbol;

            // Get active indicators from config
            const activeStudies = getActiveIndicators();

            // Create TradingView Widget
            const container = document.getElementById('chartContainer');
            container.innerHTML = '';

            // Volumen nur anzeigen wenn in Config aktiviert
            const hideVolume = !tradingViewConfig.indicators?.volume;

            new TradingView.widget({
                "autosize": true,
                "symbol": tvSymbol,
                "interval": interval,
                "timezone": DISPLAY_TIMEZONE,
                "theme": tradingViewConfig.theme || "dark",
                "style": style,
                "locale": "de_DE",
                "toolbar_bg": "#1a1a2e",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "hide_volume": hideVolume,
                "save_image": true,
                "container_id": "chartContainer",
                "studies": activeStudies,
                "show_popup_button": true,
                "popup_width": "1000",
                "popup_height": "650"
            });
        }

        function updateChart() {
            if (currentChartSymbol) {
                loadChart(currentChartSymbol);
            }
        }

        async function loadSetups() {
            const direction = document.getElementById('directionFilter').value;
            const marketFilter = document.getElementById('marketFilter').value;
            const container = document.getElementById('setupsContainer');

            try {
                // min_score auf 0 setzen um alle Setups zu sehen
                let url = `${API_BASE}/setups/?limit=20&min_score=0`;
                if (direction) url += `&direction=${direction}`;

                const response = await fetch(url);
                const data = await response.json();

                console.log('Setups loaded:', data);

                if (data.setups && data.setups.length > 0) {
                    let setups = data.setups;

                    console.log('Before filter:', setups.length, 'setups, marketFilter:', marketFilter);
                    console.log('marketStatus:', marketStatus);

                    // Filter nach Markt
                    if (marketFilter === 'open') {
                        setups = setups.filter(s => {
                            const open = isMarketOpen(s.symbol);
                            console.log(`${s.symbol}: market=${getSymbolMarket(s.symbol)}, open=${open}`);
                            return open;
                        });
                    } else if (marketFilter === 'crypto') {
                        setups = setups.filter(s => getSymbolMarket(s.symbol) === 'crypto');
                    } else if (marketFilter === 'forex') {
                        setups = setups.filter(s => ['forex'].includes(getSymbolMarket(s.symbol)));
                    } else if (marketFilter === 'stocks') {
                        setups = setups.filter(s => ['us', 'eu', 'asia'].includes(getSymbolMarket(s.symbol)));
                    }

                    // Sortiere: Offene M√§rkte zuerst, dann nach Score
                    setups.sort((a, b) => {
                        const aOpen = isMarketOpen(a.symbol) ? 1 : 0;
                        const bOpen = isMarketOpen(b.symbol) ? 1 : 0;
                        if (aOpen !== bOpen) return bOpen - aOpen;
                        return b.composite_score - a.composite_score;
                    });

                    if (setups.length > 0) {
                        container.innerHTML = setups.map(setup => createSetupCard(setup)).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>Keine Setups f√ºr diesen Filter</p></div>';
                    }

                    document.getElementById('totalScanned').textContent = data.total_scanned;
                    document.getElementById('highConfidence').textContent = data.high_confidence_count;
                } else {
                    container.innerHTML = '<div class="empty-state"><p>Keine Setups gefunden</p></div>';
                }
            } catch (error) {
                console.error('Fehler:', error);
                container.innerHTML = '<div class="empty-state"><p>Fehler beim Laden</p></div>';
            }
        }

        // Cache f√ºr geladene Setups (f√ºr Detail-Modal)
        let setupsCache = {};

        function createSetupCard(setup) {
            const scoreClass = setup.composite_score >= 75 ? 'high' :
                              setup.composite_score >= 60 ? 'moderate' : 'low';

            const market = getSymbolMarket(setup.symbol);
            const isOpen = isMarketOpen(setup.symbol);
            const marketClosedClass = isOpen ? '' : 'market-closed';

            const signals = [
                { name: 'N', available: setup.nhits_signal?.available, tooltip: 'NHITS: Preis-Prognose (30%)' },
                { name: 'H', available: setup.hmm_signal?.available, tooltip: 'HMM: Regime-Erkennung (25%)' },
                { name: 'T', available: setup.tcn_signal?.available && setup.tcn_signal?.patterns?.length > 0, tooltip: 'TCN: Chart-Patterns (20%)' },
                { name: 'C', available: setup.candlestick_signal?.available && setup.candlestick_signal?.patterns?.length > 0, tooltip: 'Candlestick: Kerzen-Patterns (15%)' },
            ];

            // Setup im Cache speichern f√ºr Detail-Modal
            setupsCache[setup.symbol] = setup;

            return `
                <div class="setup-card ${setup.direction} ${marketClosedClass}" onclick="selectSetup('${setup.symbol}', '${setup.timeframe}')" ondblclick="openAnalysis('${setup.symbol}', '${setup.timeframe}')">
                    <div class="setup-top">
                        <span class="setup-symbol">
                            ${setup.symbol}
                            <span class="market-indicator ${isOpen ? 'open' : ''}">${isOpen ? 'OPEN' : 'CLOSED'}</span>
                        </span>
                        <div class="setup-score">
                            <span class="score-value ${scoreClass}">${setup.composite_score.toFixed(0)}</span>
                            <span class="setup-direction ${setup.direction}">${setup.direction.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="setup-signals">
                        ${signals.map(s => `<span class="signal-tag ${s.available ? 'available' : ''}" title="${s.tooltip}">${s.name}</span>`).join('')}
                    </div>
                    <div class="setup-meta">
                        <span>${setup.timeframe} | ${setup.confidence_level}</span>
                        <button class="setup-detail-btn" onclick="event.stopPropagation(); openDetailModal('${setup.symbol}', '${setup.timeframe}')" title="Alle Details anzeigen">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            Details
                        </button>
                    </div>
                </div>
            `;
        }

        async function loadWatchlist() {
            const container = document.getElementById('watchlistContainer');

            try {
                const response = await fetch(`${API_BASE}/watchlist/`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    // Sortiere nach Score (h√∂chste zuerst)
                    const sortedItems = [...data.items].sort((a, b) => (b.last_score || 0) - (a.last_score || 0));

                    container.innerHTML = sortedItems.slice(0, 8).map(item => {
                        const scoreClass = item.last_score >= 75 ? 'high' :
                                          item.last_score >= 60 ? 'moderate' : 'low';
                        return `
                            <div class="watchlist-item">
                                <span class="watchlist-symbol ${item.is_favorite ? 'favorite' : ''}">${item.symbol}</span>
                                <span class="watchlist-score ${scoreClass}">${item.last_score ? item.last_score.toFixed(0) : '-'}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="opacity: 0.6; text-align: center; font-size: 0.8rem;">Leer</p>';
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function loadScannerStatus() {
            try {
                const response = await fetch(`${API_BASE}/scan/status`);
                const data = await response.json();

                scannerRunning = data.is_running;

                const badge = document.getElementById('scannerBadge');
                const toggleBtn = document.getElementById('toggleBtn');

                if (data.is_running) {
                    badge.classList.remove('stopped');
                    document.getElementById('scannerText').textContent = 'Scanner';
                    toggleBtn.textContent = 'Stop';
                } else {
                    badge.classList.add('stopped');
                    document.getElementById('scannerText').textContent = 'Gestoppt';
                    toggleBtn.textContent = 'Start';
                }

                document.getElementById('scanStatus').textContent = data.status;
                document.getElementById('scanInterval').textContent = `${data.scan_interval_seconds}s`;
                document.getElementById('lastScanTime').textContent = data.last_scan_time
                    ? new Date(data.last_scan_time).toLocaleTimeString('de-CH')
                    : '-';
                document.getElementById('nextScanTime').textContent = data.next_scan_time
                    ? new Date(data.next_scan_time).toLocaleTimeString('de-CH')
                    : '-';
                document.getElementById('errorCount').textContent = data.errors_count;
                document.getElementById('alertsTriggered').textContent = data.alerts_triggered;

                if (data.last_scan_time) {
                    document.getElementById('lastScan').textContent =
                        new Date(data.last_scan_time).toLocaleTimeString('de-CH');
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function toggleScanner() {
            const endpoint = scannerRunning ? 'stop' : 'start';
            try {
                await fetch(`${API_BASE}/scan/${endpoint}`, { method: 'POST' });
                loadScannerStatus();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function triggerScan() {
            try {
                await fetch(`${API_BASE}/scan/trigger`, { method: 'POST' });
                loadScannerStatus();
                setTimeout(loadSetups, 2000);
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function openAnalysis(symbol, timeframe) {
            const modal = document.getElementById('analysisModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modal.classList.add('active');
            modalTitle.textContent = `${symbol} Analyse`;
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analysiere...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/analyze/${symbol}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeframe, include_rag: true, include_llm: true })
                });
                const data = await response.json();

                const isOpen = isMarketOpen(symbol);

                modalBody.innerHTML = `
                    <div class="analysis-section">
                        <h4>Score: ${data.setup.composite_score.toFixed(1)} | ${data.setup.direction.toUpperCase()} | ${data.setup.confidence_level}</h4>
                        <div class="analysis-content">
                            <p><strong>Markt:</strong> ${isOpen ? 'üü¢ Offen' : 'üî¥ Geschlossen'}</p>
                            <p><strong>Signal-Alignment:</strong> ${data.setup.signal_alignment}</p>
                            <p><strong>Key Drivers:</strong> ${data.setup.key_drivers?.join(', ') || '-'}</p>
                        </div>
                    </div>

                    ${data.entry_exit_levels ? `
                    <div class="analysis-section">
                        <h4>Levels</h4>
                        <div class="levels-grid">
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.entry_price?.toFixed(2) || '-'}</div>
                                <div class="label">Entry</div>
                            </div>
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.stop_loss?.toFixed(2) || '-'}</div>
                                <div class="label">Stop</div>
                            </div>
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.take_profit_1?.toFixed(2) || '-'}</div>
                                <div class="label">TP1</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${data.analysis_summary ? `
                    <div class="analysis-section">
                        <h4>LLM-Analyse</h4>
                        <div class="analysis-content">${data.analysis_summary}</div>
                    </div>
                    ` : ''}

                    ${data.risk_assessment ? `
                    <div class="analysis-section">
                        <h4>Risiko</h4>
                        <div class="analysis-content">${data.risk_assessment}</div>
                    </div>
                    ` : ''}

                    <p style="opacity: 0.5; font-size: 0.75rem; margin-top: 0.5rem;">
                        ${data.analysis_duration_ms?.toFixed(0) || '-'}ms | RAG: ${data.rag_sources_used || 0}
                    </p>
                `;
            } catch (error) {
                console.error('Fehler:', error);
                modalBody.innerHTML = '<div class="empty-state"><p>Fehler bei der Analyse</p></div>';
            }
        }

        function closeModal() {
            document.getElementById('analysisModal').classList.remove('active');
        }

        document.getElementById('analysisModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeModal();
        });

        // =============================================
        // Detail Modal Funktionen
        // =============================================

        let currentDetailSymbol = null;
        let currentDetailTimeframe = null;
        let llmAnalysisLoaded = false;

        async function openDetailModal(symbol, timeframe) {
            currentDetailSymbol = symbol;
            currentDetailTimeframe = timeframe;
            llmAnalysisLoaded = false;

            const modal = document.getElementById('detailModal');
            document.getElementById('detailModalTitle').textContent = `${symbol} - Setup Details`;

            // Reset tabs
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.detail-tab').classList.add('active');
            document.querySelectorAll('.detail-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById('panel-overview').classList.add('active');

            // Reset LLM content
            document.getElementById('detailLlmContent').innerHTML = `
                <div class="llm-loading">
                    <div class="spinner"></div>
                    <span>LLM-Analyse wird beim Wechsel zum Tab geladen...</span>
                </div>
            `;

            modal.classList.add('active');

            // Lade Setup-Details
            await loadDetailContent(symbol, timeframe);
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            currentDetailSymbol = null;
            currentDetailTimeframe = null;
        }

        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeDetailModal();
        });

        function switchDetailTab(tabId) {
            // Tab-Buttons aktualisieren
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Panels aktualisieren
            document.querySelectorAll('.detail-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`panel-${tabId}`).classList.add('active');

            // LLM-Analyse lazy laden
            if (tabId === 'llm' && !llmAnalysisLoaded && currentDetailSymbol) {
                loadLlmAnalysis(currentDetailSymbol, currentDetailTimeframe);
            }
        }

        async function loadDetailContent(symbol, timeframe) {
            // Versuche zuerst aus Cache
            let setup = setupsCache[symbol];

            // Falls nicht im Cache, vom API laden
            if (!setup) {
                try {
                    const response = await fetch(`${API_BASE}/setups/${symbol}?timeframe=${timeframe}`);
                    if (response.ok) {
                        setup = await response.json();
                        setupsCache[symbol] = setup;
                    }
                } catch (error) {
                    console.error('Fehler beim Laden des Setups:', error);
                }
            }

            if (!setup) {
                document.getElementById('detailOverviewContent').innerHTML = '<div class="empty-state">Setup nicht gefunden</div>';
                return;
            }

            // Overview Panel bef√ºllen
            renderOverviewPanel(setup);

            // Signals Panel bef√ºllen
            renderSignalsPanel(setup);

            // Patterns Panel bef√ºllen
            renderPatternsPanel(setup);
        }

        function renderOverviewPanel(setup) {
            const scoreClass = setup.composite_score >= 75 ? 'high' :
                              setup.composite_score >= 60 ? 'moderate' : 'low';

            const directionIcon = setup.direction === 'long' ? 'üìà' :
                                 setup.direction === 'short' ? 'üìâ' : '‚û°Ô∏è';

            const directionColor = setup.direction === 'long' ? '#34d399' :
                                  setup.direction === 'short' ? '#f87171' : '#fbbf24';

            document.getElementById('detailOverviewContent').innerHTML = `
                <div class="detail-section">
                    <h4><span class="icon">üìä</span> Composite Score</h4>
                    <div class="score-meter">
                        <div class="score-bar">
                            <div class="score-bar-fill ${scoreClass}" style="width: ${setup.composite_score}%"></div>
                        </div>
                        <span class="score-value-large" style="color: ${scoreClass === 'high' ? '#34d399' : scoreClass === 'moderate' ? '#fbbf24' : '#9ca3af'}">${setup.composite_score.toFixed(1)}</span>
                    </div>
                </div>

                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-title">Richtung</span>
                        </div>
                        <div class="detail-card-value" style="color: ${directionColor}">
                            ${directionIcon} ${setup.direction.toUpperCase()}
                        </div>
                        <div class="detail-card-sub">Signal-Alignment: ${setup.signal_alignment}</div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-title">Konfidenz</span>
                        </div>
                        <div class="detail-card-value">${setup.confidence_level.toUpperCase()}</div>
                        <div class="detail-card-sub">${setup.signals_available} von 5 Signalen verf√ºgbar</div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-title">Timeframe</span>
                        </div>
                        <div class="detail-card-value">${setup.timeframe}</div>
                        <div class="detail-card-sub">${new Date(setup.timestamp).toLocaleString('de-CH')}</div>
                    </div>

                    ${setup.current_price ? `
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-title">Aktueller Preis</span>
                        </div>
                        <div class="detail-card-value">${setup.current_price.toLocaleString('de-CH', {minimumFractionDigits: 2})}</div>
                        <div class="detail-card-sub">${setup.symbol}</div>
                    </div>
                    ` : ''}
                </div>

                ${setup.key_drivers && setup.key_drivers.length > 0 ? `
                <div class="detail-section" style="margin-top: 1rem;">
                    <h4><span class="icon">üéØ</span> Key Drivers</h4>
                    <div class="pattern-list">
                        ${setup.key_drivers.map(driver => `<span class="pattern-tag">${driver}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            `;
        }

        function renderSignalsPanel(setup) {
            const nhits = setup.nhits_signal || {};
            const hmm = setup.hmm_signal || {};
            const technical = setup.technical_signal || {};

            document.getElementById('detailSignalsContent').innerHTML = `
                <!-- NHITS Signal -->
                <div class="detail-section">
                    <h4><span class="icon">üîÆ</span> NHITS Prognose (30%)</h4>
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Status</span>
                                <span class="detail-card-badge ${nhits.available ? 'available' : 'unavailable'}">
                                    ${nhits.available ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'}
                                </span>
                            </div>
                            ${nhits.available ? `
                            <div class="detail-card-value" style="color: ${nhits.direction === 'long' ? '#34d399' : nhits.direction === 'short' ? '#f87171' : '#fbbf24'}">
                                ${nhits.direction?.toUpperCase() || 'NEUTRAL'}
                            </div>
                            <div class="detail-card-sub">Trend-Wahrscheinlichkeit: ${((nhits.trend_probability || 0) * 100).toFixed(1)}%</div>
                            ` : '<div class="detail-card-sub">Keine Prognose verf√ºgbar</div>'}
                        </div>

                        ${nhits.available && (nhits.forecast_change_1h !== null || nhits.forecast_change_24h !== null) ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Prognose</span>
                            </div>
                            <table class="forecast-table">
                                <tr>
                                    <th>Zeitraum</th>
                                    <th>√Ñnderung</th>
                                </tr>
                                ${nhits.forecast_change_1h !== null ? `
                                <tr>
                                    <td>1 Stunde</td>
                                    <td class="${nhits.forecast_change_1h >= 0 ? 'forecast-positive' : 'forecast-negative'}">
                                        ${nhits.forecast_change_1h >= 0 ? '+' : ''}${nhits.forecast_change_1h?.toFixed(2)}%
                                    </td>
                                </tr>
                                ` : ''}
                                ${nhits.forecast_change_24h !== null ? `
                                <tr>
                                    <td>24 Stunden</td>
                                    <td class="${nhits.forecast_change_24h >= 0 ? 'forecast-positive' : 'forecast-negative'}">
                                        ${nhits.forecast_change_24h >= 0 ? '+' : ''}${nhits.forecast_change_24h?.toFixed(2)}%
                                    </td>
                                </tr>
                                ` : ''}
                            </table>
                        </div>
                        ` : ''}

                        ${nhits.available && nhits.model_confidence !== null ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Modell-Konfidenz</span>
                            </div>
                            <div class="detail-card-value">${((nhits.model_confidence || 0) * 100).toFixed(1)}%</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- HMM Signal -->
                <div class="detail-section">
                    <h4><span class="icon">üìä</span> HMM Regime (25%)</h4>
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Status</span>
                                <span class="detail-card-badge ${hmm.available ? 'available' : 'unavailable'}">
                                    ${hmm.available ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'}
                                </span>
                            </div>
                            ${hmm.available ? `
                            <div class="detail-card-value">${formatRegime(hmm.regime)}</div>
                            <div class="detail-card-sub">Wahrscheinlichkeit: ${((hmm.regime_probability || 0) * 100).toFixed(1)}%</div>
                            ` : '<div class="detail-card-sub">Keine Regime-Daten verf√ºgbar</div>'}
                        </div>

                        ${hmm.available ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Signal Score</span>
                            </div>
                            <div class="detail-card-value">${(hmm.signal_score || 0).toFixed(1)}</div>
                            <div class="detail-card-sub">Alignment: ${hmm.alignment || 'neutral'}</div>
                        </div>

                        ${hmm.regime_duration !== null ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Regime-Dauer</span>
                            </div>
                            <div class="detail-card-value">${hmm.regime_duration} Bars</div>
                        </div>
                        ` : ''}
                        ` : ''}
                    </div>
                </div>

                <!-- Technical Signal -->
                <div class="detail-section">
                    <h4><span class="icon">üìà</span> Technische Indikatoren (10%)</h4>
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Status</span>
                                <span class="detail-card-badge ${technical.available ? 'available' : 'unavailable'}">
                                    ${technical.available ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'}
                                </span>
                            </div>
                            ${technical.available ? `
                            <div class="detail-card-sub">Trend Alignment: ${((technical.trend_alignment || 0) * 100).toFixed(0)}%</div>
                            ` : '<div class="detail-card-sub">Keine technischen Daten verf√ºgbar</div>'}
                        </div>

                        ${technical.available && technical.rsi !== null ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">RSI (14)</span>
                            </div>
                            <div class="detail-card-value" style="color: ${technical.rsi < 30 ? '#34d399' : technical.rsi > 70 ? '#f87171' : '#fbbf24'}">
                                ${technical.rsi?.toFixed(1)}
                            </div>
                            <div class="detail-card-sub">${technical.rsi_signal || 'neutral'}</div>
                        </div>
                        ` : ''}

                        ${technical.available ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">MACD</span>
                            </div>
                            <div class="detail-card-value" style="color: ${technical.macd_signal === 'bullish' ? '#34d399' : technical.macd_signal === 'bearish' ? '#f87171' : '#fbbf24'}">
                                ${(technical.macd_signal || 'neutral').toUpperCase()}
                            </div>
                        </div>
                        ` : ''}

                        ${technical.available && technical.bb_position !== null ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">BB Position</span>
                            </div>
                            <div class="detail-card-value">${((technical.bb_position || 0) * 100).toFixed(0)}%</div>
                            <div class="detail-card-sub">${technical.bb_position < 0.2 ? 'Nahe unteres Band' : technical.bb_position > 0.8 ? 'Nahe oberes Band' : 'Mittig'}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderPatternsPanel(setup) {
            const tcn = setup.tcn_signal || {};
            const candlestick = setup.candlestick_signal || {};

            document.getElementById('detailPatternsContent').innerHTML = `
                <!-- TCN Patterns -->
                <div class="detail-section">
                    <h4><span class="icon">üìê</span> TCN Chart Patterns (20%)</h4>
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Status</span>
                                <span class="detail-card-badge ${tcn.available ? 'available' : 'unavailable'}">
                                    ${tcn.available ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'}
                                </span>
                            </div>
                            ${tcn.available ? `
                            <div class="detail-card-value" style="color: ${tcn.direction === 'long' ? '#34d399' : tcn.direction === 'short' ? '#f87171' : '#fbbf24'}">
                                ${tcn.direction?.toUpperCase() || 'NEUTRAL'}
                            </div>
                            <div class="detail-card-sub">Konfidenz: ${((tcn.pattern_confidence || 0) * 100).toFixed(1)}%</div>
                            ` : '<div class="detail-card-sub">Keine TCN-Patterns erkannt</div>'}
                        </div>

                        ${tcn.available && tcn.price_target ? `
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Kursziel</span>
                            </div>
                            <div class="detail-card-value">${tcn.price_target?.toLocaleString('de-CH', {minimumFractionDigits: 2})}</div>
                        </div>
                        ` : ''}
                    </div>

                    ${tcn.available && tcn.patterns && tcn.patterns.length > 0 ? `
                    <div style="margin-top: 0.75rem;">
                        <div class="detail-card-title" style="margin-bottom: 0.5rem;">Erkannte Patterns:</div>
                        <div class="pattern-list">
                            ${tcn.patterns.map(p => `
                                <span class="pattern-tag ${tcn.direction === 'long' ? 'bullish' : tcn.direction === 'short' ? 'bearish' : ''}">
                                    ${formatPatternName(p)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Candlestick Patterns -->
                <div class="detail-section">
                    <h4><span class="icon">üïØÔ∏è</span> Candlestick Patterns (15%)</h4>
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <span class="detail-card-title">Status</span>
                                <span class="detail-card-badge ${candlestick.available ? 'available' : 'unavailable'}">
                                    ${candlestick.available ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'}
                                </span>
                            </div>
                            ${candlestick.available ? `
                            <div class="detail-card-value" style="color: ${candlestick.direction === 'long' ? '#34d399' : candlestick.direction === 'short' ? '#f87171' : '#fbbf24'}">
                                ${candlestick.direction?.toUpperCase() || 'NEUTRAL'}
                            </div>
                            <div class="detail-card-sub">St√§rke: ${((candlestick.pattern_strength || 0) * 100).toFixed(1)}%</div>
                            ` : '<div class="detail-card-sub">Keine Candlestick-Patterns erkannt</div>'}
                        </div>
                    </div>

                    ${candlestick.available && candlestick.patterns && candlestick.patterns.length > 0 ? `
                    <div style="margin-top: 0.75rem;">
                        <div class="detail-card-title" style="margin-bottom: 0.5rem;">Erkannte Patterns:</div>
                        <div class="pattern-list">
                            ${candlestick.patterns.map(p => `
                                <span class="pattern-tag ${candlestick.direction === 'long' ? 'bullish' : candlestick.direction === 'short' ? 'bearish' : ''}">
                                    ${formatPatternName(p)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- CNN-LSTM (falls verf√ºgbar - zuk√ºnftige Erweiterung) -->
                <div class="detail-section">
                    <h4><span class="icon">üß†</span> CNN-LSTM Multi-Task</h4>
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-title">Status</span>
                            <span class="detail-card-badge unavailable">Nicht integriert</span>
                        </div>
                        <div class="detail-card-sub">CNN-LSTM Multi-Task-Prognosen werden in einer zuk√ºnftigen Version integriert.</div>
                    </div>
                </div>
            `;
        }

        async function loadLlmAnalysis(symbol, timeframe) {
            const container = document.getElementById('detailLlmContent');
            container.innerHTML = `
                <div class="llm-loading">
                    <div class="spinner"></div>
                    <span>LLM-Analyse wird generiert...</span>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/analyze/${symbol}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeframe, include_rag: true, include_llm: true })
                });

                if (!response.ok) {
                    throw new Error('Analyse konnte nicht geladen werden');
                }

                const data = await response.json();
                llmAnalysisLoaded = true;

                container.innerHTML = `
                    ${data.analysis_summary ? `
                    <div class="detail-section">
                        <h4><span class="icon">ü§ñ</span> LLM Kurzanalyse</h4>
                        <div class="llm-analysis-box">
                            <p>${data.analysis_summary}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${data.entry_exit_levels ? `
                    <div class="detail-section">
                        <h4><span class="icon">üéØ</span> Entry/Exit Levels</h4>
                        <div class="detail-grid">
                            ${data.entry_exit_levels.entry_price ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Entry</div>
                                <div class="detail-card-value" style="color: #64c8ff">${data.entry_exit_levels.entry_price?.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${data.entry_exit_levels.stop_loss ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Stop Loss</div>
                                <div class="detail-card-value" style="color: #f87171">${data.entry_exit_levels.stop_loss?.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${data.entry_exit_levels.take_profit_1 ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Take Profit 1</div>
                                <div class="detail-card-value" style="color: #34d399">${data.entry_exit_levels.take_profit_1?.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${data.entry_exit_levels.take_profit_2 ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Take Profit 2</div>
                                <div class="detail-card-value" style="color: #34d399">${data.entry_exit_levels.take_profit_2?.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${data.entry_exit_levels.risk_reward_ratio ? `
                            <div class="detail-card">
                                <div class="detail-card-title">Risk/Reward</div>
                                <div class="detail-card-value">${data.entry_exit_levels.risk_reward_ratio?.toFixed(2)}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${data.risk_assessment ? `
                    <div class="detail-section">
                        <h4><span class="icon">‚ö†Ô∏è</span> Risiko-Bewertung</h4>
                        <div class="llm-analysis-box" style="border-left-color: #f59e0b;">
                            <p>${data.risk_assessment}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${data.rationale ? `
                    <div class="detail-section">
                        <h4><span class="icon">üí°</span> Begr√ºndung</h4>
                        <div class="llm-analysis-box" style="border-left-color: #8b5cf6;">
                            <p>${data.rationale}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${data.similar_patterns && data.similar_patterns.length > 0 ? `
                    <div class="detail-section">
                        <h4><span class="icon">üìö</span> √Ñhnliche historische Patterns</h4>
                        <div class="detail-card">
                            <div class="detail-card-sub">${data.similar_patterns.length} √§hnliche Situationen gefunden</div>
                        </div>
                    </div>
                    ` : ''}

                    <div style="margin-top: 1rem; font-size: 0.75rem; opacity: 0.6;">
                        <span>Analyse-Dauer: ${data.analysis_duration_ms?.toFixed(0) || '-'}ms</span>
                        ${data.rag_sources_used ? `<span style="margin-left: 1rem;">RAG-Quellen: ${data.rag_sources_used}</span>` : ''}
                        ${data.llm_model ? `<span style="margin-left: 1rem;">Modell: ${data.llm_model}</span>` : ''}
                    </div>
                `;

            } catch (error) {
                console.error('LLM Analyse Fehler:', error);
                container.innerHTML = `
                    <div class="detail-section">
                        <div class="llm-analysis-box" style="border-left-color: #f87171;">
                            <p>Die LLM-Analyse konnte nicht geladen werden. Bitte versuchen Sie es sp√§ter erneut.</p>
                            <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 0.5rem;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Hilfsfunktionen
        function formatRegime(regime) {
            const regimeMap = {
                'bull_trend': 'üêÇ Bull Trend',
                'bear_trend': 'üêª Bear Trend',
                'sideways': '‚ÜîÔ∏è Sideways',
                'high_volatility': '‚ö° High Volatility'
            };
            return regimeMap[regime] || regime || 'Unbekannt';
        }

        function formatPatternName(pattern) {
            if (!pattern) return 'Unknown';
            // snake_case zu Title Case
            return pattern
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }
    </script>
</body>
</html>
