<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Workplace - Setups & Analyse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0.75rem 1rem;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            color: #64c8ff;
            text-decoration: none;
            font-size: 0.85rem;
        }

        h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Market Hours Section */
        .market-hours {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .market-hours-title {
            color: #94a3b8;
            margin-right: 0.25rem;
        }

        .market {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }

        .market.open {
            background: rgba(16, 185, 129, 0.15);
        }

        .market.closed {
            background: rgba(239, 68, 68, 0.1);
            opacity: 0.6;
        }

        .market-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ef4444;
        }

        .market.open .market-dot {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .market-name {
            font-weight: 500;
        }

        .market-time {
            color: #94a3b8;
            font-size: 0.7rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scanner-badge {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: rgba(16, 185, 129, 0.15);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .scanner-badge.stopped {
            background: rgba(239, 68, 68, 0.15);
        }

        .scanner-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
        }

        .scanner-badge.stopped .scanner-dot {
            background: #ef4444;
        }

        .btn {
            padding: 0.35rem 0.7rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .btn-sm {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .btn-sm:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Stats Row - Compact */
        .stats-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34d399;
        }

        .stat-value.warning {
            color: #fbbf24;
        }

        .stat-label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 0.75rem;
        }

        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .section-header select {
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            color: #e8e8e8;
            font-size: 0.75rem;
        }

        /* Setups Grid - Compact */
        .setups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.6rem;
        }

        .setup-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s;
        }

        .setup-card:hover {
            transform: translateY(-2px);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .setup-card.long {
            border-left: 3px solid #10b981;
        }

        .setup-card.short {
            border-left: 3px solid #ef4444;
        }

        .setup-card.neutral {
            border-left: 3px solid #fbbf24;
        }

        .setup-card.market-closed {
            opacity: 0.5;
        }

        .setup-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .setup-symbol {
            font-size: 1rem;
            font-weight: 600;
        }

        .setup-symbol .market-indicator {
            font-size: 0.65rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            margin-left: 0.3rem;
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .setup-symbol .market-indicator.open {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .setup-score {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .score-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .score-value.high { color: #10b981; }
        .score-value.moderate { color: #fbbf24; }
        .score-value.low { color: #94a3b8; }

        .setup-direction {
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .setup-direction.long {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .setup-direction.short {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .setup-direction.neutral {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .setup-signals {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.4rem;
            flex-wrap: wrap;
        }

        .signal-tag {
            padding: 0.1rem 0.35rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            font-size: 0.65rem;
            opacity: 0.5;
        }

        .signal-tag.available {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
            opacity: 1;
        }

        .setup-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            opacity: 0.6;
        }

        /* Sidebar - Compact */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-card h3 {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            color: #94a3b8;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }

        .watchlist-item:last-child {
            border-bottom: none;
        }

        .watchlist-symbol {
            font-weight: 500;
        }

        .watchlist-symbol.favorite::before {
            content: '‚òÖ ';
            color: #fbbf24;
        }

        .watchlist-score {
            font-weight: 600;
        }

        .watchlist-score.high { color: #10b981; }
        .watchlist-score.moderate { color: #fbbf24; }
        .watchlist-score.low { color: #94a3b8; }

        .scanner-info p {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
            font-size: 0.75rem;
        }

        .scanner-info .label {
            opacity: 0.6;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 2rem;
            opacity: 0.6;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            opacity: 0.6;
            font-size: 0.85rem;
        }

        /* Modal - Compact */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #e8e8e8;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .modal-body {
            padding: 1rem;
        }

        .analysis-section {
            margin-bottom: 1rem;
        }

        .analysis-section h4 {
            color: #34d399;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .analysis-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            line-height: 1.5;
            font-size: 0.85rem;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .level-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .level-item .value {
            font-size: 1rem;
            font-weight: 600;
            color: #ffd54f;
        }

        .level-item .label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .market-hours {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .header-row {
                flex-wrap: wrap;
            }
            .setups-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-row">
                <div class="header-left">
                    <a href="index.html" class="back-link">‚Üê Dashboard</a>
                    <h1>Trading Workplace</h1>
                </div>

                <!-- Market Hours -->
                <div class="market-hours" id="marketHours">
                    <span class="market-hours-title">M√§rkte:</span>
                    <div class="market" id="market-crypto">
                        <span class="market-dot"></span>
                        <span class="market-name">Crypto</span>
                    </div>
                    <div class="market" id="market-forex">
                        <span class="market-dot"></span>
                        <span class="market-name">Forex</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-us">
                        <span class="market-dot"></span>
                        <span class="market-name">US</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-eu">
                        <span class="market-dot"></span>
                        <span class="market-name">EU</span>
                        <span class="market-time"></span>
                    </div>
                    <div class="market" id="market-asia">
                        <span class="market-dot"></span>
                        <span class="market-name">Asia</span>
                        <span class="market-time"></span>
                    </div>
                </div>

                <div class="header-right">
                    <div class="scanner-badge" id="scannerBadge">
                        <span class="scanner-dot"></span>
                        <span id="scannerText">Scanner</span>
                    </div>
                    <button class="btn btn-sm" onclick="triggerScan()">Scan</button>
                    <button class="btn btn-sm" onclick="toggleScanner()" id="toggleBtn">Stop</button>
                    <a href="config-workplace.html" class="btn btn-sm">Config</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" id="totalScanned">-</div>
                <div class="stat-label">Gescannt</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highConfidence">-</div>
                <div class="stat-label">High Conf.</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="openMarketsCount">-</div>
                <div class="stat-label">M√§rkte offen</div>
            </div>
            <div class="stat-item">
                <div class="stat-value warning" id="alertsTriggered">-</div>
                <div class="stat-label">Alerts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastScan">-</div>
                <div class="stat-label">Letzter Scan</div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Setups Section -->
            <div class="setups-section">
                <div class="section-header">
                    <span>Top Trading-Setups</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="marketFilter" onchange="loadSetups()">
                            <option value="">Alle M√§rkte</option>
                            <option value="open">Nur offene M√§rkte</option>
                            <option value="crypto">Crypto</option>
                            <option value="forex">Forex</option>
                            <option value="stocks">Aktien/Indizes</option>
                        </select>
                        <select id="directionFilter" onchange="loadSetups()">
                            <option value="">Alle</option>
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                    </div>
                </div>
                <div id="setupsContainer" class="setups-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Lade Setups...</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-card">
                    <h3>Watchlist</h3>
                    <div id="watchlistContainer">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>Scanner-Status</h3>
                    <div class="scanner-info" id="scannerInfo">
                        <p><span class="label">Status</span><span id="scanStatus">-</span></p>
                        <p><span class="label">Intervall</span><span id="scanInterval">-</span></p>
                        <p><span class="label">Letzter Scan</span><span id="lastScanTime">-</span></p>
                        <p><span class="label">N√§chster Scan</span><span id="nextScanTime">-</span></p>
                        <p><span class="label">Fehler</span><span id="errorCount">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Analyse</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analysiere...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/workplace/api/v1';
        let scannerRunning = true;
        let marketStatus = {};

        // Symbol-Kategorien f√ºr Markt-Filterung
        const SYMBOL_CATEGORIES = {
            crypto: ['BTCUSD', 'ETHUSD', 'XRPUSD', 'SOLUSD', 'ADAUSD', 'DOTUSD', 'LINKUSD', 'BNBUSD'],
            forex: ['EURUSD', 'GBPUSD', 'USDJPY', 'USDCHF', 'AUDUSD', 'USDCAD', 'NZDUSD', 'EURGBP', 'EURJPY', 'GBPJPY'],
            us_stocks: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'US500', 'US100', 'US30'],
            eu_stocks: ['DE40', 'UK100', 'FR40', 'EU50'],
            asia_stocks: ['JP225', 'HK50', 'AU200'],
            metals: ['XAUUSD', 'XAGUSD']
        };

        // Display timezone from settings (Europe/Zurich)
        const DISPLAY_TIMEZONE = 'Europe/Zurich';

        // Market Hours (in UTC) - will be converted to local time for display
        const MARKET_HOURS_UTC = {
            crypto: { open: 0, close: 24 }, // 24/7
            forex: { sundayOpen: 22, fridayClose: 21 }, // Sun 22:00 - Fri 21:00 UTC
            us: { open: 14.5, close: 21 }, // 14:30-21:00 UTC
            eu: { open: 8, close: 16.5 }, // 08:00-16:30 UTC
            asia: { open: 0, close: 6 } // 00:00-06:00 UTC
        };

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            updateMarketHours();
            loadSetups();
            loadWatchlist();
            loadScannerStatus();

            // Regelm√§ssige Updates
            setInterval(updateMarketHours, 60000); // Jede Minute
            setInterval(loadScannerStatus, 5000);
            setInterval(loadSetups, 15000);
        });

        // Convert UTC hour to local timezone hour
        function utcToLocal(utcHour, utcMinutes = 0) {
            const now = new Date();
            const utcDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), Math.floor(utcHour), utcMinutes));
            const localTime = utcDate.toLocaleTimeString('de-CH', { timeZone: DISPLAY_TIMEZONE, hour: '2-digit', minute: '2-digit' });
            return localTime;
        }

        function updateMarketHours() {
            const now = new Date();
            const utcHour = now.getUTCHours() + now.getUTCMinutes() / 60;
            const utcDay = now.getUTCDay();
            let openCount = 0;

            // Crypto - 24/7
            const cryptoOpen = true;
            updateMarketDisplay('crypto', cryptoOpen, '24/7');
            if (cryptoOpen) openCount++;
            marketStatus.crypto = cryptoOpen;

            // Forex - Sun 22:00 UTC bis Fri 21:00 UTC (Sun 23:00 - Fri 22:00 CET)
            let forexOpen = false;
            if (utcDay === 0 && utcHour >= 22) forexOpen = true;
            else if (utcDay > 0 && utcDay < 5) forexOpen = true;
            else if (utcDay === 5 && utcHour < 21) forexOpen = true;
            const forexCloseLocal = utcToLocal(21, 0);
            const forexOpenLocal = utcToLocal(22, 0);
            updateMarketDisplay('forex', forexOpen, forexOpen ? `bis Fr ${forexCloseLocal}` : `ab So ${forexOpenLocal}`);
            if (forexOpen) openCount++;
            marketStatus.forex = forexOpen;

            // US Markets - 14:30-21:00 UTC (15:30-22:00 CET)
            const usOpen = utcDay >= 1 && utcDay <= 5 && utcHour >= 14.5 && utcHour < 21;
            const usOpenLocal = utcToLocal(14, 30);
            const usCloseLocal = utcToLocal(21, 0);
            updateMarketDisplay('us', usOpen, usOpen ? `bis ${usCloseLocal}` : `ab ${usOpenLocal}`);
            if (usOpen) openCount++;
            marketStatus.us = usOpen;

            // EU Markets - 08:00-16:30 UTC (09:00-17:30 CET)
            const euOpen = utcDay >= 1 && utcDay <= 5 && utcHour >= 8 && utcHour < 16.5;
            const euOpenLocal = utcToLocal(8, 0);
            const euCloseLocal = utcToLocal(16, 30);
            updateMarketDisplay('eu', euOpen, euOpen ? `bis ${euCloseLocal}` : `ab ${euOpenLocal}`);
            if (euOpen) openCount++;
            marketStatus.eu = euOpen;

            // Asia Markets - 00:00-06:00 UTC (01:00-07:00 CET)
            const asiaOpen = utcDay >= 1 && utcDay <= 5 && utcHour < 6;
            const asiaOpenLocal = utcToLocal(0, 0);
            const asiaCloseLocal = utcToLocal(6, 0);
            updateMarketDisplay('asia', asiaOpen, asiaOpen ? `bis ${asiaCloseLocal}` : `ab ${asiaOpenLocal}`);
            if (asiaOpen) openCount++;
            marketStatus.asia = asiaOpen;

            document.getElementById('openMarketsCount').textContent = openCount;
        }

        function updateMarketDisplay(marketId, isOpen, timeText) {
            const el = document.getElementById(`market-${marketId}`);
            if (!el) return;

            el.classList.remove('open', 'closed');
            el.classList.add(isOpen ? 'open' : 'closed');

            const timeEl = el.querySelector('.market-time');
            if (timeEl) timeEl.textContent = timeText;
        }

        function getSymbolMarket(symbol) {
            const upperSymbol = symbol.toUpperCase();
            if (SYMBOL_CATEGORIES.crypto.includes(upperSymbol)) return 'crypto';
            if (SYMBOL_CATEGORIES.forex.includes(upperSymbol)) return 'forex';
            if (SYMBOL_CATEGORIES.metals.includes(upperSymbol)) return 'forex'; // Metals follow forex hours
            if (SYMBOL_CATEGORIES.us_stocks.includes(upperSymbol)) return 'us';
            if (SYMBOL_CATEGORIES.eu_stocks.includes(upperSymbol)) return 'eu';
            if (SYMBOL_CATEGORIES.asia_stocks.includes(upperSymbol)) return 'asia';
            return 'unknown';
        }

        function isMarketOpen(symbol) {
            const market = getSymbolMarket(symbol);
            return marketStatus[market] !== false;
        }

        async function loadSetups() {
            const direction = document.getElementById('directionFilter').value;
            const marketFilter = document.getElementById('marketFilter').value;
            const container = document.getElementById('setupsContainer');

            try {
                let url = `${API_BASE}/setups/?limit=20&min_score=40`;
                if (direction) url += `&direction=${direction}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.setups && data.setups.length > 0) {
                    let setups = data.setups;

                    // Filter nach Markt
                    if (marketFilter === 'open') {
                        setups = setups.filter(s => isMarketOpen(s.symbol));
                    } else if (marketFilter === 'crypto') {
                        setups = setups.filter(s => getSymbolMarket(s.symbol) === 'crypto');
                    } else if (marketFilter === 'forex') {
                        setups = setups.filter(s => ['forex'].includes(getSymbolMarket(s.symbol)));
                    } else if (marketFilter === 'stocks') {
                        setups = setups.filter(s => ['us', 'eu', 'asia'].includes(getSymbolMarket(s.symbol)));
                    }

                    // Sortiere: Offene M√§rkte zuerst, dann nach Score
                    setups.sort((a, b) => {
                        const aOpen = isMarketOpen(a.symbol) ? 1 : 0;
                        const bOpen = isMarketOpen(b.symbol) ? 1 : 0;
                        if (aOpen !== bOpen) return bOpen - aOpen;
                        return b.composite_score - a.composite_score;
                    });

                    if (setups.length > 0) {
                        container.innerHTML = setups.map(setup => createSetupCard(setup)).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>Keine Setups f√ºr diesen Filter</p></div>';
                    }

                    document.getElementById('totalScanned').textContent = data.total_scanned;
                    document.getElementById('highConfidence').textContent = data.high_confidence_count;
                } else {
                    container.innerHTML = '<div class="empty-state"><p>Keine Setups gefunden</p></div>';
                }
            } catch (error) {
                console.error('Fehler:', error);
                container.innerHTML = '<div class="empty-state"><p>Fehler beim Laden</p></div>';
            }
        }

        function createSetupCard(setup) {
            const scoreClass = setup.composite_score >= 75 ? 'high' :
                              setup.composite_score >= 60 ? 'moderate' : 'low';

            const market = getSymbolMarket(setup.symbol);
            const isOpen = isMarketOpen(setup.symbol);
            const marketClosedClass = isOpen ? '' : 'market-closed';

            const signals = [
                { name: 'N', available: setup.nhits_signal?.available },
                { name: 'H', available: setup.hmm_signal?.available },
                { name: 'T', available: setup.tcn_signal?.available && setup.tcn_signal?.patterns?.length > 0 },
                { name: 'C', available: setup.candlestick_signal?.available && setup.candlestick_signal?.patterns?.length > 0 },
            ];

            return `
                <div class="setup-card ${setup.direction} ${marketClosedClass}" onclick="openAnalysis('${setup.symbol}', '${setup.timeframe}')">
                    <div class="setup-top">
                        <span class="setup-symbol">
                            ${setup.symbol}
                            <span class="market-indicator ${isOpen ? 'open' : ''}">${isOpen ? 'OPEN' : 'CLOSED'}</span>
                        </span>
                        <div class="setup-score">
                            <span class="score-value ${scoreClass}">${setup.composite_score.toFixed(0)}</span>
                            <span class="setup-direction ${setup.direction}">${setup.direction.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="setup-signals">
                        ${signals.map(s => `<span class="signal-tag ${s.available ? 'available' : ''}">${s.name}</span>`).join('')}
                    </div>
                    <div class="setup-meta">
                        <span>${setup.timeframe} | ${setup.confidence_level}</span>
                        <span>${setup.signal_alignment}</span>
                    </div>
                </div>
            `;
        }

        async function loadWatchlist() {
            const container = document.getElementById('watchlistContainer');

            try {
                const response = await fetch(`${API_BASE}/watchlist/`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    container.innerHTML = data.items.slice(0, 8).map(item => {
                        const scoreClass = item.last_score >= 75 ? 'high' :
                                          item.last_score >= 60 ? 'moderate' : 'low';
                        return `
                            <div class="watchlist-item">
                                <span class="watchlist-symbol ${item.is_favorite ? 'favorite' : ''}">${item.symbol}</span>
                                <span class="watchlist-score ${scoreClass}">${item.last_score ? item.last_score.toFixed(0) : '-'}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="opacity: 0.6; text-align: center; font-size: 0.8rem;">Leer</p>';
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function loadScannerStatus() {
            try {
                const response = await fetch(`${API_BASE}/scan/status`);
                const data = await response.json();

                scannerRunning = data.is_running;

                const badge = document.getElementById('scannerBadge');
                const toggleBtn = document.getElementById('toggleBtn');

                if (data.is_running) {
                    badge.classList.remove('stopped');
                    document.getElementById('scannerText').textContent = 'Scanner';
                    toggleBtn.textContent = 'Stop';
                } else {
                    badge.classList.add('stopped');
                    document.getElementById('scannerText').textContent = 'Gestoppt';
                    toggleBtn.textContent = 'Start';
                }

                document.getElementById('scanStatus').textContent = data.status;
                document.getElementById('scanInterval').textContent = `${data.scan_interval_seconds}s`;
                document.getElementById('lastScanTime').textContent = data.last_scan_time
                    ? new Date(data.last_scan_time).toLocaleTimeString('de-CH')
                    : '-';
                document.getElementById('nextScanTime').textContent = data.next_scan_time
                    ? new Date(data.next_scan_time).toLocaleTimeString('de-CH')
                    : '-';
                document.getElementById('errorCount').textContent = data.errors_count;
                document.getElementById('alertsTriggered').textContent = data.alerts_triggered;

                if (data.last_scan_time) {
                    document.getElementById('lastScan').textContent =
                        new Date(data.last_scan_time).toLocaleTimeString('de-CH');
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function toggleScanner() {
            const endpoint = scannerRunning ? 'stop' : 'start';
            try {
                await fetch(`${API_BASE}/scan/${endpoint}`, { method: 'POST' });
                loadScannerStatus();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function triggerScan() {
            try {
                await fetch(`${API_BASE}/scan/trigger`, { method: 'POST' });
                loadScannerStatus();
                setTimeout(loadSetups, 2000);
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function openAnalysis(symbol, timeframe) {
            const modal = document.getElementById('analysisModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modal.classList.add('active');
            modalTitle.textContent = `${symbol} Analyse`;
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analysiere...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/analyze/${symbol}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeframe, include_rag: true, include_llm: true })
                });
                const data = await response.json();

                const isOpen = isMarketOpen(symbol);

                modalBody.innerHTML = `
                    <div class="analysis-section">
                        <h4>Score: ${data.setup.composite_score.toFixed(1)} | ${data.setup.direction.toUpperCase()} | ${data.setup.confidence_level}</h4>
                        <div class="analysis-content">
                            <p><strong>Markt:</strong> ${isOpen ? 'üü¢ Offen' : 'üî¥ Geschlossen'}</p>
                            <p><strong>Signal-Alignment:</strong> ${data.setup.signal_alignment}</p>
                            <p><strong>Key Drivers:</strong> ${data.setup.key_drivers?.join(', ') || '-'}</p>
                        </div>
                    </div>

                    ${data.entry_exit_levels ? `
                    <div class="analysis-section">
                        <h4>Levels</h4>
                        <div class="levels-grid">
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.entry_price?.toFixed(2) || '-'}</div>
                                <div class="label">Entry</div>
                            </div>
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.stop_loss?.toFixed(2) || '-'}</div>
                                <div class="label">Stop</div>
                            </div>
                            <div class="level-item">
                                <div class="value">${data.entry_exit_levels.take_profit_1?.toFixed(2) || '-'}</div>
                                <div class="label">TP1</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${data.analysis_summary ? `
                    <div class="analysis-section">
                        <h4>LLM-Analyse</h4>
                        <div class="analysis-content">${data.analysis_summary}</div>
                    </div>
                    ` : ''}

                    ${data.risk_assessment ? `
                    <div class="analysis-section">
                        <h4>Risiko</h4>
                        <div class="analysis-content">${data.risk_assessment}</div>
                    </div>
                    ` : ''}

                    <p style="opacity: 0.5; font-size: 0.75rem; margin-top: 0.5rem;">
                        ${data.analysis_duration_ms?.toFixed(0) || '-'}ms | RAG: ${data.rag_sources_used || 0}
                    </p>
                `;
            } catch (error) {
                console.error('Fehler:', error);
                modalBody.innerHTML = '<div class="empty-state"><p>Fehler bei der Analyse</p></div>';
            }
        }

        function closeModal() {
            document.getElementById('analysisModal').classList.remove('active');
        }

        document.getElementById('analysisModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeModal();
        });
    </script>
</body>
</html>
