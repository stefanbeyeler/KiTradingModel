<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>KI Trading Model - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            padding: 1rem 2rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #f8fafc;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .release-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .release-version {
            font-weight: 600;
            color: #3b82f6;
        }

        .release-date {
            color: #64748b;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-api-docs {
            padding: 0.5rem 1rem;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            color: #e2e8f0;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-api-docs:hover {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .btn-api-docs svg {
            width: 16px;
            height: 16px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background: #ef4444;
        }

        .status-indicator.warning {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .card {
            background: #1e293b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid #334155;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.875rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 600;
            color: #f8fafc;
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .sync-card {
            grid-column: span 2;
        }

        .sync-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .service-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #0f172a;
            border-radius: 0.5rem;
        }

        .service-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .service-status.healthy {
            background: #22c55e;
        }

        .service-status.unhealthy {
            background: #ef4444;
        }

        .service-name {
            font-size: 0.875rem;
            color: #e2e8f0;
        }

        .logs-container {
            background: #0f172a;
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.75rem;
        }

        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #1e293b;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #64748b;
        }

        .log-info {
            color: #3b82f6;
        }

        .log-warning {
            color: #f59e0b;
        }

        .log-error {
            color: #ef4444;
        }

        .progress-bar {
            height: 4px;
            background: #334155;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #94a3b8;
        }

        .metric-value {
            color: #f8fafc;
            font-weight: 500;
        }

        .refresh-info {
            text-align: center;
            padding: 1rem;
            color: #64748b;
            font-size: 0.75rem;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.75rem 1rem;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .action-btn:hover {
            background: #475569;
            border-color: #64748b;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.875rem;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #22c55e;
        }

        .toast.error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* KI Query Section */
        .ai-query-card {
            grid-column: span 2;
        }

        .query-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .query-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .response-container {
            margin-top: 1.5rem;
            display: none;
        }

        .response-container.visible {
            display: block;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .response-box {
            background: #0f172a;
            border-radius: 0.5rem;
            padding: 1.25rem;
            border: 1px solid #334155;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .recommendation-badge.buy {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .recommendation-badge.sell {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .recommendation-badge.hold {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }

        .confidence-bar {
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .confidence-fill.high {
            background: #22c55e;
        }

        .confidence-fill.medium {
            background: #f59e0b;
        }

        .confidence-fill.low {
            background: #ef4444;
        }

        .analysis-text {
            color: #cbd5e1;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 0.9rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #334155;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .rag-results {
            margin-top: 1rem;
        }

        .rag-result-item {
            background: #1e293b;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid #3b82f6;
        }

        .rag-result-item:last-child {
            margin-bottom: 0;
        }

        .rag-result-meta {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .rag-result-content {
            font-size: 0.875rem;
            color: #e2e8f0;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #334155;
            padding-bottom: 0.5rem;
            overflow: visible;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 0.875rem;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #e2e8f0;
        }

        .tab-btn.active {
            background: #334155;
            color: #e2e8f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Strategies Section */
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .strategy-card {
            background: #0f172a;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #334155;
            transition: all 0.2s;
            cursor: pointer;
        }

        .strategy-card:hover {
            border-color: #3b82f6;
        }

        .strategy-card.active {
            border-color: #22c55e;
            box-shadow: 0 0 0 1px #22c55e;
        }

        .strategy-card.default {
            border-color: #f59e0b;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .strategy-name {
            font-weight: 600;
            color: #f8fafc;
            font-size: 1rem;
        }

        .strategy-badges {
            display: flex;
            gap: 0.25rem;
        }

        .strategy-badge {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .strategy-badge.default {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .strategy-badge.conservative {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .strategy-badge.moderate {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .strategy-badge.aggressive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .strategy-description {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .strategy-info {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
        }

        .strategy-info-item {
            background: #1e293b;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .strategy-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #334155;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Query Logs styles */
        .query-logs-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .log-stats {
            display: flex;
            gap: 1.5rem;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .log-stat-item strong {
            color: #e2e8f0;
        }

        .log-filter-select {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .log-filter-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .log-entry {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-entry:hover {
            border-color: #3b82f6;
            background: #253449;
        }

        .log-entry.expanded {
            border-color: #3b82f6;
        }

        .log-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .log-entry-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .log-type-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .log-type-analysis {
            background: #3b82f6;
            color: white;
        }

        .log-type-quick_recommendation {
            background: #22c55e;
            color: white;
        }

        .log-type-rag_query {
            background: #f59e0b;
            color: black;
        }

        .log-symbol {
            font-weight: 600;
            color: #f8fafc;
        }

        .log-timestamp {
            font-size: 0.75rem;
            color: #64748b;
        }

        .log-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .log-success {
            color: #22c55e;
        }

        .log-error {
            color: #ef4444;
        }

        .log-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
        }

        .log-entry.expanded .log-details {
            display: block;
        }

        .log-section {
            margin-bottom: 1rem;
        }

        .log-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .log-section-content {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            color: #e2e8f0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-rag-context {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .log-rag-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .log-rag-count {
            background: #334155;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
        }

        .expand-icon {
            transition: transform 0.2s;
            color: #64748b;
        }

        .log-entry.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: #1e293b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #f8fafc;
        }

        .modal-close {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: #f8fafc;
        }

        .indicator-list {
            margin-top: 0.5rem;
        }

        .indicator-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: #0f172a;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .indicator-item input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
        }

        .indicator-item input[type="number"] {
            width: 60px;
            padding: 0.25rem;
        }

        .indicator-name {
            flex: 1;
            font-size: 0.875rem;
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>KI Trading Model Dashboard</h1>
        <div class="header-info">
            <a href="/docs" target="_blank" class="btn-api-docs" title="API Dokumentation in neuem Tab öffnen">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                API Docs
            </a>
            <div class="release-info">
                <span class="release-version" id="releaseVersion">v1.0.0</span>
                <span class="release-date" id="releaseDate">-</span>
            </div>
            <div class="header-status">
                <div class="status-indicator" id="globalStatus"></div>
                <span id="statusText">Verbinde...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Overview Cards -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">RAG Dokumente</span>
                </div>
                <div class="card-value" id="ragDocCount">-</div>
                <div class="card-subtitle" id="ragCollection">Lade...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Sync Status</span>
                </div>
                <div class="card-value" id="syncStatus">-</div>
                <div class="card-subtitle" id="lastSync">Letzte Sync: -</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Sync Intervall</span>
                </div>
                <div class="card-value" id="syncInterval">-</div>
                <div class="card-subtitle" id="syncCount">Syncs: 0</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">LLM Model</span>
                </div>
                <div class="card-value" id="llmStatus">-</div>
                <div class="card-subtitle" id="llmModel">Lade...</div>
            </div>
        </div>

        <!-- Services Health -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">Service Health</span>
            </div>
            <div class="services-grid" id="servicesHealth">
                <div class="service-item">
                    <div class="service-status" id="ollamaHealth"></div>
                    <span class="service-name">Ollama LLM</span>
                </div>
                <div class="service-item">
                    <div class="service-status" id="ragHealth"></div>
                    <span class="service-name">RAG System</span>
                </div>
                <div class="service-item">
                    <div class="service-status" id="syncHealth"></div>
                    <span class="service-name">TimescaleDB Sync</span>
                </div>
            </div>
        </div>

        <!-- KI Query Section -->
        <div class="card ai-query-card">
            <div class="card-header">
                <span class="card-title">KI Trading Analyse</span>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('analysis')">Vollanalyse</button>
                <button class="tab-btn" onclick="switchTab('quick')">Schnellempfehlung</button>
                <button class="tab-btn" onclick="switchTab('rag')">RAG Abfrage</button>
                <button class="tab-btn" onclick="switchTab('strategies')">Strategien</button>
                <button class="tab-btn" onclick="switchTab('logs')">Query Logs</button>
            </div>

            <!-- Vollanalyse Tab -->
            <div id="tab-analysis" class="tab-content active">
                <div class="query-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="analysisSymbol">Symbol</label>
                            <input type="text" id="analysisSymbol" list="symbolList" placeholder="z.B. BTC/USD, EUR/USD">
                        </div>
                        <div class="form-group">
                            <label for="analysisLookback">Zeitraum (Tage)</label>
                            <input type="number" id="analysisLookback" value="30" min="1" max="365">
                        </div>
                        <div class="form-group">
                            <label for="analysisStrategy">Strategie</label>
                            <select id="analysisStrategy">
                                <option value="">Standard (Default-Strategie)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="analysisTechnical">Technische Analyse</label>
                            <select id="analysisTechnical">
                                <option value="true">Aktiviert</option>
                                <option value="false">Deaktiviert</option>
                            </select>
                        </div>
                    </div>
                    <div class="query-buttons">
                        <button class="btn btn-primary" id="btnAnalyze" onclick="runAnalysis()">
                            Analyse starten
                        </button>
                        <button class="btn btn-secondary" onclick="loadSymbols()">
                            Symbole laden
                        </button>
                    </div>
                </div>
            </div>

            <!-- Schnellempfehlung Tab -->
            <div id="tab-quick" class="tab-content">
                <div class="query-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quickSymbol">Symbol</label>
                            <input type="text" id="quickSymbol" list="symbolList" placeholder="z.B. BTC/USD, EUR/USD">
                        </div>
                        <div class="form-group">
                            <label for="quickLookback">Zeitraum (Tage)</label>
                            <input type="number" id="quickLookback" value="30" min="1" max="365">
                        </div>
                        <div class="form-group">
                            <label for="quickStrategy">Strategie</label>
                            <select id="quickStrategy">
                                <option value="">Standard</option>
                            </select>
                        </div>
                    </div>
                    <p style="color: #64748b; font-size: 0.8rem; margin-bottom: 1rem;">
                        Schnelle regelbasierte Analyse ohne LLM. Für detaillierte KI-Analyse nutze "Vollanalyse".
                    </p>
                    <div class="query-buttons">
                        <button class="btn btn-success" id="btnQuick" onclick="runQuickRecommendation()">
                            Empfehlung abrufen
                        </button>
                    </div>
                </div>
            </div>

            <!-- RAG Abfrage Tab -->
            <div id="tab-rag" class="tab-content">
                <div class="query-form">
                    <div class="form-group">
                        <label for="ragQuery">Abfrage</label>
                        <textarea id="ragQuery" placeholder="z.B. RSI oversold patterns, Double Bottom bei BTC..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ragSymbol">Symbol (optional)</label>
                            <input type="text" id="ragSymbol" list="symbolList" placeholder="Alle Symbole">
                        </div>
                        <div class="form-group">
                            <label for="ragResults">Max. Ergebnisse</label>
                            <input type="number" id="ragResults" value="5" min="1" max="20">
                        </div>
                    </div>
                    <div class="query-buttons">
                        <button class="btn btn-secondary" id="btnRagQuery" onclick="runRagQuery()">
                            RAG durchsuchen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Strategien Tab -->
            <div id="tab-strategies" class="tab-content">
                <div class="query-form">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                        <p style="color: #94a3b8; font-size: 0.875rem;">
                            Wähle eine Strategie für die Analyse aus oder erstelle eine neue.
                        </p>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="document.getElementById('importFileInput').click()">
                                Import
                            </button>
                            <input type="file" id="importFileInput" accept=".md" style="display: none;" onchange="importStrategy(this)">
                            <button class="btn btn-primary" onclick="showCreateStrategyModal()">
                                + Neue Strategie
                            </button>
                        </div>
                    </div>
                    <div id="strategiesGrid" class="strategies-grid">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <span class="loading-spinner"></span>
                            <p style="margin-top: 0.5rem;">Lade Strategien...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Query Logs Tab -->
            <div id="tab-logs" class="tab-content">
                <div class="query-form">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div class="log-stats" id="logStats">
                                <span class="log-stat-item">Gesamt: <strong id="logTotalCount">0</strong></span>
                                <span class="log-stat-item">Erfolgsrate: <strong id="logSuccessRate">0%</strong></span>
                                <span class="log-stat-item">Avg. Zeit: <strong id="logAvgTime">0ms</strong></span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <select id="logTypeFilter" class="log-filter-select" onchange="loadQueryLogs()">
                                <option value="">Alle Typen</option>
                                <option value="analysis">Vollanalyse</option>
                                <option value="quick_recommendation">Schnellempfehlung</option>
                                <option value="rag_query">RAG Abfrage</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadQueryLogs()">Aktualisieren</button>
                            <button class="btn btn-danger" onclick="clearQueryLogs()">Logs löschen</button>
                        </div>
                    </div>
                    <div id="queryLogsContainer" class="query-logs-container">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <p>Klicken Sie auf "Aktualisieren" um Logs zu laden.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datalist for symbols -->
            <datalist id="symbolList"></datalist>

            <!-- Response Container -->
            <div id="responseContainer" class="response-container">
                <div class="response-header">
                    <span class="card-title" id="responseTitle">Ergebnis</span>
                    <button class="action-btn" onclick="clearResponse()">Schliessen</button>
                </div>
                <div class="response-box" id="responseBox">
                    <!-- Response content will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Sync Control Card -->
        <div class="card sync-card">
            <div class="card-header">
                <span class="card-title">TimescaleDB Sync Steuerung</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Host</span>
                <span class="metric-value" id="dbHost">localhost:5432</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Datenbank</span>
                <span class="metric-value" id="dbName">easyinsight</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Verbunden</span>
                <span class="metric-value" id="dbConnected">Ja</span>
            </div>
            <div class="sync-controls">
                <button class="btn btn-primary" id="btnStartSync" onclick="startSync()">Start Sync</button>
                <button class="btn btn-danger" id="btnStopSync" onclick="stopSync()">Stop Sync</button>
                <button class="btn btn-secondary" onclick="manualSync()">Manueller Sync (7 Tage)</button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">Schnellaktionen</span>
            </div>
            <div class="quick-actions">
                <button class="action-btn" onclick="persistRAG()">RAG Speichern</button>
                <button class="action-btn" onclick="checkLLM()">LLM Status</button>
                <button class="action-btn" onclick="openDocs()">API Docs</button>
                <button class="action-btn" onclick="refreshAll()">Alles Aktualisieren</button>
            </div>
        </div>

        <div class="refresh-info">
            Auto-Refresh alle 10 Sekunden | Letzte Aktualisierung: <span id="lastRefresh">-</span>
        </div>
    </div>

    <!-- Strategy Create/Edit Modal -->
    <div id="strategyModal" class="modal-overlay" onclick="if(event.target === this) closeStrategyModal()">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="strategyModalTitle">Neue Strategie erstellen</h3>
                <button class="modal-close" onclick="closeStrategyModal()">&times;</button>
            </div>
            <form id="strategyForm" onsubmit="saveStrategy(event)">
                <input type="hidden" id="strategyEditId" value="">
                <div class="form-group">
                    <label for="strategyName">Name *</label>
                    <input type="text" id="strategyName" required placeholder="z.B. Meine Trend-Strategie">
                </div>
                <div class="form-group">
                    <label for="strategyDescription">Beschreibung</label>
                    <textarea id="strategyDescription" placeholder="Beschreibung der Strategie..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="strategyType">Strategie-Typ</label>
                        <select id="strategyType">
                            <option value="custom">Custom</option>
                            <option value="trend_following">Trend Following</option>
                            <option value="mean_reversion">Mean Reversion</option>
                            <option value="momentum">Momentum</option>
                            <option value="breakout">Breakout</option>
                            <option value="scalping">Scalping</option>
                            <option value="swing">Swing Trading</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="strategyRisk">Risikolevel</label>
                        <select id="strategyRisk">
                            <option value="conservative">Konservativ</option>
                            <option value="moderate" selected>Moderat</option>
                            <option value="aggressive">Aggressiv</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="strategyMinBuy">Min. Kaufsignale</label>
                        <input type="number" id="strategyMinBuy" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="strategyMinSell">Min. Verkaufssignale</label>
                        <input type="number" id="strategyMinSell" value="3" min="1" max="10">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="strategyStopLoss">Stop-Loss ATR Multiplikator</label>
                        <input type="number" id="strategyStopLoss" value="2.0" min="0.5" max="5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="strategyTakeProfit">Take-Profit ATR Multiplikator</label>
                        <input type="number" id="strategyTakeProfit" value="3.0" min="1" max="10" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="strategyTimeframe">Bevorzugter Zeitrahmen</label>
                        <select id="strategyTimeframe">
                            <option value="short_term">Kurzfristig</option>
                            <option value="medium_term">Mittelfristig</option>
                            <option value="long_term">Langfristig</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="strategyLookback">Lookback Tage</label>
                        <input type="number" id="strategyLookback" value="30" min="7" max="365">
                    </div>
                </div>
                <div class="form-group">
                    <label for="strategyPrompt">Custom Prompt (optional)</label>
                    <textarea id="strategyPrompt" placeholder="Zusätzliche Anweisungen für die KI..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="strategyUseRag" checked>
                        RAG-Kontext verwenden
                    </label>
                </div>
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeStrategyModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';

        // Fetch wrapper with error handling
        async function apiFetch(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                throw error;
            }
        }

        // Update dashboard data
        async function updateDashboard() {
            try {
                // Fetch all data in parallel
                const [health, syncStatus, ragStats, llmStatus] = await Promise.all([
                    apiFetch('/health').catch(() => null),
                    apiFetch('/sync/status').catch(() => null),
                    apiFetch('/rag/stats').catch(() => null),
                    apiFetch('/llm/status').catch(() => null)
                ]);

                // Update global status
                const globalStatus = document.getElementById('globalStatus');
                const statusText = document.getElementById('statusText');
                if (health && health.status === 'healthy') {
                    globalStatus.className = 'status-indicator';
                    statusText.textContent = 'Online';
                } else if (health && health.status === 'degraded') {
                    globalStatus.className = 'status-indicator warning';
                    statusText.textContent = 'Eingeschränkt';
                } else {
                    globalStatus.className = 'status-indicator error';
                    statusText.textContent = 'Offline';
                }

                // Update RAG stats
                if (ragStats) {
                    document.getElementById('ragDocCount').textContent = ragStats.document_count || 0;
                    document.getElementById('ragCollection').textContent = `Collection: ${ragStats.collection_name || '-'}`;
                }

                // Update sync status
                if (syncStatus) {
                    const isRunning = syncStatus.running;
                    document.getElementById('syncStatus').textContent = isRunning ? 'Aktiv' : 'Gestoppt';
                    document.getElementById('syncStatus').style.color = isRunning ? '#22c55e' : '#ef4444';
                    document.getElementById('lastSync').textContent = syncStatus.last_sync_time
                        ? `Letzte Sync: ${new Date(syncStatus.last_sync_time).toLocaleString('de-DE')}`
                        : 'Noch keine Sync';
                    document.getElementById('syncInterval').textContent = `${syncStatus.sync_interval_seconds}s`;
                    document.getElementById('syncCount').textContent = `Syncs: ${syncStatus.sync_count || 0}`;
                    document.getElementById('dbConnected').textContent = syncStatus.connected ? 'Ja' : 'Nein';

                    // Update buttons
                    document.getElementById('btnStartSync').disabled = isRunning;
                    document.getElementById('btnStopSync').disabled = !isRunning;

                    // Update sync health indicator
                    document.getElementById('syncHealth').className =
                        `service-status ${syncStatus.connected ? 'healthy' : 'unhealthy'}`;
                }

                // Update LLM status
                if (llmStatus) {
                    document.getElementById('llmStatus').textContent = llmStatus.available ? 'Verfügbar' : 'Nicht verfügbar';
                    document.getElementById('llmStatus').style.color = llmStatus.available ? '#22c55e' : '#ef4444';
                    document.getElementById('llmModel').textContent = llmStatus.model || '-';
                    document.getElementById('ollamaHealth').className =
                        `service-status ${llmStatus.available ? 'healthy' : 'unhealthy'}`;
                }

                // Update health indicators
                if (health && health.services) {
                    document.getElementById('ragHealth').className =
                        `service-status ${health.services.rag_service ? 'healthy' : 'unhealthy'}`;
                }

                // Update last refresh time
                document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString('de-DE');

            } catch (error) {
                console.error('Dashboard update error:', error);
            }
        }

        // Sync controls
        async function startSync() {
            try {
                await apiFetch('/sync/start', { method: 'POST' });
                showToast('Sync gestartet', 'success');
                await updateDashboard();
            } catch (error) {
                showToast('Fehler beim Starten', 'error');
            }
        }

        async function stopSync() {
            try {
                await apiFetch('/sync/stop', { method: 'POST' });
                showToast('Sync gestoppt', 'success');
                await updateDashboard();
            } catch (error) {
                showToast('Fehler beim Stoppen', 'error');
            }
        }

        async function manualSync() {
            try {
                showToast('Manueller Sync läuft...', 'success');
                const result = await apiFetch('/sync/manual?days_back=7', { method: 'POST' });
                showToast(`Sync abgeschlossen: ${result.documents_synced} Dokumente`, 'success');
                await updateDashboard();
            } catch (error) {
                showToast('Fehler beim manuellen Sync', 'error');
            }
        }

        // Quick actions
        async function persistRAG() {
            try {
                await apiFetch('/rag/persist', { method: 'POST' });
                showToast('RAG gespeichert', 'success');
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function checkLLM() {
            try {
                const status = await apiFetch('/llm/status');
                showToast(`LLM: ${status.available ? 'Verfügbar' : 'Nicht verfügbar'}`, status.available ? 'success' : 'error');
            } catch (error) {
                showToast('LLM nicht erreichbar', 'error');
            }
        }

        function openDocs() {
            window.open('/docs', '_blank');
        }

        // ==================== Query Logs Functions ====================

        async function loadQueryLogs() {
            const container = document.getElementById('queryLogsContainer');
            const typeFilter = document.getElementById('logTypeFilter').value;

            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><p style="margin-top: 0.5rem; color: #64748b;">Lade Logs...</p></div>';

            try {
                // Load logs and stats in parallel
                const [logsResponse, statsResponse] = await Promise.all([
                    apiFetch(`/query-logs?limit=100${typeFilter ? '&query_type=' + typeFilter : ''}`),
                    apiFetch('/query-logs/stats')
                ]);

                // Update stats
                document.getElementById('logTotalCount').textContent = statsResponse.total_queries || 0;
                document.getElementById('logSuccessRate').textContent = (statsResponse.success_rate || 0) + '%';
                document.getElementById('logAvgTime').textContent = Math.round(statsResponse.avg_processing_time_ms || 0) + 'ms';

                const logs = logsResponse.logs || [];

                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;"><p>Keine Logs vorhanden.</p></div>';
                    return;
                }

                container.innerHTML = logs.map(log => renderLogEntry(log)).join('');

            } catch (error) {
                console.error('Error loading logs:', error);
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #ef4444;"><p>Fehler beim Laden: ${error.message}</p></div>`;
            }
        }

        function renderLogEntry(log) {
            const timestamp = new Date(log.timestamp).toLocaleString('de-DE');
            const typeLabel = {
                'analysis': 'Vollanalyse',
                'quick_recommendation': 'Schnellempfehlung',
                'rag_query': 'RAG Abfrage'
            }[log.query_type] || log.query_type;

            const ragContextHtml = log.rag_context && log.rag_context.length > 0
                ? `<div class="log-section">
                    <div class="log-section-title">
                        RAG Kontext <span class="log-rag-count">${log.rag_document_count} Dokumente</span>
                    </div>
                    <ul class="log-rag-context">
                        ${log.rag_context.slice(0, 3).map((ctx, i) => `
                            <li class="log-rag-item">${escapeHtml(ctx.substring(0, 200))}${ctx.length > 200 ? '...' : ''}</li>
                        `).join('')}
                    </ul>
                </div>`
                : '';

            return `
                <div class="log-entry" onclick="toggleLogEntry(this)">
                    <div class="log-entry-header">
                        <div class="log-entry-info">
                            <span class="log-type-badge log-type-${log.query_type}">${typeLabel}</span>
                            ${log.symbol ? `<span class="log-symbol">${log.symbol}</span>` : ''}
                            <span class="log-timestamp">${timestamp}</span>
                            ${log.strategy_name ? `<span style="color: #94a3b8; font-size: 0.75rem;">Strategie: ${log.strategy_name}</span>` : ''}
                        </div>
                        <div class="log-meta">
                            <span class="${log.success ? 'log-success' : 'log-error'}">${log.success ? 'Erfolgreich' : 'Fehler'}</span>
                            <span>${Math.round(log.processing_time_ms)}ms</span>
                            <span>${log.model_used}</span>
                            <span class="expand-icon">▼</span>
                        </div>
                    </div>
                    <div class="log-details">
                        <div class="log-section">
                            <div class="log-section-title">System Prompt</div>
                            <div class="log-section-content">${escapeHtml(log.system_prompt || '-')}</div>
                        </div>
                        <div class="log-section">
                            <div class="log-section-title">User Prompt</div>
                            <div class="log-section-content">${escapeHtml(log.user_prompt || '-')}</div>
                        </div>
                        ${ragContextHtml}
                        <div class="log-section">
                            <div class="log-section-title">LLM Antwort</div>
                            <div class="log-section-content">${escapeHtml(log.llm_response || '-')}</div>
                        </div>
                        ${log.error_message ? `
                            <div class="log-section">
                                <div class="log-section-title" style="color: #ef4444;">Fehlermeldung</div>
                                <div class="log-section-content" style="border-color: #ef4444;">${escapeHtml(log.error_message)}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function toggleLogEntry(element) {
            element.classList.toggle('expanded');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function clearQueryLogs() {
            if (!confirm('Alle Query-Logs wirklich löschen?')) return;

            try {
                const response = await apiFetch('/query-logs', { method: 'DELETE' });
                showToast(`${response.deleted_count} Logs gelöscht`, 'success');
                await loadQueryLogs();
            } catch (error) {
                showToast('Fehler beim Löschen', 'error');
            }
        }

        async function refreshAll() {
            await updateDashboard();
            showToast('Aktualisiert', 'success');
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Hide response when switching tabs
            clearResponse();
        }

        // Load available symbols
        async function loadSymbols() {
            try {
                const data = await apiFetch('/symbols');
                const symbols = data.symbols || [];

                const datalist = document.getElementById('symbolList');
                datalist.innerHTML = '';

                if (symbols.length === 0) {
                    showToast('Keine Symbole gefunden - Backend nicht verbunden?', 'error');
                    return;
                }

                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    datalist.appendChild(option);
                });

                showToast(`${symbols.length} Symbole geladen`, 'success');
            } catch (error) {
                console.error('Failed to load symbols:', error);
                showToast('Symbole konnten nicht geladen werden - Backend pruefen', 'error');
            }
        }

        // Run full analysis
        async function runAnalysis() {
            const symbol = document.getElementById('analysisSymbol').value.trim();
            const lookback = parseInt(document.getElementById('analysisLookback').value);
            const technical = document.getElementById('analysisTechnical').value === 'true';
            const strategyId = document.getElementById('analysisStrategy').value;

            if (!symbol) {
                showToast('Bitte Symbol eingeben (z.B. BTC/USD)', 'error');
                return;
            }

            const btn = document.getElementById('btnAnalyze');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Analysiere...';

            // Get strategy name for display
            const strategySelect = document.getElementById('analysisStrategy');
            const strategyName = strategyId ? strategySelect.options[strategySelect.selectedIndex].text : 'Standard';

            showResponse('Analyse läuft...', `<div style="text-align: center; padding: 2rem;">
                <span class="loading-spinner"></span>
                <p style="margin-top: 1rem; color: #94a3b8;">KI analysiert ${symbol}...</p>
                <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Strategie: ${strategyName}</p>
                <p style="font-size: 0.75rem; color: #64748b;">Dies kann einige Sekunden dauern</p>
            </div>`);

            try {
                const requestBody = {
                    symbol: symbol,
                    lookback_days: lookback,
                    include_technical: technical
                };

                // Add strategy_id if selected
                if (strategyId) {
                    requestBody.strategy_id = strategyId;
                }

                const response = await apiFetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                displayAnalysisResult(response);
                showToast('Analyse abgeschlossen', 'success');
            } catch (error) {
                showResponse('Fehler', `<p style="color: #ef4444;">Analyse fehlgeschlagen: ${error.message}</p>`);
                showToast('Analyse fehlgeschlagen', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Analyse starten';
            }
        }

        // Run RAG query
        async function runRagQuery() {
            const query = document.getElementById('ragQuery').value.trim();
            const symbol = document.getElementById('ragSymbol').value.trim();
            const nResults = parseInt(document.getElementById('ragResults').value);

            if (!query) {
                showToast('Bitte Abfrage eingeben', 'error');
                return;
            }

            const btn = document.getElementById('btnRagQuery');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Suche...';

            showResponse('Suche läuft...', `<div style="text-align: center; padding: 2rem;">
                <span class="loading-spinner"></span>
                <p style="margin-top: 1rem; color: #94a3b8;">Durchsuche RAG-Datenbank...</p>
            </div>`);

            try {
                let url = `/rag/query?query=${encodeURIComponent(query)}&n_results=${nResults}`;
                if (symbol) {
                    url += `&symbol=${encodeURIComponent(symbol)}`;
                }

                const response = await apiFetch(url);
                displayRagResults(response);
                showToast(`${response.count} Ergebnisse gefunden`, 'success');
            } catch (error) {
                showResponse('Fehler', `<p style="color: #ef4444;">RAG-Abfrage fehlgeschlagen: ${error.message}</p>`);
                showToast('RAG-Abfrage fehlgeschlagen', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'RAG durchsuchen';
            }
        }

        // Display full analysis result with complete output schema
        function displayAnalysisResult(data) {
            const rec = data.recommendation || {};

            // Map direction values (handle both old and new format)
            let direction = (rec.direction || rec.action || rec.signal || 'NEUTRAL').toUpperCase();
            if (direction === 'BUY') direction = 'LONG';
            if (direction === 'SELL') direction = 'SHORT';
            if (direction === 'HOLD') direction = 'NEUTRAL';

            // Map direction to CSS class
            const directionClass = direction === 'LONG' ? 'buy' : direction === 'SHORT' ? 'sell' : 'hold';

            // Handle confidence_score (0-100) or confidence (0-1 or string)
            let confidencePercent = 0;
            if (rec.confidence_score !== undefined) {
                confidencePercent = rec.confidence_score;
            } else if (typeof rec.confidence === 'string') {
                if (rec.confidence === 'high') confidencePercent = 85;
                else if (rec.confidence === 'medium') confidencePercent = 55;
                else confidencePercent = 25;
            } else if (rec.confidence !== undefined) {
                confidencePercent = rec.confidence * 100;
            }

            const confidenceClass = confidencePercent >= 70 ? 'high' : confidencePercent >= 40 ? 'medium' : 'low';

            // Format price with appropriate decimals
            const formatPrice = (price) => {
                if (!price && price !== 0) return '-';
                return price < 10 ? price.toFixed(5) : price.toFixed(2);
            };

            let html = `
                <div style="margin-bottom: 1.5rem;">
                    <span class="recommendation-badge ${directionClass}">${direction}</span>
                    <div style="margin-top: 0.5rem;">
                        <span style="color: #94a3b8; font-size: 0.875rem;">Konfidenz: ${confidencePercent.toFixed(0)}%</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill ${confidenceClass}" style="width: ${confidencePercent}%"></div>
                        </div>
                    </div>
                </div>
            `;

            // Setup Recommendation
            if (rec.setup_recommendation || rec.reasoning) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Setup Empfehlung</h4>
                        <p class="analysis-text">${rec.setup_recommendation || rec.reasoning}</p>
                    </div>
                `;
            }

            // Trading Levels - Entry, Stop Loss, Take Profits
            if (rec.entry_price || rec.stop_loss || rec.take_profit_1 || rec.take_profit) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Trading Levels</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Entry Price</div>
                                <div style="color: #3b82f6; font-weight: 600; font-size: 1.1rem;">${formatPrice(rec.entry_price)}</div>
                            </div>
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Stop Loss</div>
                                <div style="color: #ef4444; font-weight: 600; font-size: 1.1rem;">${formatPrice(rec.stop_loss)}</div>
                            </div>
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Take Profit 1</div>
                                <div style="color: #22c55e; font-weight: 600;">${formatPrice(rec.take_profit_1 || rec.take_profit)}</div>
                            </div>
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Take Profit 2</div>
                                <div style="color: #22c55e; font-weight: 600;">${formatPrice(rec.take_profit_2)}</div>
                            </div>
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Take Profit 3</div>
                                <div style="color: #22c55e; font-weight: 600;">${formatPrice(rec.take_profit_3)}</div>
                            </div>
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Risk/Reward</div>
                                <div style="color: #f59e0b; font-weight: 600;">${rec.risk_reward_ratio ? rec.risk_reward_ratio.toFixed(2) + ':1' : '-'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Risk Management
            if (rec.recommended_position_size || rec.max_risk_percent) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Risikomanagement</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Position Size</div>
                                <div style="color: #e2e8f0; font-weight: 600;">${rec.recommended_position_size ? rec.recommended_position_size.toFixed(2) + ' Lots' : '-'}</div>
                            </div>
                            <div style="background: #1e293b; padding: 0.75rem; border-radius: 0.5rem;">
                                <div style="color: #64748b; font-size: 0.75rem;">Max. Risiko</div>
                                <div style="color: #f59e0b; font-weight: 600;">${rec.max_risk_percent ? rec.max_risk_percent.toFixed(1) + '%' : '-'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Trend Analysis
            if (rec.trend_analysis) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Trend-Analyse</h4>
                        <p class="analysis-text">${rec.trend_analysis}</p>
                    </div>
                `;
            }

            // Support & Resistance
            if (rec.support_resistance) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Unterstützung & Widerstand</h4>
                        <p class="analysis-text">${rec.support_resistance}</p>
                    </div>
                `;
            }

            // Key Levels
            if (rec.key_levels) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Wichtige Preisniveaus</h4>
                        <p class="analysis-text">${rec.key_levels}</p>
                    </div>
                `;
            }

            // Risk Factors
            if (rec.risk_factors) {
                const riskContent = Array.isArray(rec.risk_factors)
                    ? rec.risk_factors.map(r => `<li>${r}</li>`).join('')
                    : `<li>${rec.risk_factors}</li>`;
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Risikofaktoren</h4>
                        <ul style="color: #f59e0b; font-size: 0.875rem; padding-left: 1.25rem; line-height: 1.6;">
                            ${riskContent}
                        </ul>
                    </div>
                `;
            }

            // Trade Rationale
            if (rec.trade_rationale) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: #f8fafc; margin-bottom: 0.5rem; font-size: 0.875rem;">Handelsbegründung</h4>
                        <p class="analysis-text">${rec.trade_rationale}</p>
                    </div>
                `;
            }

            showResponse(`Analyse: ${data.symbol || 'Ergebnis'}`, html);
        }

        // Display quick recommendation
        function displayRecommendation(rec, symbol) {
            // Handle both 'action' and 'signal' field names
            const action = (rec.action || rec.signal || 'hold').toLowerCase();
            // Handle confidence as string or number
            let confidence = rec.confidence;
            let confidenceClass = 'low';
            let confidencePercent = 0;
            if (typeof confidence === 'string') {
                if (confidence === 'high') { confidenceClass = 'high'; confidencePercent = 85; }
                else if (confidence === 'medium') { confidenceClass = 'medium'; confidencePercent = 55; }
                else { confidenceClass = 'low'; confidencePercent = 25; }
            } else {
                confidence = confidence || 0;
                confidencePercent = confidence * 100;
                confidenceClass = confidence >= 0.7 ? 'high' : confidence >= 0.4 ? 'medium' : 'low';
            }

            let html = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <span class="recommendation-badge ${action}" style="font-size: 1.25rem; padding: 0.75rem 1.5rem;">
                        ${action.toUpperCase()}
                    </span>
                    <div style="margin-top: 1rem;">
                        <span style="color: #94a3b8;">Konfidenz: ${confidencePercent.toFixed(0)}%</span>
                        <div class="confidence-bar" style="max-width: 200px; margin: 0.5rem auto;">
                            <div class="confidence-fill ${confidenceClass}" style="width: ${confidencePercent}%"></div>
                        </div>
                    </div>
                </div>
            `;

            if (rec.reasoning) {
                html += `<p class="analysis-text" style="text-align: center;">${rec.reasoning}</p>`;
            }

            showResponse(`Empfehlung: ${symbol}`, html);
        }

        // Display RAG results
        function displayRagResults(data) {
            if (!data.results || data.results.length === 0) {
                showResponse('RAG Ergebnisse', '<p style="color: #64748b; text-align: center;">Keine Ergebnisse gefunden</p>');
                return;
            }

            let html = `<p style="color: #94a3b8; margin-bottom: 1rem;">${data.count} Dokumente gefunden für: "${data.query}"</p>`;
            html += '<div class="rag-results">';

            data.results.forEach((result, index) => {
                const meta = result.metadata || {};
                html += `
                    <div class="rag-result-item">
                        <div class="rag-result-meta">
                            ${meta.symbol ? `<span>Symbol: ${meta.symbol}</span> | ` : ''}
                            ${meta.document_type ? `<span>Typ: ${meta.document_type}</span> | ` : ''}
                            ${meta.timestamp ? `<span>${new Date(meta.timestamp).toLocaleString('de-DE')}</span>` : ''}
                        </div>
                        <div class="rag-result-content">${result.content || result.page_content || 'Kein Inhalt'}</div>
                    </div>
                `;
            });

            html += '</div>';
            showResponse('RAG Ergebnisse', html);
        }

        // Show/hide response container
        function showResponse(title, content) {
            document.getElementById('responseTitle').textContent = title;
            document.getElementById('responseBox').innerHTML = content;
            document.getElementById('responseContainer').classList.add('visible');
        }

        function clearResponse() {
            document.getElementById('responseContainer').classList.remove('visible');
        }

        // ============================================
        // Strategy Management Functions
        // ============================================

        let strategiesCache = [];

        async function loadStrategies() {
            try {
                const strategies = await apiFetch('/strategies');
                strategiesCache = strategies;
                renderStrategies(strategies);
                updateStrategyDropdowns(strategies);
            } catch (error) {
                console.error('Failed to load strategies:', error);
                document.getElementById('strategiesGrid').innerHTML =
                    '<p style="color: #ef4444; text-align: center;">Fehler beim Laden der Strategien</p>';
            }
        }

        function renderStrategies(strategies) {
            const grid = document.getElementById('strategiesGrid');

            if (!strategies || strategies.length === 0) {
                grid.innerHTML = '<p style="color: #64748b; text-align: center;">Keine Strategien vorhanden</p>';
                return;
            }

            grid.innerHTML = strategies.map(s => `
                <div class="strategy-card ${s.is_default ? 'default' : ''}" data-id="${s.id}">
                    <div class="strategy-header">
                        <span class="strategy-name">${escapeHtml(s.name)}</span>
                        <div class="strategy-badges">
                            ${s.is_default ? '<span class="strategy-badge default">Default</span>' : ''}
                            <span class="strategy-badge ${s.risk_level}">${getRiskLabel(s.risk_level)}</span>
                        </div>
                    </div>
                    <p class="strategy-description">${escapeHtml(s.description || 'Keine Beschreibung')}</p>
                    <div class="strategy-info">
                        <span class="strategy-info-item">${getTypeLabel(s.strategy_type)}</span>
                        <span class="strategy-info-item">${s.lookback_days} Tage</span>
                        <span class="strategy-info-item">Min. ${s.min_buy_signals} Signale</span>
                    </div>
                    <div class="strategy-actions">
                        ${!s.is_default ? `<button class="btn btn-small btn-secondary" onclick="setDefaultStrategy('${s.id}')">Als Standard</button>` : ''}
                        <button class="btn btn-small btn-secondary" onclick="editStrategy('${s.id}')">Bearbeiten</button>
                        <button class="btn btn-small btn-secondary" onclick="exportStrategy('${s.id}')" title="Als Markdown exportieren">Export</button>
                        ${!s.id.startsWith('default_') ? `
                            <button class="btn btn-small btn-danger" onclick="deleteStrategy('${s.id}')">Löschen</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateStrategyDropdowns(strategies) {
            const quickSelect = document.getElementById('quickStrategy');
            const analysisSelect = document.getElementById('analysisStrategy');
            const quickCurrentValue = quickSelect.value;
            const analysisCurrentValue = analysisSelect ? analysisSelect.value : '';

            // Update quick recommendation dropdown
            quickSelect.innerHTML = '<option value="">Standard (Default-Strategie)</option>';
            strategies.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.name} (${getRiskLabel(s.risk_level)})`;
                if (s.is_default) option.textContent += ' ★';
                quickSelect.appendChild(option);
            });

            // Update full analysis dropdown
            if (analysisSelect) {
                analysisSelect.innerHTML = '<option value="">Standard (Default-Strategie)</option>';
                strategies.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = `${s.name} (${getRiskLabel(s.risk_level)})`;
                    if (s.is_default) option.textContent += ' ★';
                    analysisSelect.appendChild(option);
                });

                // Restore analysis selection if still valid
                if (analysisCurrentValue && strategies.some(s => s.id === analysisCurrentValue)) {
                    analysisSelect.value = analysisCurrentValue;
                }
            }

            // Restore quick selection if still valid
            if (quickCurrentValue && strategies.some(s => s.id === quickCurrentValue)) {
                quickSelect.value = quickCurrentValue;
            }
        }

        function getRiskLabel(risk) {
            const labels = {
                'conservative': 'Konservativ',
                'moderate': 'Moderat',
                'aggressive': 'Aggressiv'
            };
            return labels[risk] || risk;
        }

        function getTypeLabel(type) {
            const labels = {
                'trend_following': 'Trend Following',
                'mean_reversion': 'Mean Reversion',
                'momentum': 'Momentum',
                'breakout': 'Breakout',
                'scalping': 'Scalping',
                'swing': 'Swing',
                'custom': 'Custom'
            };
            return labels[type] || type;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showCreateStrategyModal() {
            document.getElementById('strategyModalTitle').textContent = 'Neue Strategie erstellen';
            document.getElementById('strategyEditId').value = '';
            document.getElementById('strategyForm').reset();
            document.getElementById('strategyUseRag').checked = true;
            document.getElementById('strategyModal').classList.add('visible');
        }

        function closeStrategyModal() {
            document.getElementById('strategyModal').classList.remove('visible');
        }

        function editStrategy(id) {
            const strategy = strategiesCache.find(s => s.id === id);
            if (!strategy) return;

            document.getElementById('strategyModalTitle').textContent = 'Strategie bearbeiten';
            document.getElementById('strategyEditId').value = id;
            document.getElementById('strategyName').value = strategy.name;
            document.getElementById('strategyDescription').value = strategy.description || '';
            document.getElementById('strategyType').value = strategy.strategy_type;
            document.getElementById('strategyRisk').value = strategy.risk_level;
            document.getElementById('strategyMinBuy').value = strategy.min_buy_signals;
            document.getElementById('strategyMinSell').value = strategy.min_sell_signals;
            document.getElementById('strategyStopLoss').value = strategy.stop_loss_atr_multiplier;
            document.getElementById('strategyTakeProfit').value = strategy.take_profit_atr_multiplier;
            document.getElementById('strategyTimeframe').value = strategy.preferred_timeframe;
            document.getElementById('strategyLookback').value = strategy.lookback_days;
            document.getElementById('strategyPrompt').value = strategy.custom_prompt || '';
            document.getElementById('strategyUseRag').checked = strategy.use_rag_context;

            document.getElementById('strategyModal').classList.add('visible');
        }

        async function saveStrategy(event) {
            event.preventDefault();

            const editId = document.getElementById('strategyEditId').value;
            const isEdit = !!editId;

            const data = {
                name: document.getElementById('strategyName').value,
                description: document.getElementById('strategyDescription').value,
                strategy_type: document.getElementById('strategyType').value,
                risk_level: document.getElementById('strategyRisk').value,
                min_buy_signals: parseInt(document.getElementById('strategyMinBuy').value),
                min_sell_signals: parseInt(document.getElementById('strategyMinSell').value),
                stop_loss_atr_multiplier: parseFloat(document.getElementById('strategyStopLoss').value),
                take_profit_atr_multiplier: parseFloat(document.getElementById('strategyTakeProfit').value),
                preferred_timeframe: document.getElementById('strategyTimeframe').value,
                lookback_days: parseInt(document.getElementById('strategyLookback').value),
                custom_prompt: document.getElementById('strategyPrompt').value || null,
                use_rag_context: document.getElementById('strategyUseRag').checked
            };

            try {
                if (isEdit) {
                    await apiFetch(`/strategies/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    showToast('Strategie aktualisiert', 'success');
                } else {
                    await apiFetch('/strategies', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    showToast('Strategie erstellt', 'success');
                }
                closeStrategyModal();
                loadStrategies();
            } catch (error) {
                showToast('Fehler beim Speichern: ' + error.message, 'error');
            }
        }

        async function deleteStrategy(id) {
            if (!confirm('Strategie wirklich löschen?')) return;

            try {
                await apiFetch(`/strategies/${id}`, { method: 'DELETE' });
                showToast('Strategie gelöscht', 'success');
                loadStrategies();
            } catch (error) {
                showToast('Fehler beim Löschen: ' + error.message, 'error');
            }
        }

        async function setDefaultStrategy(id) {
            try {
                await apiFetch(`/strategies/${id}/set-default`, { method: 'POST' });
                showToast('Standard-Strategie gesetzt', 'success');
                loadStrategies();
            } catch (error) {
                showToast('Fehler: ' + error.message, 'error');
            }
        }

        // Export strategy as Markdown file
        async function exportStrategy(id) {
            try {
                const response = await fetch(`${API_BASE}/strategies/${id}/export`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `strategy_${id}.md`;

                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }

                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                showToast('Strategie exportiert', 'success');
            } catch (error) {
                showToast('Export fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Import strategy from Markdown file
        async function importStrategy(input) {
            if (!input.files || input.files.length === 0) return;

            const file = input.files[0];
            if (!file.name.endsWith('.md')) {
                showToast('Nur Markdown-Dateien (.md) werden akzeptiert', 'error');
                input.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/strategies/import`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }

                const strategy = await response.json();
                showToast(`Strategie "${strategy.name}" importiert`, 'success');
                loadStrategies();
            } catch (error) {
                showToast('Import fehlgeschlagen: ' + error.message, 'error');
            } finally {
                input.value = ''; // Reset file input
            }
        }

        // Quick recommendation (rule-based only, no LLM)
        async function runQuickRecommendation() {
            const symbol = document.getElementById('quickSymbol').value.trim();
            const lookback = parseInt(document.getElementById('quickLookback').value);
            const strategyId = document.getElementById('quickStrategy').value;

            if (!symbol) {
                showToast('Bitte Symbol eingeben (z.B. BTC/USD)', 'error');
                return;
            }

            const btn = document.getElementById('btnQuick');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Lädt...';

            showResponse('Empfehlung wird geladen...', `<div style="text-align: center; padding: 2rem;">
                <span class="loading-spinner"></span>
                <p style="margin-top: 1rem; color: #94a3b8;">Schnellempfehlung für ${symbol}...</p>
            </div>`);

            try {
                let url = `/recommendation/${encodeURIComponent(symbol)}?lookback_days=${lookback}&use_llm=false`;
                if (strategyId) {
                    url += `&strategy_id=${encodeURIComponent(strategyId)}`;
                }

                const response = await apiFetch(url);
                displayRecommendation(response, symbol);
                showToast('Empfehlung erhalten', 'success');
            } catch (error) {
                showResponse('Fehler', `<p style="color: #ef4444;">Empfehlung fehlgeschlagen: ${error.message}</p>`);
                showToast('Empfehlung fehlgeschlagen', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Empfehlung abrufen';
            }
        }

        // Load release/version info
        async function loadVersionInfo() {
            try {
                const data = await apiFetch('/version');
                if (data.version) {
                    document.getElementById('releaseVersion').textContent = data.version;
                }
                if (data.release_date) {
                    const releaseDate = new Date(data.release_date);
                    document.getElementById('releaseDate').textContent =
                        `Release: ${releaseDate.toLocaleDateString('de-DE')} ${releaseDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}`;
                }
            } catch (error) {
                // Fallback: Try to get from root endpoint or keep defaults
                try {
                    const rootData = await fetch('/').then(r => r.json());
                    if (rootData.version) {
                        document.getElementById('releaseVersion').textContent = rootData.version;
                    }
                    if (rootData.release_date) {
                        const releaseDate = new Date(rootData.release_date);
                        document.getElementById('releaseDate').textContent =
                            `Release: ${releaseDate.toLocaleDateString('de-DE')} ${releaseDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}`;
                    }
                } catch (e) {
                    console.log('Version info not available from API');
                }
            }
        }

        // Initialize
        updateDashboard();
        loadSymbols();
        loadStrategies();
        loadVersionInfo();
        setInterval(updateDashboard, 10000);

        // Fetch config info
        fetch('/').then(r => r.json()).then(data => {
            document.getElementById('dbHost').textContent = 'localhost:5432';
            document.getElementById('dbName').textContent = 'easyinsight';
        }).catch(() => {});
    </script>
</body>
</html>
